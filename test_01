package com.optum.fads.userroles.api.service.Impl;

import com.optum.fads.userroles.api.domain.SeCaseGrp;
import com.optum.fads.userroles.api.domain.SeFadsGrp;
import com.optum.fads.userroles.api.domain.SeSurGrp;
import com.optum.fads.userroles.api.domain.SeUsrGrp;
import com.optum.fads.userroles.api.domain.UiUserBase;
import com.optum.fads.userroles.api.repo.SeUsrGrpRepository;
import com.optum.fads.userroles.api.repo.UiUserBaseRepository;
import com.optum.fads.userroles.api.service.UserRoleCreateService;
import com.optum.fads.userroles.api.web.CreateUserRoleRequest;
import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

@Service
@RequiredArgsConstructor
@Slf4j
public class UserRoleCreateServiceImpl implements UserRoleCreateService {

    private final UiUserBaseRepository userRepo;
    private final SeUsrGrpRepository usrGrpRepo;

    @PersistenceContext
    private EntityManager em;

    @Override
    @Transactional
    public void createOrUpdateUser(CreateUserRoleRequest req) {
        if (req == null || !StringUtils.hasText(req.getUiSystemId())) {
            throw new IllegalArgumentException("uiSystemId is required");
        }

        final String uiSystemId = req.getUiSystemId();
        log.info("Create/Update user & group for uiSystemId={}", uiSystemId);

        // -------- Upsert UI_USER_BASE (managed entity) --------
        UiUserBase user = userRepo.findById(uiSystemId).orElseGet(() -> {
            UiUserBase u = new UiUserBase();
            u.setUiSystemId(uiSystemId);
            return u;
        });

        // set/overwrite simple fields from request
        user.setUiUserId(req.getUiUserId());
        user.setUiFirstName(req.getFirstName());
        user.setUiLastName(req.getLastName());
        user.setUiEMailAddress(req.getEmail());

        // save returns a managed instance (merge-or-persist as needed)
        user = userRepo.save(user);

        // -------- Upsert SE_USR_GRP (managed entity) --------
        SeUsrGrp grp = usrGrpRepo.findById(uiSystemId).orElseGet(() -> {
            SeUsrGrp g = new SeUsrGrp();
            g.setUiSystemId(uiSystemId);   // PK == same as user
            g.setUiUserBase(user);         // FK to UI_USER_BASE
            return g;
        });

        // Always keep the link to the (now) managed user
        grp.setUiUserBase(user);

        // IMPORTANT: For @ManyToOne lookups, use managed references (no transient objects)
        if (req.getFadsGrpId() != null) {
            grp.setFadsGrp(em.getReference(SeFadsGrp.class, req.getFadsGrpId()));
        } else {
            grp.setFadsGrp(null);
        }

        if (req.getFadsSurGrpId() != null) {
            grp.setFadsSurGrp(em.getReference(SeSurGrp.class, req.getFadsSurGrpId()));
        } else {
            grp.setFadsSurGrp(null);
        }

        if (req.getFadsCaseGrpId() != null) {
            grp.setFadsCaseGrp(em.getReference(SeCaseGrp.class, req.getFadsCaseGrpId()));
        } else {
            grp.setFadsCaseGrp(null);
        }

        // save/merge the group row
        usrGrpRepo.save(grp);

        log.info("Create/Update completed for uiSystemId={}", uiSystemId);
    }
}


{
  "uiSystemId": "GS1002",
  "uiUserId": "JSMITH",
  "firstName": "John",
  "lastName": "Smith",
  "email": "john.smith@optum.com",
  "fadsGrpId": 10,
  "fadsSurGrpId": 21,
  "fadsCaseGrpId": 5
}

