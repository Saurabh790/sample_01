@Test
void testUpdateUser_withGroupAssignments() {
    // Arrange
    UserForAdmin inputUser = new UserForAdmin();
    inputUser.setSystemId("JD12345678");
    inputUser.setUserId("john.doe@example.com");
    inputUser.setFadsGroup(5);
    inputUser.setSurGroup(10);
    inputUser.setCaseGroup(15);

    UiUserBase entityFromMapper = new UiUserBase();
    entityFromMapper.setUiSystemId("JD12345678");

    UiUserBase savedUser = new UiUserBase();
    savedUser.setUiSystemId("JD12345678");

    SeUsrGrp existingUserGroup = new SeUsrGrp();
    existingUserGroup.setUiUserBase(savedUser);

    // --- mock group entities that the service will look up ---
    SeFadsGrp fadsGrp = new SeFadsGrp();
    fadsGrp.setId(BigDecimal.valueOf(5));

    SeSurGrp surGrp = new SeSurGrp();
    surGrp.setId(BigDecimal.valueOf(10));

    SeCaseGrp caseGrp = new SeCaseGrp();
    caseGrp.setId(BigDecimal.valueOf(15));

    // --- stubbing repository calls used in updateUser(...) ---
    when(repo.existsById("JD12345678")).thenReturn(true);
    when(mapper.toEntity(inputUser)).thenReturn(entityFromMapper);
    when(repo.save(entityFromMapper)).thenReturn(savedUser);

    when(seUsrGrpRepository.findById("JD12345678"))
            .thenReturn(Optional.of(existingUserGroup));

    // service will typically call findById(...) on these repos
    when(seFadsGrpRepository.findById(BigDecimal.valueOf(5)))
            .thenReturn(Optional.of(fadsGrp));
    when(seSurGrpRepository.findById(BigDecimal.valueOf(10)))
            .thenReturn(Optional.of(surGrp));
    when(seCaseGrpRepository.findById(BigDecimal.valueOf(15)))
            .thenReturn(Optional.of(caseGrp));

    // let save(...) return the same instance so we can inspect it
    when(seUsrGrpRepository.save(any(SeUsrGrp.class)))
            .thenAnswer(invocation -> invocation.getArgument(0));

    // Act
    assertDoesNotThrow(() -> userService.updateUser(inputUser));

    // Assert
    verify(repo, times(1)).existsById("JD12345678");
    verify(mapper, times(1)).toEntity(inputUser);
    verify(repo, times(1)).save(entityFromMapper);
    verify(repo, times(1)).flush();
    verify(seUsrGrpRepository, times(1)).findById("JD12345678");

    // Verify SeUsrGrp group assignments
    ArgumentCaptor<SeUsrGrp> seUserGroupCaptor = ArgumentCaptor.forClass(SeUsrGrp.class);
    verify(seUsrGrpRepository, times(1)).save(seUserGroupCaptor.capture());

    SeUsrGrp capturedSeUserGroup = seUserGroupCaptor.getValue();
    // use the *same types* as the real fields (BigDecimal ids on the group entities)
    assertEquals(BigDecimal.valueOf(5),  capturedSeUserGroup.getFadsGrp().getId());
    assertEquals(BigDecimal.valueOf(10), capturedSeUserGroup.getFadsSurGrp().getId());
    assertEquals(BigDecimal.valueOf(15), capturedSeUserGroup.getFadsCaseGrp().getId());

    // Verify history record creation
    ArgumentCaptor<UserListItemHistoryRequest> historyCaptor =
            ArgumentCaptor.forClass(UserListItemHistoryRequest.class);
    verify(userHistory, times(1)).createHistory(historyCaptor.capture());

    UserListItemHistoryRequest historyRequest = historyCaptor.getValue();
    assertEquals("john.doe@example.com", historyRequest.getUiUserId());
    assertEquals("JD12345678", historyRequest.getUiSystemId());

    // match whatever type the history request fields actually are.
    // If they are BigDecimal:
    assertEquals(BigDecimal.valueOf(5),  historyRequest.getFadsGrpId());
    assertEquals(BigDecimal.valueOf(10), historyRequest.getFadsSurGrpId());
    assertEquals(BigDecimal.valueOf(15), historyRequest.getFadsCaseGrpId());

    // If in your code these are Integer instead, then use:
    // assertEquals(Integer.valueOf(5),  historyRequest.getFadsGrpId());
    // assertEquals(Integer.valueOf(10), historyRequest.getFadsSurGrpId());
    // assertEquals(Integer.valueOf(15), historyRequest.getFadsCaseGrpId());
}
