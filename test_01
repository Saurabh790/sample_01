package com.optum.fads.pgp.jobs.api.security;

import com.optum.fads.pgp.jobs.api.service.IUserDetailsService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.security.authentication.AbstractAuthenticationToken;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.oauth2.jwt.Jwt;

import java.time.Instant;
import java.util.List;
import java.util.Map;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class UserJwtAuthenticationConverterTest {

    @Mock
    private IUserDetailsService userDetailsService;

    private UserJwtAuthenticationConverter converter;

    @BeforeEach
    void setUp() {
        converter = new UserJwtAuthenticationConverter(userDetailsService);
    }

    @Test
    void convert_shouldUseUpnFirst_andMapGroupsToRoleAuthorities() {
        Jwt jwt = jwtWithClaims(Map.of(
                "upn", "user@company.com",
                "email", "email@company.com",
                "groups", List.of("admin", "dev")
        ));

        Object principal = new Object();
        when(userDetailsService.loadUserByUsername("user@company.com")).thenReturn((org.springframework.security.core.userdetails.UserDetails) principal);

        // If your FadsUser implements UserDetails, better to use that in real test.
        // Here we just want to validate behavior, so we mock with UserDetails cast.
        AbstractAuthenticationToken token = converter.convert(jwt);

        assertNotNull(token);
        assertEquals(principal, token.getPrincipal());

        // authorities should be ROLE_ADMIN, ROLE_DEV
        assertTrue(token.getAuthorities().contains(new SimpleGrantedAuthority("ROLE_ADMIN")));
        assertTrue(token.getAuthorities().contains(new SimpleGrantedAuthority("ROLE_DEV")));
        assertEquals(2, token.getAuthorities().size());

        // verify service called with UPN
        verify(userDetailsService).loadUserByUsername("user@company.com");
    }

    @Test
    void convert_shouldFallbackToUniqueName_thenEmail_thenSub() {
        Jwt jwt = jwtWithClaims(Map.of(
                "unique_name", "unique-name-1",
                "email", "email-1",
                "sub", "sub-1",
                "groups", List.of("qa")
        ));

        Object principal = new Object();
        when(userDetailsService.loadUserByUsername("unique-name-1"))
                .thenReturn((org.springframework.security.core.userdetails.UserDetails) principal);

        AbstractAuthenticationToken token = converter.convert(jwt);

        assertEquals(principal, token.getPrincipal());
        assertTrue(token.getAuthorities().contains(new SimpleGrantedAuthority("ROLE_QA")));
        verify(userDetailsService).loadUserByUsername("unique-name-1");
    }

    @Test
    void convert_shouldUseEmail_ifUpnAndUniqueNameMissing() {
        Jwt jwt = jwtWithClaims(Map.of(
                "email", "only-email",
                "groups", List.of("ops")
        ));

        Object principal = new Object();
        when(userDetailsService.loadUserByUsername("only-email"))
                .thenReturn((org.springframework.security.core.userdetails.UserDetails) principal);

        AbstractAuthenticationToken token = converter.convert(jwt);

        assertEquals(principal, token.getPrincipal());
        assertTrue(token.getAuthorities().contains(new SimpleGrantedAuthority("ROLE_OPS")));
        verify(userDetailsService).loadUserByUsername("only-email");
    }

    @Test
    void convert_shouldUseSub_ifOthersMissing() {
        Jwt jwt = jwtWithClaims(Map.of(
                "sub", "sub-user",
                "groups", List.of("viewer")
        ));

        Object principal = new Object();
        when(userDetailsService.loadUserByUsername("sub-user"))
                .thenReturn((org.springframework.security.core.userdetails.UserDetails) principal);

        AbstractAuthenticationToken token = converter.convert(jwt);

        assertEquals(principal, token.getPrincipal());
        assertTrue(token.getAuthorities().contains(new SimpleGrantedAuthority("ROLE_VIEWER")));
        verify(userDetailsService).loadUserByUsername("sub-user");
    }

    @Test
    void convert_shouldPassNullToService_ifNoUniqueIdClaimsPresent() {
        Jwt jwt = jwtWithClaims(Map.of(
                "groups", List.of("admin")
        ));

        when(userDetailsService.loadUserByUsername(anyString())).thenReturn(null);

        // capture what was passed
        ArgumentCaptor<String> captor = ArgumentCaptor.forClass(String.class);

        assertThrows(BadCredentialsException.class, () -> converter.convert(jwt));

        verify(userDetailsService).loadUserByUsername(captor.capture());
        assertNull(captor.getValue()); // because getUniqueID returns null
    }

    @Test
    void convert_shouldThrowBadCredentials_whenUserServiceReturnsNull() {
        Jwt jwt = jwtWithClaims(Map.of(
                "email", "missing-user",
                "groups", List.of("admin")
        ));

        when(userDetailsService.loadUserByUsername("missing-user")).thenReturn(null);

        assertThrows(BadCredentialsException.class, () -> converter.convert(jwt));
        verify(userDetailsService).loadUserByUsername("missing-user");
    }

    @Test
    void convert_shouldReturnEmptyAuthorities_whenGroupsClaimMissing() {
        Jwt jwt = jwtWithClaims(Map.of(
                "email", "user1"
        ));

        Object principal = new Object();
        when(userDetailsService.loadUserByUsername("user1"))
                .thenReturn((org.springframework.security.core.userdetails.UserDetails) principal);

        AbstractAuthenticationToken token = converter.convert(jwt);

        assertEquals(principal, token.getPrincipal());
        assertNotNull(token.getAuthorities());
        assertEquals(0, token.getAuthorities().size());
    }

    @Test
    void convert_shouldReturnEmptyAuthorities_whenGroupsNotACollection() {
        Jwt jwt = jwtWithClaims(Map.of(
                "email", "user1",
                "groups", "admin" // invalid type
        ));

        Object principal = new Object();
        when(userDetailsService.loadUserByUsername("user1"))
                .thenReturn((org.springframework.security.core.userdetails.UserDetails) principal);

        AbstractAuthenticationToken token = converter.convert(jwt);

        assertEquals(principal, token.getPrincipal());
        assertEquals(0, token.getAuthorities().size());
    }

    // ---- helper ----
    private Jwt jwtWithClaims(Map<String, Object> claims) {
        return Jwt.withTokenValue("token")
                .header("alg", "none")
                .issuedAt(Instant.now())
                .expiresAt(Instant.now().plusSeconds(3600))
                .claims(c -> c.putAll(claims))
                .build();
    }
}
