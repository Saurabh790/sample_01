@Service
@RequiredArgsConstructor
public class UserRoleCreateServiceImpl implements UserRoleCreateService {

    private final UiUserBaseRepository userRepo;
    private final SeUsrGrpRepository usrGrpRepo;

    @PersistenceContext
    private EntityManager em;

    @Override
    @Transactional
    public void createOrUpdateUser(CreateUserRoleRequest req) {

        // 1) UPSERT UI_USER_BASE (managed instance returned)
        UiUserBase user = userRepo.findById(req.getUiSystemId()).orElseGet(UiUserBase::new);
        user.setUiSystemId(req.getUiSystemId());
        user.setUiUserId(req.getUiUserId());
        user.setUiFirstName(req.getFirstName());
        user.setUiLastName(req.getLastName());
        user.setUiEMailAddress(req.getEmail());
        user = userRepo.save(user); // 'user' is managed in the PC

        // 2) INSERT vs UPDATE for SE_USR_GRP
        boolean exists = usrGrpRepo.existsById(req.getUiSystemId());
        SeUsrGrp grp;

        if (exists) {
            // UPDATE path: get the managed entity and mutate it
            grp = usrGrpRepo.findById(req.getUiSystemId()).orElseThrow();
        } else {
            // INSERT path: create new and attach the *managed* UiUserBase
            grp = new SeUsrGrp();
            grp.setUiSystemId(req.getUiSystemId());

            // CRITICAL: reuse managed instance (or use getReference) — do NOT new UiUserBase()
            grp.setUiUserBase(user);
            // alternatively:
            // grp.setUiUserBase(em.getReference(UiUserBase.class, req.getUiSystemId()));
        }

        // set optional relationships by id without reloading full rows
        if (req.getFadsGrpId() != null) {
            SeFadsGrp f = new SeFadsGrp();
            f.setId(req.getFadsGrpId());
            grp.setFadsGrp(f);
        } else {
            grp.setFadsGrp(null);
        }

        if (req.getFadsSurGrpId() != null) {
            SeSurGrp s = new SeSurGrp();
            s.setId(req.getFadsSurGrpId());
            grp.setFadsSurGrp(s);
        } else {
            grp.setFadsSurGrp(null);
        }

        if (req.getFadsCaseGrpId() != null) {
            SeCaseGrp c = new SeCaseGrp();
            c.setId(req.getFadsCaseGrpId());
            grp.setFadsCaseGrp(c);
        } else {
            grp.setFadsCaseGrp(null);
        }

        if (exists) {
            // managed entity – flush will update automatically
        } else {
            em.persist(grp); // will INSERT without trying to persist another UiUserBase
        }
    }
}

{
  "uiSystemId": "GS1001",
  "uiUserId": "JSMITH",
  "firstName": "John",
  "lastName": "Smith",
  "email": "john.smith@optum.com",
  "fadsGrpId": 10,
  "fadsSurGrpId": 21,
  "fadsCaseGrpId": 5
}

