// UserRoleCreateServiceImpl.java (only the bottom part changes)
@Service
@RequiredArgsConstructor
public class UserRoleCreateServiceImpl implements UserRoleCreateService {

    private final UiUserBaseRepository userRepo;
    private final SeUsrGrpRepository usrGrpRepo;

    @PersistenceContext
    private EntityManager em;

    @Override
    @Transactional
    public void createOrUpdateUser(CreateUserRoleRequest req) {

        // 1) upsert UI_USER_BASE
        UiUserBase user = userRepo.findById(req.getUiSystemId()).orElseGet(UiUserBase::new);
        user.setUiSystemId(req.getUiSystemId());
        user.setUiUserId(req.getUiUserId());
        user.setUiFirstName(req.getFirstName());
        user.setUiLastName(req.getLastName());
        user.setUiEMailAddress(req.getEmail());
        userRepo.save(user); // safe

        // 2) INSERT vs UPDATE for SE_USR_GRP
        boolean exists = usrGrpRepo.existsById(req.getUiSystemId());

        SeUsrGrp grp;
        if (exists) {
            // UPDATE path – managed entity; just mutate it, no save() needed
            grp = usrGrpRepo.findById(req.getUiSystemId()).orElseThrow();
        } else {
            // INSERT path – new entity; we will em.persist(..)
            grp = new SeUsrGrp();
            grp.setUiSystemId(req.getUiSystemId());
            grp.setUiUserBase(user); // required because of @MapsId
        }

        // set relationships using your existing entities’ API (id field = setId)
        if (req.getFadsGrpId() != null) {
            SeFadsGrp f = new SeFadsGrp();
            f.setId(req.getFadsGrpId());
            grp.setFadsGrp(f);
        } else {
            grp.setFadsGrp(null);
        }

        if (req.getFadsSurGrpId() != null) {
            SeSurGrp s = new SeSurGrp();
            s.setId(req.getFadsSurGrpId());
            grp.setFadsSurGrp(s);
        } else {
            grp.setFadsSurGrp(null);
        }

        if (req.getFadsCaseGrpId() != null) {
            SeCaseGrp c = new SeCaseGrp();
            c.setId(req.getFadsCaseGrpId());
            grp.setFadsCaseGrp(c);
        } else {
            grp.setFadsCaseGrp(null);
        }

        if (exists) {
            // managed; changes will flush automatically
        } else {
            em.persist(grp); // force INSERT (no merge, no stale)
        }
    }
}
