server:
  port: 8080
  servlet:
    context-path: /userroles  # Main app context

spring:
  application:
    name: fads-userroles-api

  datasource:
    # --- DB connectivity (non-secret parts) ---
    url: jdbc:sqlserver://sql-pi-dev-cus-001.database.windows.net:1433;database=pi-dev-db
    driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver

    # These are **Key Vault secret names**, NOT actual values.
    # ServiceConfig will call SecretClient.getSecret(...) using these names.
    username-secret-name: fads-userroles-db-username
    password-secret-name: fads-userroles-db-password

    hikari:
      maximum-pool-size: ${MAXIMUM_DB_POOL_SIZE:50}
      minimum-idle: ${MIN_POOL_IDLE:1}
      connection-timeout: ${DB_CONNECTION_TIMEOUT:60000}
      idle-timeout: ${DB_POOL_IDLE_TIMEOUT:60000}
      leak-detection-threshold: ${LEAK_DETECTION_THRESHOLD:0}

  azure:
    keyvault:
      secrets:
        endpoint: https://kv-anly-pi-dev-cus-001.vault.azure.net/
        # endpoint: https://kv-anly-pi-tst-cus-001.vault.azure.net/
      credential:
        client-id:                       # << fill in
        client-secret:                   # << fill in
        tenant-id: fbe00597-ca09-441a-836a-eb0dcb7c14e1
        # client-id: cec3005b-b518-48c6-b67e-cde75d6864a5
        # client-secret:
        # tenant-id:

  jpa:
    hibernate:
      ddl-auto: none
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        globally_quoted_identifiers: true
    database-platform: org.hibernate.dialect.SQLServer2016Dialect

  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: https://login.microsoftonline.com/fbe00597-ca09-441a-836a-eb0dcb7c14e1/discovery/v2.0/keys
          jws-algorithms:
            - RS256

management:
  endpoints:
    web:
      exposure:
        include: "*"
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true

logging:
  level:
    org.springframework.web: INFO
    org.springframework.security: INFO

---
spring:
  config:
    activate:
      on-profile: build

logging:
  level:
    root: INFO
⚠️ In Azure Key Vault, create two secrets:

fads-userroles-db-username → real DB username

fads-userroles-db-password → real DB password

2. ServiceConfig class
This class:

Reads the secret names from spring.datasource.username-secret-name and spring.datasource.password-secret-name

Uses SecretClient to fetch the real values

Builds a HikariDataSource

Enables JPA repositories and component scanning under com.optum.fads.userroles.api

java
Copy code
package com.optum.fads.userroles.api.config;

import javax.sql.DataSource;

import com.azure.security.keyvault.secrets.SecretClient;
import com.zaxxer.hikari.HikariDataSource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.transaction.annotation.EnableTransactionManagement;

@Configuration
@EnableTransactionManagement
@EnableJpaRepositories(basePackages = "com.optum.fads.userroles.api.repo")
@ComponentScan(basePackages = { "com.optum.fads.userroles.api" })
public class ServiceConfig {

    private static final Logger logger = LoggerFactory.getLogger(ServiceConfig.class);

    // ---- JDBC / pool configuration (non-secret) ----

    @Value("${spring.datasource.url}")
    private String url;

    @Value("${spring.datasource.driver-class-name}")
    private String driverClassName;

    @Value("${spring.datasource.hikari.maximum-pool-size:50}")
    private int maximumPoolSize;

    @Value("${spring.datasource.hikari.minimum-idle:1}")
    private int minimumIdle;

    @Value("${spring.datasource.hikari.connection-timeout:60000}")
    private long connectionTimeout;

    @Value("${spring.datasource.hikari.idle-timeout:60000}")
    private long idleTimeout;

    @Value("${spring.datasource.hikari.leak-detection-threshold:0}")
    private long leakDetectionThreshold;

    // ---- Key Vault secret names (from YAML) ----

    @Value("${spring.datasource.username-secret-name}")
    private String usernameSecretName;

    @Value("${spring.datasource.password-secret-name}")
    private String passwordSecretName;

    private final SecretClient secretClient;

    public ServiceConfig(SecretClient secretClient) {
        this.secretClient = secretClient;
    }

    @Bean(name = "fadsDataSource")
    @Primary // Mark this as the primary DataSource
    public DataSource customDataSource() {

        logger.info("Initializing custom HikariDataSource bean");

        try {
            // Fetch actual credentials from Azure Key Vault
            String userNameValue = secretClient.getSecret(usernameSecretName).getValue();
            String passwordValue = secretClient.getSecret(passwordSecretName).getValue();

            logger.info("Successfully retrieved DB credentials from Key Vault (username secret: {})",
                    usernameSecretName);

            // Configure HikariCP
            HikariDataSource dataSource = new HikariDataSource();
            dataSource.setJdbcUrl(url);
            dataSource.setDriverClassName(driverClassName);
            dataSource.setUsername(userNameValue);
            dataSource.setPassword(passwordValue);

            dataSource.setMaximumPoolSize(maximumPoolSize);
            dataSource.setMinimumIdle(minimumIdle);
            dataSource.setConnectionTimeout(connectionTimeout);
            dataSource.setIdleTimeout(idleTimeout);
            dataSource.setLeakDetectionThreshold(leakDetectionThreshold);

            logger.info("HikariDataSource bean created successfully");
            return dataSource;

        } catch (Exception e) {
            logger.error("Failed to create DataSource bean", e);
            throw new RuntimeException("Error initializing DataSource", e);
        }
    }
}
