package com.optum.fads.casetracking.dao.impl;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang3.ArrayUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.log4j.Logger;
import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.query.Query;
import org.hibernate.transform.Transformers;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationContext;
import org.springframework.stereotype.Repository;

import com.optum.fads.casetracking.common.CaseConstants;
import com.optum.fads.casetracking.common.CaseListAssociationsColumnsEnum;
import com.optum.fads.casetracking.common.CasesForAssociationsColumnsEnum;
import com.optum.fads.casetracking.dao.CaseAssociationListDAO;
import com.optum.fads.casetracking.dto.AssociationListItem;
import com.optum.fads.casetracking.util.CaseGlobalConstants;

@Repository
public class CaseAssociationListDAOImpl implements CaseAssociationListDAO  {
	private final Logger log = Logger.getLogger(this.getClass().getName());
	@Autowired
	private SessionFactory sessionFactory;

	public static CaseAssociationListDAO getFromApplicationContext(
			ApplicationContext ctx) {
		return (CaseAssociationListDAO) ctx.getBean("caseAssociationListDAO");
	}

	public void setSessionFactory(SessionFactory sessionFactory) {
		this.sessionFactory = sessionFactory;
	}

	private Session getCurrentSession() {
		return sessionFactory.getCurrentSession();
	}

	protected void initDao() {
		// do nothing
	}

    // for new table scenarios when using UITK 3 components
    @Override
    public int findAllCaseAssociationsTotalCount(Map<String,String> filterConditions, String[] nodes) {
        StringBuilder sb = new StringBuilder();
        getFindTotalCountQuerySelectFrom(sb);
        sb.append(" where c.caIntelligentKeyTByCaseId.deleteFlag is null  ");

		//log.info("---------------------CaseAssociationListDAOImpl findAllCaseAssociationsTotalCount - nodes.length: " + nodes.length + "---------------------");
		if (ArrayUtils.isNotEmpty(nodes)) {
			sb.append(" and c.caIntelligentKeyTByCaseId.caLuPrmNodeT.nodeCd IN (:nodeList) ");
		}

		getFindAllQueryFilters(sb, filterConditions);

        final String queryString = sb.toString();
        int resultListSize = 0;
        try {
            Query query = getCurrentSession().createQuery(queryString);

			if (ArrayUtils.isNotEmpty(nodes)) {
				query.setParameterList("nodeList", nodes);
			}

			setFindAllQueryFilters(query, filterConditions);

            resultListSize = query.list().size();
        } catch (Exception e) {
            log.error("Exception in findAllCaseAssociationsTotalCount: ", e);
            throw e;
        }

        return resultListSize;
    }

    // for new table scenarios when using UITK 3 components
    @Override
    public List<AssociationListItem> findAllCaseAssociations(Map<String,String> filterConditions,
                                           Map<String,String> sortConditions,
                                           final int firstRecord, final int maxRecords, String[] nodes) {
        StringBuilder sb = new StringBuilder();
        getFindAllQuerySelectFrom(sb);

        sb.append(" where c.caIntelligentKeyTByCaseId.deleteFlag is null  ");

		//log.info("---------------------CaseAssociationListDAOImpl findAllCaseAssociations - nodes.length: " + nodes.length + "---------------------");
		if (ArrayUtils.isNotEmpty(nodes)) {
			sb.append(" and c.caIntelligentKeyTByCaseId.caLuPrmNodeT.nodeCd IN (:nodeList) ");
		}

		getFindAllQueryFilters(sb, filterConditions);

        getFindAllQueryOrderBy(sb, sortConditions);

        final String queryString = sb.toString();
        List<AssociationListItem> resultList = new ArrayList<>();
        try {
            Query query = getCurrentSession().createQuery(queryString);

			if (ArrayUtils.isNotEmpty(nodes)) {
				query.setParameterList("nodeList", nodes);
			}

			setFindAllQueryFilters(query, filterConditions);
            for (Map.Entry<String, String> entry : filterConditions.entrySet()) {
                query.setParameter(entry.getKey(), entry.getValue());
            }

            query.setResultTransformer(Transformers.aliasToBean(AssociationListItem.class));
            query.setFirstResult(firstRecord);
            query.setMaxResults(maxRecords);

            resultList = query.list();
        } catch (Exception e) {
            log.error("Exception in findAllCaseAssociations: ", e);
            throw e;
        }

        return resultList;
    }

	// for new table scenarios when using UITK 3 components
	private void getFindAllQueryFilters(StringBuilder sb, Map<String,String> filterConditions) {
        if(filterConditions != null && !filterConditions.isEmpty()) {
            for (Map.Entry<String, String> entry : filterConditions.entrySet()) {
				for (CaseListAssociationsColumnsEnum col : CaseListAssociationsColumnsEnum.values()) {
					if (col.getColumnId().equals(entry.getKey())) {
						if (col.isColumnDropDownForSearch()){
							sb.append(" and ").append(col.getColumnStringSearchOrderBy()).append(" = :").append(entry.getKey());
						} else if ("intelligentKey".equals(entry.getKey())) {
							sb.append(" and lower(c.caIntelligentKeyTByCaseId.caLuPrmNodeT.nodeCd || '-' || ");
							if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
								sb.append(" c.caIntelligentKeyTByCaseId.caLuScndNodeT.nodeCd || '-' || ");
							}
							sb.append(" c.caIntelligentKeyTByCaseId.caYearId || '-' || ");
							sb.append(" to_char(c.caIntelligentKeyTByCaseId.caSequenceId,'FM00000')) like :").append(entry.getKey());
                        } else if ("associatedIntelligentKey".equals(entry.getKey())) {
                            sb.append(" and lower(c.caIntelligentKeyTByAssociateCaseId.caLuPrmNodeT.nodeCd ")
                                    .append("||'-'|| ");
                            if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
                                sb.append(" c.caIntelligentKeyTByAssociateCaseId.caLuScndNodeT.nodeCd ");
                                sb.append(" ||'-'|| ");
                            }
                            sb.append(" c.caIntelligentKeyTByAssociateCaseId.caYearId ");
                            sb.append(" ||'-'|| ");
                            //sb.append(" to_char(c.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000')) like '").append(getLowerSearchString(entry.getValue())).append("' ");
							sb.append(" to_char(c.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000')) like :").append(entry.getKey());
                        } else {
							if (StringUtils.containsIgnoreCase(col.getColumnId(), "name")){
								/*
								if (StringUtils.containsAny(entry.getValue(),'%','_')){
									sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like '")
											.append(escapeSingleQuote(getLowerSearchString(StringUtils.replace(
													StringUtils.replace(entry.getValue(), "%", "\\%"), "_", "\\_"))))
											.append("'  ESCAPE '\\' ");
								} else {
									sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like '")
											.append(escapeSingleQuote(getLowerSearchString(entry.getValue()))).append("' ");
								}
								*/
								sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like :").append(entry.getKey());
								if (StringUtils.containsAny(entry.getValue(),'%','_')){
									sb.append(" ESCAPE '\\' ");
								}
							} else if (StringUtils.containsIgnoreCase(col.getColumnId(), "id")) {
								/*
								if (StringUtils.containsAny(entry.getValue(),'%','_')){
									sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like '")
											.append(getLowerSearchString(StringUtils.replace(
													StringUtils.replace(entry.getValue(), "%", "\\%"), "_", "\\_")))
											.append("'  ESCAPE '\\' ");
								} else {
									sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like '")
											.append(getLowerSearchString(entry.getValue())).append("' ");
								}
								*/
								sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like :").append(entry.getKey());
								if (StringUtils.containsAny(entry.getValue(),'%','_')){
									sb.append(" ESCAPE '\\' ");
								}
							} else {
								//sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like '").append(getLowerSearchString(entry.getValue())).append("' ");
								sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like :").append(entry.getKey());
							}
						}
					}
				}
            }
        }
	}

	private void setFindAllQueryFilters(Query query, Map<String,String> filterConditions) {
		if(filterConditions != null && !filterConditions.isEmpty()) {
			for (Map.Entry<String, String> entry : filterConditions.entrySet()) {
				for (CaseListAssociationsColumnsEnum col : CaseListAssociationsColumnsEnum.values()) {
					if (col.getColumnId().equals(entry.getKey())) {
						if (col.isColumnDropDownForSearch()){
							//sb.append(" and ").append(col.getColumnStringSearchOrderBy()).append(" = '").append(entry.getValue()).append("' ");
							query.setString(entry.getKey(), entry.getValue());

						} else if ("intelligentKey".equals(entry.getKey())) {
							/*
							sb.append(" and lower(c.caIntelligentKeyTByCaseId.caLuPrmNodeT.nodeCd ").append("||'-'|| ");
							if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
								sb.append(" c.caIntelligentKeyTByCaseId.caLuScndNodeT.nodeCd ");
								sb.append(" ||'-'|| ");
							}
							sb.append(" c.caIntelligentKeyTByCaseId.caYearId ");
							sb.append(" ||'-'|| ");
							sb.append(" to_char(c.caIntelligentKeyTByCaseId.caSequenceId,'FM00000')) like '")
									.append(getLowerSearchString(entry.getValue())).append("' ");
							*/
							query.setString(entry.getKey(), getLowerSearchString(entry.getValue()));

						} else if ("associatedIntelligentKey".equals(entry.getKey())) {
							/*
							sb.append(" and lower(c.caIntelligentKeyTByAssociateCaseId.caLuPrmNodeT.nodeCd ")
									.append("||'-'|| ");
							if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
								sb.append(" c.caIntelligentKeyTByAssociateCaseId.caLuScndNodeT.nodeCd ");
								sb.append(" ||'-'|| ");
							}
							sb.append(" c.caIntelligentKeyTByAssociateCaseId.caYearId ");
							sb.append(" ||'-'|| ");
							sb.append(" to_char(c.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000')) like '")
									.append(getLowerSearchString(entry.getValue())).append("' ");
							*/
							query.setString(entry.getKey(), getLowerSearchString(entry.getValue()));

						} else {
							if (StringUtils.containsIgnoreCase(col.getColumnId(), "name")){
								/*
								if (StringUtils.containsAny(entry.getValue(),'%','_')){
									sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like '")
											.append(escapeSingleQuote(getLowerSearchString(StringUtils.replace(
													StringUtils.replace(entry.getValue(), "%", "\\%"), "_", "\\_"))))
											.append("'  ESCAPE '\\' ");
								} else {
									sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like '")
											.append(escapeSingleQuote(getLowerSearchString(entry.getValue()))).append("' ");
								}
								*/
								String escString;
								if (StringUtils.containsAny(entry.getValue(), '%', '_')){
									escString = StringUtils.replace(StringUtils.replace(entry.getValue(), "%", "\\%"), "_", "\\_");
								} else {
									escString = entry.getValue();
								}
								query.setString(entry.getKey(), getLowerSearchString(escString));//escapeSingleQuote()

							} else if (StringUtils.containsIgnoreCase(col.getColumnId(), "id")) {
								/*
								if (StringUtils.containsAny(entry.getValue(),'%','_')){
									sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like '")
											.append(getLowerSearchString(StringUtils.replace(
													StringUtils.replace(entry.getValue(), "%", "\\%"), "_", "\\_")))
											.append("'  ESCAPE '\\' ");
								} else {
									sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like '")
											.append(getLowerSearchString(entry.getValue())).append("' ");
								}
								*/
								String escString;
								if (StringUtils.containsAny(entry.getValue(), '%', '_')){
									escString = StringUtils.replace(StringUtils.replace(entry.getValue(), "%", "\\%"), "_", "\\_");
								} else {
									escString = entry.getValue();
								}
								query.setString(entry.getKey(), getLowerSearchString(escString));

							} else {
								/*
								sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like '")
										.append(getLowerSearchString(entry.getValue())).append("' ");
								*/
								query.setString(entry.getKey(), getLowerSearchString(entry.getValue()));
							}
						}
					}
				}
			}
		}
	}

    // for new table scenarios when using UITK 3 components
    private String getLowerSearchString(String searchInput){
        return "%" + StringUtils.lowerCase(searchInput) + "%";
    }

	private String escapeSingleQuote(String searchInput){
		return StringUtils.replace(searchInput, "'", "''");
	}

    // for new table scenarios when using UITK 3 components
    private void getFindAllQueryOrderBy(StringBuilder sb, Map<String, String> sortConditions) {
        if (sortConditions != null && !sortConditions.isEmpty()) {
            sb.append(" order by");

            for (Map.Entry<String, String> entry : sortConditions.entrySet()) {
                for (CaseListAssociationsColumnsEnum col : CaseListAssociationsColumnsEnum.values()) {
                    if (col.getColumnId().equals(entry.getKey())) {
                        if (col.isColumnStringTypeForOrderBy()) {
                            sb.append(" lower(").append(col.getColumnStringSearchOrderBy()).append(")");
                        } else {
                            sb.append(" ").append(col.getColumnQueryOrder());
                        }
                        break;
                    }
                }

                if ("-1".equals(entry.getValue())) {
                    sb.append(" DESC NULLS LAST,");
                } else if ("1".equals(entry.getValue())) {
                    sb.append(" ASC NULLS FIRST,");
                }

                if (!"intelligentKey".equals(entry.getKey())) {
                    sb.append(" ").append(CaseListAssociationsColumnsEnum.CASE_ID.getColumnQueryOrder());
                } else {
                    sb.delete(sb.length() - 1, sb.length());
                }
            }
        }
    }

    private void getFindAllQuerySelectFrom(StringBuilder sb) {
        sb.append(" select c.id.caseId  as caseId,");
        sb.append(" c.caIntelligentKeyTByCaseId.caLuPrmNodeT.nodeCd as primaryNode ,");
        sb.append(" c.caIntelligentKeyTByCaseId.caLuPrmNodeT.nodeCd ");
        sb.append( "||'-'|| ");

        if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
            sb.append(" c.caIntelligentKeyTByCaseId.caLuScndNodeT.nodeCd ");
            sb.append(" ||'-'|| ");
        }

        sb.append(" c.caIntelligentKeyTByCaseId.caYearId ");
        sb.append(" ||'-'|| ");
        sb.append(" to_char(c.caIntelligentKeyTByCaseId.caSequenceId,'FM00000') as intelligentKey ,");

        sb.append(" caGeneralT.protectStatus as protectStatus, ");
        sb.append(" caGeneralT.caseName as caseName, ");

        sb.append(" caLuCaseTypeT.typeCd as caseType, ");
        sb.append(" caLuCaseTypeT.typeDesc as caseTypeDesc, ");

        sb.append(" caGeneralT.participantId as participantId, ");
        sb.append(" caGeneralT.participantName as participantName, ");

        sb.append(" c.caIntelligentKeyTByAssociateCaseId.caseId as associatedCaseId, ");

        sb.append(" c.caIntelligentKeyTByAssociateCaseId.caLuPrmNodeT.nodeCd ");
        //sb.append( "||'-'|| ");
        sb.append( " || ");
        sb.append( "NVL2(c.caIntelligentKeyTByAssociateCaseId.caseId, '-', '')");
        sb.append( " || ");

        if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
            sb.append(" c.caIntelligentKeyTByAssociateCaseId.caLuScndNodeT.nodeCd ");
            //sb.append(" ||'-'|| ");
            sb.append( " || ");
            sb.append( "NVL2(c.caIntelligentKeyTByAssociateCaseId.caseId, '-', '')");
            sb.append( " || ");
        }

        sb.append(" c.caIntelligentKeyTByAssociateCaseId.caYearId ");
        //sb.append( "||'-'|| ");
        sb.append( " || ");
        sb.append( "NVL2(c.caIntelligentKeyTByAssociateCaseId.caseId, '-', '')");
        sb.append( " || ");
        sb.append(" to_char(c.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000') as associatedIntelligentKey, ");

        sb.append(" ccaLuCaseTypeT.typeCd AS associatedCaseType, ");
        sb.append(" ccaLuCaseTypeT.typeDesc AS associatedTypeDesc, ");

        sb.append(" c.associateCaseName as associatedName,  ");
        sb.append(" c.associateId as associatedParticipantId, ");
        sb.append(" c.associateName as associatedParticipantName,  ");
        sb.append(" c.associateComment as comments ");
        sb.append(" from CaAssociateT c ");
        sb.append(" left outer join c.caIntelligentKeyTByCaseId  ");
        sb.append(" left outer join c.caIntelligentKeyTByCaseId.caGeneralT  as caGeneralT");
        sb.append(" left outer join c.caIntelligentKeyTByCaseId.caLuCaseTypeT as caLuCaseTypeT");
        sb.append(" left outer join c.caIntelligentKeyTByAssociateCaseId ");
        sb.append(" left outer join c.caIntelligentKeyTByAssociateCaseId.caLuCaseTypeT as  ccaLuCaseTypeT");
    }

    /* (non-Javadoc)
	 * @see com.optum.fads.casetracking.dao.impl.CaseAssociationListDAO#findAll(java.lang.String, java.lang.String, java.lang.String, java.lang.String, int, int)
	 */
	@Override
	public List<AssociationListItem> findAll(final String caseType,
			final String searchValue, final String sortBy,
			final String sortDirection, final int firstRecord,
			final int maxRecords) {
		log.debug("finding all CaseAssociationListDAO instances");
		log.info("CaseAssociationListDAO.findAll() starts ");
		try {
			StringBuilder sb = new StringBuilder();
            getFindAllQuerySelectFrom(sb);

			sb.append(" where c.caIntelligentKeyTByCaseId.deleteFlag is null  ");
			if (caseType != null){
					sb.append(" and caLuCaseTypeT.typeCd = :caseType ");
			   }
			 if(searchValue!=null){
				sb.append(" and (lower(c.associateCaseName) like :searchValue ");
				sb.append(" or lower(c.associateId) like :searchValue ");
				sb.append(" or lower(c.associateName) like :searchValue ");
				sb.append(" or lower(caLuCaseTypeT.typeDesc) like :searchValue ");
				sb.append("or lower(c.caIntelligentKeyTByCaseId.caLuPrmNodeT.nodeCd ");
				sb.append( "||'-'|| ");
				if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
					sb.append(" c.caIntelligentKeyTByCaseId.caLuScndNodeT.nodeCd ");
					sb.append(" ||'-'|| ");
				}
				sb.append(" c.caIntelligentKeyTByCaseId.caYearId ");
				sb.append(" ||'-'|| ");
				sb.append(" to_char(c.caIntelligentKeyTByCaseId.caSequenceId,'FM00000')) like :searchValue ");

				sb.append(" or lower(caLuCaseTypeT.typeDesc) like :searchValue ");
				sb.append("or lower( c.caIntelligentKeyTByAssociateCaseId.caLuPrmNodeT.nodeCd ");
				sb.append(" ||'-'|| ");

				if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
					sb.append(" c.caIntelligentKeyTByAssociateCaseId.caLuScndNodeT.nodeCd ");
					sb.append(" ||'-'|| ");
				}

				sb.append(" c.caIntelligentKeyTByAssociateCaseId.caYearId ");
				sb.append(" ||'-'|| ");
				sb.append(" to_char(c.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000')) like :searchValue  ");

				sb.append(" or lower( caLuCaseTypeT.typeDesc) like :searchValue ");
				sb.append(" or lower( caGeneralT.caseName) like :searchValue ");
				sb.append(" or lower( caGeneralT.participantId) like :searchValue ");
				sb.append(" or lower( caGeneralT.participantName) like :searchValue )");

			}




			 if(sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_RESTRICT)){
				// sb.append(" order by  c.caIntelligentKeyTByCaseId.caGeneralT.protectStatus  ");
				 sb.append(" order by  caGeneralT.protectStatus  ");
				 sb.append("  ");
				 sb.append(sortDirection);
			 }


			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_CASE_TYPE)) {
			//	sb.append(" order by c.caIntelligentKeyTByCaseId.caLuCaseTypeT.typeDesc ) ");
				sb.append(" order by caLuCaseTypeT.typeDesc  ");

				sb.append("  ");
				sb.append(sortDirection);
				sb.append(" ) ");
			}

			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_INTELLIGENT_KEY)) {
				sb.append(" order by  ");
				sb.append(" c.caIntelligentKeyTByCaseId.caLuPrmNodeT.nodeCd ");
						sb.append(" ||'-'|| ");

				if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
					sb.append(" c.caIntelligentKeyTByCaseId.caLuScndNodeT.nodeCd ");
							sb.append(" ||'-'|| ");
				}

				sb.append(" c.caIntelligentKeyTByCaseId.caYearId ");
						sb.append(" ||'-'|| ");
				sb.append(" to_char(c.caIntelligentKeyTByCaseId.caSequenceId,'FM00000') ");
				sb.append("  ");
				sb.append(sortDirection);

			}
			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_CASE_NAME)) {
				sb.append(" order by lower( caGeneralT.caseName ) ");
				sb.append("  ");
				sb.append(sortDirection);
			}

			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_PARTICIPANT_ID)) {
				sb.append(" order by lower( caGeneralT.participantId ) ");
				sb.append("  ");
				sb.append(sortDirection);
			}
			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_PARTICIPANT_NAME)) {
				sb.append(" order by lower( caGeneralT.participantName  )");
				sb.append("  ");
				sb.append(sortDirection);
			}

			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_ASC_CASE_TYPE)) {
				sb.append(" order by lower( ccaLuCaseTypeT.typeDesc ) ");
				sb.append("  ");
				sb.append(sortDirection);
			}

			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_ASC_INTELLIGENT_KEY)) {
				sb.append(" order by  ");
				sb.append(" c.caIntelligentKeyTByAssociateCaseId.caLuPrmNodeT.nodeCd ");
						sb.append(" ||'-'|| ");

				if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
					sb.append(" c.caIntelligentKeyTByAssociateCaseId.caLuScndNodeT.nodeCd ");
							sb.append(" ||'-'|| ");
				}

				sb.append(" c.caIntelligentKeyTByAssociateCaseId.caYearId ");
						sb.append(" ||'-'|| ");
				sb.append(" to_char(c.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000')  ");
				sb.append("  ");
				sb.append(sortDirection);

			}
			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_ASC_CASE_NAME)) {
				sb.append(" order by lower(c.associateCaseName ) ");
				sb.append("  ");
				sb.append(sortDirection);
			}

			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_ASC_PARTICIPANT_ID)) {
				sb.append(" order by lower(c.associateId )");
				sb.append("  ");
				sb.append(sortDirection);
			}
			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_ASC_PARTICIPANT_NAME)) {
				sb.append(" order by lower(c.associateName ) ");
				sb.append("  ");
				sb.append(sortDirection);
			}

			final String queryString = sb.toString();
							Query query = getCurrentSession().createQuery(queryString);
							query.setResultTransformer(Transformers.aliasToBean(AssociationListItem.class));
							query.setFirstResult(firstRecord);
							query.setMaxResults(maxRecords);


							 if(searchValue!=null){
									String lsearchValue="%"+ searchValue.toLowerCase()+ "%";
									query.setParameter("searchValue", lsearchValue);
							}
							if (caseType != null){
								query.setParameter("caseType", caseType);
							}
							List<AssociationListItem> aliasToValueMapList = query.list();

							return aliasToValueMapList;


		} catch (RuntimeException re) {
			log.error("find all failed", re);
			throw re;
		}

	}

    private void getFindTotalCountQuerySelectFrom(StringBuilder sb) {
        sb.append(" select c.id.caseId  as caseId ");
        sb.append(" from CaAssociateT c ");
        sb.append(" left outer join c.caIntelligentKeyTByCaseId  as caIntelligentKeyTByCaseId");
        sb.append(" left outer join c.caIntelligentKeyTByCaseId.caGeneralT  as caGeneralT");
        sb.append(" left outer join c.caIntelligentKeyTByCaseId.caLuCaseTypeT as caLuCaseTypeT");
        sb.append(" left outer join c.caIntelligentKeyTByAssociateCaseId as caIntelligentKeyTByAssociateCaseId");
        sb.append(" left outer join c.caIntelligentKeyTByAssociateCaseId.caLuCaseTypeT  as ccaLuCaseTypeT");
    }

	/* (non-Javadoc)
	 * @see com.optum.fads.casetracking.dao.impl.CaseAssociationListDAO#findTotalAssociationsCount(java.lang.String, java.lang.String)
	 */
	@Override
	public Integer findTotalAssociationsCount(final String caseType,final String searchValue) {
	log.debug("finding all CaseAssociationListDAO instances");
	try {
		StringBuilder sb = new StringBuilder();
        getFindTotalCountQuerySelectFrom(sb);
		sb.append(" where c.caIntelligentKeyTByCaseId.deleteFlag is null  ");
		if (caseType != null){
			sb.append(" and c.caIntelligentKeyTByCaseId.caLuCaseTypeT.typeCd = :caseType ");
		}
		 if(searchValue!=null){
				sb.append(" and (lower(c.associateCaseName) like :searchValue ");
				sb.append(" or lower(c.associateId) like :searchValue ");
				sb.append(" or lower(c.associateName) like :searchValue ");
				sb.append(" or lower(caLuCaseTypeT.typeDesc) like :searchValue ");
				sb.append("or lower(caIntelligentKeyTByCaseId.caLuPrmNodeT.nodeCd ");
				sb.append( "||'-'|| ");
				if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
					sb.append(" caIntelligentKeyTByCaseId.caLuScndNodeT.nodeCd ");
					sb.append(" ||'-'|| ");
				}
				sb.append(" caIntelligentKeyTByCaseId.caYearId ");
				sb.append(" ||'-'|| ");
				sb.append(" to_char(caIntelligentKeyTByCaseId.caSequenceId,'FM00000')) like :searchValue ");

				sb.append(" or lower( ccaLuCaseTypeT.typeDesc) like :searchValue ");
				sb.append("or lower( caIntelligentKeyTByAssociateCaseId.caLuPrmNodeT.nodeCd ");
				sb.append(" ||'-'|| ");

				if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
					sb.append(" caIntelligentKeyTByAssociateCaseId.caLuScndNodeT.nodeCd ");
					sb.append(" ||'-'|| ");
				}

				sb.append(" caIntelligentKeyTByAssociateCaseId.caYearId ");
				sb.append(" ||'-'|| ");
				sb.append(" to_char(caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000')) like :searchValue  ");

				sb.append(" or lower( ccaLuCaseTypeT.typeDesc) like :searchValue ");
				sb.append(" or lower( caGeneralT.caseName) like :searchValue ");
				sb.append(" or lower( caGeneralT.participantId) like :searchValue ");
				sb.append(" or lower( caGeneralT.participantName) like :searchValue )");
		 }


		final String queryString = sb.toString();

						Query query = getCurrentSession().createQuery(queryString);
					//	query.setResultTransformer(Transformers.aliasToBean(AssociationListItem.class));

						if (searchValue != null) {
							final String lsearchValue="%"+searchValue.toLowerCase()+"%";
							query.setParameter("searchValue", lsearchValue);
						}
						if (caseType != null)
						{
							query.setParameter("caseType", caseType);
						}
						Integer listSize = query.list().size();
						return listSize;


	} catch (RuntimeException re) {
		log.error("find all failed", re);
		throw re;
	}

}

	// for new table scenarios on Detail - Associations page when using UITK 3 components
	@Override
	public int findCasesForAssociationsTotalCount(Map<String,String> filterConditions, Integer caseId, String[] nodes) {
        StringBuilder sb = new StringBuilder();
        getFindCasesForAssocTotalCountQuerySelectFrom(sb);
        sb.append(" where  c.deleteFlag is null   ");

		//log.info("---------------------CaseAssociationListDAOImpl findCasesForAssociationsTotalCount - nodes.length: " + nodes.length + "---------------------");
		if (ArrayUtils.isNotEmpty(nodes)) {
			sb.append(" and c.caLuPrmNodeT.nodeCd IN (:nodeList) ");
		}

		//sb.append(" and ( c.caseId <> ");
        //sb.append(caseId);
		sb.append(" and ( c.caseId <> :cid");
        sb.append(" )");

		getCasesForAssocQueryFilters(sb, filterConditions);

        sb.append(" ) ");
		final String queryString = sb.toString();

        int resultListSize = 0;
        try {
            Query query = getCurrentSession().createQuery(queryString);

			if (ArrayUtils.isNotEmpty(nodes)) {
				query.setParameterList("nodeList", nodes);
			}

			query.setInteger("cid", caseId);
			setCasesForAssocQueryFilters(query, filterConditions);

            final Long longVal = (Long) query.uniqueResult();
            resultListSize = longVal.intValue();

        } catch (Exception e) {
            log.error("Exception in findCasesForAssociationsTotalCount: ", e);
            throw e;
        }

		return resultListSize;
	}

    // for new table scenarios on Detail - Associations page when using UITK 3 components
    @Override
    public List<AssociationListItem> findCasesForAssociations(Map<String, String> filterConditions,
                                                              Map<String, String> sortConditions,
                                                              final int firstRecord, final int maxRecords,
                                                              Integer caseId, String[] nodes) {
        StringBuilder sb = new StringBuilder();
        getFindCasesForAssocQuerySelectFrom(sb);

        sb.append(" where c.deleteFlag is null   ");

		//log.info("---------------------CaseAssociationListDAOImpl findCasesForAssociations - nodes.length: " + nodes.length + "---------------------");
		if (ArrayUtils.isNotEmpty(nodes)) {
			sb.append(" and c.caLuPrmNodeT.nodeCd IN (:nodeList) ");
		}

		//sb.append(" and ( c.caseId <> ");
        //sb.append(caseId);
		sb.append(" and ( c.caseId <> :cid");
		sb.append(" )");

		getCasesForAssocQueryFilters(sb, filterConditions);

		getCasesForAssocQueryOrderBy(sb, sortConditions);

		final String queryString = sb.toString();
		List<AssociationListItem> resultList = new ArrayList<>();
		try {
			Query query = getCurrentSession().createQuery(queryString);

			if (ArrayUtils.isNotEmpty(nodes)) {
				query.setParameterList("nodeList", nodes);
			}

			query.setInteger("cid", caseId);
			setCasesForAssocQueryFilters(query, filterConditions);

			query.setResultTransformer(Transformers.aliasToBean(AssociationListItem.class));
			query.setFirstResult(firstRecord);
			query.setMaxResults(maxRecords);

			resultList = query.list();

		} catch (Exception e) {
			log.error("Exception in findCasesForAssociations: ", e);
			throw e;
		}

		return resultList;
	}

	private void getFindCasesForAssocQuerySelectFrom(StringBuilder sb) {
		sb.append(" SELECT c.caseId  as caseId,");
		sb.append(" c.caLuPrmNodeT.nodeCd ");
		sb.append(" ||'-'|| ");

		if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
			sb.append(" c.caLuScndNodeT.nodeCd ");
			sb.append(" ||'-'|| ");
		}

		sb.append(" c.caYearId ");
		sb.append(" ||'-'|| ");
		sb.append(" to_char(c.caSequenceId,'FM00000') as intelligentKey ,");

		sb.append(" caGeneralT.protectStatus as protectStatus, ");
		sb.append(" caLuCaseTypeT.typeCd as caseType, ");
		sb.append(" caLuCaseTypeT.typeDesc as caseTypeDesc, ");
		sb.append(" caGeneralT.caseName as caseName ,");
		sb.append(" caGeneralT.participantId as participantId, ");
		sb.append(" caGeneralT.participantName as participantName, ");
		sb.append(" assoc.caIntelligentKeyTByAssociateCaseId.caseId as associatedCaseId ,");

		//avoid to show empty -- for associatedIntelligentKey (case id) column in table
		sb.append(" assoc.caIntelligentKeyTByAssociateCaseId.caLuPrmNodeT.nodeCd ");
		//sb.append( " ||'-'|| ");
		sb.append( " || ");
		sb.append( "NVL2(assoc.caIntelligentKeyTByAssociateCaseId.caseId, '-', '')");
		sb.append( " || ");

		if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
			sb.append(" assoc.caIntelligentKeyTByAssociateCaseId.caLuScndNodeT.nodeCd ");
			//sb.append( " ||'-'|| ");
			sb.append( " || ");
			sb.append( "NVL2(assoc.caIntelligentKeyTByAssociateCaseId.caseId, '-', '')");
			sb.append( " || ");
		}

		sb.append(" assoc.caIntelligentKeyTByAssociateCaseId.caYearId ");
		//sb.append(  " ||'-'|| ");
		sb.append( " || ");
		sb.append( "NVL2(assoc.caIntelligentKeyTByAssociateCaseId.caseId, '-', '')");
		sb.append( " || ");
		sb.append(" to_char(assoc.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000') as associatedIntelligentKey, ");

		sb.append(" assocCaLuCaseTypeT.typeCd AS associatedCaseType, ");
		sb.append(" assocCaLuCaseTypeT.typeDesc AS associatedTypeDesc, ");

		sb.append(" assoc.associateCaseName as associatedName , ");
		sb.append(" assoc.associateId as associatedParticipantId , ");
		sb.append(" assoc.associateName as associatedParticipantName ");

		//	sb.append(" ,assoc.associateComment as comments ");
		sb.append(" FROM CaIntelligentKeyT c ");
		sb.append(" left outer join c.caGeneralT as caGeneralT");
		sb.append(" left outer join c.caLuCaseTypeT as caLuCaseTypeT");
		sb.append(" left outer join c.caAssociateTsForCaseId as assoc");
		sb.append(" left outer join assoc.caIntelligentKeyTByAssociateCaseId.caGeneralT as assocCaGeneralT ");
		sb.append(" left outer join assoc.caIntelligentKeyTByAssociateCaseId.caLuCaseTypeT as assocCaLuCaseTypeT ");
	}

	// for new Detail - Associations page
	private void getCasesForAssocQueryFilters(StringBuilder sb, Map<String,String> filterConditions) {
		if(filterConditions != null && !filterConditions.isEmpty()) {
			for (Map.Entry<String, String> entry : filterConditions.entrySet()) {
				for (CasesForAssociationsColumnsEnum col : CasesForAssociationsColumnsEnum.values()) {
					if (col.getColumnId().equals(entry.getKey())) {
						if ("intelligentKey".equals(entry.getKey())) {
							sb.append(" and lower(c.caLuPrmNodeT.nodeCd ").append("||'-'|| ");
							if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
								sb.append(" c.caLuScndNodeT.nodeCd ");
								sb.append(" ||'-'|| ");
							}
							sb.append(" c.caYearId ");
							sb.append(" ||'-'|| ");
							//sb.append(" to_char(c.caSequenceId,'FM00000')) like '").append(getLowerSearchString(entry.getValue())).append("' ");
							sb.append(" to_char(c.caSequenceId,'FM00000')) like :").append(entry.getKey());
						} else if ("associatedIntelligentKey".equals(entry.getKey())) {
							sb.append(" and lower(assoc.caIntelligentKeyTByAssociateCaseId.caLuPrmNodeT.nodeCd ")
									.append("||'-'|| ");
							if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
								sb.append(" assoc.caIntelligentKeyTByAssociateCaseId.caLuScndNodeT.nodeCd ");
								sb.append(" ||'-'|| ");
							}
							sb.append(" assoc.caIntelligentKeyTByAssociateCaseId.caYearId ");
							sb.append(" ||'-'|| ");
							//sb.append(" to_char(assoc.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000')) like '").append(getLowerSearchString(entry.getValue())).append("' ");
							sb.append(" to_char(assoc.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000')) like :").append(entry.getKey());
						} else {
							/*
							if (StringUtils.containsIgnoreCase(col.getColumnId(), "name")){
								sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like '")
										.append(escapeSingleQuote(getLowerSearchString(entry.getValue()))).append("' ");
							} else {
								sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like '")
										.append(getLowerSearchString(entry.getValue())).append("' ");
							}
							*/
							sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like :").append(entry.getKey());
						}
					}
				}
			}
		}
	}

	private void setCasesForAssocQueryFilters(Query query, Map<String,String> filterConditions) {
		if(filterConditions != null && !filterConditions.isEmpty()) {
			for (Map.Entry<String, String> entry : filterConditions.entrySet()) {
				for (CasesForAssociationsColumnsEnum col : CasesForAssociationsColumnsEnum.values()) {
					if (col.getColumnId().equals(entry.getKey())) {
						if ("intelligentKey".equals(entry.getKey())) {
							/*
							sb.append(" and lower(c.caLuPrmNodeT.nodeCd ").append("||'-'|| ");
							if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
								sb.append(" c.caLuScndNodeT.nodeCd ");
								sb.append(" ||'-'|| ");
							}
							sb.append(" c.caYearId ");
							sb.append(" ||'-'|| ");
							sb.append(" to_char(c.caSequenceId,'FM00000')) like '").append(getLowerSearchString(entry.getValue())).append("' ");
							*/
							query.setString(entry.getKey(), getLowerSearchString(entry.getValue()));
						} else if ("associatedIntelligentKey".equals(entry.getKey())) {
							/*
							sb.append(" and lower(assoc.caIntelligentKeyTByAssociateCaseId.caLuPrmNodeT.nodeCd ")
									.append("||'-'|| ");
							if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
								sb.append(" assoc.caIntelligentKeyTByAssociateCaseId.caLuScndNodeT.nodeCd ");
								sb.append(" ||'-'|| ");
							}
							sb.append(" assoc.caIntelligentKeyTByAssociateCaseId.caYearId ");
							sb.append(" ||'-'|| ");
							sb.append(" to_char(assoc.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000')) like '").append(getLowerSearchString(entry.getValue())).append("' ");
							*/
							query.setString(entry.getKey(), getLowerSearchString(entry.getValue()));
						} else {
							/*
							if (StringUtils.containsIgnoreCase(col.getColumnId(), "name")){
								sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like '")
										.append(escapeSingleQuote(getLowerSearchString(entry.getValue()))).append("' ");
							} else {
								sb.append(" and lower(").append(col.getColumnStringSearchOrderBy()).append(") like '")
										.append(getLowerSearchString(entry.getValue())).append("' ");
							}
							*/
							query.setString(entry.getKey(), getLowerSearchString(entry.getValue()));//escapeSingleQuote()
						}
					}
				}
			}
		}
	}

	// for new Detail - Associations page
	private void getCasesForAssocQueryOrderBy(StringBuilder sb, Map<String,String> sortConditions) {
		if (sortConditions != null && !sortConditions.isEmpty()) {
			sb.append(" order by");

			for (Map.Entry<String, String> entry : sortConditions.entrySet()) {
				for (CasesForAssociationsColumnsEnum col : CasesForAssociationsColumnsEnum.values()) {
					if (col.getColumnId().equals(entry.getKey())) {
						if (col.isColumnStringTypeForOrderBy()){
							sb.append(" lower(").append(col.getColumnStringSearchOrderBy()).append(")");
						} else {
							sb.append(" ").append(col.getColumnQueryOrder());
						}
						break;
					}
				}

				if ("-1".equals(entry.getValue())) {
					sb.append(" DESC,");    // NULLS LAST
				} else if ("1".equals(entry.getValue())) {
					sb.append(" ASC,");		// NULLS FIRST
				}

                if (! "intelligentKey".equals(entry.getKey())){
                    sb.append(" ").append(CasesForAssociationsColumnsEnum.CASE_ID.getColumnQueryOrder());
                } else {
                    sb.delete(sb.length()-1, sb.length());
                }
			}
		}
	}

	/* (non-Javadoc)
	 * @see com.optum.fads.casetracking.dao.impl.CaseAssociationListDAO#findAllCasesWithAssociations(java.lang.Integer, java.lang.String, java.lang.String, java.lang.String, java.lang.String, int, int)
	 */
	@Override
	public List<AssociationListItem>  findAllCasesWithAssociations(final Integer caseId,final String caseType,
			final String searchValue, final String sortBy,
			final String sortDirection, final int firstRecord,
			final int maxRecords) {
		log.debug("finding all CaseAssociationListDAO instances");
		try {
			StringBuilder sb = new StringBuilder();
			getFindCasesForAssocQuerySelectFrom(sb);
			sb.append(" where  c.deleteFlag is null   ");
		//	sb.append(" and ( c.caseId <> :caseId or assoc.caIntelligentKeyTByAssociateCaseId.caseId <> :caseId )");
			sb.append(" and ( c.caseId <> :caseId  )");
			if (caseType != null){
				sb.append(" and caLuCaseTypeT.typeCd = :caseType ");
			}
			 if(searchValue!=null){
					sb.append(" and ( ");
					sb.append(" lower(caLuCaseTypeT.typeDesc) like :searchValue ");
					sb.append(" or lower( c.caLuPrmNodeT.nodeCd  ");
							sb.append( "||'-'|| ");
					if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
						sb.append(" c.caLuScndNodeT.nodeCd ");
								sb.append( " ||'-'|| ");
					}
					sb.append(" c.caYearId ");
					sb.append(" ||'-'|| ");
					sb.append(" to_char(c.caSequenceId,'FM00000')) like :searchValue ");
					sb.append(" or lower(caGeneralT.caseName) like :searchValue ");
					sb.append(" or lower(caGeneralT.participantId ) like :searchValue ");
					sb.append(" or lower(caGeneralT.participantName ) like :searchValue ");

					sb.append(" or lower(assocCaLuCaseTypeT.typeDesc) like :searchValue ");
					sb.append("or lower( assoc.caIntelligentKeyTByAssociateCaseId.caLuPrmNodeT.nodeCd  ");
							sb.append( "||'-'|| ");
					if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
						sb.append(" assoc.caIntelligentKeyTByAssociateCaseId.caLuScndNodeT.nodeCd ");
								sb.append( " ||'-'|| ");
					}
					sb.append(" assoc.caIntelligentKeyTByAssociateCaseId.caYearId ");
					sb.append( "||'-'|| ");
					sb.append(" to_char( assoc.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000')) like :searchValue  ");
					sb.append(" or lower( assoc.associateCaseName) like :searchValue ");
					sb.append(" or lower( assoc.associateId) like :searchValue ");
					sb.append(" or lower( assoc.associateName) like :searchValue ");
					sb.append(" )");

			 		}

				if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_CASE_TYPE)) {
					sb.append(" order by caLuCaseTypeT.typeDesc  ");
					sb.append("  ");
					sb.append(sortDirection);
				}

				if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_INTELLIGENT_KEY)) {
					sb.append(" order by  ");
					sb.append(" c.caLuPrmNodeT.nodeCd ");
					sb.append( "||'-'|| ");

				if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
					sb.append(" c.caLuScndNodeT.nodeCd ");
					sb.append( " ||'-'|| ");
				}

					sb.append(" c.caYearId ");
					sb.append( "||'-'|| ");
					sb.append(" to_char(c.caSequenceId,'FM00000') ");
					sb.append("  ");
					sb.append(sortDirection);

			}
			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_CASE_NAME)) {
					sb.append(" order by lower( caGeneralT.caseName ) ");
					sb.append("  ");
					sb.append(sortDirection);
			}

			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_PARTICIPANT_ID)) {
					sb.append(" order by lower( caGeneralT.participantId) ");
					sb.append("  ");
					sb.append(sortDirection);
			}
			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_PARTICIPANT_NAME)) {
					sb.append(" order by lower(caGeneralT.participantName ) ");
					sb.append("  ");
					sb.append(sortDirection);
			}

			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_ASC_CASE_TYPE)) {
					sb.append(" order by  assocCaLuCaseTypeT.typeDesc  ");
					sb.append("  ");
					sb.append(sortDirection);
			}

			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_ASC_INTELLIGENT_KEY)) {
					sb.append(" order by  ");
					sb.append(" assoc.caIntelligentKeyTByAssociateCaseId.caLuPrmNodeT.nodeCd ");
					sb.append(" ||'-'|| ");

				if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
					sb.append(" assoc.caIntelligentKeyTByAssociateCaseId.caLuScndNodeT.nodeCd ");
					sb.append(" ||'-'|| ");
				}

				sb.append(" assoc.caIntelligentKeyTByAssociateCaseId.caYearId ");
				sb.append(" ||'-'|| ");
				sb.append(" to_char(assoc.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000')  ");
				sb.append("  ");
				sb.append(sortDirection);

			}
			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_ASC_CASE_NAME)) {
				sb.append(" order by lower(assoc.associateCaseName ) ");
				sb.append("  ");
				sb.append(sortDirection);
			}

			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_ASC_PARTICIPANT_ID)) {
				sb.append(" order by lower(assoc.associateId) ");
				sb.append("  ");
				sb.append(sortDirection);
			}
			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_ASC_PARTICIPANT_NAME)) {
				sb.append(" order by lower( assoc.associateName )");
				sb.append("  ");
				sb.append(sortDirection);
			}


			final String queryString = sb.toString();

							Query query =  getCurrentSession().createQuery(queryString);
							query.setResultTransformer(Transformers.aliasToBean(AssociationListItem.class));
							query.setFirstResult(firstRecord);
							query.setMaxResults(maxRecords);
							if(caseId!=null){
								query.setParameter("caseId", caseId);
							}
							if(searchValue != null) {
								String lsearchVal="%"+ searchValue.toLowerCase() + "%";
								query.setParameter("searchValue",lsearchVal );
							}
							if(caseType != null) {
								query.setParameter("caseType", caseType);
							}

							List<AssociationListItem> aliasToValueMapList = query.list();
							return aliasToValueMapList;


		} catch (RuntimeException re) {
			log.error("find all failed", re);
			throw re;
		}

	}

    private void getFindCasesForAssocTotalCountQuerySelectFrom(StringBuilder sb) {
        //sb.append(" select count(*) from CaIntelligentKeyT intKey where intKey.caseId in ( ");
        //sb.append(" SELECT c.caseId  as caseId");
		sb.append(" select count(1) ");
		sb.append(" FROM CaIntelligentKeyT c ");
        sb.append(" left outer join c.caGeneralT as caGeneralT");
        sb.append(" left outer join c.caLuCaseTypeT as caLuCaseTypeT");
        sb.append(" left outer join c.caAssociateTsForCaseId as assoc");
        sb.append(" left outer join assoc.caIntelligentKeyTByAssociateCaseId.caGeneralT as assocCaGeneralT ");
        sb.append(" left outer join assoc.caIntelligentKeyTByAssociateCaseId.caLuCaseTypeT as assocCaLuCaseTypeT ");
    }
	
    /* (non-Javadoc)
	 * @see com.optum.fads.casetracking.dao.impl.CaseAssociationListDAO#findAllTotalCasesWithAssociationsCount(java.lang.Integer, java.lang.String, java.lang.String)
	 */
	@Override
	public Integer findAllTotalCasesWithAssociationsCount(final Integer caseId,final String caseType,final String searchValue) {
		log.debug("finding all CaseAssociationListDAO instances");
		try {
			StringBuilder sb = new StringBuilder();
            getFindCasesForAssocTotalCountQuerySelectFrom(sb);
			sb.append(" where  c.deleteFlag is null   ");
		//	sb.append(" and ( c.caseId <> :caseId or assoc.caIntelligentKeyTByAssociateCaseId.caseId <> :caseId )");
			sb.append(" and ( c.caseId <> :caseId  )");
			if (caseType != null){
				sb.append(" and caLuCaseTypeT.typeCd = :caseType ");
			}
			 if(searchValue!=null){
					sb.append(" and ( ");
					sb.append(" lower(caLuCaseTypeT.typeDesc) like :searchValue ");
					sb.append(" or lower( c.caLuPrmNodeT.nodeCd  ");
							sb.append( "||'-'|| ");
					if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
						sb.append(" c.caLuScndNodeT.nodeCd ");
								sb.append( " ||'-'|| ");
					}
					sb.append(" c.caYearId ");
					sb.append(" ||'-'|| ");
					sb.append(" to_char(c.caSequenceId,'FM00000')) like :searchValue ");
					sb.append(" or lower(caGeneralT.caseName) like :searchValue ");
					sb.append(" or lower(caGeneralT.participantId ) like :searchValue ");
					sb.append(" or lower(caGeneralT.participantName ) like :searchValue ");

					sb.append(" or lower(assocCaLuCaseTypeT.typeDesc) like :searchValue ");
					sb.append("or lower( assoc.caIntelligentKeyTByAssociateCaseId.caLuPrmNodeT.nodeCd  ");
							sb.append( "||'-'|| ");
					if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
						sb.append(" assoc.caIntelligentKeyTByAssociateCaseId.caLuScndNodeT.nodeCd ");
								sb.append( " ||'-'|| ");
					}
					sb.append(" assoc.caIntelligentKeyTByAssociateCaseId.caYearId ");
					sb.append( "||'-'|| ");
					sb.append(" to_char( assoc.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000')) like :searchValue  ");
					sb.append(" or lower( assoc.associateCaseName) like :searchValue ");
					sb.append(" or lower( assoc.associateId) like :searchValue ");
					sb.append(" or lower( assoc.associateName) like :searchValue ");
					sb.append(" )");
             }
            sb.append(" ) ");

            final String queryString = sb.toString();

							Query query =  getCurrentSession().createQuery(queryString);
					//		query.setResultTransformer(Transformers.aliasToBean(AssociationListItem.class));
							if(caseId!=null){
								query.setParameter("caseId", caseId);
							}
							 if(searchValue!=null){
								 String lsearchVal="%"+ searchValue.toLowerCase() + "%";
								query.setParameter("searchValue",lsearchVal );

							}
							if (caseType != null) {
								query.setParameter("caseType", caseType);
							}
							/*Integer listSize=query.list().size();
							return listSize;
							*/
							final Long longVal=(Long) query.uniqueResult();//.size();
							final Integer intVal= longVal.intValue();
							return intVal;

		} catch (RuntimeException re) {
			log.error("find all failed", re);
			throw re;
		}

	}

	/*
	 public List<AssociationListItem> findAll(final String caseType,
			final String searchValue, final String sortBy,
			final String sortDirection, final int firstRecord,
			final int maxRecords) {
		log.debug("finding all CaseAssociationListDAO instances");
		log.info("CaseAssociationListDAO.findAll() starts ");
		try {
			StringBuilder sb = new StringBuilder();
			sb.append(" select c.id.caseId  as caseId,");
			sb.append(" c.caIntelligentKeyTByCaseId.caLuPrmNodeT.nodeCd ");
			sb.append( "||'-'|| ");

			if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
				sb.append(" c.caIntelligentKeyTByCaseId.caLuScndNodeT.nodeCd ");
				sb.append(" ||'-'|| ");
			}

			sb.append(" c.caIntelligentKeyTByCaseId.caYearId ");
			sb.append(" ||'-'|| ");
			sb.append(" to_char(c.caIntelligentKeyTByCaseId.caSequenceId,'FM00000') as intelligentKey ,");

			sb.append(" c.caIntelligentKeyTByCaseId.caGeneralT.protectStatus as protectStatus, ");
			sb.append(" c.caIntelligentKeyTByCaseId.caGeneralT.caseName as caseName, ");

			sb.append(" c.caIntelligentKeyTByCaseId.caLuCaseTypeT.typeCd as caseType, ");
			sb.append(" c.caIntelligentKeyTByCaseId.caLuCaseTypeT.typeDesc as caseTypeDesc, ");

			sb.append(" c.caIntelligentKeyTByCaseId.caGeneralT.participantId as participantId, ");
			sb.append(" c.caIntelligentKeyTByCaseId.caGeneralT.participantName as participantName, ");

			sb.append(" c.caIntelligentKeyTByAssociateCaseId.caseId as associatedCaseId, ");
			sb.append(" c.caIntelligentKeyTByAssociateCaseId.caLuPrmNodeT.nodeCd ");
			sb.append( "||'-'|| ");

			if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
				sb.append(" c.caIntelligentKeyTByAssociateCaseId.caLuScndNodeT.nodeCd ");
						sb.append(" ||'-'|| ");
			}

			sb.append(" c.caIntelligentKeyTByAssociateCaseId.caYearId ");
			sb.append( "||'-'|| ");
			sb.append(" to_char(c.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000') as associatedIntelligentKey, ");

			sb.append(" c.caIntelligentKeyTByAssociateCaseId.caLuCaseTypeT.typeCd AS associatedCaseType, ");
			sb.append(" c.caIntelligentKeyTByAssociateCaseId.caLuCaseTypeT.typeDesc AS associatedTypeDesc, ");

			sb.append(" c.associateCaseName as associatedName,  ");
			sb.append(" c.associateId as associatedParticipantId, ");
			sb.append(" c.associateName as associatedParticipantName,  ");
			sb.append(" c.associateComment as comments ");
			sb.append(" from CaAssociateT c ");
			sb.append(" left outer join c.caIntelligentKeyTByCaseId  as caIntelligentKeyTByCaseId");
			sb.append(" left outer join c.caIntelligentKeyTByCaseId.caGeneralT  as caGeneralT");
			sb.append(" left outer join c.caIntelligentKeyTByCaseId.caLuCaseTypeT as caLuCaseTypeT");
			sb.append(" left outer join c.caIntelligentKeyTByAssociateCaseId as caIntelligentKeyTByAssociateCaseId");
			sb.append(" left outer join c.caIntelligentKeyTByAssociateCaseId.caLuCaseTypeT  as cccaLuCaseTypeT");
			sb.append(" where c.caIntelligentKeyTByCaseId.deleteFlag is null  ");
			if (caseType != null){
					sb.append(" and c.caIntelligentKeyTByCaseId.caLuCaseTypeT.typeCd = :caseType ");
			}
			 if(searchValue!=null){
				sb.append(" and (lower(c.associateCaseName) like :searchValue ");
				sb.append(" or lower(c.associateId) like :searchValue ");
				sb.append(" or lower(c.associateName) like :searchValue ");
				sb.append(" or lower(c.caIntelligentKeyTByCaseId.caLuCaseTypeT.typeDesc) like :searchValue ");
				sb.append("or lower(c.caIntelligentKeyTByCaseId.caLuPrmNodeT.nodeCd ");
				sb.append( "||'-'|| ");
				if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
					sb.append(" c.caIntelligentKeyTByCaseId.caLuScndNodeT.nodeCd ");
					sb.append(" ||'-'|| ");
				}
				sb.append(" c.caIntelligentKeyTByCaseId.caYearId ");
				sb.append(" ||'-'|| ");
				sb.append(" to_char(c.caIntelligentKeyTByCaseId.caSequenceId,'FM00000')) like :searchValue ");

				sb.append(" or lower( c.caIntelligentKeyTByAssociateCaseId.caLuCaseTypeT.typeDesc) like :searchValue ");
				sb.append("or lower( c.caIntelligentKeyTByAssociateCaseId.caLuPrmNodeT.nodeCd ");
				sb.append(" ||'-'|| ");

				if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
					sb.append(" c.caIntelligentKeyTByAssociateCaseId.caLuScndNodeT.nodeCd ");
					sb.append(" ||'-'|| ");
				}

				sb.append(" c.caIntelligentKeyTByAssociateCaseId.caYearId ");
				sb.append(" ||'-'|| ");
				sb.append(" to_char(c.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000')) like :searchValue  ");

				sb.append(" or lower( c.caIntelligentKeyTByAssociateCaseId.caLuCaseTypeT.typeDesc) like :searchValue ");
				sb.append(" or lower(  c.caIntelligentKeyTByCaseId.caGeneralT.caseName) like :searchValue ");
				sb.append(" or lower( c.caIntelligentKeyTByCaseId.caGeneralT.participantId) like :searchValue ");
				sb.append(" or lower( c.caIntelligentKeyTByCaseId.caGeneralT.participantName) like :searchValue )");

			}




			 if(sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_RESTRICT)){
				 sb.append(" order by  c.caIntelligentKeyTByCaseId.caGeneralT.protectStatus  ");
				 sb.append("  ");
				 sb.append(sortDirection);
			 }


			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_CASE_TYPE)) {
				sb.append(" order by c.caIntelligentKeyTByCaseId.caLuCaseTypeT.typeDesc ) ");
				sb.append("  ");
				sb.append(sortDirection);
			}

			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_INTELLIGENT_KEY)) {
				sb.append(" order by  ");
				sb.append(" c.caIntelligentKeyTByCaseId.caLuPrmNodeT.nodeCd ");
						sb.append(" ||'-'|| ");

				if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
					sb.append(" c.caIntelligentKeyTByCaseId.caLuScndNodeT.nodeCd ");
							sb.append(" ||'-'|| ");
				}

				sb.append(" c.caIntelligentKeyTByCaseId.caYearId ");
						sb.append(" ||'-'|| ");
				sb.append(" to_char(c.caIntelligentKeyTByCaseId.caSequenceId,'FM00000') ");
				sb.append("  ");
				sb.append(sortDirection);

			}
			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_CASE_NAME)) {
				sb.append(" order by lower( c.caIntelligentKeyTByCaseId.caGeneralT.caseName ) ");
				sb.append("  ");
				sb.append(sortDirection);
			}

			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_PARTICIPANT_ID)) {
				sb.append(" order by lower( c.caIntelligentKeyTByCaseId.caGeneralT.participantId ) ");
				sb.append("  ");
				sb.append(sortDirection);
			}
			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_PARTICIPANT_NAME)) {
				sb.append(" order by lower( c.caIntelligentKeyTByCaseId.caGeneralT.participantName  )");
				sb.append("  ");
				sb.append(sortDirection);
			}

			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_ASC_CASE_TYPE)) {
				sb.append(" order by lower( c.caIntelligentKeyTByAssociateCaseId.caLuCaseTypeT.typeDesc ) ");
				sb.append("  ");
				sb.append(sortDirection);
			}

			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_ASC_INTELLIGENT_KEY)) {
				sb.append(" order by  ");
				sb.append(" c.caIntelligentKeyTByAssociateCaseId.caLuPrmNodeT.nodeCd ");
						sb.append(" ||'-'|| ");

				if (CaseGlobalConstants.SCND_NODE_VISIBLE.equalsIgnoreCase("Y")) {
					sb.append(" c.caIntelligentKeyTByAssociateCaseId.caLuScndNodeT.nodeCd ");
							sb.append(" ||'-'|| ");
				}

				sb.append(" c.caIntelligentKeyTByAssociateCaseId.caYearId ");
						sb.append(" ||'-'|| ");
				sb.append(" to_char(c.caIntelligentKeyTByAssociateCaseId.caSequenceId,'FM00000')  ");
				sb.append("  ");
				sb.append(sortDirection);

			}
			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_ASC_CASE_NAME)) {
				sb.append(" order by lower(c.associateCaseName ) ");
				sb.append("  ");
				sb.append(sortDirection);
			}

			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_ASC_PARTICIPANT_ID)) {
				sb.append(" order by lower(c.associateId )");
				sb.append("  ");
				sb.append(sortDirection);
			}
			if (sortBy.equalsIgnoreCase(CaseConstants.SORT_BY_ASC_PARTICIPANT_NAME)) {
				sb.append(" order by lower(c.associateName ) ");
				sb.append("  ");
				sb.append(sortDirection);
			}

			final String queryString = sb.toString();
							Query query = getCurrentSession().createQuery(queryString);
							query.setResultTransformer(Transformers.aliasToBean(AssociationListItem.class));
							query.setFirstResult(firstRecord);
							query.setMaxResults(maxRecords);


							 if(searchValue!=null){
									String lsearchValue="%"+ searchValue.toLowerCase()+ "%";
									query.setParameter("searchValue", lsearchValue);
							}
							if (caseType != null){
								query.setParameter("caseType", caseType);
							}
							List<AssociationListItem> aliasToValueMapList = query.list();

							return aliasToValueMapList;


		} catch (RuntimeException re) {
			log.error("find all failed", re);
			throw re;
		}

	}
	 */
}
