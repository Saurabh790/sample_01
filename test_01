package com.optum.fads.pgp.jobs.api.service.impl;

import com.optum.fads.pgp.jobs.api.common.FadsConfigProperties;
import com.optum.fads.pgp.jobs.api.common.JobsConstants;
import com.optum.fads.pgp.jobs.api.common.ListTableParams;
import com.optum.fads.pgp.jobs.api.domain.FadsConfigT;
import com.optum.fads.pgp.jobs.api.dto.JobDTO;
import com.optum.fads.pgp.jobs.api.dto.PaginationResult;
import com.optum.fads.pgp.jobs.api.exception.JobsMonitorApiException;
import com.optum.fads.pgp.jobs.api.mapper.JobDetailMapper;
import com.optum.fads.pgp.jobs.api.repo.FadsConfigRepository;
import com.optum.fads.pgp.jobs.api.snowflakeDomain.JobLuStatusT;
import com.optum.fads.pgp.jobs.api.snowflakeDomain.JobMasterLogsT;
import com.optum.fads.pgp.jobs.api.snowflakeDomain.JobMasterT;
import com.optum.fads.pgp.jobs.api.snowflakeRepo.JobMasterSchedulerRepository;
import com.optum.fads.pgp.jobs.api.snowflakeRepo.JobsRepository;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.Pageable;

import java.time.LocalDateTime;
import java.util.*;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class JobMonitorDataServiceTest {

    @Mock private FadsConfigRepository fadsConfigRepository;
    @Mock private JobsRepository jobsRepository;
    @Mock private JobMasterSchedulerRepository jobMasterSchedulerRepository;
    @Mock private JobDetailMapper jobDetailMapper;

    @InjectMocks
    private JobMonitorDataService service;

    @Test
    void getJobDetailsById_whenJobExists_withEmptyLogs_returnsJobDTO_withoutNotes() {
        Integer jobId = 10;

        JobMasterT jobMasterT = new JobMasterT();
        // IMPORTANT: must be NON-NULL, else code NPEs
        jobMasterT.setJobMasterLogsTs(Collections.emptyList());

        when(jobsRepository.findById(jobId)).thenReturn(Optional.of(jobMasterT));

        JobDTO dto = new JobDTO();
        dto.setJobId(jobId);
        when(jobDetailMapper.convertToJob(any(JobMasterT.class))).thenReturn(dto);

        JobDTO result = service.getJobDetailsById(jobId);

        assertNotNull(result);
        assertEquals(jobId, result.getJobId());
        // notes should remain null/empty since logs empty
        // (depends on your JobDTO default; allow either)
        if (result.getNotes() != null) {
            assertTrue(result.getNotes().isEmpty());
        }

        verify(jobsRepository).findById(jobId);
        verify(jobDetailMapper).convertToJob(jobMasterT);
        verifyNoMoreInteractions(jobMasterSchedulerRepository);
    }

    @Test
    void getJobDetailsById_whenJobExists_withLogs_populatesNotes() {
        Integer jobId = 11;

        JobMasterLogsT log1 = new JobMasterLogsT();
        log1.setLogFileNotes("note-1");
        JobMasterLogsT log2 = new JobMasterLogsT();
        log2.setLogFileNotes("note-2");

        JobMasterT jobMasterT = new JobMasterT();
        jobMasterT.setJobMasterLogsTs(Arrays.asList(log1, log2));

        when(jobsRepository.findById(jobId)).thenReturn(Optional.of(jobMasterT));

        JobDTO dto = new JobDTO();
        dto.setJobId(jobId);
        when(jobDetailMapper.convertToJob(any(JobMasterT.class))).thenReturn(dto);

        JobDTO result = service.getJobDetailsById(jobId);

        assertNotNull(result);
        assertEquals(jobId, result.getJobId());
        assertNotNull(result.getNotes());
        assertEquals(2, result.getNotes().size());
        assertEquals("note-1", result.getNotes().get(0));
        assertEquals("note-2", result.getNotes().get(1));
    }

    @Test
    void getJobDetailsById_whenJobMissing_throwsJobsMonitorApiException() {
        Integer jobId = 999;
        when(jobsRepository.findById(jobId)).thenReturn(Optional.empty());

        JobsMonitorApiException ex = assertThrows(JobsMonitorApiException.class,
                () -> service.getJobDetailsById(jobId));

        // message depends on your exception constructor, so just ensure it throws
        assertNotNull(ex);
        verify(jobsRepository).findById(jobId);
    }

    @Test
    void getJobsByListTableParms_whenNoSearchBy_usesFindAll_andMapsDTOs() {
        ListTableParams params = new ListTableParams();
        params.setPageNumber(1);
        params.setRecordsPerPage(10);
        params.setSortBy(JobsConstants.JOB_ID);
        params.setSortOrder(-1);
        params.setSearchBy(null); // this is the branch we want

        JobMasterT jm = new JobMasterT();
        List<JobMasterT> content = Collections.singletonList(jm);

        Page<JobMasterT> page = new PageImpl<>(content);
        when(jobsRepository.findAll(any(Pageable.class))).thenReturn(page);

        List<JobDTO> mapped = Collections.singletonList(new JobDTO());
        when(jobDetailMapper.convertToJobDTOs(content)).thenReturn(mapped);

        PaginationResult out = service.getJobsByListTableParms(params);

        assertNotNull(out);
        assertNotNull(out.getJobsData());
        assertEquals(1, out.getJobsData().size());
        assertEquals(1, out.getTotalRecordsCount());

        verify(jobsRepository).findAll(any(Pageable.class));
        verify(jobDetailMapper).convertToJobDTOs(content);
    }

    @Test
    void changeScheduleDateById_updatesRepository_andReturnsSaved() {
        JobDTO jobDTO = new JobDTO();
        jobDTO.setJobId(101);
        jobDTO.setStatus(1);
        jobDTO.setUpdatedBySystemId("u1");
        jobDTO.setScheduledRunDate(LocalDateTime.now());

        when(jobsRepository.updateScheduledRunDate(
                eq(101),
                any(LocalDateTime.class),
                eq("u1"),
                any(LocalDateTime.class)
        )).thenReturn(1);

        String status = service.changeScheduleDateById(jobDTO);

        assertEquals(JobsConstants.RUN_DATE_SAVED, status);
        verify(jobsRepository).updateScheduledRunDate(eq(101), any(LocalDateTime.class), eq("u1"), any(LocalDateTime.class));
    }

    @Test
    void changePurgeDateById_whenUpdateSuccess_returnsSaved() {
        JobDTO jobDTO = new JobDTO();
        jobDTO.setJobId(201);
        jobDTO.setUpdatedBySystemId("u2");
        jobDTO.setStatus(20);
        jobDTO.setPurgeDate("12-31-2025"); // whatever your repo expects

        when(jobsRepository.updatePurgeDate(eq(201), eq("12-31-2025"), eq("u2"), any(Date.class)))
                .thenReturn(1);

        String status = service.changePurgeDateById(jobDTO);

        assertEquals(JobsConstants.PURGE_DATE_SAVED, status);
        verify(jobsRepository).updatePurgeDate(eq(201), eq("12-31-2025"), eq("u2"), any(Date.class));
    }

    @Test
    void getReportUrlByOptionCd_whenConfigPresent_returnsDescription() {
        // service ignores input optionCd and reads JobsConstants.COGNOS_REPORT_OPTION_CODE
        FadsConfigT cfg = new FadsConfigT();
        cfg.setDescription("http://cognos/report");

        when(fadsConfigRepository.findById(JobsConstants.COGNOS_REPORT_OPTION_CODE))
                .thenReturn(Optional.of(cfg));

        String url = service.getReportUrlByOptionCd(300);

        assertEquals("http://cognos/report", url);
        verify(fadsConfigRepository).findById(JobsConstants.COGNOS_REPORT_OPTION_CODE);
    }

    @Test
    void getFadsConfigByIds_mapsToProperties() {
        FadsConfigT c1 = new FadsConfigT();
        c1.setOptionCode(1L);
        c1.setDescription("d1");
        c1.setOptionValue("v1");

        FadsConfigT c2 = new FadsConfigT();
        c2.setOptionCode(2L);
        c2.setDescription("d2");
        c2.setOptionValue("v2");

        when(fadsConfigRepository.findAllById(Arrays.asList(1L, 2L)))
                .thenReturn(Arrays.asList(c1, c2));

        List<FadsConfigProperties> out = service.getFadsConfigByIds(Arrays.asList(1L, 2L));

        assertEquals(2, out.size());
        assertEquals(1L, out.get(0).getCode());
        assertEquals("d1", out.get(0).getDesc());
        assertEquals("v1", out.get(0).getValue());
    }
}
