package com.optum.fads.caseentry.api.config;

import java.util.HashMap;
import java.util.Map;

import javax.sql.DataSource;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import org.springframework.data.jpa.repository.config.EnableJpaRepositories;

import org.springframework.jdbc.datasource.DriverManagerDataSource;

import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;

import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.annotation.EnableTransactionManagement;

import com.azure.security.keyvault.secrets.SecretClient;

import jakarta.persistence.EntityManagerFactory;

@Configuration
@EnableAutoConfiguration(exclude = { DataSourceAutoConfiguration.class })
@EnableTransactionManagement
@EnableJpaRepositories(
        entityManagerFactoryRef = "sqlEntityManagerFactory",
        transactionManagerRef = "txManagerSQL",
        basePackages = "com.optum.fads.caseentry.api.repo"
)
public class ServiceConfigSQL {

    private static final Logger logger =
            LoggerFactory.getLogger(ServiceConfigSQL.class);

    // Secret names stored in Key Vault
    @Value("${spring.datasource.sql.userName}")
    private String userNameSecretName;

    @Value("${spring.datasource.sql.password}")
    private String passwordSecretName;

    // Normal properties
    @Value("${spring.datasource.sql.jdbcUrl}")
    private String jdbcUrl;

    @Value("${spring.datasource.sql.driverClassName}")
    private String driverClassName;

    private final SecretClient secretClient;

    public ServiceConfigSQL(SecretClient secretClient) {
        this.secretClient = secretClient;
    }

    /**
     * DataSource using Azure Key Vault secrets
     */
    @Bean(name = "fadsSQLDataSource")
    public DataSource fadsSQLDataSource() {

        logger.info("Initializing SQL DataSource using Azure Key Vault...");

        String username =
                secretClient.getSecret(userNameSecretName).getValue();

        String password =
                secretClient.getSecret(passwordSecretName).getValue();

        DriverManagerDataSource dataSource =
                new DriverManagerDataSource();

        dataSource.setDriverClassName(driverClassName);
        dataSource.setUrl(jdbcUrl);
        dataSource.setUsername(username);
        dataSource.setPassword(password);

        logger.info("SQL DataSource initialized successfully");

        return dataSource;
    }

    /**
     * EntityManagerFactory
     */
    @Bean(name = "sqlEntityManagerFactory")
    public LocalContainerEntityManagerFactoryBean sqlEntityManagerFactory(
            @Qualifier("fadsSQLDataSource") DataSource dataSource) {

        LocalContainerEntityManagerFactoryBean em =
                new LocalContainerEntityManagerFactoryBean();

        em.setDataSource(dataSource);

        em.setPackagesToScan(
                "com.optum.fads.caseentry.api.domain");

        HibernateJpaVendorAdapter vendorAdapter =
                new HibernateJpaVendorAdapter();

        em.setJpaVendorAdapter(vendorAdapter);

        Map<String, Object> properties = new HashMap<>();

        properties.put(
                "hibernate.dialect",
                "org.hibernate.dialect.SQLServer2016Dialect");

        properties.put("hibernate.show_sql", true);
        properties.put("hibernate.format_sql", true);
        properties.put("hibernate.globally_quoted_identifiers", true);
        properties.put("hibernate.allow_update_outside_transaction", true);

        em.setJpaPropertyMap(properties);

        return em;
    }

    /**
     * Transaction Manager
     */
    @Bean(name = "txManagerSQL")
    public PlatformTransactionManager txManagerSQL(
            @Qualifier("sqlEntityManagerFactory")
            EntityManagerFactory emf) {

        JpaTransactionManager txManager =
                new JpaTransactionManager();

        txManager.setEntityManagerFactory(emf);

        return txManager;
    }

}
