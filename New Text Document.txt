/*
//***********************************************
// Copyright UNITEDHEALTH GROUP CORPORATION 2018.
// This software and documentation contain confidential and
// proprietary information owned by UnitedHealth Group Corporation.
// Unauthorized use and distribution are prohibited.
//***********************************************
*/
/** 
 *  The service contains methods to retrieve and update FADS Report Item data.
 * 
 * @author Anil Wagh
 */
package com.optum.fads.pgp.reportsection.api.service.impl;

import java.text.SimpleDateFormat;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Locale;
import java.util.Optional;

import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;

import com.optum.fads.pgp.reportsection.api.common.ListTableParams;
import com.optum.fads.pgp.reportsection.api.common.constants.ReportSectionConstants;
import com.optum.fads.pgp.reportsection.api.domain.FadsConfigT;
import com.optum.fads.pgp.reportsection.api.domain.PrmBpBehaviorPatsT;
import com.optum.fads.pgp.reportsection.api.domain.PrmBpRiFormulaT;
import com.optum.fads.pgp.reportsection.api.domain.PrmBpRiFormulaTPK;
import com.optum.fads.pgp.reportsection.api.domain.PrmDrDataRuleT;
import com.optum.fads.pgp.reportsection.api.domain.PrmDrRangesT;
import com.optum.fads.pgp.reportsection.api.domain.PrmDrSingleValuesT;
import com.optum.fads.pgp.reportsection.api.domain.PrmErDrT;
import com.optum.fads.pgp.reportsection.api.domain.PrmRiRptItemT;
import com.optum.fads.pgp.reportsection.api.domain.PrmRsRiT;
import com.optum.fads.pgp.reportsection.api.domain.PrmRsRptSecT;
import com.optum.fads.pgp.reportsection.api.domain.UiUserBase;
import com.optum.fads.pgp.reportsection.api.dto.BehaviorPatternDTO;
import com.optum.fads.pgp.reportsection.api.dto.DataRuleDTO;
import com.optum.fads.pgp.reportsection.api.dto.DrCodeValueDTO;
import com.optum.fads.pgp.reportsection.api.dto.DrRangeValuesDTO;
import com.optum.fads.pgp.reportsection.api.dto.PaginationResultRI;
import com.optum.fads.pgp.reportsection.api.dto.ReportItemDTO;
import com.optum.fads.pgp.reportsection.api.exception.ReportSectionApiException;
import com.optum.fads.pgp.reportsection.api.mapper.ReportGroupDetailMapper;
import com.optum.fads.pgp.reportsection.api.repo.BehaviorPatternErDrRepository;
import com.optum.fads.pgp.reportsection.api.repo.BehaviorPatternsRepository;
import com.optum.fads.pgp.reportsection.api.repo.DataRulesRepository;
import com.optum.fads.pgp.reportsection.api.repo.FadsConfigRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportItemFormulasRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportItemsRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportSectionItemsRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportSectionsRepository;
import com.optum.fads.pgp.reportsection.api.service.IReportItemDataService;

@Service("reportItemDataService")
//@Slf4j
public class ReportItemDataService implements IReportItemDataService {

	private static final Logger logit = LoggerFactory.getLogger(ReportItemDataService.class);

//	@Autowired
	private ReportItemsRepository reportItemsRepository;
//	@Autowired
	private ReportItemFormulasRepository reportItemFormulasRepository;
//	@Autowired
	private ReportSectionItemsRepository reportSectionItemsRepository;
//	@Autowired
	private BehaviorPatternsRepository behaviorPatternsRepository;
//	@Autowired
	private BehaviorPatternErDrRepository behaviorPatternErDrRepository;
//	@Autowired
	private DataRulesRepository dataRulesRepository;
//	@Autowired
	private ReportSectionsRepository reportSectionsRepository;
	@Autowired
	private FadsConfigRepository fadsConfigRepository;
	@Autowired
	private ReportGroupDetailMapper reportGroupDetailMapper;
	  @Autowired
	    public ReportItemDataService(ReportItemsRepository reportItemsRepository,
	    		ReportItemFormulasRepository reportItemFormulasRepository,
	    		ReportSectionItemsRepository reportSectionItemsRepository,
	    		BehaviorPatternsRepository behaviorPatternsRepository,
	    		BehaviorPatternErDrRepository behaviorPatternErDrRepository,
	    		DataRulesRepository dataRulesRepository,
	    		ReportSectionsRepository reportSectionsRepository) {
	        this.reportItemsRepository = reportItemsRepository;
	        this.reportItemFormulasRepository = reportItemFormulasRepository;
	        this.reportSectionItemsRepository = reportSectionItemsRepository;
	        this.behaviorPatternsRepository = behaviorPatternsRepository;
	        this.behaviorPatternErDrRepository = behaviorPatternErDrRepository;
	        this.dataRulesRepository = dataRulesRepository;
	        this.reportSectionsRepository = reportSectionsRepository;
	    }

	/**
	 * this method will give all the Report Item records data or records per page
	 * 
	 * Parameters - ListTableParams (contains sort, filter conditions; page number,
	 * page size)
	 */
	public PaginationResultRI getReportItemsList(ListTableParams listTableParams) {
		int reportItemsCount = 0;
		List<ReportItemDTO> reportItemDataList = null;
		List<PrmRiRptItemT> reportItemList;
		List<PrmRiRptItemT> reportItemsCntList = null;
		PaginationResultRI paginationResult;
		Pageable pageable = null;
		if (listTableParams.getSelectedItemIds() == null) {
			listTableParams.setSelectedItemIds(new ArrayList<>());
		}
		try {
			if (listTableParams.getSearchBy() == null) {
				pageable = createPageableReports(listTableParams);
				if (!(listTableParams.getSelectedItemIds().isEmpty())) {
					reportItemList = reportItemsRepository.getAvailableReportItems(listTableParams.getSelectedItemIds(),
							pageable);
					reportItemsCntList = reportItemsRepository
							.getAvailableReportItems(listTableParams.getSelectedItemIds(), null);
					reportItemsCount = reportItemsCntList.size();
				} else {
					reportItemList = reportItemsRepository.getReportItems(pageable);
					reportItemsCount = (int) reportItemsRepository.count();
				}
				paginationResult = new PaginationResultRI();
				reportItemDataList = populateReportItemList(reportItemList);
				paginationResult.setReportItemsData(reportItemDataList);
				paginationResult.setTotalRecordsCount(reportItemsCount);
			} else {
				paginationResult = getReportItemsOnSearchCriteria(listTableParams);
			}
		} catch (Exception e) {
			throw new ReportSectionApiException(e);
		}
		return paginationResult;
	}

	/**
	 * this method is called by getReportItemsList to apply filter and sort criteria
	 * and fetch the report item records data
	 * 
	 * Parameters - ListTableParams (contains sort, filter conditions; page number,
	 * page size)
	 */
	public PaginationResultRI getReportItemsOnSearchCriteria(ListTableParams listTableParams) {
		
		Pageable pageable = null;
		int reportItemsCount = 0;
		int myItemsIndex = -1;
		List<ReportItemDTO> reportItemDataList = null;
		List<PrmRiRptItemT> reportItemsList = null;
		List<PrmRiRptItemT> reportItemsCntList = null;
		PaginationResultRI paginationResult = new PaginationResultRI();
		pageable = createPageableReports(listTableParams);
		if (listTableParams.getSearchBy().contains(ReportSectionConstants.USER_SYSTEM_ID)) {
			myItemsIndex = listTableParams.getSearchBy().indexOf(ReportSectionConstants.USER_SYSTEM_ID);
		}
		String[] searchCriteriaItems = getSearchCriteria(listTableParams, myItemsIndex); // reportItemNameVal, createdByVal,
																			// updatedByVal, sp ch in Name

		if (listTableParams.getSelectedItemIds().isEmpty()) {
			if (searchCriteriaItems[3].equals(ReportSectionConstants.SEARCH_SP_CH_IN_NM_STR)) {// set RI/RS name contain % or underscore
				if (myItemsIndex >= 0) {		// Retrieve my items
					reportItemsList = reportItemsRepository.getMyReportItemsBySearchCritEsc(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], searchCriteriaItems[4], pageable);
					reportItemsCntList = reportItemsRepository.getMyReportItemsBySearchCritEsc(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], searchCriteriaItems[4], null);
				} else {
					reportItemsList = reportItemsRepository.getReportItemsBySearchCritEsc(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], pageable);
					reportItemsCntList = reportItemsRepository.getReportItemsBySearchCritEsc(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], null);
				}
			} else {
				if (myItemsIndex >= 0) {		// Retrieve my items
					reportItemsList = reportItemsRepository.getMyReportItemsBySearchCrit(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], searchCriteriaItems[4], pageable);
					reportItemsCntList = reportItemsRepository.getMyReportItemsBySearchCrit(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], searchCriteriaItems[4], null);
				} else {
					reportItemsList = reportItemsRepository.getReportItemsBySearchCrit(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], pageable);
					reportItemsCntList = reportItemsRepository.getReportItemsBySearchCrit(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], null);
				}
			}
		} else {
			if (searchCriteriaItems[3].equals(ReportSectionConstants.SEARCH_SP_CH_IN_NM_STR)) {// set if Report Item name or Report
																					// Section name contain % or
																					// underscore
				if (myItemsIndex >= 0) {		// Retrieve my items
					reportItemsList = reportItemsRepository.getMyAvailableReportItemsBySearchCritEsc(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], searchCriteriaItems[4],  
							listTableParams.getSelectedItemIds(), pageable);
					reportItemsCntList = reportItemsRepository.getMyAvailableReportItemsBySearchCritEsc(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], searchCriteriaItems[4], 
							listTableParams.getSelectedItemIds(), null);
				} else {
					reportItemsList = reportItemsRepository.getAvailableReportItemsBySearchCritEsc(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], listTableParams.getSelectedItemIds(), pageable);
					reportItemsCntList = reportItemsRepository.getAvailableReportItemsBySearchCritEsc(
							searchCriteriaItems[0], searchCriteriaItems[1], searchCriteriaItems[2],
							listTableParams.getSelectedItemIds(), null);
				}
			} else {
				if (myItemsIndex >= 0) {		// Retrieve my items
					reportItemsList = reportItemsRepository.getMyAvailableReportItemsBySearchCrit(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], searchCriteriaItems[4], 
							listTableParams.getSelectedItemIds(), pageable);
					reportItemsCntList = reportItemsRepository.getMyAvailableReportItemsBySearchCrit(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], searchCriteriaItems[4],
							listTableParams.getSelectedItemIds(), null);
				} else {			
					reportItemsList = reportItemsRepository.getAvailableReportItemsBySearchCrit(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], listTableParams.getSelectedItemIds(), pageable);
					reportItemsCntList = reportItemsRepository.getAvailableReportItemsBySearchCrit(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], listTableParams.getSelectedItemIds(), null);
				}
			}
		}
		reportItemsCount = reportItemsCntList.size();
		logit.info("Total Report Item records retrieved = {}", reportItemsCount);
		if (!reportItemsList.isEmpty()) {
			reportItemDataList = populateReportItemList(reportItemsList);
			paginationResult.setReportItemsData(reportItemDataList);
		} else {
			paginationResult.setReportItemsData(new ArrayList<>());
			reportItemsCount = 0;
		}
		paginationResult.setTotalRecordsCount(reportItemsCount);
		return paginationResult;
	}

	/**
	 * this method is called by getReportItemsOnSearchCriteria. Returns search
	 * criteria in an array
	 * 
	 * Parameters - ListTableParams (contains sort, filter conditions; page number,
	 * page size)
	 */
	protected String[] getSearchCriteria(ListTableParams listTableParams, int myItemsIndex) {
		String[] searchCriteriaItems = {ReportSectionConstants.PERCENT_STR, // [0][ RI/RS Name
										ReportSectionConstants.PERCENT_STR, // [1] Created by
										ReportSectionConstants.PERCENT_STR, // [2] Modified by
										ReportSectionConstants.ZERO_STR ,	// [3] if Name contains sp ch
										ReportSectionConstants.NULL_STR };	// [4] User System Id
		String searchInput;
		String searchBy;
		int searchCritSize = listTableParams.getSearchBy().size();
		
		for (int index = 0; index < searchCritSize; index++) {
			searchInput = listTableParams.getSearchInput().get(index).toLowerCase();
			searchBy = listTableParams.getSearchBy().get(index);
			switch (searchBy) {
			case ReportSectionConstants.REPORT_ITEM_NAME:
			case ReportSectionConstants.REPORT_SECTION_NAME:
				if (StringUtils.containsAny(searchInput, ReportSectionConstants.PERCENT_CHAR)
						|| StringUtils.containsAny(searchInput, ReportSectionConstants.UNDERSCORE_CHAR)) {
					searchCriteriaItems[3] = ReportSectionConstants.SEARCH_SP_CH_IN_NM_STR;
				}
				searchCriteriaItems[0] = replReportItemName(searchInput); /// reportItemNameVal
				break;
			case ReportSectionConstants.CREATED_BY:
				if (StringUtils.containsWhitespace(searchInput)){
					searchInput = searchInput.trim();
			    	searchInput = searchInput.replaceAll("\\s+", " ");
		        }
				searchCriteriaItems[1] = ReportSectionConstants.PERCENT_STR + searchInput + ReportSectionConstants.PERCENT_STR; // createdByVal
				break;
			case ReportSectionConstants.MODIFIED_BY:
				if (StringUtils.containsWhitespace(searchInput)){
					searchInput = searchInput.trim();
			    	searchInput = searchInput.replaceAll("\\s+", " ");
		        }
				searchCriteriaItems[2] = ReportSectionConstants.PERCENT_STR + searchInput + ReportSectionConstants.PERCENT_STR; // updatedByVal
				break;
			case ReportSectionConstants.USER_SYSTEM_ID:
				searchCriteriaItems[4] = searchInput;
				break;
			default:
				break;
			}
		}
		return searchCriteriaItems;
	}

	protected Pageable createPageableReports(ListTableParams listTableParams) {
		Pageable pageable = null;
		String sortStr1;
		String sortStr2 = "";
		String sortByStr = listTableParams.getSortBy();
		int pageNumberI = listTableParams.getPageNumber() - 1;
		int pageSizeI = listTableParams.getRecordsPerPage();
		// Pageable represents the Page configuration with sorting
		Sort.Order order1 = null;
		Sort.Order order2 = null;
		Sort.Direction sortDirection;
		Sort sort1;
		if (listTableParams.getSortOrder() > 0) {
			sortDirection = Sort.Direction.ASC;
		} else {
			sortDirection = Sort.Direction.DESC;
		}
		switch (sortByStr) {
		case ReportSectionConstants.REPORT_ITEM_NAME:
		case ReportSectionConstants.REPORT_SECTION_NAME:
			sortStr1 = sortByStr;
			order1 = new Sort.Order(sortDirection, sortStr1).ignoreCase();
			sort1 = Sort.by(order1);
			break;
		case ReportSectionConstants.CREATE_DATE:
			sortStr1 = sortByStr;
			order1 = new Sort.Order(sortDirection, sortStr1);
			sort1 = Sort.by(order1);
			break;
		case ReportSectionConstants.MODIFIED_DATE:
			sortStr1 = ReportSectionConstants.UPDATE_DATE;
			order1 = new Sort.Order(sortDirection, sortStr1);
			sort1 = Sort.by(order1);
			break;
		case ReportSectionConstants.CREATED_BY:
			sortStr1 = "uiUserBaseCr.uiFirstName";
			sortStr2 = "uiUserBaseCr.uiLastName";
			order1 = new Sort.Order(sortDirection, sortStr1).ignoreCase();
			order2 = new Sort.Order(sortDirection, sortStr2).ignoreCase();
			sort1 = Sort.by(order1, order2);
			break;
		case ReportSectionConstants.MODIFIED_BY:
			sortStr1 = "uiUserBaseUpd.uiFirstName";
			sortStr2 = "uiUserBaseUpd.uiLastName";
			order1 = new Sort.Order(sortDirection, sortStr1).ignoreCase();
			order2 = new Sort.Order(sortDirection, sortStr2).ignoreCase();
			sort1 = Sort.by(order1, order2);
			break;
		default:
			sortStr1 = ReportSectionConstants.CREATE_DATE;
			order1 = new Sort.Order(sortDirection, sortStr1);
			sort1 = Sort.by(order1);
			break;
		}
		pageable = PageRequest.of(pageNumberI, pageSizeI, sort1);
		return pageable;
	}

	/**
	 * this method is called by getReportItemsList, getReportItemsByPage to populate
	 * and return a list Report items
	 * 
	 * Parameters - List of PrmRiRptItemTs (Report Item table)
	 */
	public List<ReportItemDTO> populateReportItemList(List<PrmRiRptItemT> reportItemList) {
		List<ReportItemDTO> reportItemDataList = new ArrayList<>();
		ReportItemDTO reportItemDTO;
		for (PrmRiRptItemT reportItemInd : reportItemList) {
			reportItemDTO = populateReportItemInd(reportItemInd);
			reportItemDataList.add(reportItemDTO);
		}
		return reportItemDataList;
	}

	protected ReportItemDTO populateReportItemInd(PrmRiRptItemT reportItemInd) {
		String[] calcFmtVal = { "Sum", "Percent", "Ratio" };
		ReportItemDTO reportItemDTO = new ReportItemDTO();
		reportItemDTO.setReportItemId(reportItemInd.getRiId());
		reportItemDTO.setReportItemName(reportItemInd.getReportItemName());
		reportItemDTO.setCalcFMT(Integer.parseInt(reportItemInd.getRiCalcFmt()));
		reportItemDTO.setRatioOf(calcFmtVal[Integer.parseInt(reportItemInd.getRiCalcFmt()) - 1]);
		reportItemDTO.setMultipleConstant(reportItemInd.getConstantNum());
		reportItemDTO.setDivideConstant(reportItemInd.getConstantDen());
		reportItemDTO.setMinimumDenominator(reportItemInd.getRiMinimumDenom());
		reportItemDTO.setCreatedBy(reportItemInd.getUiUserBaseCr().getUiFirstName() + ReportSectionConstants.BLANK_STR
				+ reportItemInd.getUiUserBaseCr().getUiLastName());
		reportItemDTO.setCreatedDate(formatLocalDate(reportItemInd.getCreateDate()));
		reportItemDTO.setModifiedBy(reportItemInd.getUiUserBaseUpd().getUiFirstName()
				+ ReportSectionConstants.BLANK_STR + reportItemInd.getUiUserBaseUpd().getUiLastName());
		reportItemDTO.setModifiedDate(formatLocalDate(reportItemInd.getUpdateDate()));
		reportItemDTO.setCreatedBySystemId(reportItemInd.getUiUserBaseCr().getUiSystemId());
		return reportItemDTO;
	}

	private List<BehaviorPatternDTO> getSelectedBps(PrmRiRptItemT reportItemInd) {
		List<BehaviorPatternDTO> behaviorPatternList = new ArrayList<>();
		try {
			for (PrmBpRiFormulaT reportItemFormula : reportItemInd.getPrmBpRiFormulaTs()) {
				PrmBpBehaviorPatsT prmBpBehaviorPatsT = behaviorPatternsRepository
						.getBehaviorPatternById(reportItemFormula.getId().getBpId());
				BehaviorPatternDTO behaviorPatternDTO = populatebehaviorPatternDTO(prmBpBehaviorPatsT);
				behaviorPatternDTO.setType(reportItemFormula.getId().getRibpType());
				behaviorPatternDTO.setOperator(reportItemFormula.getOperatorExp());
				logit.info("behavior Id = {} Type = {} Operator Exp = {}", behaviorPatternDTO.getBehaviorPatternId(),
						behaviorPatternDTO.getType(), behaviorPatternDTO.getOperator());
				behaviorPatternList.add(behaviorPatternDTO);
			}
		} catch (Exception e) {
			throw new ReportSectionApiException(e);
		}
		return behaviorPatternList;
	}

	/**
	 * this method will get the report item record data corresponding to Report Item
	 * ID
	 * 
	 * Parameters - Report Item ID
	 */
	public ReportItemDTO getReportItemById(Integer reportItemId) {
		ReportItemDTO reportItemDTO = null;
		PrmRiRptItemT reportItemInd;
		try {
			reportItemInd = reportItemsRepository.getReportItemById(reportItemId);
			if (reportItemInd == null) {
				throw new ReportSectionApiException(ReportSectionConstants.NO_DATA_FOUND_MSG);
			}
			reportItemDTO = populateReportItemInd(reportItemInd);
			reportItemDTO.setNumeratorBehaviorPatterns(new ArrayList<>());
			reportItemDTO.setDenominatorBehaviorPatterns(new ArrayList<>());
			List<BehaviorPatternDTO> behaviorPatternList = getBehaviorPatterns(reportItemInd);
			for (BehaviorPatternDTO behaviorPatternDTO : behaviorPatternList) {
				if (behaviorPatternDTO.getType().equals(ReportSectionConstants.NUM_STR)) {
					reportItemDTO.getNumeratorBehaviorPatterns().add(behaviorPatternDTO);
				} else {
					reportItemDTO.getDenominatorBehaviorPatterns().add(behaviorPatternDTO);
				}
			}
			logit.info("Get Report Item -  DTO populated with data for ID = {}", reportItemId);
		} catch (Exception e) {
			throw new ReportSectionApiException(e);
		}
		return reportItemDTO;
	}

	/**
	 * this method will get the behavior pattern data corresponding to Behavior
	 * Pattern IDs of a Report Item
	 * 
	 * Parameters - PrmRiRptItemT
	 */
	public List<BehaviorPatternDTO> getBehaviorPatterns(PrmRiRptItemT reportItemInd) {
		List<BehaviorPatternDTO> behaviorPatternList = new ArrayList<>();
		BehaviorPatternDTO behaviorPatternDTO = null;
		List<Object[]> behaviorPatternRS;
		Integer behaviorPatternId;
		try {
			for (PrmBpRiFormulaT reportItemFormula : reportItemInd.getPrmBpRiFormulaTs()) {
				behaviorPatternId = reportItemFormula.getId().getBpId();
				logit.info("Retrieve Behavior Pattern By  ID = {}", behaviorPatternId);
				behaviorPatternRS = behaviorPatternsRepository.retrieveBehaviorPatternById(behaviorPatternId);
				if (!behaviorPatternRS.isEmpty()) {
					Object[] behaviorPatternData = behaviorPatternRS.get(0);
					behaviorPatternDTO = new BehaviorPatternDTO();
					behaviorPatternDTO.setBehaviorPatternId(reportItemFormula.getId().getBpId());
					behaviorPatternDTO.setErId((int) behaviorPatternData[0]);
					behaviorPatternDTO.setThisBpRequiresDr((int) behaviorPatternData[0] != -1);
					behaviorPatternDTO.setBaId((String) behaviorPatternData[1]);
					behaviorPatternDTO.setBehaviorPatternName((String) behaviorPatternData[2]);
					behaviorPatternDTO.setDataElementCode((int) behaviorPatternData[3]);
					if (behaviorPatternData[4] != null) {
						behaviorPatternDTO.setDateElementCode((int) behaviorPatternData[4]);
					}
					behaviorPatternDTO.setCreatedDate(formatDate((Date) behaviorPatternData[5]));
					behaviorPatternDTO.setCreatedBy((String) behaviorPatternData[6] + ReportSectionConstants.BLANK_STR
							+ (String) behaviorPatternData[7]);
					behaviorPatternDTO.setModifiedDate(formatDate((Date) behaviorPatternData[8]));
					behaviorPatternDTO.setModifiedBy((String) behaviorPatternData[9] + ReportSectionConstants.BLANK_STR
							+ (String) behaviorPatternData[10]);
					behaviorPatternDTO.setSumOf((String) behaviorPatternData[11]);
					behaviorPatternDTO.setDataElementName((String) behaviorPatternData[12]);
				//	behaviorPatternDTO.setDateElementName((String) behaviorPatternData[13]);
					behaviorPatternDTO.setType(reportItemFormula.getId().getRibpType());
					behaviorPatternDTO.setOperator(reportItemFormula.getOperatorExp());
					List<DataRuleDTO> dataRules = getSelectedDataRules(behaviorPatternDTO.getErId());
					behaviorPatternDTO.setDataRules(dataRules);
					logit.info("BehaviorPattern Bean populated with data for ID = {}", behaviorPatternId);
					behaviorPatternList.add(behaviorPatternDTO);
				} else {
					throw new ReportSectionApiException(ReportSectionConstants.NO_DATA_FOUND_MSG);
				}
			}
		} catch (Exception e) {
			throw new ReportSectionApiException(e);
		}
		return behaviorPatternList;
	}

	/**
	 * this method will give the selected Data Rules records data for a Extract Rule ID
	 * 
	 * Parameters - erId
	 */
	public List<DataRuleDTO> getSelectedDataRules(Integer erId) {
		List<DataRuleDTO> selectedDataRulesList = new ArrayList<>();
		List<Integer> dataRuleIdList;
		List<PrmDrDataRuleT> dataRuleDrList;
		try {
			List<PrmErDrT> erdrList = behaviorPatternErDrRepository.retrieveErDrValues(erId);
			logit.info("{} Data Rule records retrieved for Extract Rule ID = {}", erdrList.size(), erId);
			if (erdrList.isEmpty()) {
				selectedDataRulesList = new ArrayList<>();
			} else {
				dataRuleIdList = new ArrayList<>();
				for (PrmErDrT erdrInd : erdrList) {
					dataRuleIdList.add(erdrInd.getId().getDrId());
				}
				dataRuleDrList = dataRulesRepository.getDataRulesByIds(dataRuleIdList);
				selectedDataRulesList = populateDataRulesList(dataRuleDrList);
			}
		} catch (Exception e) {
			throw new ReportSectionApiException(e);
		}
		return selectedDataRulesList;
	}

	private List<DataRuleDTO> populateDataRulesList(List<PrmDrDataRuleT> dataruleList) {
		List<DataRuleDTO> dataRuleDataList = new ArrayList<>();
		for (PrmDrDataRuleT dataRuleInd : dataruleList) {
			DataRuleDTO dataRuleDTO = new DataRuleDTO();
			dataRuleDTO.setDataRuleId(dataRuleInd.getDrId());
			dataRuleDTO.setDataRuleName(dataRuleInd.getDataRuleName());
			dataRuleDTO.setDataElementName(dataRuleInd.getPrmMbMasterT().getMbCustDatadesc());
			dataRuleDTO.setOperator(dataRuleInd.getPrmDrLuOperatorT().getOperatorDesc());
			dataRuleDTO.setCreatedBy(dataRuleInd.getUiUserBaseCr().getUiFirstName() + ReportSectionConstants.BLANK_STR
					+ dataRuleInd.getUiUserBaseCr().getUiLastName());
			dataRuleDTO.setCreatedDate(formatDate(dataRuleInd.getCreateDate()));
			dataRuleDTO.setModifiedBy(dataRuleInd.getUiUserBaseUpd().getUiFirstName()
					+ ReportSectionConstants.BLANK_STR + dataRuleInd.getUiUserBaseUpd().getUiLastName());
			dataRuleDTO.setModifiedDate(formatDate(dataRuleInd.getUpdateDate()));
			dataRuleDTO.setDataElementId(dataRuleInd.getPrmMbMasterT().getMbCtecFid());
			setCodeRangeValues(dataRuleInd, dataRuleDTO);
			dataRuleDataList.add(dataRuleDTO);
		}
		return dataRuleDataList;
	}

	private void setCodeRangeValues(PrmDrDataRuleT dataRuleInd, DataRuleDTO dataRuleDTO) {
		if (!dataRuleInd.getPrmDrSingleValuesTs().isEmpty()) {
			dataRuleDTO.setRangeValue(ReportSectionConstants.NO_VALUE);
			List<DrCodeValueDTO> codeValuesList = new ArrayList<>();
			for (PrmDrSingleValuesT singleValue : dataRuleInd.getPrmDrSingleValuesTs()) {
				DrCodeValueDTO codeBean = new DrCodeValueDTO();
				codeBean.setValue(singleValue.getDrLabel());
				codeBean.setCode(singleValue.getId().getDrValue());
				codeValuesList.add(codeBean);
			}
			dataRuleDTO.setSelectedValues(codeValuesList);
		} else {
			dataRuleDTO.setSelectedValues(new ArrayList<DrCodeValueDTO>());
		}
		if (!dataRuleInd.getPrmDrRangesTs().isEmpty()) {
			dataRuleDTO.setRangeValue(ReportSectionConstants.HAS_VALUE);
			List<DrRangeValuesDTO> drRangeValuesList = new ArrayList<>();
			for (PrmDrRangesT rangeFromTo : dataRuleInd.getPrmDrRangesTs()) {
				DrRangeValuesDTO rangeBean = new DrRangeValuesDTO();
				rangeBean.setFrom(rangeFromTo.getDrRangeFrom());
				rangeBean.setTo(rangeFromTo.getDrRangeTo());
				drRangeValuesList.add(rangeBean);
			}
			dataRuleDTO.setRangeValues(drRangeValuesList);
		} else {
			dataRuleDTO.setRangeValues(new ArrayList<DrRangeValuesDTO>());
		}
	}

	/**
	 * this method will delete selected Report Item
	 * 
	 * Parameters - Report Item Id
	 */
	public List<String> deleteReportItem(Integer reportItemId) {
		int reportItemsDeleted = 0;
		int riFormulasDeleted = 0;
		boolean delReportItemConstraint = false;
		List<String> deleteReportItemMessages = new ArrayList<>();
		List<Integer> rsIdList;
		try {
			PrmRiRptItemT reportItem = reportItemsRepository.getReportItemById(reportItemId);
			if (reportItem == null) {
				deleteReportItemMessages.add(ReportSectionConstants.REPORT_ITEM_DOES_NOT_EXIST);
			} else {
				List<PrmRsRiT> rsriList = reportSectionItemsRepository.getRsRisByRiId(reportItemId);
				if (!rsriList.isEmpty()) {
					if (rsriList.size() > 1) {
						rsIdList = new ArrayList<>();
						for (PrmRsRiT prmRsRiT : rsriList ) {
							rsIdList.add(prmRsRiT.getId().getRsId());
						}
						List<PrmRsRptSecT> reportSectionList = reportSectionsRepository.getReportSectionByIds(rsIdList);
						for (PrmRsRptSecT reportSection: reportSectionList) {
							deleteReportItemMessages.add(ReportSectionConstants.RS_CONST + reportSection.getReportSectionName());
						}
					} else { 
						PrmRsRptSecT reportSection = reportSectionsRepository.getReportSectionById(rsriList.get(0).getId().getRsId());
						deleteReportItemMessages.add(ReportSectionConstants.RS_CONST + reportSection.getReportSectionName());
					}
					delReportItemConstraint = true;
				}
				if (!delReportItemConstraint) { 
					riFormulasDeleted = reportItemFormulasRepository.deleteReportItemFormulaByRiId(reportItemId);
					logit.info("Deleted {} RI Formula records for input ID", riFormulasDeleted);
					reportItemsDeleted = reportItemsRepository.deleteReportItem(reportItemId);
					if (reportItemsDeleted > 0) {
						deleteReportItemMessages.add(ReportSectionConstants.DELETE_REPORT_ITEM_SUCCESS);
					} else {
						deleteReportItemMessages.add(ReportSectionConstants.DELETE_REPORT_ITEM_FAIL);
					}
				}
			}
		} catch (Exception e) {
			throw new ReportSectionApiException(e);
		}
		return deleteReportItemMessages;
	}

	/**
	 * this method will create a new Report Item
	 * 
	 * Parameters - reportItemDTO
	 */
	public ReportItemDTO addReportItem(ReportItemDTO reportItemDTO) {
		ReportItemDTO retReportItemDTO = new ReportItemDTO();
		DateTimeFormatter dateTimeFormatter = DateTimeFormatter.ofPattern(ReportSectionConstants.DATE_FORMAT_MMDDYYYY_HHMMSS_A,
				Locale.ENGLISH);
		String reportItemNameLc = reportItemDTO.getReportItemName().toLowerCase().trim();
			try {
				PrmRiRptItemT reportItem = reportItemsRepository.getReportItemByName(reportItemNameLc);
				if (reportItem == null) {
					Integer reportItemId = reportItemsRepository.retrieveNextRiId();
					if(reportItemId ==null){
                        reportItemId=1;
                    }
					reportItemDTO.setReportItemId(reportItemId);
					PrmRiRptItemT ri = new PrmRiRptItemT();
					UiUserBase uiUserBaseCr = new UiUserBase();	
					uiUserBaseCr.setUiSystemId(reportItemDTO.getCreatedBySystemId());
					ri.setUiUserBaseCr(uiUserBaseCr);				// Set UiUserBase
					UiUserBase uiUserBaseUpd = new UiUserBase();
					uiUserBaseUpd.setUiSystemId(reportItemDTO.getModifiedBySystemId());
					ri.setUiUserBaseUpd(uiUserBaseUpd);
					ri.setRiId(reportItemId);
					ri.setReportItemName(reportItemDTO.getReportItemName().trim());
					ri.setRiCalcFmt(String.valueOf(reportItemDTO.getCalcFMT()));
					ri.setRiMinimumDenom(reportItemDTO.getMinimumDenominator());
					ri.setConstantDen(reportItemDTO.getDivideConstant());
					ri.setConstantDenOp(ReportSectionConstants.OP_STR);
					ri.setConstantNum(reportItemDTO.getMultipleConstant());
					ri.setConstantNumOp(ReportSectionConstants.OP_STR);
					
					ri.setCreateDate(LocalDateTime.parse(reportItemDTO.getCreatedDate(), dateTimeFormatter));
					ri.setUpdateDate(LocalDateTime.parse(reportItemDTO.getModifiedDate(), dateTimeFormatter));
					reportItemsRepository.saveAndFlush(ri);
					saveReportItemFormulas(reportItemDTO);
					retReportItemDTO.setReportItemId(reportItemId);
					retReportItemDTO.setReportItemName(reportItemDTO.getReportItemName().trim());
					retReportItemDTO.setCreatedDate(reportItemDTO.getCreatedDate());
					retReportItemDTO.setModifiedDate(reportItemDTO.getModifiedDate());
					retReportItemDTO.setModifiedBySystemId(reportItemDTO.getModifiedBySystemId());
					retReportItemDTO.setCreatedBySystemId(reportItemDTO.getCreatedBySystemId());
					logit.info("Report Item saved with Report Item ID = {}", reportItemId);
				} else {
					retReportItemDTO.setReportItemId(reportItem.getRiId());
					retReportItemDTO.setReportItemName(ReportSectionConstants.REPORT_ITEM_EXISTS);
					retReportItemDTO.setModifiedBySystemId(reportItem.getUiUserBaseUpd().getUiSystemId());
					retReportItemDTO.setCreatedBySystemId(reportItem.getUiUserBaseCr().getUiSystemId());
				}
			} catch (Exception e) {
				throw new ReportSectionApiException(e);
			}
		return retReportItemDTO;
	}

	/**
	 * this method will update a Report Section records based on input data
	 * 
	 * Parameters - reportItemDTO
	 */
	public String updateReportItem(Integer reportItemId, ReportItemDTO reportItemDTO) {
		
		String reportItemName = reportItemDTO.getReportItemName().trim();
		DateTimeFormatter dateTimeFormatter = DateTimeFormatter.ofPattern(ReportSectionConstants.DATE_FORMAT_MMDDYYYY_HHMMSS_A,
				Locale.ENGLISH);
		try {

			PrmRiRptItemT prmRiRptItemT = reportGroupDetailMapper.convertToPrmRiRptItemT(reportItemDTO);
			prmRiRptItemT.setConstantDenOp(ReportSectionConstants.OP_STR);
			prmRiRptItemT.setConstantNumOp(ReportSectionConstants.OP_STR);
			prmRiRptItemT.setUpdateDate(LocalDateTime.parse(reportItemDTO.getModifiedDate(), dateTimeFormatter));
			PrmRiRptItemT reportItemInd = reportItemsRepository.getReportItemById(reportItemId);
			prmRiRptItemT.setCreateDate(reportItemInd.getCreateDate());
			prmRiRptItemT = reportItemsRepository.saveAndFlush(prmRiRptItemT);
			if (!reportItemDTO.getNumeratorBehaviorPatterns().isEmpty()
					|| !reportItemDTO.getDenominatorBehaviorPatterns().isEmpty()) {
				int rfsDeleted = reportItemFormulasRepository.deleteReportItemFormulaByRiId(reportItemId);
				logit.info("Deleted {} Report Item formulas for the ID = {}", rfsDeleted, reportItemId);
				saveReportItemFormulas(reportItemDTO);
			}
			logit.info("Updated Report Item for the ID = {}", reportItemId);	

		} catch (Exception e) {
			throw new ReportSectionApiException(e);
		}
		return ReportSectionConstants.UPDATE_REPORT_ITEM_SUCCESS;
	}
	/**
	 * this method will save report item formulas - to maintain the relationship between Report Item and its behavior patterns
	 * the numerator, denominator Behavior Pattern IDs and Report Item ID are saved in PRM_BP_RI_FORMULA_T table
	 * along with type (Numerator or Denominator) and operator (+, -)
	 * 
	 * Parameters - reportItemDTO
	 */
	private void saveReportItemFormulas(ReportItemDTO reportItemDTO) {
		List<PrmBpRiFormulaT> riFormulaList = new ArrayList<>();
		int sequence = 0;
		List<BehaviorPatternDTO> behaviorPatternList = new ArrayList<>();
		behaviorPatternList.addAll(reportItemDTO.getNumeratorBehaviorPatterns());
		behaviorPatternList.addAll(reportItemDTO.getDenominatorBehaviorPatterns());
		for (BehaviorPatternDTO behaviorPatternDTO : behaviorPatternList) {
			PrmBpRiFormulaT rf = new PrmBpRiFormulaT();
			PrmBpRiFormulaTPK rfPk = new PrmBpRiFormulaTPK();
			rfPk.setRiId(reportItemDTO.getReportItemId());
			rfPk.setBpId(behaviorPatternDTO.getBehaviorPatternId());
			rf.setOperatorExp(behaviorPatternDTO.getOperator());
			rfPk.setRibpSeq(++sequence);
			rfPk.setRibpType(behaviorPatternDTO.getType());
			rf.setId(rfPk);
			riFormulaList.add(rf);
		}
		try {
			if (!riFormulaList.isEmpty()) {
				logit.info("Save RiFormulas = {} for Report Item ID {}", riFormulaList.size(), reportItemDTO.getReportItemId());
				reportItemFormulasRepository.saveAll(riFormulaList);
				reportItemFormulasRepository.flush();
			}
		} catch (Exception e) {
			throw new ReportSectionApiException(e);
		}
	}

	/**
	 * this method will return the available Behavior Pattern records data, except those associated 
	 * with the input Report Item ID
	 * 
	 * Parameters - reportItemId
	 */
	public List<BehaviorPatternDTO> getAvailableBehaviorPatterns(Integer reportItemId) {
		logit.info("Get Available  Behavior Patterns List ");
		List<BehaviorPatternDTO> availableBehaviorPatternList = new ArrayList<>();
		List<PrmBpBehaviorPatsT> behaviorPatternBPList;
		try {
			PrmRiRptItemT reportItem = reportItemsRepository.getReportItemById(reportItemId);
			if (reportItem == null) {
				throw new ReportSectionApiException(ReportSectionConstants.REPORT_ITEM_DOES_NOT_EXIST);
			}
			behaviorPatternBPList = behaviorPatternsRepository.getAvailableBehaviorPatterns(reportItemId);
			if (!behaviorPatternBPList.isEmpty()) {
				for (PrmBpBehaviorPatsT prmBpBehaviorPatsT : behaviorPatternBPList) {
					BehaviorPatternDTO behaviorPatternDTO = populatebehaviorPatternDTO(prmBpBehaviorPatsT);
					availableBehaviorPatternList.add(behaviorPatternDTO);
				}
			} else {
				throw new ReportSectionApiException(ReportSectionConstants.NO_DATA_FOUND_MSG);
			}
		} catch (Exception e) {
			throw new ReportSectionApiException(e);
		}
		return availableBehaviorPatternList;
	}

	private BehaviorPatternDTO populatebehaviorPatternDTO(PrmBpBehaviorPatsT behaviorPatternInd) {
		
		BehaviorPatternDTO behaviorPatternDTO = new BehaviorPatternDTO();
		behaviorPatternDTO.setBehaviorPatternId(behaviorPatternInd.getBpId());
		behaviorPatternDTO.setErId(behaviorPatternInd.getPrmErExtractRuleT().getErId());
		behaviorPatternDTO.setBehaviorPatternName(behaviorPatternInd.getBehaviorPatternName());
		behaviorPatternDTO.setBaId(behaviorPatternInd.getBaId());
		behaviorPatternDTO.setCreatedBy(behaviorPatternInd.getUiUserBaseCr().getUiUserId());
		behaviorPatternDTO.setCreatedDate(formatDate(behaviorPatternInd.getCreateDate()));
		behaviorPatternDTO.setModifiedBy(behaviorPatternInd.getUiUserBaseUpd().getUiUserId());
		behaviorPatternDTO.setModifiedDate(formatDate(behaviorPatternInd.getUpdateDate()));
		return behaviorPatternDTO;
	}

	/**
	 * this method will give the selected Behavior Pattern records data for an input Report Item
	 * 
	 * Parameters - reportItemId
	 */
	public List<BehaviorPatternDTO> getSelectedBehaviorPatterns(Integer reportItemId) {
		logit.info("Get Selected Behavior Patterns List ");
		List<BehaviorPatternDTO> selectedBehaviorPatternList = null;
		try {
			PrmRiRptItemT reportItem = reportItemsRepository.getReportItemById(reportItemId);
			if (reportItem == null) {
				throw new ReportSectionApiException(ReportSectionConstants.REPORT_ITEM_DOES_NOT_EXIST);
			}
			selectedBehaviorPatternList = getSelectedBps(reportItem);
		} catch (Exception e) {
			throw new ReportSectionApiException(e);
		}
		return selectedBehaviorPatternList;
	}
	/**
	 * this method will replace all special characters in the input string
	 * 
	 * Parameters - searchInput
	 */
	protected String replReportItemName(String searchInput) {
		StringBuilder strbldr = new StringBuilder();
		String reportItemNameVal;
		String replacedInput = "";
		// the space is an encoded string %20
		if (StringUtils.containsAny(searchInput,ReportSectionConstants.SPACE_ENCODED_STR)) {
			searchInput = searchInput.replaceAll(ReportSectionConstants.SPACE_ENCODED_STR, ReportSectionConstants.BLANK_STR);
		} 
		if (StringUtils.containsAny(searchInput,ReportSectionConstants.PLUS_REPL_STR)) {
	  		searchInput = searchInput.replaceAll(ReportSectionConstants.PLUS_REPL_STR, ReportSectionConstants.PLUS_STR );
		}
		if (StringUtils.containsAny(searchInput,ReportSectionConstants.COMMA_REPL_STR)) {
	  		searchInput = searchInput.replaceAll(ReportSectionConstants.COMMA_REPL_STR, ReportSectionConstants.COMMA_STR );
		}
		if (StringUtils.containsAny(searchInput, ReportSectionConstants.PERCENT_CHAR)
				|| StringUtils.containsAny(searchInput, ReportSectionConstants.UNDERSCORE_CHAR)) {
			if (StringUtils.containsAny(searchInput, ReportSectionConstants.PERCENT_CHAR)) {
				replacedInput = searchInput.replaceAll("\\%", "\\\\%");
			} else if (StringUtils.containsAny(searchInput, ReportSectionConstants.UNDERSCORE_CHAR)) {
				replacedInput = searchInput.replaceAll("\\_", "\\\\_");
			} else {
				replacedInput = searchInput;
			}
			strbldr.append(ReportSectionConstants.PERCENT_STR);
			strbldr.append(replacedInput);
			strbldr.append(ReportSectionConstants.PERCENT_STR);
			reportItemNameVal = strbldr.toString();
		} else {
			reportItemNameVal = ReportSectionConstants.PERCENT_STR + searchInput + ReportSectionConstants.PERCENT_STR;
		}
		return reportItemNameVal;
	}

	public String formatDate(Date dt) {
		if (dt == null)
			return null;
		SimpleDateFormat formatter = new SimpleDateFormat(ReportSectionConstants.DATE_FORMAT_MMDDYYYY_HHMM_A);
		return formatter.format(dt);
	}

		// For LocalDateTime
		protected String formatLocalDate(LocalDateTime dt) {
			DateTimeFormatter dateTimeFormatter;
			if (dt == null)
				return null;
			dateTimeFormatter = DateTimeFormatter.ofPattern(ReportSectionConstants.DATE_FORMAT_MMDDYYYY_HHMM_A,
					Locale.ENGLISH);
			return dateTimeFormatter.format(dt);
		}		
	
		/** 
		 * This method will get the ZoneId corresponding to the time zone used at the customer site
		 * Parameters: the time zone is stored in an entry in the FADS_CONFIG_T table 
		 */
		public ZoneId getZoneId() {
			ZoneId zid = ZoneId.systemDefault();;
			Optional<FadsConfigT> optional = fadsConfigRepository.findById(ReportSectionConstants.DATE_TIME_ZONE_ID);
			if (optional.isPresent()) {
				FadsConfigT fadsConfigT = optional.get();
				zid = ZoneId.of(fadsConfigT.getOptionValue());	//  the zone ID corresponding to date-time zone used
			}
			return zid;

		}
}
