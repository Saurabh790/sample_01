FO] Results:
[INFO]
[ERROR] Errors:
[ERROR]   ServiceConfigTest.customDataSource_buildsDatasource_usingSecretsFromKeyVault:38 Â» IllegalState Could not load JDBC driver class [org.h2.Driver]
[INFO]
package com.optum.fads.pgp.behavior.api.config;
import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

import javax.sql.DataSource;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.springframework.jdbc.datasource.DriverManagerDataSource;
import org.springframework.test.util.ReflectionTestUtils;

import com.azure.security.keyvault.secrets.SecretClient;
import com.azure.security.keyvault.secrets.models.KeyVaultSecret;
import org.mockito.junit.jupiter.MockitoExtension;

@ExtendWith(MockitoExtension.class)

class ServiceConfigTest {

    @Test
    void customDataSource_buildsDatasource_usingSecretsFromKeyVault() {

        SecretClient secretClient = mock(SecretClient.class);

        when(secretClient.getSecret("db-user-secret"))
                .thenReturn(new KeyVaultSecret("db-user-secret", "dbuser"));

        when(secretClient.getSecret("db-pass-secret"))
                .thenReturn(new KeyVaultSecret("db-pass-secret", "dbpass"));

        ServiceConfig config = new ServiceConfig(secretClient);

        ReflectionTestUtils.setField(config, "userNameSecretName", "db-user-secret");
        ReflectionTestUtils.setField(config, "passwordSecretName", "db-pass-secret");
        ReflectionTestUtils.setField(config, "jdbcUrl", "jdbc:h2:mem:test");
        ReflectionTestUtils.setField(config, "driverClassName", "org.h2.Driver");

        DataSource ds = config.customDataSource();

        assertNotNull(ds);
        assertTrue(ds instanceof DriverManagerDataSource);

        DriverManagerDataSource dmds = (DriverManagerDataSource) ds;
        assertEquals("jdbc:h2:mem:test", dmds.getUrl());
        assertEquals("dbuser", dmds.getUsername());
        assertEquals("dbpass", dmds.getPassword());
    }
}


package com.optum.fads.pgp.behavior.api.config;

import javax.sql.DataSource;

import com.azure.security.keyvault.secrets.SecretClient;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.jdbc.datasource.DriverManagerDataSource;
import org.springframework.transaction.annotation.EnableTransactionManagement;

@Configuration
@EnableTransactionManagement
@EnableJpaRepositories(basePackages = "com.optum.fads.pgp.behavior.api.repo")
@ComponentScan(basePackages = { "com.optum.fads.pgp.behavior.api" })
public class ServiceConfig {

    private static final Logger logger = LoggerFactory.getLogger(ServiceConfig.class);

    // these are secret NAMES stored in KeyVault
    @Value("${spring.datasource.userName}")
    private String userNameSecretName;

    @Value("${spring.datasource.password}")
    private String passwordSecretName;

    @Value("${spring.datasource.jdbcUrl}")
    private String jdbcUrl;

    @Value("${spring.datasource.driverClassName}")
    private String driverClassName;

    private final SecretClient secretClient;

    public ServiceConfig(SecretClient secretClient) {
        this.secretClient = secretClient;
    }

    @Bean(name = "fadsDataSource")
    @Primary
    public DataSource customDataSource() {
        logger.info("Initializing custom DataSource bean...");

        String username = secretClient.getSecret(userNameSecretName).getValue();
        String password = secretClient.getSecret(passwordSecretName).getValue();

        DriverManagerDataSource dataSource = new DriverManagerDataSource();
        dataSource.setDriverClassName(driverClassName);
        dataSource.setUrl(jdbcUrl);
        dataSource.setUsername(username);
        dataSource.setPassword(password);

        return dataSource;
    }
}
