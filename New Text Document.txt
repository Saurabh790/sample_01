package com.optum.fads.pgp.behavior.api.security;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.core.Authentication;
import org.springframework.security.oauth2.jwt.Jwt;

import com.optum.fads.pgp.behavior.api.dto.AppUser;
import com.optum.fads.pgp.behavior.api.service.IUserDetailsService;

@ExtendWith(MockitoExtension.class)
class UserJwtAuthenticationConverterTest {

    @Mock
    private IUserDetailsService userDetailsService;

    @Test
    void convert_success() {
        Jwt jwt = Jwt.withTokenValue("abc")
                .header("alg", "none")
                .claim("groups", List.of("admin", "user"))
                .claim("email", "john@test.com")
                .build();

        AppUser user = new AppUser();
        user.setUserId("johnid");
        user.setUserEmail("john@test.com");

        when(userDetailsService.loadUserByUsername("john@test.com"))
                .thenReturn(user);

        UserJwtAuthenticationConverter converter =
                new UserJwtAuthenticationConverter(userDetailsService);

        Authentication auth = converter.convert(jwt);

        assertNotNull(auth);

        // Safer than assertEquals unless AppUser overrides equals/hashCode properly
        assertSame(user, auth.getPrincipal());

        // Your converter sets credentials as "n/a"
        assertEquals("n/a", auth.getCredentials());

        // Assert authorities EXACTLY (order independent)
        Set<String> authorities = auth.getAuthorities().stream()
                .map(a -> a.getAuthority())
                .collect(Collectors.toSet());

        assertEquals(Set.of("ROLE_ADMIN", "ROLE_USER"), authorities);

        // Verify service was called exactly once with expected username
        verify(userDetailsService, times(1)).loadUserByUsername("john@test.com");
        verifyNoMoreInteractions(userDetailsService);
    }

    @Test
    void convert_userNotFound_throwsBadCredentials() {
        Jwt jwt = Jwt.withTokenValue("xyz")
                .header("alg", "none")
                .claim("email", "missing@test.com")
                .build();

        when(userDetailsService.loadUserByUsername("missing@test.com"))
                .thenReturn(null);

        UserJwtAuthenticationConverter converter =
                new UserJwtAuthenticationConverter(userDetailsService);

        assertThrows(BadCredentialsException.class, () -> converter.convert(jwt));

        verify(userDetailsService, times(1)).loadUserByUsername("missing@test.com");
        verifyNoMoreInteractions(userDetailsService);
    }

    // Optional: recommended extra coverage if converter expects groups missing -> empty authorities
    @Test
    void convert_noGroups_returnsEmptyAuthorities() {
        Jwt jwt = Jwt.withTokenValue("pqr")
                .header("alg", "none")
                .claim("email", "john@test.com")
                .build();

        AppUser user = new AppUser();
        user.setUserId("johnid");
        user.setUserEmail("john@test.com");

        when(userDetailsService.loadUserByUsername("john@test.com"))
                .thenReturn(user);

        UserJwtAuthenticationConverter converter =
                new UserJwtAuthenticationConverter(userDetailsService);

        Authentication auth = converter.convert(jwt);

        assertNotNull(auth);
        assertSame(user, auth.getPrincipal());
        assertTrue(auth.getAuthorities().isEmpty());

        verify(userDetailsService, times(1)).loadUserByUsername("john@test.com");
        verifyNoMoreInteractions(userDetailsService);
    }
}
