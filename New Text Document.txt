package com.optum.fads.pgp.behavior.api.security;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

import java.util.List;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.core.Authentication;
import org.springframework.security.oauth2.jwt.Jwt;

import com.optum.fads.pgp.behavior.api.dto.AppUser;
import com.optum.fads.pgp.behavior.api.service.IUserDetailsService;

@ExtendWith(MockitoExtension.class)
class UserJwtAuthenticationConverterTest {

    @Mock
    private IUserDetailsService userDetailsService;

    @Test
    void convert_success() {
        Jwt jwt = Jwt.withTokenValue("abc")
                .header("alg", "none")
                .claim("groups", List.of("admin", "user"))
                .claim("email", "john@test.com")
                .build();

        AppUser user = new AppUser();
        user.setUserId("johnid");
        user.setUserEmail("john@test.com");

        when(userDetailsService.loadUserByUsername("john@test.com"))
                .thenReturn(user);

        UserJwtAuthenticationConverter converter =
                new UserJwtAuthenticationConverter(userDetailsService);

        Authentication auth = converter.convert(jwt);

        assertNotNull(auth);
        assertEquals(user, auth.getPrincipal());
        assertEquals("n/a", auth.getCredentials());
        assertTrue(auth.getAuthorities().stream()
                .anyMatch(a -> a.getAuthority().equals("ROLE_ADMIN")));
        assertTrue(auth.getAuthorities().stream()
                .anyMatch(a -> a.getAuthority().equals("ROLE_USER")));
    }

    @Test
    void convert_userNotFound_throwsBadCredentials() {
        Jwt jwt = Jwt.withTokenValue("xyz")
                .header("alg", "none")
                .claim("email", "missing@test.com")
                .build();

        when(userDetailsService.loadUserByUsername("missing@test.com"))
                .thenReturn(null);

        UserJwtAuthenticationConverter converter =
                new UserJwtAuthenticationConverter(userDetailsService);

        assertThrows(
                BadCredentialsException.class,
                () -> converter.convert(jwt)
        );
    }
}
