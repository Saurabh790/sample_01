package com.optum.fads.pgp.reportsection.api.service.impl;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.pgp.reportsection.api.domain.SeSurGrpModAccess;
import com.optum.fads.pgp.reportsection.api.domain.UiUserBase;
import com.optum.fads.pgp.reportsection.api.dto.AccessLevel;
import com.optum.fads.pgp.reportsection.api.dto.AppUser;
import com.optum.fads.pgp.reportsection.api.dto.ModuleAccess;
import com.optum.fads.pgp.reportsection.api.dto.Role;
import com.optum.fads.pgp.reportsection.api.repo.UserRepository;
import com.optum.fads.pgp.reportsection.api.service.IUserDetailsService;

@Service
public class UserDetailsService implements IUserDetailsService {

	@Autowired
	UserRepository userRepository;

	@Override
	@Transactional(readOnly = true)
	public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
		Optional<UiUserBase> optional = userRepository.findByUiEMailAddressOrUiUserId(username, username);
		optional.orElseThrow(() -> new UsernameNotFoundException("Not found: " + username));
		AppUser user = new AppUser();
		UiUserBase uiUserBase = optional.get();

		user.setUserEmail(uiUserBase.getUiEMailAddress());
		user.setUserId(uiUserBase.getUiUserId());
		user.setUserSystemId(uiUserBase.getUiSystemId());
		Role role = new Role();
		role.setId(Long.valueOf(uiUserBase.getSeUsrGrp().getSeSurGrp().getSurGrpId()).toString());
		role.setRoleName(uiUserBase.getSeUsrGrp().getSeSurGrp().getSurGrpName());
		List<SeSurGrpModAccess> surAccesses = uiUserBase.getSeUsrGrp().getSeSurGrp().getSeSurGrpModAccesses();

		List<AccessLevel> accesses = new ArrayList<AccessLevel>();
		surAccesses.forEach(surModuleAccess -> {
			accesses.add(new AccessLevel(surModuleAccess.getId().getSurModuleId(),
					ModuleAccess.getByName(surModuleAccess.getId().getSurModuleId()).toString(),
					surModuleAccess.getSeSurModule().getSurModuleName(),
					surModuleAccess.getSeSurAccess().getSurAccessId()));

		});

		role.setAllowedAccesses(accesses);
		user.setRole(role);
		return user;

	}

	

}



/*
//***********************************************
// Copyright UNITEDHEALTH GROUP CORPORATION 2018.
// This software and documentation contain confidential and
// proprietary information owned by UnitedHealth Group Corporation.
// Unauthorized use and distribution are prohibited.
//***********************************************
*/
/** 
 *  The service contains methods to retrieve and update FADS Report Section data.
 * 
 * @author Anil Wagh
 */
package com.optum.fads.pgp.reportsection.api.service.impl;

import java.time.LocalDateTime;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.Optional;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.pgp.reportsection.api.common.ListTableParams;
import com.optum.fads.pgp.reportsection.api.common.constants.ReportSectionConstants;
import com.optum.fads.pgp.reportsection.api.domain.FadsConfigT;
import com.optum.fads.pgp.reportsection.api.domain.PrmRiRptItemT;
import com.optum.fads.pgp.reportsection.api.domain.PrmRsRiT;
import com.optum.fads.pgp.reportsection.api.domain.PrmRsRiTPK;
import com.optum.fads.pgp.reportsection.api.domain.PrmRsRptSecT;
import com.optum.fads.pgp.reportsection.api.domain.PrmStudyMasterT;
import com.optum.fads.pgp.reportsection.api.domain.PrmStudyRsRiT;
import com.optum.fads.pgp.reportsection.api.domain.UiUserBase;
import com.optum.fads.pgp.reportsection.api.dto.BehaviorPatternDTO;
import com.optum.fads.pgp.reportsection.api.dto.PaginationResultRS;
import com.optum.fads.pgp.reportsection.api.dto.ReportItemDTO;
import com.optum.fads.pgp.reportsection.api.dto.ReportSectionDTO;
import com.optum.fads.pgp.reportsection.api.exception.ReportSectionApiException;
import com.optum.fads.pgp.reportsection.api.mapper.ReportGroupDetailMapper;
import com.optum.fads.pgp.reportsection.api.repo.BehaviorPatternErDrRepository;
import com.optum.fads.pgp.reportsection.api.repo.BehaviorPatternsRepository;
import com.optum.fads.pgp.reportsection.api.repo.DataRulesRepository;
import com.optum.fads.pgp.reportsection.api.repo.FadsConfigRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportItemFormulasRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportItemsRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportSectionItemsRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportSectionsRepository;
import com.optum.fads.pgp.reportsection.api.repo.StudyRepository;
import com.optum.fads.pgp.reportsection.api.service.IReportSectionDataService;

@Service("reportSectionDataService")
//@Slf4j
public class ReportSectionDataService implements IReportSectionDataService  {

	private static final Logger logit = LoggerFactory
			.getLogger(ReportSectionDataService.class);

    private ReportSectionsRepository reportSectionsRepository; 
	private StudyRepository studyRepository;
	private ReportItemDataService reportItemDataService;
	private ReportSectionItemsRepository reportSectionItemsRepository;
    private ReportItemsRepository reportItemsRepository;
	private ReportItemFormulasRepository reportItemFormulasRepository;
	private BehaviorPatternsRepository behaviorPatternsRepository;
	private BehaviorPatternErDrRepository behaviorPatternErDrRepository;
	private DataRulesRepository dataRulesRepository;
	@Autowired
	private FadsConfigRepository fadsConfigRepository;
	@Autowired
	private ReportGroupDetailMapper reportGroupDetailMapper;
	 @Autowired
	 public ReportSectionDataService(ReportSectionsRepository reportSectionsRepository,
	    		StudyRepository studyRepository,
	    		ReportSectionItemsRepository reportSectionItemsRepository,
	    		ReportItemsRepository reportItemsRepository,
	    		ReportItemFormulasRepository reportItemFormulasRepository,
	    		BehaviorPatternsRepository behaviorPatternsRepository,
	    		BehaviorPatternErDrRepository behaviorPatternErDrRepository,
	    		DataRulesRepository dataRulesRepository) {
	        
		 	this.reportSectionsRepository = reportSectionsRepository;
		 	this.studyRepository = studyRepository;
	        this.reportSectionItemsRepository = reportSectionItemsRepository;
	        this.reportItemsRepository = reportItemsRepository;
	        this.reportItemFormulasRepository = reportItemFormulasRepository;
	        this.behaviorPatternsRepository = behaviorPatternsRepository;
	        this.behaviorPatternErDrRepository = behaviorPatternErDrRepository;
	        this.dataRulesRepository = dataRulesRepository;

	        reportItemDataService = new ReportItemDataService(reportItemsRepository,
	    			reportItemFormulasRepository, 		
	    			reportSectionItemsRepository, 		
	    			behaviorPatternsRepository,
	    			behaviorPatternErDrRepository,
	    			dataRulesRepository,
	    			reportSectionsRepository);
	    }   

	/**
	 * this method will give the Report Section records data as per filter/sort criteria - per page  
	 * 
	 * Parameters - ListTableParams (contains sort, filter conditions; page number, page size)
	 */
	public PaginationResultRS getReportSectionsList(ListTableParams listTableParams){
		int reportSectionsCount = 0;
		List<ReportSectionDTO> reportSectionDataList = null;
		List<PrmRsRptSecT> reportSectionList;
		List<PrmRsRptSecT> reportSectionsCntList = null;
		PaginationResultRS paginationResult;
		Pageable pageable = null;
		if (listTableParams.getSelectedItemIds() == null) {
			listTableParams.setSelectedItemIds(new ArrayList<>());
		}
		try {
			if (listTableParams.getSearchBy() == null) {	 
				 pageable = reportItemDataService.createPageableReports(listTableParams);
				 if (!(listTableParams.getSelectedItemIds().isEmpty())) {
					 reportSectionList = reportSectionsRepository.getAvailableReportSections(listTableParams.getSelectedItemIds(),
								pageable);
					 reportSectionsCntList = reportSectionsRepository
								.getAvailableReportSections(listTableParams.getSelectedItemIds(), null);
					reportSectionsCount = reportSectionsCntList.size();
				 } else {
					 reportSectionList = reportSectionsRepository.getReportSections(pageable);
					 reportSectionsCount = (int) reportSectionsRepository.count();
				 }
				 paginationResult = new PaginationResultRS();
				 reportSectionDataList = populateReportSectionList(reportSectionList);
				 paginationResult.setReportSectionsData(reportSectionDataList);
				 paginationResult.setTotalRecordsCount(reportSectionsCount);
			 } else {
				 paginationResult = getReportSectionsOnSearchCriteria(listTableParams);
			 }
		} catch (Exception e) {
			throw new ReportSectionApiException(e);
		}            
        return paginationResult;
	}
	/**
	 * this method is called by getReportSectionsList to apply filter and sort criteria and fetch the report section records data 
	 * 
	 * Parameters - ListTableParams (contains sort, filter conditions; page number, page size)
	 */
	 public PaginationResultRS getReportSectionsOnSearchCriteria(ListTableParams listTableParams) {
		 logit.info("Set the search criteria for retrieving report sections");
		 Pageable pageable = null;
		 int reportSectionsCount = 0;
		 int myItemsIndex = -1;
		 List<ReportSectionDTO> reportSectionDataList = null;
		 List<PrmRsRptSecT> reportSectionsList = null;
		 List<PrmRsRptSecT> reportSectionsCntList = null;
		 PaginationResultRS paginationResult = new PaginationResultRS();
		 pageable = reportItemDataService.createPageableReports(listTableParams);
		 if (listTableParams.getSearchBy().contains(ReportSectionConstants.USER_SYSTEM_ID)) {
				myItemsIndex = listTableParams.getSearchBy().indexOf(ReportSectionConstants.USER_SYSTEM_ID);
		}
		 String[] searchCriteriaItems = reportItemDataService.getSearchCriteria(listTableParams, myItemsIndex); // reportSectionNameVal, createdByVal, updatedByVal, sp ch in Name
		 logit.info("Get Report Sections List by Search Criteria");
		 if (listTableParams.getSelectedItemIds().isEmpty()) {
			 if (searchCriteriaItems[3].equals(ReportSectionConstants.SEARCH_SP_CH_IN_NM_STR)) {
				 if (myItemsIndex >= 0) {		// Retrieve my items
						reportSectionsList = reportSectionsRepository.getMyReportSectionsBySearchCritEsc(searchCriteriaItems[0], searchCriteriaItems[1], 
								searchCriteriaItems[2], searchCriteriaItems[4], pageable );
						reportSectionsCntList = reportSectionsRepository.getMyReportSectionsBySearchCritEsc(searchCriteriaItems[0], searchCriteriaItems[1], 
								searchCriteriaItems[2], searchCriteriaItems[4], null );
				} else {
					 reportSectionsList = reportSectionsRepository.getReportSectionsBySearchCritEsc(searchCriteriaItems[0], searchCriteriaItems[1], 
							 searchCriteriaItems[2], pageable );
					 reportSectionsCntList = reportSectionsRepository.getReportSectionsBySearchCritEsc(searchCriteriaItems[0], searchCriteriaItems[1], 
							 searchCriteriaItems[2], null );
				}
			} else {
				if (myItemsIndex >= 0) {		// Retrieve my items
					reportSectionsList = reportSectionsRepository.getMyReportSectionsBySearchCrit(searchCriteriaItems[0], searchCriteriaItems[1], 
							searchCriteriaItems[2], searchCriteriaItems[4], pageable );
					reportSectionsCntList = reportSectionsRepository.getMyReportSectionsBySearchCrit(searchCriteriaItems[0], searchCriteriaItems[1], 
							searchCriteriaItems[2], searchCriteriaItems[4], null );
				} else {
					reportSectionsList = reportSectionsRepository.getReportSectionsBySearchCrit(searchCriteriaItems[0], searchCriteriaItems[1], 
							searchCriteriaItems[2], pageable );
					reportSectionsCntList = reportSectionsRepository.getReportSectionsBySearchCrit(searchCriteriaItems[0], searchCriteriaItems[1], 
							searchCriteriaItems[2], null );
				}
			}
		 } else {
			 if (searchCriteriaItems[3].equals(ReportSectionConstants.SEARCH_SP_CH_IN_NM_STR)) {// set if Report Item name or Report
																								// Section name contain % or underscore
				 if (myItemsIndex >= 0) {		// Retrieve my items
					 reportSectionsList = reportSectionsRepository.getMyAvailableReportSectionsBySearchCritEsc(searchCriteriaItems[0],
							 searchCriteriaItems[1], searchCriteriaItems[2], searchCriteriaItems[4], listTableParams.getSelectedItemIds(), pageable);
					 reportSectionsCntList = reportSectionsRepository.getMyAvailableReportSectionsBySearchCritEsc(
							 searchCriteriaItems[0], searchCriteriaItems[1], searchCriteriaItems[2], searchCriteriaItems[4],
							 listTableParams.getSelectedItemIds(), null);
				 } else {
					 reportSectionsList = reportSectionsRepository.getAvailableReportSectionsBySearchCritEsc(searchCriteriaItems[0],
							 searchCriteriaItems[1], searchCriteriaItems[2], listTableParams.getSelectedItemIds(), pageable);
					 reportSectionsCntList = reportSectionsRepository.getAvailableReportSectionsBySearchCritEsc(
							 searchCriteriaItems[0], searchCriteriaItems[1], searchCriteriaItems[2],
							 listTableParams.getSelectedItemIds(), null);
				 }
			} else {
				if (myItemsIndex >= 0) {		// Retrieve my items
					reportSectionsList = reportSectionsRepository.getMyAvailableReportSectionsBySearchCrit(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], searchCriteriaItems[4], listTableParams.getSelectedItemIds(), pageable);
					reportSectionsCntList = reportSectionsRepository.getMyAvailableReportSectionsBySearchCrit(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], searchCriteriaItems[4], listTableParams.getSelectedItemIds(), null);
				 } else {
					reportSectionsList = reportSectionsRepository.getAvailableReportSectionsBySearchCrit(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], listTableParams.getSelectedItemIds(), pageable);
					reportSectionsCntList = reportSectionsRepository.getAvailableReportSectionsBySearchCrit(searchCriteriaItems[0],
							searchCriteriaItems[1], searchCriteriaItems[2], listTableParams.getSelectedItemIds(), null);
				 }
			}
		 }
		 reportSectionsCount = reportSectionsCntList.size();
		 logit.info("Total Report Section records retrieved = {}", reportSectionsList.size());
		 logit.info("Total number of Report Section records for search criteria = {}", reportSectionsCount);
		if (!reportSectionsList.isEmpty()) {
			 reportSectionDataList = populateReportSectionList(reportSectionsList);
			 paginationResult.setReportSectionsData(reportSectionDataList);
		 } else {
			 paginationResult.setReportSectionsData(new ArrayList<>());
			 reportSectionsCount = 0;
		 }
		 paginationResult.setTotalRecordsCount(reportSectionsCount);
		 return paginationResult;
     }
	public List<ReportSectionDTO> populateReportSectionList(List<PrmRsRptSecT> reportSectionList) {
		 List<ReportSectionDTO> reportSectionDataList = new ArrayList<>();
		 
		 for (PrmRsRptSecT reportSectionInd  : reportSectionList) {  
			 ReportSectionDTO reportSectionDTO = new ReportSectionDTO();
			 reportSectionDTO.setReportSectionId(reportSectionInd.getRsId()); 
			 reportSectionDTO.setReportSectionName(reportSectionInd.getReportSectionName()); 
			 reportSectionDTO.setCreatedBy(reportSectionInd.getUiUserBaseCr().getUiFirstName() + ReportSectionConstants.BLANK_STR + reportSectionInd.getUiUserBaseCr().getUiLastName());
			 reportSectionDTO.setCreatedDate(reportItemDataService.formatLocalDate(reportSectionInd.getCreateDate()));
			 reportSectionDTO.setModifiedBy(reportSectionInd.getUiUserBaseUpd().getUiFirstName() + ReportSectionConstants.BLANK_STR + reportSectionInd.getUiUserBaseUpd().getUiLastName());
			 reportSectionDTO.setModifiedDate(reportItemDataService.formatLocalDate(reportSectionInd.getUpdateDate())); 
			 reportSectionDTO.setCreatedBySystemId(reportSectionInd.getUiUserBaseCr().getUiSystemId());
			 reportSectionDataList.add(reportSectionDTO);  
	       }
		 return reportSectionDataList;
	 }
	/**
	 * this method will get the report section record data corresponding to Report Section ID  
	 * 
	 * Parameters - Report Section ID
	 */
	public ReportSectionDTO getReportSectionById(Integer reportSectionRecId, boolean details){
		logit.info(" Obtain Report Section for the ID = {}", reportSectionRecId );
		ReportSectionDTO reportSectionDTO = null;
		List<ReportItemDTO> reportItemDataList = new ArrayList<>();
		PrmRsRptSecT reportSectionInd;
		ReportItemDTO reportItemDTO;
		
		try {
			reportSectionInd = reportSectionsRepository.getReportSectionById(reportSectionRecId);
			if (reportSectionInd == null ) {
				throw new ReportSectionApiException(ReportSectionConstants.NO_DATA_FOUND_MSG);
			}
			reportSectionDTO = new ReportSectionDTO();
			reportSectionDTO.setReportSectionId(reportSectionRecId);
			reportSectionDTO.setReportSectionName(reportSectionInd.getReportSectionName());
			reportSectionDTO.setCreatedBy(reportSectionInd.getUiUserBaseCr().getUiFirstName() + ReportSectionConstants.BLANK_STR + reportSectionInd.getUiUserBaseCr().getUiLastName());
			reportSectionDTO.setCreatedDate(reportItemDataService.formatLocalDate(reportSectionInd.getCreateDate()));
			reportSectionDTO.setModifiedBy(reportSectionInd.getUiUserBaseUpd().getUiFirstName() + ReportSectionConstants.BLANK_STR + reportSectionInd.getUiUserBaseUpd().getUiLastName());
			reportSectionDTO.setModifiedDate(reportItemDataService.formatLocalDate(reportSectionInd.getUpdateDate())); 
			reportSectionDTO.setCreatedBySystemId(reportSectionInd.getUiUserBaseCr().getUiSystemId());
			for (PrmRsRiT prmRsRiT: reportSectionInd.getPrmRsRiTs()) {
				PrmRiRptItemT prmRiRptItemT = prmRsRiT.getPrmRiRptItemT();  
				reportItemDTO = reportItemDataService.populateReportItemInd(prmRiRptItemT);
				reportItemDTO.setOrder(prmRsRiT.getRiOrder());
				if (details) {
					reportItemDTO.setNumeratorBehaviorPatterns(new ArrayList<>());
					reportItemDTO.setDenominatorBehaviorPatterns(new ArrayList<>());
					List<BehaviorPatternDTO> selectedBehaviorPatternList =reportItemDataService.getBehaviorPatterns(prmRiRptItemT);
					for (BehaviorPatternDTO behaviorPatternDTO : selectedBehaviorPatternList) {
						if (behaviorPatternDTO.getType().equals(ReportSectionConstants.NUM_STR)) {
							reportItemDTO.getNumeratorBehaviorPatterns().add(behaviorPatternDTO);
						} else {
							reportItemDTO.getDenominatorBehaviorPatterns().add(behaviorPatternDTO);
						}
					}
				}
				reportItemDataList.add(reportItemDTO);
			}
			reportSectionDTO.setReportItems(reportItemDataList);
		} catch (Exception e) {
			throw new ReportSectionApiException(e);
		} 
        return reportSectionDTO;
	}
	/**
	  * this method will delete selected Report Section 
	  * 
	  * Parameters - Report Section Id
	 */		
	 public List<String> deleteReportSection(Integer reportSectionId){
		 int reportSectionsDeleted = 0;
		 boolean delReportSectionConstraint = false;
		 List<String> deleteReportSectionMessages = new ArrayList<>();
		 List<Integer> pbIdList;
		 logit.info(" Delete Report Section for input ID" );
			try {
				PrmRsRptSecT reportSection = reportSectionsRepository.getReportSectionById(reportSectionId);
				if (reportSection == null) {
					deleteReportSectionMessages.add(ReportSectionConstants.REPORT_SECTION_DOES_NOT_EXIST);
				} else {
					// Check if Report Section is assigned to Study via PrmStudyRsRiT
					List<PrmStudyRsRiT> prmStudyRsRiListInDb = reportSectionItemsRepository.getStudyRsRisByRsId(reportSectionId);
					if (!prmStudyRsRiListInDb.isEmpty()) {
						if (prmStudyRsRiListInDb.size() > 1) {
							pbIdList = new ArrayList<>();
							for (PrmStudyRsRiT prmStudyRsRiT : prmStudyRsRiListInDb ) {
								pbIdList.add(prmStudyRsRiT.getId().getPbId());
							}
							List<PrmStudyMasterT> studyList = studyRepository.getStudyByPbIds(pbIdList);
							for (PrmStudyMasterT study: studyList) {
								deleteReportSectionMessages.add(ReportSectionConstants.STUDY_CONST + study.getPbName());
							}
						} else { 
							PrmStudyMasterT prmStudyMasterT = studyRepository.getStudyByPbId(prmStudyRsRiListInDb.get(0).getId().getPbId());
							deleteReportSectionMessages.add(ReportSectionConstants.STUDY_CONST + prmStudyMasterT.getPbName());
						}
						delReportSectionConstraint = true;
					}
					if (!delReportSectionConstraint) {
						int reportSectionItemsDeleted = reportSectionItemsRepository.deleteReportSectionItemsByRsId(reportSectionId);
						logit.info("Deleted {} Report Section Item record(s) for input RS ID {}", reportSectionItemsDeleted, reportSectionId );
						reportSectionsDeleted = reportSectionsRepository.deleteReportSection(reportSectionId);
						if (reportSectionsDeleted > 0) {
							deleteReportSectionMessages.add(ReportSectionConstants.DELETE_REPORT_SECTION_SUCCESS);
						} else {
							deleteReportSectionMessages.add(ReportSectionConstants.DELETE_REPORT_SECTION_FAIL);
						}
					}
				}
			} catch (Exception e) {
				throw new ReportSectionApiException(e );
			} 
	        return deleteReportSectionMessages;
		}
	 /**
	  * this method will create a new Report Section  
	  * 
	  * Parameters - reportItemDTO
	 */
	 public ReportSectionDTO addReportSection(ReportSectionDTO reportSectionDTO){
		 ReportSectionDTO retReportSectionDTO = new ReportSectionDTO();
		 String reportSectionNameLc = reportSectionDTO.getReportSectionName().toLowerCase().trim();
		 
		 try {
			
			PrmRsRptSecT reportSection = reportSectionsRepository.getReportSectionByName(reportSectionNameLc);
			if (reportSection == null) {
				Integer reportSectionId = reportSectionsRepository.retrieveNextRsId();
				reportSectionDTO.setReportSectionId(reportSectionId);
				saveReportSection(reportSectionDTO);
				if(!reportSectionDTO.getReportItems().isEmpty()) { 
					saveReportSectionItems(reportSectionDTO.getReportItems(), reportSectionId);
				} 
				retReportSectionDTO.setReportSectionId(reportSectionId);
				retReportSectionDTO.setReportSectionName(reportSectionDTO.getReportSectionName().trim());
				retReportSectionDTO.setCreatedDate(reportSectionDTO.getCreatedDate());
				retReportSectionDTO.setModifiedDate(reportSectionDTO.getModifiedDate());
				retReportSectionDTO.setModifiedBySystemId(reportSectionDTO.getModifiedBySystemId());
				retReportSectionDTO.setCreatedBySystemId(reportSectionDTO.getCreatedBySystemId());
			} else {
				retReportSectionDTO.setReportSectionId(reportSection.getRsId());
				retReportSectionDTO.setReportSectionName(ReportSectionConstants.REPORT_ITEM_EXISTS);
				retReportSectionDTO.setModifiedBySystemId(reportSection.getUiUserBaseUpd().getUiSystemId());
				retReportSectionDTO.setCreatedBySystemId(reportSection.getUiUserBaseCr().getUiSystemId());
			}
		} catch (Exception e) {
			throw new ReportSectionApiException(e);
		} 	
	    return retReportSectionDTO;
	}	
	 /**
	  * this method will save the new Report Section to the Database
	  * 
	  * Parameters - reportSectionDTO, Current Date
	 */
	 private void saveReportSection(ReportSectionDTO reportSectionDTO) {
		 PrmRsRptSecT rs = new PrmRsRptSecT();
		 UiUserBase uiUserBaseCr = new UiUserBase();	
		 DateTimeFormatter dateTimeFormatter = DateTimeFormatter.ofPattern(ReportSectionConstants.DATE_FORMAT_MMDDYYYY_HHMMSS_A,
					Locale.ENGLISH);
			uiUserBaseCr.setUiSystemId(reportSectionDTO.getCreatedBySystemId());
			rs.setUiUserBaseCr(uiUserBaseCr);				// Set UiUserBase
			UiUserBase uiUserBaseUpd = new UiUserBase();
			uiUserBaseUpd.setUiSystemId(reportSectionDTO.getModifiedBySystemId());
			rs.setUiUserBaseUpd(uiUserBaseUpd);
			rs.setRsId(reportSectionDTO.getReportSectionId());
			rs.setReportSectionName(reportSectionDTO.getReportSectionName().trim()); 
			  
			rs.setCreateDate(LocalDateTime.parse(reportSectionDTO.getCreatedDate(), dateTimeFormatter));
			rs.setUpdateDate(LocalDateTime.parse(reportSectionDTO.getModifiedDate(), dateTimeFormatter));
			reportSectionsRepository.saveAndFlush(rs);
			logit.info("Saved the Report Section Id {}", reportSectionDTO.getReportSectionId());
		}
	 /**
		 * this method will update a Report Section records based on input data  
		 * 
		 * Parameters - reportSectionDTO
		 */	
	@Transactional
	public String updateReportSection(Integer reportSectionId, ReportSectionDTO reportSectionDTO){
		DateTimeFormatter dateTimeFormatter = DateTimeFormatter.ofPattern(ReportSectionConstants.DATE_FORMAT_MMDDYYYY_HHMMSS_A,
				Locale.ENGLISH);
		try {
			
			PrmRsRptSecT prmRsRptSecT = reportGroupDetailMapper.convertToPrmRsRptSecT(reportSectionDTO);
			PrmRsRptSecT reportSectionInd = reportSectionsRepository.getReportSectionById(reportSectionId);
			prmRsRptSecT.setCreateDate(reportSectionInd.getCreateDate());
			prmRsRptSecT.setUpdateDate(LocalDateTime.parse(reportSectionDTO.getModifiedDate(), dateTimeFormatter));
			prmRsRptSecT = reportSectionsRepository.saveAndFlush(prmRsRptSecT);
			reportSectionItemsRepository.deleteReportSectionItemsByRsId(reportSectionId);
			if(!reportSectionDTO.getReportItems().isEmpty()) { 
				saveReportSectionItems(reportSectionDTO.getReportItems(), reportSectionId);
			}
			logit.info("Updated Report Section for the ID = {}", reportSectionId);
		} catch (Exception e) {
			throw new ReportSectionApiException(e );
		} 
		return ReportSectionConstants.UPDATE_REPORT_SECTION_SUCCESS;
	}

	private void saveReportSectionItems(List<ReportItemDTO> items, Integer reportSectionId){
		List<PrmRsRiT> rsRiList =new ArrayList<>(); 	
		for (ReportItemDTO reportItemDTO : items) {
			PrmRsRiT prmRsRiT = new PrmRsRiT();
			PrmRsRiTPK prmRsRiTPK = new PrmRsRiTPK();
			prmRsRiTPK.setRsId(reportSectionId);
			prmRsRiTPK.setRiId(reportItemDTO.getReportItemId());
			prmRsRiT.setId(prmRsRiTPK);
			prmRsRiT.setRiOrder(reportItemDTO.getOrder());
			rsRiList.add(prmRsRiT);
		}
		logit.info("Save the Report Section via ReportSectionsRepository");
		reportSectionItemsRepository.saveAll(rsRiList);
		reportSectionItemsRepository.flush();
	}	
	/**
	 * this method will give the available Report Item records data (per page) for a Report Section ID
	 * 
	 * Parameters - reportSectionId, ListTableParams (contains sort, filter conditions; page number, page size)
	 */ 
	public List<ReportItemDTO> getAvailableReportItems(Integer reportSectionId){
		logit.info("Get Available  Report Items List ");
		List<ReportItemDTO> availableReportItemDataList = null;
		List<PrmRiRptItemT> reportItemRIList;
		try {
			reportItemRIList = reportItemsRepository.getAvailableReportItems(reportSectionId);
			if (!reportItemRIList.isEmpty()) {
				availableReportItemDataList = reportItemDataService.populateReportItemList(reportItemRIList);
			} else {
				logit.info(ReportSectionConstants.NO_DATA_FOUND_MSG);
				throw new ReportSectionApiException(ReportSectionConstants.NO_DATA_FOUND_MSG);
			}
		} catch (Exception e) {
			throw new ReportSectionApiException(e);
		}            
        return availableReportItemDataList;
	}
	/**
	 * this method will give the selected Report Item records data for a Report Section ID
	 * 
	 * Parameters - reportSectionId
	 */ 
	public List<ReportItemDTO> getSelectedReportItems(Integer reportSectionId){
		logit.info("Get Selected  Report Items List ");
		List<ReportItemDTO> selectedReportItemsList = null;
		List<PrmRiRptItemT> ruleItemRIList;
		try {
			List<PrmRsRiT> rsriList = reportSectionItemsRepository.getRsRisByRsId(reportSectionId);
			logit.info("{} Report Item records retrieved for Report Section ID = {}" , rsriList.size(), reportSectionId);
			if (rsriList.isEmpty()) {
				selectedReportItemsList = new ArrayList<>();
			} else {
				List<Integer> reportItemIdList = new ArrayList<>();
				 for ( PrmRsRiT rsriInd : rsriList) {
					 reportItemIdList.add(rsriInd.getId().getRiId());
				 }	
				 ruleItemRIList = reportItemsRepository.getReportItemsByIds(reportItemIdList);
				 selectedReportItemsList = reportItemDataService.populateReportItemList(ruleItemRIList);	
			}
		} catch (Exception e) {
			throw new ReportSectionApiException(e);
		}            
        return selectedReportItemsList;
	}
	/** 
	 * This method will get the ZoneId corresponding to the time zone used at the customer site
	 * Parameters: the time zone is stored in an entry in the FADS_CONFIG_T table 
	 */
	public ZoneId getZoneId() {
		ZoneId zid = ZoneId.systemDefault();;
		Optional<FadsConfigT> optional = fadsConfigRepository.findById(ReportSectionConstants.DATE_TIME_ZONE_ID);
		if (optional.isPresent()) {
			FadsConfigT fadsConfigT = optional.get();
			zid = ZoneId.of(fadsConfigT.getOptionValue());	//  the zone ID corresponding to date-time zone used
		}
		return zid;

	}
}
