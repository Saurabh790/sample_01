package com.optum.fads.userroles.api.domain;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import jakarta.validation.constraints.Size;
import lombok.Getter;
import lombok.Setter;

import java.math.BigDecimal;

@Getter
@Setter
@Entity
@Table(name = "SE_CASE_GRP")
public class SeCaseGrp {
    @Id
    @Column(name = "CASE_GRP_ID", nullable = false, precision = 5)
    private BigDecimal id;

    @Size(max = 40)
    @Column(name = "CASE_GRP_NAME", length = 40)
    private String caseGrpName;

}

package com.optum.fads.userroles.api.domain;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import jakarta.validation.constraints.Size;
import lombok.Getter;
import lombok.Setter;

import java.math.BigDecimal;

@Getter
@Setter
@Entity
@Table(name = "SE_FADS_GRP")
public class SeFadsGrp {
    @Id
    @Column(name = "FADS_GRP_ID", nullable = false, precision = 5)
    private BigDecimal id;

    @Size(max = 40)
    @Column(name = "FADS_GRP_NAME", length = 40)
    private String fadsGrpName;

}

package com.optum.fads.userroles.api.domain;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import jakarta.validation.constraints.Size;
import lombok.Getter;
import lombok.Setter;

import java.math.BigDecimal;

@Getter
@Setter
@Entity
@Table(name = "SE_SUR_GRP")
public class SeSurGrp {
    @Id
    @Column(name = "SUR_GRP_ID", nullable = false, precision = 5)
    private BigDecimal id;

    @Size(max = 40)
    @Column(name = "SUR_GRP_NAME", length = 40)
    private String surGrpName;

}
package com.optum.fads.userroles.api.domain;

import jakarta.persistence.*;
import jakarta.validation.constraints.Size;
import lombok.Getter;
import lombok.Setter;

import java.time.Instant;

@Getter
@Setter
@Entity
@Table(name = "SE_USR_GRP")
public class SeUsrGrp {
    @Id
    @Size(max = 25)
    @Column(name = "UI_SYSTEM_ID", nullable = false, length = 25)
    private String uiSystemId;

    @MapsId
    @OneToOne(fetch = FetchType.LAZY, optional = false)
    @JoinColumn(name = "UI_SYSTEM_ID", nullable = false)
    private UiUserBase uiUserBase;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "FADS_GRP_ID")
    private SeFadsGrp fadsGrp;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "FADS_SUR_GRP_ID")
    private SeSurGrp fadsSurGrp;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "FADS_CASE_GRP_ID")
    private SeCaseGrp fadsCaseGrp;


}
package com.optum.fads.userroles.api.domain;

import jakarta.persistence.*;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Size;
import lombok.Getter;
import lombok.Setter;

import java.time.Instant;

@Getter
@Setter
@Entity
@Table(name = "UI_USER_BASE")
public class UiUserBase {
    @Id
    @Size(max = 25)
    @Column(name = "UI_SYSTEM_ID", nullable = false, length = 25)
    private String uiSystemId;

    @Size(max = 50)
    @NotNull
    @Column(name = "UI_USER_ID", nullable = false, length = 50)
    private String uiUserId;

    @Size(max = 15)
    @Column(name = "UI_TITLE", length = 15)
    private String uiTitle;

    @Size(max = 40)
    @Column(name = "UI_LAST_NAME", length = 40)
    private String uiLastName;

    @Size(max = 20)
    @Column(name = "UI_FIRST_NAME", length = 20)
    private String uiFirstName;

    @Column(name = "UI_USER_INACTIVE")
    private Character uiUserInactive;

    @Size(max = 50)
    @NotNull
    @Column(name = "UI_E_MAIL_ADDRESS", nullable = false, length = 50)
    private String uiEMailAddress;

    @Size(max = 25)
    @Column(name = "UI_CREATED_BY", length = 25)
    private String uiCreatedBy;

    @Column(name = "UI_CREATED_DT")
    private Instant uiCreatedDt;

    @OneToOne(mappedBy = "uiUserBase")
    private SeUsrGrp seUsrGrp;

}

package com.optum.fads.userroles.api.dto;

public class UserListItem {
    private final String uiSystemId;
    private final String uiUserId;
    private final String lastName;
    private final String firstName;
    private final String title;
    private final String email;
    private final String fadsGrpName;
    private final String surGrpName;
    private final String caseGrpName;

    public UserListItem(String uiSystemId, String uiUserId, String lastName, String firstName,
                        String title, String email, String fadsGrpName, String surGrpName, String caseGrpName) {
        this.uiSystemId = uiSystemId;
        this.uiUserId = uiUserId;
        this.lastName = lastName;
        this.firstName = firstName;
        this.title = title;
        this.email = email;
        this.fadsGrpName = fadsGrpName;
        this.surGrpName = surGrpName;
        this.caseGrpName = caseGrpName;
    }

	public String getUiSystemId() {
		return uiSystemId;
	}

	public String getUiUserId() {
		return uiUserId;
	}

	public String getLastName() {
		return lastName;
	}

	public String getFirstName() {
		return firstName;
	}

	public String getTitle() {
		return title;
	}

	public String getEmail() {
		return email;
	}

	public String getFadsGrpName() {
		return fadsGrpName;
	}

	public String getSurGrpName() {
		return surGrpName;
	}

	public String getCaseGrpName() {
		return caseGrpName;
	}

    
    
    
}
package com.optum.fads.userroles.api.mapper;

import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.ReportingPolicy;

import com.optum.fads.userroles.api.domain.UiUserBase;
import com.optum.fads.userroles.api.dto.UserListItem;


@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface UserListItemMapper {

    @Mapping(target = "uiSystemId", source = "uiSystemId")
    @Mapping(target = "uiUserId", source = "uiUserId")
    @Mapping(target = "lastName", source = "uiLastName")
    @Mapping(target = "firstName", source = "uiFirstName")
    @Mapping(target = "title", source = "uiTitle")
    @Mapping(target = "email", source = "uiEMailAddress")
    @Mapping(target = "fadsGrpName", source = "seUsrGrp.fadsGrp.fadsGrpName")
    @Mapping(target = "surGrpName", source = "seUsrGrp.fadsSurGrp.surGrpName")
    @Mapping(target = "caseGrpName", source = "seUsrGrp.fadsCaseGrp.caseGrpName")
    UserListItem toDto(UiUserBase entity);
}
package com.optum.fads.userroles.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;

import com.optum.fads.userroles.api.domain.UiUserBase;

public interface UiUserBaseRepository
        extends JpaRepository<UiUserBase, String>,
                JpaSpecificationExecutor<UiUserBase> {
}
package com.optum.fads.userroles.api.service;

import java.util.Map;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;

import com.optum.fads.userroles.api.dto.UserListItem;

public interface UserService {
    Page<UserListItem> getUsersList(Map<String, String> filters, Pageable pageable, Map<String, String> fieldMap);
}
package com.optum.fads.userroles.api.service;

import java.util.Map;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;

import com.optum.fads.userroles.api.domain.UiUserBase;
import com.optum.fads.userroles.api.dto.UserListItem;
import com.optum.fads.userroles.api.mapper.UserListItemMapper;
import com.optum.fads.userroles.api.repo.UiUserBaseRepository;
import com.optum.fads.userroles.api.utility.UserSpecification;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class UserServiceImpl implements UserService {

    private final UiUserBaseRepository repo;
    private final UserListItemMapper mapper;

    @Override
    public Page<UserListItem> getUsersList(Map<String, String> filters, Pageable pageable, Map<String, String> fieldMap) {
        Specification<UiUserBase> spec = UserSpecification.containsAll(filters, fieldMap);

        Page<UiUserBase> page = (spec == null)
                ? repo.findAll(pageable)            
                : repo.findAll(spec, pageable);         
        return page.map(mapper::toDto);
    }
}

package com.optum.fads.userroles.api.utility;

import com.optum.fads.userroles.api.domain.UiUserBase;
import jakarta.persistence.criteria.*;
import org.springframework.data.jpa.domain.Specification;

import java.util.*;

public final class UserSpecification {

	private UserSpecification() {
	}

	
	public static Specification<UiUserBase> containsAll(Map<String, String> filters, Map<String, String> fieldMap) {
		if (filters == null || filters.isEmpty()) {
			return null; 
		}

		return (root, query, cb) -> {
			boolean needsDistinct = filters.keySet().stream().map(fieldMap::get).filter(Objects::nonNull)
					.anyMatch(path -> path.contains("."));
			if (needsDistinct) {
				query.distinct(true);
			}

			List<Predicate> predicates = new ArrayList<>();

			for (Map.Entry<String, String> e : filters.entrySet()) {
				String apiField = e.getKey();
				String value = e.getValue();
				if (value == null || value.isBlank())
					continue;

				String entityPath = fieldMap.get(apiField);
				if (entityPath == null)
					continue; 

				Expression<String> pathExpr = resolvePath(root, entityPath);
				predicates.add(cb.like(cb.lower(pathExpr), "%" + value.toLowerCase(Locale.ROOT) + "%"));
			}

			return predicates.isEmpty() ? cb.conjunction() : cb.and(predicates.toArray(new Predicate[0]));
		};
	}

	
	@SuppressWarnings("unchecked")
	private static Expression<String> resolvePath(From<?, ?> root, String dotPath) {
		String[] parts = dotPath.split("\\.");
		From<?, ?> from = root;
		Path<?> path = root;

		for (int i = 0; i < parts.length; i++) {
			String part = parts[i];

			if (i < parts.length - 1) {
				from = safeJoin(from, part);
				path = from;
			} else {
				path = path.get(part);
			}
		}
		return (Expression<String>) path.as(String.class);
	}

	private static From<?, ?> safeJoin(From<?, ?> from, String attribute) {
		for (Join<?, ?> j : from.getJoins()) {
			if (j.getAttribute() != null && attribute.equals(j.getAttribute().getName())) {
				return (From<?, ?>) j;
			}
		}
		return from.join(attribute, JoinType.LEFT);
	}
}
package com.optum.fads.userroles.api.controllers;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.optum.fads.userroles.api.dto.AllDropdownsResponse;
import com.optum.fads.userroles.api.dto.UserListItem;
import com.optum.fads.userroles.api.service.GroupDropdownService;
import com.optum.fads.userroles.api.service.UserService;

@RestController
public class UserRolesController {

	private static final Map<String, String> FIELD_MAP;
	static {
		Map<String, String> m = new LinkedHashMap<>();
		m.put("uiSystemId", "uiSystemId");
		m.put("uiUserId", "uiUserId");
		m.put("lastName", "uiLastName");
		m.put("firstName", "uiFirstName");
		m.put("title", "uiTitle");
		m.put("email", "uiEMailAddress");
		m.put("fadsGrpName", "seUsrGrp.fadsGrp.fadsGrpName");
		m.put("surGrpName", "seUsrGrp.fadsSurGrp.surGrpName");
		m.put("caseGrpName", "seUsrGrp.fadsCaseGrp.caseGrpName");
		FIELD_MAP = Collections.unmodifiableMap(m);
	}

	private final UserService userService;
	private final GroupDropdownService groupDropdownService;

	public UserRolesController(UserService userService, GroupDropdownService groupDropdownService) {
		this.userService = userService;
		this.groupDropdownService = groupDropdownService;
	}

	@GetMapping(value = "/findAllByPageable", headers = "Accept=application/json")
	public Page<UserListItem> findAllByPageable(
			@RequestParam(name = "pageNumber", defaultValue = "1") Integer pageNumber,
			@RequestParam(name = "recordsPerPage", defaultValue = "10") Integer recordsPerPage,
			@RequestParam(name = "sortBy", defaultValue = "lastName") String sortByCsv,
			@RequestParam(name = "sortOrder", defaultValue = "1") String sortOrderCsv,
			@RequestParam(name = "searchBy", required = false) List<String> searchBy,
			@RequestParam(name = "searchInput", required = false) List<String> searchInput) {
		int pageIdx = (pageNumber != null && pageNumber > 0) ? pageNumber - 1 : 0;
		Pageable pg = buildPageable(sortByCsv, sortOrderCsv, pageIdx, recordsPerPage);
		Map<String, String> filters = buildFilters(searchBy, searchInput);
		return userService.getUsersList(filters, pg, FIELD_MAP);
	}

	private Pageable buildPageable(String sortByCsv, String sortOrderCsv, int pageIdx, int size) {
		List<Sort.Order> orders = buildSort(sortByCsv, sortOrderCsv);
		if (orders.isEmpty()) {
			orders = List.of(Sort.Order.asc(FIELD_MAP.get("lastName")));
		}
		return PageRequest.of(pageIdx, size, Sort.by(orders));
	}

	private List<Sort.Order> buildSort(String sortByCsv, String sortOrderCsv) {
		List<String> sortBy = Arrays.stream(sortByCsv.split(",")).map(String::trim).filter(s -> !s.isBlank()).toList();

		List<Integer> orders = Arrays.stream(sortOrderCsv.split(",")).map(String::trim).filter(s -> !s.isBlank())
				.map(v -> "1".equals(v) ? 1 : 0).toList();

		List<Integer> padded = padOrders(orders, sortBy.size());

		List<Sort.Order> result = new ArrayList<>();
		for (int i = 0; i < sortBy.size(); i++) {
			String apiField = sortBy.get(i);
			String entityPath = FIELD_MAP.get(apiField);
			if (entityPath == null)
				continue;
			boolean asc = padded.get(i) == 1;
			result.add(asc ? Sort.Order.asc(entityPath) : Sort.Order.desc(entityPath));
		}
		return result;
	}

	private List<Integer> padOrders(List<Integer> orders, int targetSize) {
		if (orders.isEmpty()) {
			return Collections.nCopies(targetSize, 1);
		}
		List<Integer> out = new ArrayList<>(orders);
		while (out.size() < targetSize) {
			out.add(out.get(out.size() - 1));
		}
		return out;
	}

	private Map<String, String> buildFilters(List<String> searchBy, List<String> searchInput) {
		if (searchBy == null || searchInput == null || searchBy.isEmpty() || searchInput.isEmpty()) {
			return Collections.emptyMap();
		}
		int size = Math.min(searchBy.size(), searchInput.size());
		Map<String, String> map = new LinkedHashMap<>(size);
		for (int i = 0; i < size; i++) {
			map.put(searchBy.get(i), searchInput.get(i));
		}
		return map;
	}

	@GetMapping("/dropdowns")
	public AllDropdownsResponse getAllDropdowns() {
		return groupDropdownService.getAllDropdowns();
	}
}


in currrent above implementation we are doing change in a differenwat way although its working but I want in another approach as given below for another api 
package com.optum.fads.userroles.api.controllers;

import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.optum.fads.userroles.api.dto.UserHistoryResponse;
import com.optum.fads.userroles.api.service.IUserHistory;

@RestController
public class UserRolesHistoryController {

    private static final String DEFAULT_SORT_FIELD = "changeDt";
    
    private final IUserHistory userHistoryService;

    public UserRolesHistoryController(IUserHistory userHistoryService) {
        this.userHistoryService = userHistoryService;
    }

    @GetMapping("/api/getUserHistory")
    public UserHistoryResponse getAllUserHistory(
            @RequestParam(defaultValue = "1") int pageNumber,
            @RequestParam(defaultValue = "10") int recordsPerPage,
            @RequestParam(defaultValue = DEFAULT_SORT_FIELD) String sortBy,
            @RequestParam(defaultValue = "-1") int sortOrder,
            @RequestParam(required = false) String searchBy,
            @RequestParam(required = false) String searchInput) {
        
        // Map DTO field names to entity field names
        String entitySortField = mapToEntityField(sortBy);
        
        // Create Sort object based on sortBy and sortOrder
        Sort.Direction direction = sortOrder == -1 ? Sort.Direction.DESC : Sort.Direction.ASC;
        Sort sort = Sort.by(direction, entitySortField);
        
        // Convert to zero-based page index for Spring Data
        Pageable pageable = PageRequest.of(pageNumber - 1, recordsPerPage, sort);
        
        // Call service with search parameters
        return userHistoryService.getAllUserHistory(pageable, searchBy, searchInput);
    }

    /**
     * Maps DTO field names to entity field names for sorting
     */
    private String mapToEntityField(String dtoField) {
        return switch (dtoField) {
            case "histSeqNum" -> "id.histSeqNum";
            case "changeUsr" -> "changeUsr.uiSystemId";
            case "uiSystemId" -> "uiSystem.uiSystemId";
            case "fadsGrpId" -> "fadsGrp.id";
            case "fadsSurGrpId" -> "fadsSurGrp.id";
            case "fadsCaseGrpId" -> "fadsCaseGrp.id";
            case "uiUserId" -> "uiUserId";
            case "uiLastName" -> "uiLastName";
            case "uiFirstName" -> "uiFirstName";
            case "uiEmailAddress" -> "uiEMailAddress";
            case DEFAULT_SORT_FIELD -> DEFAULT_SORT_FIELD;
            default -> DEFAULT_SORT_FIELD; // default sort field
        };
    }
}

package com.optum.fads.userroles.api.domain;

import jakarta.persistence.*;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Size;
import lombok.Getter;
import lombok.Setter;

import java.time.LocalDateTime;

@Getter
@Setter
@Entity
@Table(name = "UI_USER_HISTORY")
public class UiUserHistory {
    @EmbeddedId
    private UiUserHistoryId id;

    @MapsId("changeUsr")
    @ManyToOne(fetch = FetchType.LAZY, optional = false)
    @JoinColumn(name = "CHANGE_USR", nullable = false)
    private UiUserBase changeUsr;

    @NotNull
    @Column(name = "CHANGE_DT", nullable = false)
    private LocalDateTime changeDt;

    @NotNull
    @ManyToOne(fetch = FetchType.LAZY, optional = false)
    @JoinColumn(name = "UI_SYSTEM_ID", nullable = false)
    private UiUserBase uiSystem;

    @Size(max = 25)
    @NotNull
    @Column(name = "UI_USER_ID", nullable = false, length = 25)
    private String uiUserId;

    @Size(max = 15)
    @Column(name = "UI_TITLE", length = 15)
    private String uiTitle;

    @Size(max = 40)
    @Column(name = "UI_LAST_NAME", length = 40)
    private String uiLastName;

    @Size(max = 20)
    @Column(name = "UI_FIRST_NAME", length = 20)
    private String uiFirstName;

    @Size(max = 50)
    @NotNull
    @Column(name = "UI_E_MAIL_ADDRESS", nullable = false, length = 50)
    private String uiEMailAddress;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "FADS_GRP_ID")
    private SeFadsGrp fadsGrp;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "FADS_SUR_GRP_ID")
    private SeSurGrp fadsSurGrp;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "FADS_CASE_GRP_ID")
    private SeCaseGrp fadsCaseGrp;

}

package com.optum.fads.userroles.api.domain;

import jakarta.persistence.Column;
import jakarta.persistence.Embeddable;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Size;
import lombok.Getter;
import lombok.Setter;
import org.hibernate.Hibernate;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.Objects;

@Getter
@Setter
@Embeddable
public class UiUserHistoryId implements Serializable {
    private static final long serialVersionUID = 6868934681267323600L;
    @Size(max = 25)
    @NotNull
    @Column(name = "CHANGE_USR", nullable = false, length = 25)
    private String changeUsr;

    @NotNull
    @Column(name = "HIST_SEQ_NUM", nullable = false, precision = 7)
    private BigDecimal histSeqNum;

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || Hibernate.getClass(this) != Hibernate.getClass(o)) return false;
        UiUserHistoryId entity = (UiUserHistoryId) o;
        return Objects.equals(this.changeUsr, entity.changeUsr) &&
                Objects.equals(this.histSeqNum, entity.histSeqNum);
    }

    @Override
    public int hashCode() {
        return Objects.hash(changeUsr, histSeqNum);
    }

}
package com.optum.fads.userroles.api.dto;

import java.util.List;

public class UserHistoryResponse {
    private final List<UserListItemHistory> data;
    private final long totalRecordsCount;

    public UserHistoryResponse(List<UserListItemHistory> data, long totalRecordsCount) {
        this.data = data;
        this.totalRecordsCount = totalRecordsCount;
    }

    public List<UserListItemHistory> getData() {
        return data;
    }

    public long getTotalRecordsCount() {
        return totalRecordsCount;
    }
}
package com.optum.fads.userroles.api.dto;

import java.math.BigDecimal;
import java.time.LocalDateTime;

public class UserListItemHistory {
    
    private final String uiSystemId;           // UI_SYSTEM_ID - UI_USER_BASE.SYSTEM_ID
    private final BigDecimal histSeqNum;       // HIST_SQ_NUM - Autopopulate (group by UI_SYSTEM_ID)
    private final LocalDateTime changeDt;      // CHANGE_DT - System Date
    private final String changeUsr;            // CHANGE_USR - UI_USER_BASE.SYSTEM_ID
    private final BigDecimal fadsGrpId;        // FADS_GRP_ID - SE_USR_GRP.FADS_GRP_ID
    private final BigDecimal fadsSurGrpId;     // FADS_SUR_GRP_ID - SE_USR_GRP.FADS_SUR_GRP_ID (on UI_SYSTEM_ID)
    private final BigDecimal fadsCaseGrpId;    // FADS_CASE_GRP_ID - SE_USR_GRP.FADS_CASE_GRP_ID
    private final String uiUserId;             // UI_USER_ID - UI_USER_BASE.UI_USER_ID
    private final String uiLastName;           // UI_LAST_NAME - UI_USER_BASE.UI_LAST_NAME
    private final String uiFirstName;          // UI_FIRST_NAME - UI_USER_BASE.UI_FIRST_NAME
    private final String uiEmailAddress;       // UI_EMAIL_ADDRESS - UI_USER_BASE.UI_EMAIL_ADDRESS

    private UserListItemHistory(Builder builder) {
        this.uiSystemId = builder.uiSystemId;
        this.histSeqNum = builder.histSeqNum;
        this.changeDt = builder.changeDt;
        this.changeUsr = builder.changeUsr;
        this.fadsGrpId = builder.fadsGrpId;
        this.fadsSurGrpId = builder.fadsSurGrpId;
        this.fadsCaseGrpId = builder.fadsCaseGrpId;
        this.uiUserId = builder.uiUserId;
        this.uiLastName = builder.uiLastName;
        this.uiFirstName = builder.uiFirstName;
        this.uiEmailAddress = builder.uiEmailAddress;
    }

    public static Builder builder() {
        return new Builder();
    }

    public static class Builder {
        private String uiSystemId;
        private BigDecimal histSeqNum;
        private LocalDateTime changeDt;
        private String changeUsr;
        private BigDecimal fadsGrpId;
        private BigDecimal fadsSurGrpId;
        private BigDecimal fadsCaseGrpId;
        private String uiUserId;
        private String uiLastName;
        private String uiFirstName;
        private String uiEmailAddress;

        private Builder() {}

        public Builder uiSystemId(String uiSystemId) {
            this.uiSystemId = uiSystemId;
            return this;
        }

        public Builder histSeqNum(BigDecimal histSeqNum) {
            this.histSeqNum = histSeqNum;
            return this;
        }

        public Builder changeDt(LocalDateTime changeDt) {
            this.changeDt = changeDt;
            return this;
        }

        public Builder changeUsr(String changeUsr) {
            this.changeUsr = changeUsr;
            return this;
        }

        public Builder fadsGrpId(BigDecimal fadsGrpId) {
            this.fadsGrpId = fadsGrpId;
            return this;
        }

        public Builder fadsSurGrpId(BigDecimal fadsSurGrpId) {
            this.fadsSurGrpId = fadsSurGrpId;
            return this;
        }

        public Builder fadsCaseGrpId(BigDecimal fadsCaseGrpId) {
            this.fadsCaseGrpId = fadsCaseGrpId;
            return this;
        }

        public Builder uiUserId(String uiUserId) {
            this.uiUserId = uiUserId;
            return this;
        }

        public Builder uiLastName(String uiLastName) {
            this.uiLastName = uiLastName;
            return this;
        }

        public Builder uiFirstName(String uiFirstName) {
            this.uiFirstName = uiFirstName;
            return this;
        }

        public Builder uiEmailAddress(String uiEmailAddress) {
            this.uiEmailAddress = uiEmailAddress;
            return this;
        }

        public UserListItemHistory build() {
            return new UserListItemHistory(this);
        }
    }

    public String getUiSystemId() {
        return uiSystemId;
    }

    public BigDecimal getHistSeqNum() {
        return histSeqNum;
    }

    public LocalDateTime getChangeDt() {
        return changeDt;
    }

    public String getChangeUsr() {
        return changeUsr;
    }

    public BigDecimal getFadsGrpId() {
        return fadsGrpId;
    }

    public BigDecimal getFadsSurGrpId() {
        return fadsSurGrpId;
    }

    public BigDecimal getFadsCaseGrpId() {
        return fadsCaseGrpId;
    }

    public String getUiUserId() {
        return uiUserId;
    }

    public String getUiLastName() {
        return uiLastName;
    }

    public String getUiFirstName() {
        return uiFirstName;
    }

    public String getUiEmailAddress() {
        return uiEmailAddress;
    }
}
package com.optum.fads.userroles.api.mapper;

import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.ReportingPolicy;

import com.optum.fads.userroles.api.domain.UiUserHistory;
import com.optum.fads.userroles.api.dto.UserListItemHistory;

@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface UserListItemHistoryMapper {
    
    @Mapping(target = "uiSystemId", source = "uiSystem.uiSystemId")
    @Mapping(target = "histSeqNum", source = "id.histSeqNum")
    @Mapping(target = "changeDt", source = "changeDt")
    @Mapping(target = "changeUsr", source = "changeUsr.uiSystemId")
    @Mapping(target = "fadsGrpId", source = "fadsGrp.id")
    @Mapping(target = "fadsSurGrpId", source = "fadsSurGrp.id")
    @Mapping(target = "fadsCaseGrpId", source = "fadsCaseGrp.id")
    @Mapping(target = "uiUserId", source = "uiUserId")
    @Mapping(target = "uiLastName", source = "uiLastName")
    @Mapping(target = "uiFirstName", source = "uiFirstName")
    @Mapping(target = "uiEmailAddress", source = "uiEMailAddress")
    UserListItemHistory toDto(UiUserHistory entity);
}
package com.optum.fads.userroles.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import com.optum.fads.userroles.api.domain.UiUserHistory;
import com.optum.fads.userroles.api.domain.UiUserHistoryId;

public interface UiUserHistoryRepository extends JpaRepository<UiUserHistory, UiUserHistoryId>, JpaSpecificationExecutor<UiUserHistory> {
    
}
package com.optum.fads.userroles.api.service;

import org.springframework.data.domain.Pageable;

import com.optum.fads.userroles.api.dto.UserHistoryResponse;

public interface IUserHistory {
    /**
     * Retrieves all user history items with pagination and search
     * @param pageable pagination information
     * @param searchBy field name to search by
     * @param searchInput search value
     * @return UserHistoryResponse containing paginated and filtered historical user data and total count
     */
    UserHistoryResponse getAllUserHistory(Pageable pageable, String searchBy, String searchInput);
}
package com.optum.fads.userroles.api.service.Impl;

import java.util.List;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import com.optum.fads.userroles.api.domain.UiUserHistory;
import com.optum.fads.userroles.api.dto.UserListItemHistory;
import com.optum.fads.userroles.api.dto.UserHistoryResponse;
import com.optum.fads.userroles.api.mapper.UserListItemHistoryMapper;
import com.optum.fads.userroles.api.repo.UiUserHistoryRepository;
import com.optum.fads.userroles.api.service.IUserHistory;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class UserHistoryImpl implements IUserHistory {

    // Field name constants to avoid duplication
    private static final String FIELD_UI_USER_ID = "uiUserId";
    private static final String FIELD_UI_LAST_NAME = "uiLastName";
    private static final String FIELD_UI_FIRST_NAME = "uiFirstName";
    private static final String FIELD_UI_EMAIL_ADDRESS = "uiEMailAddress";
    private static final String FIELD_UI_SYSTEM_ID = "uiSystemId";

    private final UiUserHistoryRepository repository;
    private final UserListItemHistoryMapper mapper;

    @Override
    public UserHistoryResponse getAllUserHistory(Pageable pageable, String searchBy, String searchInput) {
        if (pageable == null) {
            throw new IllegalArgumentException("Pageable cannot be null");
        }
        
        Page<UiUserHistory> page;
        
        // If search parameters are provided, use specification for filtering
        if (StringUtils.hasText(searchBy) && StringUtils.hasText(searchInput)) {
            Specification<UiUserHistory> spec = createSearchSpecification(searchBy, searchInput);
            page = repository.findAll(spec, pageable);
        } else {
            // If no search parameters, use regular findAll
            page = repository.findAll(pageable);
        }
        
        List<UserListItemHistory> data = page.getContent()
                .stream()
                .map(mapper::toDto)
                .toList();
        
        return new UserHistoryResponse(data, page.getTotalElements());
    }

    /**
     * Creates a search specification based on searchBy field and searchInput value
     */
    private Specification<UiUserHistory> createSearchSpecification(String searchBy, String searchInput) {
        return (root, query, criteriaBuilder) -> {
            String entityField = mapSearchFieldToEntityPath(searchBy);
            String searchPattern = "%" + searchInput.toLowerCase() + "%";
            
            return switch (entityField) {
                case FIELD_UI_USER_ID, FIELD_UI_LAST_NAME, FIELD_UI_FIRST_NAME, FIELD_UI_EMAIL_ADDRESS -> 
                    criteriaBuilder.like(criteriaBuilder.lower(root.get(entityField)), searchPattern);
                
                case "uiSystem." + FIELD_UI_SYSTEM_ID -> 
                    criteriaBuilder.like(criteriaBuilder.lower(root.get("uiSystem").get(FIELD_UI_SYSTEM_ID)), searchPattern);
                
                case "changeUsr." + FIELD_UI_SYSTEM_ID -> 
                    criteriaBuilder.like(criteriaBuilder.lower(root.get("changeUsr").get(FIELD_UI_SYSTEM_ID)), searchPattern);
                
                case "id.histSeqNum" -> {
                    try {
                        java.math.BigDecimal searchValue = new java.math.BigDecimal(searchInput);
                        yield criteriaBuilder.equal(root.get("id").get("histSeqNum"), searchValue);
                    } catch (NumberFormatException e) {
                        // If search input is not a valid number, return a predicate that matches nothing
                        yield criteriaBuilder.disjunction();
                    }
                }
                
                case "fadsGrp.id", "fadsSurGrp.id", "fadsCaseGrp.id" -> {
                    try {
                        java.math.BigDecimal searchValue = new java.math.BigDecimal(searchInput);
                        String[] parts = entityField.split("\\.");
                        yield criteriaBuilder.equal(root.get(parts[0]).get(parts[1]), searchValue);
                    } catch (NumberFormatException e) {
                        // If search input is not a valid number, return a predicate that matches nothing
                        yield criteriaBuilder.disjunction();
                    }
                }
                
                default -> 
                    criteriaBuilder.like(criteriaBuilder.lower(root.get(FIELD_UI_EMAIL_ADDRESS)), searchPattern);
            };
        };
    }

    /**
     * Maps search field names to entity field paths
     */
    private String mapSearchFieldToEntityPath(String searchField) {
        return switch (searchField) {
            case "histSeqNum" -> "id.histSeqNum";
            case "changeUsr" -> "changeUsr." + FIELD_UI_SYSTEM_ID;
            case FIELD_UI_SYSTEM_ID -> "uiSystem." + FIELD_UI_SYSTEM_ID;
            case "fadsGrpId" -> "fadsGrp.id";
            case "fadsSurGrpId" -> "fadsSurGrp.id";
            case "fadsCaseGrpId" -> "fadsCaseGrp.id";
            case FIELD_UI_USER_ID -> FIELD_UI_USER_ID;
            case FIELD_UI_LAST_NAME -> FIELD_UI_LAST_NAME;
            case FIELD_UI_FIRST_NAME -> FIELD_UI_FIRST_NAME;
            case FIELD_UI_EMAIL_ADDRESS -> FIELD_UI_EMAIL_ADDRESS;
            default -> FIELD_UI_EMAIL_ADDRESS; // default search field
        };
    }
}
