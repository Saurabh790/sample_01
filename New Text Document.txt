@Test
void loadUserByUsername_userFound_mapsRoleAndAccesses() {

    UiUserBase uiDeep = mock(UiUserBase.class, RETURNS_DEEP_STUBS);

    when(uiDeep.getUiEMailAddress()).thenReturn("u@x.com");
    when(uiDeep.getUiUserId()).thenReturn("user1");
    when(uiDeep.getUiSystemId()).thenReturn("SYS-1");

    when(uiDeep.getSeUsrGrp().getSeSurGrp().getSurGrpId()).thenReturn(10L);
    when(uiDeep.getSeUsrGrp().getSeSurGrp().getSurGrpName()).thenReturn("Admin");

    SeSurGrpModAccess modAccess = mock(SeSurGrpModAccess.class, RETURNS_DEEP_STUBS);
    when(modAccess.getId().getSurModuleId()).thenReturn("REPORT_ITEMS");
    when(modAccess.getSeSurModule().getSurModuleName()).thenReturn("Report Items");
    when(modAccess.getSeSurAccess().getSurAccessId()).thenReturn("2");

    when(uiDeep.getSeUsrGrp().getSeSurGrp().getSeSurGrpModAccesses())
            .thenReturn(List.of(modAccess));

    when(userRepository.findByUiEMailAddressOrUiUserId("user1", "user1"))
            .thenReturn(Optional.of(uiDeep));

    ModuleAccess anyEnum = ModuleAccess.values()[0];

    try (MockedStatic<ModuleAccess> mocked = mockStatic(ModuleAccess.class)) {
        mocked.when(() -> ModuleAccess.getByName("REPORT_ITEMS"))
              .thenReturn(anyEnum);

        UserDetails out = service.loadUserByUsername("user1");

        assertNotNull(out);
        assertTrue(out instanceof AppUser);

        AppUser user = (AppUser) out;
        assertEquals("u@x.com", user.getUserEmail());
        assertEquals("user1", user.getUserId());
        assertEquals("SYS-1", user.getUserSystemId());

        assertEquals("10", user.getRole().getId());
        assertEquals("Admin", user.getRole().getRoleName());

        assertEquals(1, user.getRole().getAllowedAccesses().size());
        assertEquals("REPORT_ITEMS", user.getRole().getAllowedAccesses().get(0).getModuleId());
        assertEquals("Report Items", user.getRole().getAllowedAccesses().get(0).getModuleName());
    }

    verify(userRepository).findByUiEMailAddressOrUiUserId("user1", "user1");
    verifyNoMoreInteractions(userRepository);
}
