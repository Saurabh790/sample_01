package com.optum.fads.pgp.jobs.api.config;

import com.azure.identity.ClientSecretCredential;
import com.azure.identity.ClientSecretCredentialBuilder;
import com.azure.security.keyvault.secrets.SecretClient;
import com.azure.security.keyvault.secrets.SecretClientBuilder;
import org.junit.jupiter.api.Test;
import org.modelmapper.ModelMapper;
import org.modelmapper.convention.MatchingStrategies;
import org.mockito.MockedConstruction;
import org.springframework.test.util.ReflectionTestUtils;
import org.springframework.web.client.RestTemplate;

import java.util.TimeZone;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

class CommonConfigTest {

    @Test
    void modelMapperBean_shouldBePrototypeAndStrict() {
        CommonConfig cfg = new CommonConfig();

        ModelMapper m1 = cfg.modelMapper();
        ModelMapper m2 = cfg.modelMapper();

        assertNotNull(m1);
        assertNotNull(m2);
        assertNotSame(m1, m2);

        assertTrue(m1.getConfiguration().isAmbiguityIgnored());
        assertEquals(MatchingStrategies.STRICT, m1.getConfiguration().getMatchingStrategy());
    }

    @Test
    void restTemplateBean_shouldExist() {
        CommonConfig cfg = new CommonConfig();
        RestTemplate rt = cfg.restTemplate();
        assertNotNull(rt);
    }

    @Test
    void postConstruct_shouldSetTimezone() {
        TimeZone old = TimeZone.getDefault();
        try {
            CommonConfig cfg = new CommonConfig();
            cfg.started();

            TimeZone tz = TimeZone.getDefault();
            assertNotNull(tz);

            // "UTC-4" can normalize; the safest is check raw offset after calling started()
            assertEquals(-4 * 60 * 60 * 1000, tz.getRawOffset());
        } finally {
            TimeZone.setDefault(old);
        }
    }

    @Test
    void secretClientBean_shouldBeCreated_withoutRealAzureCall() {
        CommonConfig cfg = new CommonConfig();

        // Inject @Value fields
        ReflectionTestUtils.setField(cfg, "azureKeyVaultUrl", "https://dummy.vault.azure.net/");
        ReflectionTestUtils.setField(cfg, "azureKeyVaultTenant", "dummy-tenant");
        ReflectionTestUtils.setField(cfg, "azureKeyVaultClientId", "dummy-client");
        ReflectionTestUtils.setField(cfg, "azureKeyVaultSecret", "dummy-secret");

        ClientSecretCredential fakeCredential = mock(ClientSecretCredential.class);
        SecretClient fakeSecretClient = mock(SecretClient.class);

        try (
                MockedConstruction<ClientSecretCredentialBuilder> credentialBuilderMock =
                        mockConstruction(ClientSecretCredentialBuilder.class, (mock, ctx) -> {
                            when(mock.clientId(any())).thenReturn(mock);
                            when(mock.clientSecret(any())).thenReturn(mock);
                            when(mock.tenantId(any())).thenReturn(mock);
                            when(mock.build()).thenReturn(fakeCredential);
                        });

                MockedConstruction<SecretClientBuilder> secretClientBuilderMock =
                        mockConstruction(SecretClientBuilder.class, (mock, ctx) -> {
                            when(mock.vaultUrl(any())).thenReturn(mock);
                            when(mock.credential(any())).thenReturn(mock);
                            when(mock.buildClient()).thenReturn(fakeSecretClient);
                        })
        ) {
            SecretClient sc = cfg.secretClient();
            assertNotNull(sc);

            // Verify builders were constructed and used
            assertEquals(1, credentialBuilderMock.constructed().size());
            assertEquals(1, secretClientBuilderMock.constructed().size());

            ClientSecretCredentialBuilder cb = credentialBuilderMock.constructed().get(0);
            verify(cb).clientId("dummy-client");
            verify(cb).clientSecret("dummy-secret");
            verify(cb).tenantId("dummy-tenant");
            verify(cb).build();

            SecretClientBuilder sb = secretClientBuilderMock.constructed().get(0);
            verify(sb).vaultUrl("https://dummy.vault.azure.net/");
            verify(sb).credential(fakeCredential);
            verify(sb).buildClient();

            assertSame(fakeSecretClient, sc);
        }
    }
}

