package com.optum.fads.userroles.api.controllers;

import java.security.SecureRandom;
import java.util.Collections;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.Optional;

import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

import com.optum.fads.userroles.api.dto.AllDropdownsResponse;
import com.optum.fads.userroles.api.dto.UserForAdmin;
import com.optum.fads.userroles.api.dto.UserListResponse;
import com.optum.fads.userroles.api.service.GroupDropdownService;
import com.optum.fads.userroles.api.service.IUserList;
import com.optum.fads.userroles.api.service.UserService;

@RestController
public class UserRolesController {

	private static final Map<String, String> FIELD_MAP;
	static {
		Map<String, String> m = new LinkedHashMap<>();
		m.put("uiSystemId", "uiSystemId");
		m.put("uiUserId", "uiUserId");
		m.put("lastName", "uiLastName");
		m.put("firstName", "uiFirstName");
		m.put("title", "uiTitle");
		m.put("email", "uiEMailAddress");
		m.put("fadsGrpName", "seUsrGrp.fadsGrp.fadsGrpName");
		m.put("surGrpName", "seUsrGrp.fadsSurGrp.surGrpName");
		m.put("caseGrpName", "seUsrGrp.fadsCaseGrp.caseGrpName");
		FIELD_MAP = Collections.unmodifiableMap(m);
	}

	private final IUserList userListService;
	private final UserService userService;
	private final GroupDropdownService groupDropdownService;
	private static final String DEFAULT_SORT_FIELD = "lastName";

	public UserRolesController(IUserList userListService, GroupDropdownService groupDropdownService,
			UserService userService) {
		this.userListService = userListService;
		this.userService = userService;
		this.groupDropdownService = groupDropdownService;
	}

	@GetMapping("/findAllByPageable")
	public UserListResponse getUsers(@RequestParam(defaultValue = "1") int pageNumber,
			@RequestParam(defaultValue = "10") int recordsPerPage,
			@RequestParam(defaultValue = DEFAULT_SORT_FIELD) String sortBy,
			@RequestParam(defaultValue = "1") int sortOrder, @RequestParam(required = false) String searchBy,
			@RequestParam(required = false) String searchInput) {

		String entitySortField = mapToEntityField(sortBy);

		Sort.Direction direction = (sortOrder == -1) ? Sort.Direction.DESC : Sort.Direction.ASC;
		Sort sort = Sort.by(direction, entitySortField);

		Pageable pageable = PageRequest.of(Math.max(pageNumber - 1, 0), recordsPerPage, sort);

		return userListService.getAllUsers(pageable, searchBy, searchInput);
	}

	

	private String mapToEntityField(String dtoField) {
		return switch (dtoField) {
		case "uiSystemId" -> "uiSystemId";
		case "uiUserId" -> "uiUserId";
		case "lastName" -> "uiLastName";
		case "firstName" -> "uiFirstName";
		case "title" -> "uiTitle";
		case "email" -> "uiEMailAddress";
		case "fadsGrpName" -> "seUsrGrp.fadsGrp.fadsGrpName";
		case "surGrpName" -> "seUsrGrp.fadsSurGrp.surGrpName";
		case "caseGrpName" -> "seUsrGrp.fadsCaseGrp.caseGrpName";
		default -> DEFAULT_SORT_FIELD.equals(dtoField) ? "uiLastName" : "uiLastName";
		};
	}

}
package com.optum.fads.userroles.api.dto;

public class UserListItem {
    private final String uiSystemId;
    private final String uiUserId;
    private final String lastName;
    private final String firstName;
    private final String title;
    private final String email;
    private final String fadsGrpName;
    private final String surGrpName;
    private final String caseGrpName;

    public UserListItem(String uiSystemId, String uiUserId, String lastName, String firstName,
                        String title, String email, String fadsGrpName, String surGrpName, String caseGrpName) {
        this.uiSystemId = uiSystemId;
        this.uiUserId = uiUserId;
        this.lastName = lastName;
        this.firstName = firstName;
        this.title = title;
        this.email = email;
        this.fadsGrpName = fadsGrpName;
        this.surGrpName = surGrpName;
        this.caseGrpName = caseGrpName;
    }

	public String getUiSystemId() {
		return uiSystemId;
	}

	public String getUiUserId() {
		return uiUserId;
	}

	public String getLastName() {
		return lastName;
	}

	public String getFirstName() {
		return firstName;
	}

	public String getTitle() {
		return title;
	}

	public String getEmail() {
		return email;
	}

	public String getFadsGrpName() {
		return fadsGrpName;
	}

	public String getSurGrpName() {
		return surGrpName;
	}

	public String getCaseGrpName() {
		return caseGrpName;
	}

    
    
    
}
package com.optum.fads.userroles.api.dto;

import java.util.List;

public class UserListResponse {
	private final List<UserListItem> data;
	private final long totalRecordsCount;

	public UserListResponse(List<UserListItem> data, long totalRecordsCount) {
		this.data = data;
		this.totalRecordsCount = totalRecordsCount;
	}

	public List<UserListItem> getData() {
		return data;
	}

	public long getTotalRecordsCount() {
		return totalRecordsCount;
	}
}
package com.optum.fads.userroles.api.mapper;

import com.optum.fads.userroles.api.domain.SeFadsGrp;
import com.optum.fads.userroles.api.domain.SeUserGroup;
import com.optum.fads.userroles.api.domain.SeUsrGrp;
import com.optum.fads.userroles.api.dto.UserForAdmin;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.ReportingPolicy;

import com.optum.fads.userroles.api.domain.UiUserBase;
import com.optum.fads.userroles.api.dto.UserListItem;

import java.math.BigDecimal;


@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface UserListItemMapper {

    @Mapping(target = "uiSystemId", source = "uiSystemId")
    @Mapping(target = "uiUserId", source = "uiUserId")
    @Mapping(target = "lastName", source = "uiLastName")
    @Mapping(target = "firstName", source = "uiFirstName")
    @Mapping(target = "title", source = "uiTitle")
    @Mapping(target = "email", source = "uiEMailAddress")
    @Mapping(target = "fadsGrpName", source = "seUsrGrp.fadsGrp.fadsGrpName")
    @Mapping(target = "surGrpName", source = "seUsrGrp.fadsSurGrp.surGrpName")
    @Mapping(target = "caseGrpName", source = "seUsrGrp.fadsCaseGrp.caseGrpName")
    UserListItem toDto(UiUserBase entity);


}
package com.optum.fads.userroles.api.service;

import com.optum.fads.userroles.api.dto.UserListResponse;
import org.springframework.data.domain.Pageable;

public interface IUserList {
	UserListResponse getAllUsers(Pageable pageable, String searchBy, String searchInput);
}

package com.optum.fads.userroles.api.service;

import java.util.Map;

import com.optum.fads.userroles.api.dto.UserForAdmin;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;

import com.optum.fads.userroles.api.dto.UserListItem;

public interface UserService {
    Page<UserListItem> getUsersList(Map<String, String> filters, Pageable pageable, Map<String, String> fieldMap);

   
}
package com.optum.fads.userroles.api.service.Impl;

import java.util.List;
import java.util.Locale;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import com.optum.fads.userroles.api.domain.UiUserBase;
import com.optum.fads.userroles.api.dto.UserListItem;
import com.optum.fads.userroles.api.dto.UserListResponse;
import com.optum.fads.userroles.api.mapper.UserListItemMapper;
import com.optum.fads.userroles.api.repo.UiUserBaseRepository;
import com.optum.fads.userroles.api.service.IUserList;

import jakarta.persistence.criteria.Join;
import jakarta.persistence.criteria.JoinType;

@Service
public class UserListImpl implements IUserList {

	private static final String FIELD_UI_SYSTEM_ID = "uiSystemId";
	private static final String FIELD_UI_USER_ID = "uiUserId";
	private static final String FIELD_LAST_NAME = "uiLastName";
	private static final String FIELD_FIRST_NAME = "uiFirstName";
	private static final String FIELD_TITLE = "uiTitle";
	private static final String FIELD_EMAIL = "uiEMailAddress";

	private static final String FIELD_FADS_NAME = "fadsGrpName";
	private static final String FIELD_SUR_NAME = "surGrpName";
	private static final String FIELD_CASE_NAME = "caseGrpName";

	private final UiUserBaseRepository repository;
	private final UserListItemMapper mapper;

	public UserListImpl(UiUserBaseRepository repository, UserListItemMapper mapper) {
		this.repository = repository;
		this.mapper = mapper;
	}

	@Override
	public UserListResponse getAllUsers(Pageable pageable, String searchBy, String searchInput) {
		Page<UiUserBase> page;

		if (StringUtils.hasText(searchBy) && StringUtils.hasText(searchInput)) {
			Specification<UiUserBase> spec = createSearchSpecification(searchBy, searchInput);
			page = repository.findAll(spec, pageable);
		} else {
			page = repository.findAll(pageable);
		}

		List<UserListItem> data = page.getContent().stream().map(mapper::toDto).toList();
		return new UserListResponse(data, page.getTotalElements());
	}

	
	private Specification<UiUserBase> createSearchSpecification(String searchBy, String searchInput) {
		final String pattern = "%" + searchInput.toLowerCase(Locale.ROOT) + "%";

		return (root, query, cb) -> {
			boolean needsJoin = FIELD_FADS_NAME.equals(searchBy) || FIELD_SUR_NAME.equals(searchBy)
					|| FIELD_CASE_NAME.equals(searchBy);
			if (needsJoin) {
				query.distinct(true);
			}

			switch (searchBy) {
			case FIELD_UI_SYSTEM_ID:
			case FIELD_UI_USER_ID:
			case FIELD_LAST_NAME:
			case FIELD_FIRST_NAME:
			case FIELD_TITLE:
			case FIELD_EMAIL:
				return cb.like(cb.lower(root.get(searchByToEntityColumn(searchBy))), pattern);

			case FIELD_FADS_NAME: {
				Join<?, ?> jUsrGrp = root.join("seUsrGrp", JoinType.LEFT);
				Join<?, ?> jFads = jUsrGrp.join("fadsGrp", JoinType.LEFT);
				return cb.like(cb.lower(jFads.get("fadsGrpName")), pattern);
			}
			case FIELD_SUR_NAME: {
				Join<?, ?> jUsrGrp = root.join("seUsrGrp", JoinType.LEFT);
				Join<?, ?> jSur = jUsrGrp.join("fadsSurGrp", JoinType.LEFT);
				return cb.like(cb.lower(jSur.get("surGrpName")), pattern);
			}
			case FIELD_CASE_NAME: {
				Join<?, ?> jUsrGrp = root.join("seUsrGrp", JoinType.LEFT);
				Join<?, ?> jCase = jUsrGrp.join("fadsCaseGrp", JoinType.LEFT);
				return cb.like(cb.lower(jCase.get("caseGrpName")), pattern);
			}

			default:
				return cb.like(cb.lower(root.get(FIELD_EMAIL)), pattern);
			}
		};
	}

	private String searchByToEntityColumn(String searchBy) {
		return switch (searchBy) {
		case FIELD_UI_SYSTEM_ID -> FIELD_UI_SYSTEM_ID;
		case FIELD_UI_USER_ID -> FIELD_UI_USER_ID;
		case FIELD_LAST_NAME -> FIELD_LAST_NAME;
		case FIELD_FIRST_NAME -> FIELD_FIRST_NAME;
		case FIELD_TITLE -> FIELD_TITLE;
		case FIELD_EMAIL -> FIELD_EMAIL;
		default -> FIELD_EMAIL;
		};
	}
}
package com.optum.fads.userroles.api.service.Impl;

import java.util.Map;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.userroles.api.domain.UiUserBase;
import com.optum.fads.userroles.api.domain.SeUserGroup;
import com.optum.fads.userroles.api.dto.UserForAdmin;
import com.optum.fads.userroles.api.repo.SeUsrGrpRepository;
import com.optum.fads.userroles.api.repo.UiUserBaseRepository;
import com.optum.fads.userroles.api.service.UserService;
import com.optum.fads.userroles.api.dto.UserListItem;
import com.optum.fads.userroles.api.mapper.UserListItemMapper;
import com.optum.fads.userroles.api.utility.UserSpecification;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class UserServiceImpl implements UserService {

    private final UiUserBaseRepository repo;
    private final SeUsrGrpRepository seUsrGrpRepository;
    private final UserListItemMapper mapper;

    @Override
    public Page<UserListItem> getUsersList(Map<String, String> filters, Pageable pageable, Map<String, String> fieldMap) {
        Specification<UiUserBase> spec = UserSpecification.containsAll(filters, fieldMap);

        Page<UiUserBase> page = (spec == null)
                ? repo.findAll(pageable)            
                : repo.findAll(spec, pageable);         
        return page.map(mapper::toDto);
    }

}
now in this there is requirement that if loggedin user is fads grp id is 2 or 3 then return those list who is having only fads grp id is 2 n 3 , if its other than 2 n 3 then we can return as usual response 
