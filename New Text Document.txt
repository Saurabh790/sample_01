package com.optum.fads.authorization.api.security;

import com.optum.fads.authorization.api.dto.FADSUser;
import com.optum.fads.authorization.api.service.IUserDetailsService;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.security.authentication.AbstractAuthenticationToken;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.oauth2.jwt.Jwt;

import java.util.*;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class UserJwtAuthenticationConverterTest {

    @Mock
    private IUserDetailsService userDetailsService;

    @InjectMocks
    private UserJwtAuthenticationConverter userJwtAuthenticationConverter;

    @Test
    void convert_withValidEmailClaim_success() {
        Map<String, Object> claims = new HashMap<>();
        claims.put("email", "valid-user@example.com");
        claims.put("groups", List.of("admin", "user"));

        Jwt jwt = jwtWithClaims(claims);

        FADSUser mockUser = new FADSUser();
        when(userDetailsService.loadUserByUsername("valid-user@example.com")).thenReturn(mockUser);

        AbstractAuthenticationToken token = userJwtAuthenticationConverter.convert(jwt);

        assertNotNull(token);
        assertSame(mockUser, token.getPrincipal()); // stronger than assertEquals
        assertAuthorities(token.getAuthorities(), "ROLE_ADMIN", "ROLE_USER");

        verify(userDetailsService, times(1)).loadUserByUsername("valid-user@example.com");
        verifyNoMoreInteractions(userDetailsService);
    }

    @Test
    void convert_whenUserNotFound_throwsBadCredentialsException() {
        Map<String, Object> claims = new HashMap<>();
        claims.put("email", "missing-user@example.com");
        claims.put("groups", List.of("admin"));

        Jwt jwt = jwtWithClaims(claims);

        when(userDetailsService.loadUserByUsername("missing-user@example.com")).thenReturn(null);

        assertThrows(BadCredentialsException.class, () -> userJwtAuthenticationConverter.convert(jwt));

        verify(userDetailsService).loadUserByUsername("missing-user@example.com");
        verifyNoMoreInteractions(userDetailsService);
    }

    @Test
    void convert_withNoGroups_returnsEmptyAuthorities() {
        Map<String, Object> claims = new HashMap<>();
        claims.put("email", "user@example.com");

        Jwt jwt = jwtWithClaims(claims);

        FADSUser mockUser = new FADSUser();
        when(userDetailsService.loadUserByUsername("user@example.com")).thenReturn(mockUser);

        AbstractAuthenticationToken token = userJwtAuthenticationConverter.convert(jwt);

        assertNotNull(token);
        assertTrue(token.getAuthorities().isEmpty());

        verify(userDetailsService).loadUserByUsername("user@example.com");
        verifyNoMoreInteractions(userDetailsService);
    }

    // Optional but recommended: fallback claim test
    @Test
    void convert_whenEmailMissing_usesUniqueName() {
        Map<String, Object> claims = new HashMap<>();
        claims.put("unique_name", "unique@example.com");
        claims.put("groups", List.of("admin"));

        Jwt jwt = jwtWithClaims(claims);

        FADSUser mockUser = new FADSUser();
        when(userDetailsService.loadUserByUsername("unique@example.com")).thenReturn(mockUser);

        AbstractAuthenticationToken token = userJwtAuthenticationConverter.convert(jwt);

        assertNotNull(token);
        assertSame(mockUser, token.getPrincipal());
        assertAuthorities(token.getAuthorities(), "ROLE_ADMIN");

        verify(userDetailsService).loadUserByUsername("unique@example.com");
        verifyNoMoreInteractions(userDetailsService);
    }

    // Helper to build Jwt consistently
    private static Jwt jwtWithClaims(Map<String, Object> claims) {
        return Jwt.withTokenValue("token")
                .header("alg", "none")
                .claims(c -> c.putAll(claims))
                .build();
    }

    // Helper to compare authorities exactly (order-independent)
    private static void assertAuthorities(Collection<? extends GrantedAuthority> actual, String... expected) {
        Set<String> actualSet = new HashSet<>();
        for (GrantedAuthority a : actual) actualSet.add(a.getAuthority());

        Set<String> expectedSet = new HashSet<>(Arrays.asList(expected));

        assertEquals(expectedSet, actualSet);
    }
}
