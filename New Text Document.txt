@ExtendWith(MockitoExtension.class)
class ServiceConfigTest {

    @Test
    void customDataSource_buildsDatasource_usingSecretsFromKeyVault() {

        SecretClient secretClient = mock(SecretClient.class);

        when(secretClient.getSecret("db-user-secret"))
                .thenReturn(new KeyVaultSecret("db-user-secret", "dbuser"));

        when(secretClient.getSecret("db-pass-secret"))
                .thenReturn(new KeyVaultSecret("db-pass-secret", "dbpass"));

        ServiceConfig config = new ServiceConfig(secretClient);

        ReflectionTestUtils.setField(config, "userNameSecretName", "db-user-secret");
        ReflectionTestUtils.setField(config, "passwordSecretName", "db-pass-secret");
        ReflectionTestUtils.setField(config, "jdbcUrl", "jdbc:h2:mem:test");
        ReflectionTestUtils.setField(config, "driverClassName", "org.h2.Driver");

        DataSource ds = config.customDataSource();

        assertNotNull(ds);
        assertTrue(ds instanceof DriverManagerDataSource);

        DriverManagerDataSource dmds = (DriverManagerDataSource) ds;
        assertEquals("jdbc:h2:mem:test", dmds.getUrl());
        assertEquals("dbuser", dmds.getUsername());
        assertEquals("dbpass", dmds.getPassword());
    }
}
