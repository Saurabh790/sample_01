package com.optum.fads.authorization.api.security;

import com.optum.fads.authorization.api.dto.FADSUser;
import com.optum.fads.authorization.api.service.IUserDetailsService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.springframework.security.authentication.AbstractAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.oauth2.jwt.Jwt;
import org.springframework.security.authentication.BadCredentialsException;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.when;

public class UserJwtAuthenticationConverterTest {

    @Mock
    private IUserDetailsService userDetailsService;

    @InjectMocks
    private UserJwtAuthenticationConverter userJwtAuthenticationConverter;


    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
    }


    @Test
    void testConvert_WithValidEmailClaim_Success() {

        Map<String, Object> claims = new HashMap<>();
        claims.put("email", "valid-user@example.com");
        claims.put("unique_name", "valid-user@example.com");
        claims.put("upn", "valid-user@example.com");
        claims.put("groups", List.of("admin", "user"));

        Jwt jwt = Jwt.withTokenValue("token")
                .header("alg", "none")
                .claims(c -> c.putAll(claims))
                .build();

        FADSUser mockUser = new FADSUser();
        when(userDetailsService.loadUserByUsername("valid-user@example.com")).thenReturn(mockUser);

        AbstractAuthenticationToken token = userJwtAuthenticationConverter.convert(jwt);

        assertNotNull(token);
        assertEquals(mockUser, token.getPrincipal());
        assertTrue(token.getAuthorities().contains(new SimpleGrantedAuthority("ROLE_ADMIN")));
        assertTrue(token.getAuthorities().contains(new SimpleGrantedAuthority("ROLE_USER")));

    }

    @Test
    void testConvert_WhenUserNotFound_ThrowsBadCredentialsException() {

        Map<String, Object> claims = new HashMap<>();
        claims.put("email", "missing-user@example.com");
        claims.put("groups", List.of("admin"));

        Jwt jwt = Jwt.withTokenValue("token")
                .header("alg", "none")
                .claims(c -> c.putAll(claims))
                .build();

        when(userDetailsService.loadUserByUsername("missing-user@example.com")).thenReturn(null);


        assertThrows(BadCredentialsException.class, () -> userJwtAuthenticationConverter.convert(jwt));

    }


    @Test
    void testConvert_WithNoGroups_ReturnsEmptyAuthorities() {

        Map<String, Object> claims = new HashMap<>();
        claims.put("email", "user@example.com");

        Jwt jwt = Jwt.withTokenValue("token")
                .header("alg", "none")
                .claims(c -> c.putAll(claims))
                .build();

        FADSUser mockUser = new FADSUser();
        when(userDetailsService.loadUserByUsername("user@example.com")).thenReturn(mockUser);

        AbstractAuthenticationToken token = userJwtAuthenticationConverter.convert(jwt);

        assertNotNull(token);
        assertTrue(token.getAuthorities().isEmpty());

    }

}
