package com.optum.fads.pgp.reportsection.api.service;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

import java.util.List;
import java.util.Optional;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UsernameNotFoundException;

import com.optum.fads.pgp.reportsection.api.domain.SeSurGrpModAccess;
import com.optum.fads.pgp.reportsection.api.domain.UiUserBase;
import com.optum.fads.pgp.reportsection.api.dto.AppUser;
import com.optum.fads.pgp.reportsection.api.repo.UserRepository;
import com.optum.fads.pgp.reportsection.api.service.impl.UserDetailsService;

@ExtendWith(MockitoExtension.class)
class UserDetailsServiceTest {

    @Mock
    private UserRepository userRepository;

    @InjectMocks
    private UserDetailsService service;

    @Test
    void loadUserByUsername_userNotFound_throws() {
        when(userRepository.findByUiEMailAddressOrUiUserId(eq("abc"), eq("abc")))
                .thenReturn(Optional.empty());

        assertThrows(UsernameNotFoundException.class, () -> service.loadUserByUsername("abc"));
    }

    @Test
    void loadUserByUsername_userFound_mapsRoleAndAccesses() {
        UiUserBase uiUserBase = mock(UiUserBase.class, RETURNS_DEEP_STUBS);

        // basic fields
        when(uiUserBase.getUiEMailAddress()).thenReturn("u@x.com");
        when(uiUserBase.getUiUserId()).thenReturn("user1");
        when(uiUserBase.getUiSystemId()).thenReturn("SYS-1");

        // deep stubs for role (group)
        when(uiUserBase.getSeUsrGrp().getSeSurGrp().getSurGrpId()).thenReturn(10);
        when(uiUserBase.getSeUsrGrp().getSeSurGrp().getSurGrpName()).thenReturn("Admin");

        // one module access
        SeSurGrpModAccess modAccess = mock(SeSurGrpModAccess.class, RETURNS_DEEP_STUBS);
        when(modAccess.getId().getSurModuleId()).thenReturn("REPORT_SECTION");
        when(modAccess.getSeSurModule().getSurModuleName()).thenReturn("Report Section");
        when(modAccess.getSeSurAccess().getSurAccessId()).thenReturn(2);

        when(uiUserBase.getSeUsrGrp().getSeSurGrp().getSeSurGrpModAccesses())
                .thenReturn(List.of(modAccess));

        when(userRepository.findByUiEMailAddressOrUiUserId(anyString(), anyString()))
                .thenReturn(Optional.of(uiUserBase));

        UserDetails out = service.loadUserByUsername("user1");

        assertNotNull(out);
        assertTrue(out instanceof AppUser);

        AppUser user = (AppUser) out;
        assertEquals("u@x.com", user.getUserEmail());
        assertEquals("user1", user.getUserId());
        assertEquals("SYS-1", user.getUserSystemId());

        assertNotNull(user.getRole());
        assertEquals("10", user.getRole().getId());
        assertEquals("Admin", user.getRole().getRoleName());

        assertNotNull(user.getRole().getAllowedAccesses());
        assertEquals(1, user.getRole().getAllowedAccesses().size());
        assertEquals("REPORT_SECTION", user.getRole().getAllowedAccesses().get(0).getModuleId());

        verify(userRepository).findByUiEMailAddressOrUiUserId(eq("user1"), eq("user1"));
    }
}
package com.optum.fads.pgp.reportsection.api.service;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

import java.time.ZoneId;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.domain.Pageable;

import com.optum.fads.pgp.reportsection.api.common.ListTableParams;
import com.optum.fads.pgp.reportsection.api.common.constants.ReportSectionConstants;
import com.optum.fads.pgp.reportsection.api.domain.FadsConfigT;
import com.optum.fads.pgp.reportsection.api.domain.PrmRiRptItemT;
import com.optum.fads.pgp.reportsection.api.domain.PrmRsRptSecT;
import com.optum.fads.pgp.reportsection.api.domain.PrmRsRiT;
import com.optum.fads.pgp.reportsection.api.dto.PaginationResultRS;
import com.optum.fads.pgp.reportsection.api.dto.ReportItemDTO;
import com.optum.fads.pgp.reportsection.api.dto.ReportSectionDTO;
import com.optum.fads.pgp.reportsection.api.exception.ReportSectionApiException;
import com.optum.fads.pgp.reportsection.api.mapper.ReportGroupDetailMapper;
import com.optum.fads.pgp.reportsection.api.repo.BehaviorPatternErDrRepository;
import com.optum.fads.pgp.reportsection.api.repo.BehaviorPatternsRepository;
import com.optum.fads.pgp.reportsection.api.repo.DataRulesRepository;
import com.optum.fads.pgp.reportsection.api.repo.FadsConfigRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportItemFormulasRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportItemsRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportSectionItemsRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportSectionsRepository;
import com.optum.fads.pgp.reportsection.api.repo.StudyRepository;
import com.optum.fads.pgp.reportsection.api.service.impl.ReportSectionDataService;

@ExtendWith(MockitoExtension.class)
class ReportSectionDataServiceTest {

    @Mock private ReportSectionsRepository reportSectionsRepository;
    @Mock private StudyRepository studyRepository;
    @Mock private ReportSectionItemsRepository reportSectionItemsRepository;
    @Mock private ReportItemsRepository reportItemsRepository;
    @Mock private ReportItemFormulasRepository reportItemFormulasRepository;
    @Mock private BehaviorPatternsRepository behaviorPatternsRepository;
    @Mock private BehaviorPatternErDrRepository behaviorPatternErDrRepository;
    @Mock private DataRulesRepository dataRulesRepository;
    @Mock private FadsConfigRepository fadsConfigRepository;
    @Mock private ReportGroupDetailMapper reportGroupDetailMapper;

    private ReportSectionDataService service;

    @BeforeEach
    void setUp() {
        service = new ReportSectionDataService(
                reportSectionsRepository,
                studyRepository,
                reportSectionItemsRepository,
                reportItemsRepository,
                reportItemFormulasRepository,
                behaviorPatternsRepository,
                behaviorPatternErDrRepository,
                dataRulesRepository
        );
        // field injection mocks
        // (since service has @Autowired fields, we set them via reflection-less approach using spies)
        // easiest: spy + doReturn on getters isn't possible. So we mock fadsConfigRepository usage via reflection:
        // If you can use SpringExtension, prefer @InjectMocks instead.
        // For pure Mockito, do this:
        injectFadsConfigAndMapper();
    }

    private void injectFadsConfigAndMapper() {
        try {
            var f1 = ReportSectionDataService.class.getDeclaredField("fadsConfigRepository");
            f1.setAccessible(true);
            f1.set(service, fadsConfigRepository);

            var f2 = ReportSectionDataService.class.getDeclaredField("reportGroupDetailMapper");
            f2.setAccessible(true);
            f2.set(service, reportGroupDetailMapper);
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }

    private ListTableParams baseParams() {
        ListTableParams p = new ListTableParams();
        p.setPageNumber(1);
        p.setRecordsPerPage(10);
        p.setSortBy(ReportSectionConstants.CREATE_DATE);
        p.setSortOrder(1);
        p.setSelectedItemIds(new ArrayList<>());
        return p;
    }

    @Test
    void getReportSectionsList_noSearch_selectedEmpty_callsGetReportSectionsAndCount() {
        ListTableParams params = baseParams();
        params.setSearchBy(null);
        params.setSelectedItemIds(new ArrayList<>());

        PrmRsRptSecT rs = mock(PrmRsRptSecT.class, RETURNS_DEEP_STUBS);
        when(reportSectionsRepository.getReportSections(any(Pageable.class))).thenReturn(List.of(rs));
        when(reportSectionsRepository.count()).thenReturn(1L);

        PaginationResultRS out = service.getReportSectionsList(params);

        assertNotNull(out);
        assertEquals(1, out.getTotalRecordsCount());
        verify(reportSectionsRepository).getReportSections(any(Pageable.class));
        verify(reportSectionsRepository).count();
        verify(reportSectionsRepository, never()).getAvailableReportSections(anyList(), any());
    }

    @Test
    void getReportSectionsList_noSearch_selectedNotEmpty_callsAvailableAndCountBySize() {
        ListTableParams params = baseParams();
        params.setSearchBy(null);
        params.setSelectedItemIds(new ArrayList<>(List.of(1, 2)));

        PrmRsRptSecT rs1 = mock(PrmRsRptSecT.class, RETURNS_DEEP_STUBS);
        PrmRsRptSecT rs2 = mock(PrmRsRptSecT.class, RETURNS_DEEP_STUBS);

        when(reportSectionsRepository.getAvailableReportSections(eq(params.getSelectedItemIds()), any(Pageable.class)))
                .thenReturn(List.of(rs1));
        when(reportSectionsRepository.getAvailableReportSections(eq(params.getSelectedItemIds()), isNull()))
                .thenReturn(List.of(rs1, rs2));

        PaginationResultRS out = service.getReportSectionsList(params);

        assertEquals(2, out.getTotalRecordsCount());
        verify(reportSectionsRepository).getAvailableReportSections(eq(params.getSelectedItemIds()), any(Pageable.class));
        verify(reportSectionsRepository).getAvailableReportSections(eq(params.getSelectedItemIds()), isNull());
        verify(reportSectionsRepository, never()).count();
    }

    @Test
    void getReportSectionById_notFound_throws() {
        when(reportSectionsRepository.getReportSectionById(eq(99))).thenReturn(null);
        assertThrows(ReportSectionApiException.class, () -> service.getReportSectionById(99, false));
    }

    @Test
    void deleteReportSection_notFound_returnsMessage() {
        when(reportSectionsRepository.getReportSectionById(eq(10))).thenReturn(null);

        List<String> out = service.deleteReportSection(10);

        assertNotNull(out);
        assertFalse(out.isEmpty());
        assertEquals(ReportSectionConstants.REPORT_SECTION_DOES_NOT_EXIST, out.get(0));
    }

    @Test
    void getAvailableReportItems_emptyList_throws() {
        when(reportItemsRepository.getAvailableReportItems(eq(5))).thenReturn(List.of());
        assertThrows(ReportSectionApiException.class, () -> service.getAvailableReportItems(5));
    }

    @Test
    void getSelectedReportItems_noAssociations_returnsEmpty() {
        when(reportSectionItemsRepository.getRsRisByRsId(eq(7))).thenReturn(List.of());

        List<ReportItemDTO> out = service.getSelectedReportItems(7);

        assertNotNull(out);
        assertTrue(out.isEmpty());
    }

    @Test
    void getZoneId_whenConfigPresent_returnsZoneId() {
        FadsConfigT cfg = mock(FadsConfigT.class);
        when(cfg.getOptionValue()).thenReturn("UTC");
        when(fadsConfigRepository.findById(eq(ReportSectionConstants.DATE_TIME_ZONE_ID)))
                .thenReturn(Optional.of(cfg));

        ZoneId out = service.getZoneId();

        assertEquals(ZoneId.of("UTC"), out);
    }
}
