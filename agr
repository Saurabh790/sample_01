<?xml version="1.0" encoding="UTF-8"?>
<configuration scan="true">

    <!-- Use app name as context name (fallback = behavior) -->
    <contextName>${APPNAME_ENV:-behavior}</contextName>

    <!-- Read properties from Spring environment -->
    <springProperty name="application.name" source="spring.application.name" defaultValue="behavior"/>
    <springProperty name="audit.application.name" source="audit.application.name" defaultValue="${application.name}"/>
    <springProperty name="audit.log.type" source="audit.log.type" defaultValue="APPLICATION"/>

    <!-- Patterns for console and file logs (close outer placeholder with final }) -->
    <property name="CONSOLE_LOG_PATTERN"
              value="${CONSOLE_LOG_PATTERN:-%clr(%d{yyyy-MM-dd'T'HH:mm:ss.SSSXXX}){faint} %clr(${LOG_LEVEL_PATTERN:-%5p}) %clr(${PID:- }){magenta} %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}}"/>

    <property name="FILE_LOG_PATTERN"
              value="${FILE_LOG_PATTERN:-%d{yyyy-MM-dd'T'HH:mm:ss.SSSXXX} ${LOG_LEVEL_PATTERN:-%5p} ${PID:- } --- [%t] %-40.40logger{39} : %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}}"/>

    <!-- Spring Boot default appenders (CONSOLE + FILE spring.log) -->
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    <property name="LOG_FILE" value="${LOG_FILE:-${LOG_PATH:-${LOG_TEMP:-${java.io.tmpdir:-/tmp}}}/spring.log}"/>
    <include resource="org/springframework/boot/logging/logback/console-appender.xml"/>
    <include resource="org/springframework/boot/logging/logback/file-appender.xml"/>

    <!--
        CUSTOM APPENDERS
        NOTE: You MUST create these directories once, logback will NOT create them:
          logs/${application.name}/audit
          logs/${application.name}/json
        With spring.application.name=behavior:
          logs/behavior/audit
          logs/behavior/json
    -->

    <!-- AUDIT file contains all 'AUDIT' logger INFO messages, and all application ERROR messages -->
    <appender name="AUDIT" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <filter class="ch.qos.logback.core.filter.EvaluatorFilter">
            <evaluator>
                <expression>
                    return (level >= INFO && "AUDIT".equals(logger)) ||
                           (level >= ERROR && logger.startsWith("com.optum.fads.study"));
                </expression>
            </evaluator>
        </filter>

        <file>logs/${application.name}/audit/${application.name}_audit.log</file>

        <rollingPolicy class="ch.qos.logback.core.rolling.FixedWindowRollingPolicy">
            <fileNamePattern>logs/${application.name}/audit/${application.name}_audit.log.%i</fileNamePattern>
        </rollingPolicy>

        <triggeringPolicy class="ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy">
            <MaxFileSize>10MB</MaxFileSize>
        </triggeringPolicy>

        <encoder>
            <pattern>
                %n${AUDIT_LOG_PATTERN:-%d{${LOG_DATEFORMAT_PATTERN:-yyyy-MM-dd'T'HH:mm:ss.SSSXXX}}|%level|${audit.application.name}|${audit.log.type}|%X{clientIp}|%X{sourceIp}|%X{userId}|%X{authorizedUser} %m}
            </pattern>
        </encoder>
    </appender>

    <!-- JSON structured log file -->
    <appender name="JSON" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/${application.name}/json/${application.name}_json.log</file>

        <rollingPolicy class="ch.qos.logback.core.rolling.FixedWindowRollingPolicy">
            <fileNamePattern>logs/${application.name}/json/${application.name}_json.log.%i</fileNamePattern>
        </rollingPolicy>

        <triggeringPolicy class="ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy">
            <MaxFileSize>10MB</MaxFileSize>
        </triggeringPolicy>

        <!-- Fixed: make "exception" actually log stack traces, not literal %wEx -->
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <timestamp>
                    <fieldName>timestamp</fieldName>
                    <timeZone>UTC</timeZone>
                </timestamp>
                <pattern>
                    <pattern>
                        {
                          "level": "%level",
                          "context": "${HOSTNAME}-%thread",
                          "logger": "%logger{40}",
                          "message": "%message",
                          "exception": "%wEx"
                        }
                    </pattern>
                </pattern>
            </providers>
        </encoder>
    </appender>

    <!-- ROOT logger: everything INFO+ goes to audit, console, spring.log, and JSON file -->
    <root level="INFO">
        <appender-ref ref="AUDIT"/>
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE"/>
        <appender-ref ref="JSON"/>
    </root>

    <!-- Extra debug for troubleshooting auth / your code -->
    <logger name="org.springframework.security" level="DEBUG"/>
    <logger name="org.springframework.security.oauth2" level="DEBUG"/>
    <logger name="com.optum.fads.pgp.behavior.api" level="DEBUG"/>

</configuration>









server:
  port: 8080
  servlet:
    contextPath: /behavior

quickstart:
  generateOrderPeriod: 10s
  processOrderPeriod: 30s

spring:
  application:
    name: behavior
  jpa:
    database-platform: org.hibernate.dialect.SQLServer2016Dialect
    database: SQL_SERVER
    show-sql: false
    hibernate:
      naming:
        implicit-strategy: org.hibernate.boot.model.naming.ImplicitNamingStrategyLegacyHbmImpl
        physical-strategy: org.hibernate.boot.model.naming.CamelCaseToUnderscoresNamingStrategy
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    jdbcUrl: jdbc:sqlserver://wn000054716:1433;databaseName=fadsdb;encrypt=true;trustServerCertificate=true;
    userName: fads_dev
    password: YOUR_REAL_PASSWORD_HERE   # keep your original value in your local file
    driverClassName: com.microsoft.sqlserver.jdbc.SQLServerDriver
    hikari:
      maximum-pool-size: ${MAXIMUM_DB_POOL_SIZE:50}
      minimum-idle: ${MIN_POOL_IDLE:1}
      connection-timeout: ${DB_CONNECTION_TIMEOUT:60000}
      idle-timeout: ${DB_POOL_IDLE_TIMEOUT:60000}
      leak-detection-threshold: ${LEAK_DETETCTION_THRESHOLD:0}
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: https://login.microsoftonline.com/fbe00597-ca09-441a-836a-eb0dcb7c14e1/discovery/v2.0/keys
          jws-algorithms: RS256

management:
  endpoint:
    metrics.enabled: true
    prometheus.enabled: true
  endpoints.web.exposure.include:
    - health
    - info
    - prometheus
  prometheus.metrics.export.enabled: true

# Optional: only if you want Hibernate SQL logs
#logging:
#  level:
#    org:
#      hibernate:
#        SQL: DEBUG
#        type: TRACE

logging:
  level:
    root: INFO
    org.springframework.security: DEBUG
    org.springframework.security.oauth2: DEBUG
    com.optum.fads.pgp.behavior.api: DEBUG
