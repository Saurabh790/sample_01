

DROP TABLE IF EXISTS TXN_SOURCE;
DROP TABLE IF EXISTS CUSTOMER;
DROP TABLE IF EXISTS PRODUCT;
DROP TABLE IF EXISTS TXN_STAGE;
DROP TABLE IF EXISTS FINAL_TXN_LINE;
DROP TABLE IF EXISTS INVOICE_FINAL;
DROP TABLE IF EXISTS TXN_ERROR;

CREATE TABLE CUSTOMER (
  customer_id VARCHAR(20) PRIMARY KEY,
  discount_rate DECIMAL(5,2) NOT NULL
);

CREATE TABLE PRODUCT (
  product_id VARCHAR(20) PRIMARY KEY,
  tax_rate DECIMAL(5,2) NOT NULL
);

-- status: N=new, D=done, E=error
CREATE TABLE TXN_SOURCE (
  txn_id BIGINT PRIMARY KEY,
  customer_id VARCHAR(20),
  product_id VARCHAR(20),
  txn_amount DECIMAL(18,2),
  txn_time TIMESTAMP NOT NULL,
  currency VARCHAR(10) NOT NULL,
  channel VARCHAR(10) NOT NULL,
  invoice_date DATE NOT NULL,
  status CHAR(1) DEFAULT 'N' NOT NULL,
  run_id VARCHAR(80)
);

CREATE INDEX IDX_TXN_SOURCE_DATE_STATUS ON TXN_SOURCE(invoice_date, status);

-- persistent staging (audit of GOOD rows)

CREATE TABLE TXN_STAGE (
  stage_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  run_id VARCHAR(80) NOT NULL,
  invoice_date DATE NOT NULL,
  txn_id BIGINT NOT NULL,
  customer_id VARCHAR(20),
  product_id VARCHAR(20),
  base_amount DECIMAL(18,2),

  -- allow NULLs for POC
  discount_rate DECIMAL(5,2),
  tax_rate DECIMAL(5,2),

  discount DECIMAL(18,2),
  tax DECIMAL(18,2),
  commission DECIMAL(18,2),
  net_amount DECIMAL(18,2),
  created_at TIMESTAMP NOT NULL
);


CREATE UNIQUE INDEX UX_STAGE_RUN_TXN ON TXN_STAGE(run_id, txn_id);

CREATE TABLE TXN_ERROR (
  error_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

  run_id VARCHAR(80),
  invoice_date DATE,
  txn_id BIGINT,
  customer_id VARCHAR(20),
  product_id VARCHAR(20),
  txn_amount DECIMAL(18,2),
  error_reason VARCHAR(300),

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- final per-transaction computed output

CREATE TABLE FINAL_TXN_LINE (
  txn_id BIGINT PRIMARY KEY,
  run_id VARCHAR(80) NOT NULL,
  invoice_date DATE NOT NULL,
  customer_id VARCHAR(20),
  base_amount DECIMAL(18,2),

  discount DECIMAL(18,2) DEFAULT 0.00,
  tax DECIMAL(18,2) DEFAULT 0.00,
  commission DECIMAL(18,2) DEFAULT 0.00,
  net_amount DECIMAL(18,2) DEFAULT 0.00,

  created_at TIMESTAMP NOT NULL
);


CREATE INDEX IDX_FINAL_RUN ON FINAL_TXN_LINE(run_id);

-- aggregated invoice per customer/day
CREATE TABLE INVOICE_FINAL (
  invoice_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

  run_id VARCHAR(80),
  customer_id VARCHAR(20),
  invoice_date DATE,

  total_gross DECIMAL(18,2) DEFAULT 0,
  total_discount DECIMAL(18,2) DEFAULT 0,
  total_tax DECIMAL(18,2) DEFAULT 0,
  total_commission DECIMAL(18,2) DEFAULT 0,
  total_net DECIMAL(18,2) DEFAULT 0,

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IDX_INVOICE_RUN ON INVOICE_FINAL(run_id);

