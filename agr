package com.optum.fads.casereminders.api.general;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

import java.io.IOException;
import java.util.Optional;

import org.apache.commons.mail.Email;
import org.apache.http.HttpResponse;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpPost;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Spy;
import org.mockito.junit.jupiter.MockitoExtension;

import com.optum.fads.casereminders.api.common.constants.CaseEntryConstants;
import com.optum.fads.casereminders.api.domain.UiUserBase;
import com.optum.fads.casereminders.api.dto.EmailSpecs;
import com.optum.fads.casereminders.api.repo.CaseConfigRepository;
import com.optum.fads.casereminders.api.repo.FadsConfigRepository;
import com.optum.fads.casereminders.api.repo.UserRepository;

/**
 * Full unit test for CaseRemindersUtil:
 * - Covers JSON creation (cc/bcc present + absent)
 * - Covers Logic App path (success + exception)
 * - Covers SMTP path (cc/bcc empty + exception)
 * - Covers sendMail wrapper (logic app + smtp + exception)
 * - Covers getEmailSpecs (logic app branch + smtp branch + exception)
 * - Covers getCtAdminSystemId (present + empty + exception)
 *
 * Uses Mockito strict stubbing safely by stubbing ALL keys getEmailSpecs() calls.
 */
@ExtendWith(MockitoExtension.class)
class CaseRemindersUtilTest {

    @Mock
    private FadsConfigRepository fadsConfigRepository;

    @Mock
    private UserRepository userRepository;

    @Mock
    private CaseConfigRepository caseConfigRepository;

    /**
     * We use @Spy so we can stub internal methods (createJsonInput / sendMailLogicAppPost / sendSimpleMailSmtp)
     * while still running real code for the rest.
     */
    @Spy
    @InjectMocks
    private CaseRemindersUtil util;

    // -------------------------
    // createJsonInput
    // -------------------------

    @Test
    void createJsonInput_withCcAndBcc_includesCcBcc() {
        String json = util.createJsonInput(
                "to@test.com",
                "cc@test.com",
                "bcc@test.com",
                "subject",
                "body"
        );

        assertTrue(json.contains("\"EmailSubject\""));
        assertTrue(json.contains("\"EmailText\""));
        assertTrue(json.contains("\"SendTo\""));
        assertTrue(json.contains("\"cc\""));
        assertTrue(json.contains("\"bcc\""));
        assertTrue(json.contains("cc@test.com"));
        assertTrue(json.contains("bcc@test.com"));
    }

    @Test
    void createJsonInput_withoutCcAndBcc_doesNotIncludeCcBcc() {
        String json = util.createJsonInput(
                "to@test.com",
                null,
                null,
                "subject",
                "body"
        );

        assertTrue(json.contains("\"EmailSubject\""));
        assertTrue(json.contains("\"EmailText\""));
        assertTrue(json.contains("\"SendTo\""));
        assertFalse(json.contains("\"cc\""));
        assertFalse(json.contains("\"bcc\""));
    }

    // -------------------------
    // sendMailLogicAppPost
    // -------------------------

    @Test
    void sendMailLogicAppPost_success_returnsTrue_setsEntity_executes() throws Exception {
        HttpPost post = mock(HttpPost.class);
        HttpClient client = mock(HttpClient.class);
        HttpResponse response = mock(HttpResponse.class);

        when(client.execute(any(HttpPost.class))).thenReturn(response);

        boolean result = util.sendMailLogicAppPost(post, client, "{\"x\":1}");

        assertTrue(result);
        verify(post, times(1)).setEntity(any());
        verify(client, times(1)).execute(post);
    }

    @Test
    void sendMailLogicAppPost_exception_returnsFalse() throws Exception {
        HttpPost post = mock(HttpPost.class);
        HttpClient client = mock(HttpClient.class);

        when(client.execute(any(HttpPost.class))).thenThrow(new RuntimeException("http down"));

        boolean result = util.sendMailLogicAppPost(post, client, "{\"x\":1}");

        assertFalse(result);
        verify(post, times(1)).setEntity(any());
        verify(client, times(1)).execute(post);
    }

    // -------------------------
    // sendSimpleMailSmtp
    // -------------------------

    @Test
    void sendSimpleMailSmtp_withCcAndBcc_callsEmailMethods() throws Exception {
        Email email = mock(Email.class);

        EmailSpecs specs = new EmailSpecs();
        specs.setEmail(email);
        specs.setCtAdminEmailAddress("admin@test.com");
        specs.setEmailSubject("sub");
        specs.setEmailText("body");
        specs.setSendToEmail("to@test.com");
        specs.setCcEmail("cc@test.com");
        specs.setBccEmail("bcc@test.com");

        boolean result = util.sendSimpleMailSmtp(specs);

        // NOTE: implementation never sets mailStatus=true, so it returns false always.
        assertFalse(result);

        verify(email).setFrom("admin@test.com");
        verify(email).setSubject("sub");
        verify(email).setMsg("body");
        verify(email).addTo("to@test.com");
        verify(email).addCc("cc@test.com");
        verify(email).addBcc("bcc@test.com");
        verify(email).send();
    }

    @Test
    void sendSimpleMailSmtp_whenCcAndBccEmpty_doesNotAddCcBcc() throws Exception {
        Email email = mock(Email.class);

        EmailSpecs specs = new EmailSpecs();
        specs.setEmail(email);
        specs.setCtAdminEmailAddress("admin@test.com");
        specs.setEmailSubject("sub");
        specs.setEmailText("body");
        specs.setSendToEmail("to@test.com");
        specs.setCcEmail("");
        specs.setBccEmail(null);

        boolean result = util.sendSimpleMailSmtp(specs);

        assertFalse(result);

        verify(email).addTo("to@test.com");
        verify(email, never()).addCc(anyString());
        verify(email, never()).addBcc(anyString());
        verify(email).send();
    }

    @Test
    void sendSimpleMailSmtp_whenEmailSendThrows_returnsFalse() throws Exception {
        Email email = mock(Email.class);
        doThrow(new RuntimeException("smtp down")).when(email).send();

        EmailSpecs specs = new EmailSpecs();
        specs.setEmail(email);
        specs.setCtAdminEmailAddress("admin@test.com");
        specs.setEmailSubject("sub");
        specs.setEmailText("body");
        specs.setSendToEmail("to@test.com");

        boolean result = util.sendSimpleMailSmtp(specs);

        assertFalse(result);
        verify(email).send();
    }

    // -------------------------
    // sendMail (wrapper)
    // -------------------------

    @Test
    void sendMail_whenSmtpHostIsNull_usesLogicApp_returnsTrue() throws Exception {
        EmailSpecs specs = new EmailSpecs();
        specs.setSmtpHostName(null);
        specs.setHttpPost(mock(HttpPost.class));
        specs.setHttpClient(mock(HttpClient.class));
        specs.setSendToEmail("to@test.com");
        specs.setEmailSubject("subject");
        specs.setEmailText("body");
        specs.setCcEmail(null);
        specs.setBccEmail(null);

        // Stub internal calls
        doReturn("{\"ok\":true}").when(util).createJsonInput(any(), any(), any(), any(), any());
        doReturn(true).when(util).sendMailLogicAppPost(any(), any(), anyString());

        boolean result = util.sendMail(specs);

        assertTrue(result);
        verify(util).createJsonInput("to@test.com", null, null, "subject", "body");
        verify(util).sendMailLogicAppPost(specs.getHttpPost(), specs.getHttpClient(), "{\"ok\":true}");
        verify(util, never()).sendSimpleMailSmtp(any());
    }

    @Test
    void sendMail_whenSmtpHostPresent_usesSmtpBranch() throws Exception {
        EmailSpecs specs = new EmailSpecs();
        specs.setSmtpHostName("smtp.host");
        specs.setEmail(mock(Email.class));
        specs.setCtAdminEmailAddress("admin@test.com");
        specs.setSendToEmail("to@test.com");
        specs.setEmailSubject("subject");
        specs.setEmailText("body");

        doReturn(false).when(util).sendSimpleMailSmtp(any(EmailSpecs.class));

        boolean result = util.sendMail(specs);

        assertFalse(result);
        verify(util).sendSimpleMailSmtp(specs);
        verify(util, never()).sendMailLogicAppPost(any(), any(), anyString());
    }

    @Test
    void sendMail_whenThrowsException_returnsFalse() throws Exception {
        EmailSpecs specs = new EmailSpecs();
        specs.setSmtpHostName(null);
        specs.setHttpPost(mock(HttpPost.class));
        specs.setHttpClient(mock(HttpClient.class));
        specs.setSendToEmail("to@test.com");
        specs.setEmailSubject("subject");
        specs.setEmailText("body");

        // Force exception inside try
        doThrow(new RuntimeException("boom")).when(util).createJsonInput(any(), any(), any(), any(), any());

        boolean result = util.sendMail(specs);

        assertFalse(result);
        verify(util, never()).sendMailLogicAppPost(any(), any(), anyString());
    }

    // -------------------------
    // getEmailSpecs
    // -------------------------

    @Test
    void getEmailSpecs_logicAppPath_buildsHttpPostAndClient() {
        // IMPORTANT: getEmailSpecs calls ALL 3 keys ALWAYS
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.CT_ADMIN_ID))
                .thenReturn("admin@test.com");
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.AZURE_LOGIC_APP_URL))
                .thenReturn("http://logic-app");
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.SMTP_HOST_NAME))
                .thenReturn(null); // -> logic app branch

        // getCtAdminSystemId() invoked inside getEmailSpecs()
        when(userRepository.findByUiEMailAddress("admin@test.com"))
                .thenReturn(Optional.empty());

        EmailSpecs specs = util.getEmailSpecs();

        assertNotNull(specs);
        assertEquals("admin@test.com", specs.getCtAdminEmailAddress());
        assertEquals("http://logic-app", specs.getAzureLogicAppUrl());
        assertNull(specs.getSmtpHostName());
        assertNotNull(specs.getHttpPost());
        assertNotNull(specs.getHttpClient());
        assertNull(specs.getEmail());
    }

    @Test
    void getEmailSpecs_smtpPath_buildsEmailObject() {
        // IMPORTANT: getEmailSpecs calls ALL 3 keys ALWAYS
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.CT_ADMIN_ID))
                .thenReturn("admin@test.com");
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.AZURE_LOGIC_APP_URL))
                .thenReturn("http://logic-app"); // still called even though smtp branch
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.SMTP_HOST_NAME))
                .thenReturn("smtp.host"); // -> smtp branch

        when(userRepository.findByUiEMailAddress("admin@test.com"))
                .thenReturn(Optional.empty());

        EmailSpecs specs = util.getEmailSpecs();

        assertNotNull(specs);
        assertEquals("admin@test.com", specs.getCtAdminEmailAddress());
        assertEquals("smtp.host", specs.getSmtpHostName());
        assertNotNull(specs.getEmail());
        assertNull(specs.getHttpPost());
        // httpClient should remain null for smtp branch
        assertNull(specs.getHttpClient());
    }

    @Test
    void getEmailSpecs_whenCaseConfigThrows_returnsNonNullSpecs() {
        when(caseConfigRepository.getOptionValue(anyString()))
                .thenThrow(new RuntimeException("db down"));

        EmailSpecs specs = util.getEmailSpecs();

        // method catches exception and returns EmailSpecs (possibly empty)
        assertNotNull(specs);
    }

    // -------------------------
    // getCtAdminSystemId
    // -------------------------

    @Test
    void getCtAdminSystemId_whenUserPresent_returnsSystemId() {
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.CT_ADMIN_ID))
                .thenReturn("admin@test.com");

        UiUserBase user = mock(UiUserBase.class);
        when(user.getUiSystemId()).thenReturn("SYS123");

        when(userRepository.findByUiEMailAddress("admin@test.com"))
                .thenReturn(Optional.of(user));

        String result = util.getCtAdminSystemId();

        assertEquals("SYS123", result);
    }

    @Test
    void getCtAdminSystemId_whenUserAbsent_returnsNull() {
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.CT_ADMIN_ID))
                .thenReturn("admin@test.com");

        when(userRepository.findByUiEMailAddress("admin@test.com"))
                .thenReturn(Optional.empty());

        String result = util.getCtAdminSystemId();

        assertNull(result);
    }

    @Test
    void getCtAdminSystemId_whenRepoThrows_propagatesException() {
        // NOTE: this method does NOT catch exceptions; it will throw.
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.CT_ADMIN_ID))
                .thenReturn("admin@test.com");
        when(userRepository.findByUiEMailAddress("admin@test.com"))
                .thenThrow(new RuntimeException("db down"));

        assertThrows(RuntimeException.class, () -> util.getCtAdminSystemId());
    }
}
