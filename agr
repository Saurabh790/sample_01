package com.optum.fads.casereminders.api.general;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

import java.util.Optional;

import org.apache.commons.mail.Email;
import org.apache.http.HttpResponse;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpPost;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import com.optum.fads.casereminders.api.common.constants.CaseEntryConstants;
import com.optum.fads.casereminders.api.domain.UiUserBase;
import com.optum.fads.casereminders.api.dto.EmailSpecs;
import com.optum.fads.casereminders.api.repo.CaseConfigRepository;
import com.optum.fads.casereminders.api.repo.FadsConfigRepository;
import com.optum.fads.casereminders.api.repo.UserRepository;

@ExtendWith(MockitoExtension.class)
class CaseRemindersUtilTest {

    @Mock
    private FadsConfigRepository fadsConfigRepository;

    @Mock
    private UserRepository userRepository;

    @Mock
    private CaseConfigRepository caseConfigRepository;

    @InjectMocks
    private CaseRemindersUtil util;

    /* -------------------- createJsonInput -------------------- */

    @Test
    void createJsonInput_withCcAndBcc() {
        String json = util.createJsonInput(
                "to@test.com",
                "cc@test.com",
                "bcc@test.com",
                "subject",
                "body"
        );

        assertTrue(json.contains("EmailSubject"));
        assertTrue(json.contains("EmailText"));
        assertTrue(json.contains("SendTo"));
        assertTrue(json.contains("cc"));
        assertTrue(json.contains("bcc"));
    }

    @Test
    void createJsonInput_withoutCcAndBcc() {
        String json = util.createJsonInput(
                "to@test.com",
                null,
                null,
                "subject",
                "body"
        );

        assertTrue(json.contains("SendTo"));
        assertFalse(json.contains("cc"));
        assertFalse(json.contains("bcc"));
    }

    /* -------------------- getCtAdminSystemId -------------------- */

    @Test
    void getCtAdminSystemId_whenUserExists() {
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.CT_ADMIN_ID))
                .thenReturn("admin@test.com");

        UiUserBase user = mock(UiUserBase.class);
        when(user.getUiSystemId()).thenReturn("SYS123");

        when(userRepository.findByUiEMailAddress("admin@test.com"))
                .thenReturn(Optional.of(user));

        String result = util.getCtAdminSystemId();

        assertEquals("SYS123", result);
    }

    @Test
    void getCtAdminSystemId_whenUserMissing() {
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.CT_ADMIN_ID))
                .thenReturn("admin@test.com");

        when(userRepository.findByUiEMailAddress("admin@test.com"))
                .thenReturn(Optional.empty());

        String result = util.getCtAdminSystemId();

        assertNull(result);
    }

    /* -------------------- sendMailLogicAppPost -------------------- */

    @Test
    void sendMailLogicAppPost_success() throws Exception {
        HttpPost post = mock(HttpPost.class);
        HttpClient client = mock(HttpClient.class);
        HttpResponse response = mock(HttpResponse.class);

        when(client.execute(post)).thenReturn(response);

        boolean result = util.sendMailLogicAppPost(post, client, "{}");

        assertTrue(result);
    }

    @Test
    void sendMailLogicAppPost_exception() throws Exception {
        HttpPost post = mock(HttpPost.class);
        HttpClient client = mock(HttpClient.class);

        when(client.execute(post)).thenThrow(new RuntimeException("http down"));

        boolean result = util.sendMailLogicAppPost(post, client, "{}");

        assertFalse(result);
    }

    /* -------------------- sendSimpleMailSmtp -------------------- */

    @Test
    void sendSimpleMailSmtp_success() throws Exception {
        Email email = mock(Email.class);

        EmailSpecs specs = new EmailSpecs();
        specs.setEmail(email);
        specs.setSendToEmail("to@test.com");
        specs.setEmailSubject("subject");
        specs.setEmailText("body");
        specs.setCtAdminEmailAddress("admin@test.com");
        specs.setCcEmail("cc@test.com");
        specs.setBccEmail("bcc@test.com");

        boolean result = util.sendSimpleMailSmtp(specs);

        assertFalse(result); // method always returns false
        verify(email).send();
    }

    @Test
    void sendSimpleMailSmtp_exception() throws Exception {
        Email email = mock(Email.class);
        doThrow(new RuntimeException("smtp down")).when(email).send();

        EmailSpecs specs = new EmailSpecs();
        specs.setEmail(email);
        specs.setSendToEmail("to@test.com");
        specs.setEmailSubject("subject");
        specs.setEmailText("body");
        specs.setCtAdminEmailAddress("admin@test.com");

        boolean result = util.sendSimpleMailSmtp(specs);

        assertFalse(result);
    }

    /* -------------------- sendMail -------------------- */

    @Test
    void sendMail_azureLogicAppPath() {
        EmailSpecs specs = new EmailSpecs();
        specs.setSmtpHostName(null);
        specs.setHttpPost(mock(HttpPost.class));
        specs.setHttpClient(mock(HttpClient.class));
        specs.setSendToEmail("to@test.com");
        specs.setEmailSubject("subject");
        specs.setEmailText("body");

        CaseRemindersUtil spy = spy(util);
        doReturn(true).when(spy)
                .sendMailLogicAppPost(any(), any(), anyString());

        boolean result = spy.sendMail(specs);

        assertTrue(result);
    }

    @Test
    void sendMail_smtpPath() {
        EmailSpecs specs = new EmailSpecs();
        specs.setSmtpHostName("smtp.host");
        specs.setEmail(mock(Email.class));

        CaseRemindersUtil spy = spy(util);
        doReturn(true).when(spy).sendSimpleMailSmtp(specs);

        boolean result = spy.sendMail(specs);

        assertTrue(result);
    }

    @Test
    void sendMail_exception() {
        EmailSpecs specs = mock(EmailSpecs.class);

        CaseRemindersUtil spy = spy(util);
        doThrow(new RuntimeException("boom")).when(spy).createJsonInput(any(), any(), any(), any(), any());

        boolean result = spy.sendMail(specs);

        assertFalse(result);
    }

    /* -------------------- getEmailSpecs -------------------- */

    @Test
    void getEmailSpecs_azureLogicApp() {
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.CT_ADMIN_ID))
                .thenReturn("admin@test.com");
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.AZURE_LOGIC_APP_URL))
                .thenReturn("http://logic-app");
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.SMTP_HOST_NAME))
                .thenReturn(null);

        when(userRepository.findByUiEMailAddress(any()))
                .thenReturn(Optional.empty());

        EmailSpecs specs = util.getEmailSpecs();

        assertNotNull(specs.getHttpPost());
        assertNotNull(specs.getHttpClient());
    }

    @Test
    void getEmailSpecs_smtpPath() {
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.CT_ADMIN_ID))
                .thenReturn("admin@test.com");
        when(caseConfigRepository.getOptionValue(CaseEntryConstants.SMTP_HOST_NAME))
                .thenReturn("smtp.host");

        when(userRepository.findByUiEMailAddress(any()))
                .thenReturn(Optional.empty());

        EmailSpecs specs = util.getEmailSpecs();

        assertNotNull(specs.getEmail());
    }
}

