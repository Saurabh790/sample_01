package com.optum.fads.userroles.api.service.impl;

import com.optum.fads.userroles.api.domain.SeCaseGrp;
import com.optum.fads.userroles.api.domain.SeFadsGrp;
import com.optum.fads.userroles.api.domain.SeSurGrp;
import com.optum.fads.userroles.api.domain.SeUsrGrp;
import com.optum.fads.userroles.api.domain.UiUserBase;
import com.optum.fads.userroles.api.dto.CreateUserRoleRequest;
import com.optum.fads.userroles.api.repo.SeUsrGrpRepository;
import com.optum.fads.userroles.api.repo.UiUserBaseRepository;
import com.optum.fads.userroles.api.service.UserRoleCreateService;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class UserRoleCreateServiceImpl implements UserRoleCreateService {

    private final UiUserBaseRepository userRepo;
    private final SeUsrGrpRepository usrGrpRepo;

    @Override
    @Transactional
    public void createOrUpdateUser(CreateUserRoleRequest req) {
        // --- upsert UI_USER_BASE ---
        UiUserBase user = userRepo.findById(req.getUiSystemId())
                .orElseGet(UiUserBase::new);

        user.setUiSystemId(req.getUiSystemId());
        user.setUiUserId(req.getUiUserId());
        user.setUiFirstName(req.getFirstName());
        user.setUiLastName(req.getLastName());
        user.setUiEMailAddress(req.getEmail());

        userRepo.save(user);

        // --- upsert SE_USR_GRP (shares PK via @MapsId) ---
        SeUsrGrp grp = usrGrpRepo.findById(req.getUiSystemId())
                .orElseGet(SeUsrGrp::new);

        // PK and @MapsId owner
        grp.setUiSystemId(req.getUiSystemId());
        grp.setUiUserBase(user);

        // FADS_GRP_ID
        if (req.getFadsGrpId() != null) {
            SeFadsGrp f = new SeFadsGrp();
            f.setId(req.getFadsGrpId());
            grp.setFadsGrp(f);
        } else {
            grp.setFadsGrp(null);
        }

        // FADS_SUR_GRP_ID
        if (req.getFadsSurGrpId() != null) {
            SeSurGrp s = new SeSurGrp();
            s.setId(req.getFadsSurGrpId());  // <-- your entity uses 'id'
            grp.setFadsSurGrp(s);            // <-- your SeUsrGrp property name
        } else {
            grp.setFadsSurGrp(null);
        }

        // FADS_CASE_GRP_ID
        if (req.getFadsCaseGrpId() != null) {
            SeCaseGrp c = new SeCaseGrp();
            c.setId(req.getFadsCaseGrpId()); // <-- your entity uses 'id'
            grp.setFadsCaseGrp(c);           // <-- your SeUsrGrp property name
        } else {
            grp.setFadsCaseGrp(null);
        }

        usrGrpRepo.save(grp);
    }
}
