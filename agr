package com.optum.fads.pgp.behavior.api.service.impl;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.pgp.behavior.api.domain.SeSurGrpModAccess;
import com.optum.fads.pgp.behavior.api.domain.UiUserBase;
import com.optum.fads.pgp.behavior.api.dto.AccessLevel;
import com.optum.fads.pgp.behavior.api.dto.AppUser;
import com.optum.fads.pgp.behavior.api.dto.ModuleAccess;
import com.optum.fads.pgp.behavior.api.dto.Role;
import com.optum.fads.pgp.behavior.api.repo.UserRepository;
import com.optum.fads.pgp.behavior.api.service.IUserDetailsService;

@Service
public class UserDetailsService implements IUserDetailsService {

	@Autowired
	UserRepository userRepository;

	@Override
	@Transactional(readOnly = true)
	public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
		Optional<UiUserBase> optional = userRepository.findByUiEMailAddressOrUiUserId(username, username);
		optional.orElseThrow(() -> new UsernameNotFoundException("Not found: " + username));
		AppUser user = new AppUser();
		UiUserBase uiUserBase = optional.get();

		user.setUserEmail(uiUserBase.getUiEMailAddress());
		user.setUserId(uiUserBase.getUiUserId());
		user.setUserSystemId(uiUserBase.getUiSystemId());
		Role role = new Role();
		role.setId(Long.valueOf(uiUserBase.getSeUsrGrp().getSeSurGrp().getSurGrpId()).toString());
		role.setRoleName(uiUserBase.getSeUsrGrp().getSeSurGrp().getSurGrpName());
		List<SeSurGrpModAccess> surAccesses = uiUserBase.getSeUsrGrp().getSeSurGrp().getSeSurGrpModAccesses();

		List<AccessLevel> accesses = new ArrayList<AccessLevel>();
		surAccesses.forEach(surModuleAccess -> {
			accesses.add(new AccessLevel(surModuleAccess.getId().getSurModuleId(),
					ModuleAccess.getByName(surModuleAccess.getId().getSurModuleId()).toString(),
					surModuleAccess.getSeSurModule().getSurModuleName(),
					surModuleAccess.getSeSurAccess().getSurAccessId()));

		});

		role.setAllowedAccesses(accesses);
		user.setRole(role);
		return user;

	}

	

}



package com.optum.fads.pgp.behavior.api.security;


import java.util.Collection;
import java.util.Collections;
import java.util.Optional;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import org.springframework.core.convert.converter.Converter;
import org.springframework.security.authentication.AbstractAuthenticationToken;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.oauth2.jwt.Jwt;

import com.optum.fads.pgp.behavior.api.service.IUserDetailsService;

//@SuppressWarnings("unused")
public class UserJwtAuthenticationConverter implements Converter<Jwt, AbstractAuthenticationToken>{

	private static final String GROUPS_CLAIM = "groups";
	private static final String ROLE_PREFIX = "ROLE_";

	private final IUserDetailsService userDetailsService;

	public UserJwtAuthenticationConverter(IUserDetailsService userDetailsService) {
		this.userDetailsService = userDetailsService;
	}

	@Override
	public AbstractAuthenticationToken convert(Jwt jwt) {
		Collection<GrantedAuthority> authorities = extractAuthorities(jwt);
		return Optional.ofNullable(userDetailsService.loadUserByUsername(getUniqueID(jwt)))
				.map(u -> new UsernamePasswordAuthenticationToken(u, "n/a", authorities))
				.orElseThrow(() -> new BadCredentialsException("No user found"));
	}

	private Collection<GrantedAuthority> extractAuthorities(Jwt jwt) {
		return this.getGroups(jwt).stream().map(authority -> ROLE_PREFIX + authority.toUpperCase())
				.map(SimpleGrantedAuthority::new).collect(Collectors.toList());
	}

	@SuppressWarnings("unchecked")
	private Collection<String> getGroups(Jwt jwt) {
		Object groups = jwt.getClaims().get(GROUPS_CLAIM);
		if (groups instanceof Collection) {
			return (Collection<String>) groups;
		}

		return Collections.emptyList();
	}
	private String getUniqueID(Jwt jwt) {
		return Stream.of("upn", "unique_name", "email", "sub")
				.map(jwt::getClaimAsString)
				.filter(v -> v != null && !v.isBlank())
				.findFirst()
				.orElse(null);
	}
	
	
}

need junit for above class n repository for understan ding 


package com.optum.fads.pgp.behavior.api.repo;

import java.util.Optional;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import com.optum.fads.pgp.behavior.api.domain.UiUserBase;

import jakarta.transaction.Transactional;
@Transactional
@Repository
public interface UserRepository extends JpaRepository<UiUserBase, String> {
	Optional<UiUserBase> findByUiEMailAddressOrUiUserId(String userEmail, String userId);

}


