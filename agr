package com.optum.fads.pgp.reportsection.api.controller;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

import java.time.ZoneId;
import java.util.*;

import org.junit.jupiter.api.*;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.*;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;

import com.optum.fads.pgp.reportsection.api.common.ListTableParams;
import com.optum.fads.pgp.reportsection.api.common.ListTableParamsReq;
import com.optum.fads.pgp.reportsection.api.common.constants.ReportSectionConstants;
import com.optum.fads.pgp.reportsection.api.dto.*;
import com.optum.fads.pgp.reportsection.api.exception.ReportSectionApiException;
import com.optum.fads.pgp.reportsection.api.service.IReportItemDataService;

@ExtendWith(MockitoExtension.class)
class ReportItemControllerTests {

    @InjectMocks
    private ReportItemController controller;

    @Mock
    private IReportItemDataService service;

    @Mock
    private SecurityContext securityContext;

    @Mock
    private Authentication authentication;

    private AppUser userWithA;
    private AppUser userWithB;
    private AppUser userWithC;

    @BeforeEach
    void setup() {
        SecurityContextHolder.setContext(securityContext);

        // IMPORTANT: real objects, not mocks, so no stubbing happens here
        userWithA = buildRealUser("U1", "STUDY", "A");
        userWithB = buildRealUser("U1", "STUDY", "B");
        userWithC = buildRealUser("U1", "STUDY", "C");
    }

    @AfterEach
    void cleanup() {
        SecurityContextHolder.clearContext();
    }

    private void mockAuth(AppUser user) {
        when(securityContext.getAuthentication()).thenReturn(authentication);
        when(authentication.getPrincipal()).thenReturn(user);
    }

    /**
     * Build REAL objects (no Mockito).
     * If your AppUser/Role/AccessLevel are interfaces and can't be instantiated,
     * then you MUST switch to lenient stubs or only create these mocks in tests that use them.
     */
    private AppUser buildRealUser(String systemId, String moduleCode, String access) {
        AccessLevel al = new AccessLevel();
        al.setModuleCode(moduleCode);
        al.setAccess(access);

        Role role = new Role();
        role.setAllowedAccesses(Collections.singletonList(al));

        AppUser user = new AppUser();
        user.setUserSystemId(systemId);
        user.setRole(role);

        return user;
    }

    // ---------------- getReportItems ----------------
    @Test
    void getReportItems_ok() {
        ListTableParamsReq req = new ListTableParamsReq();
        req.setPageNumber(1);
        req.setRecordsPerPage(10);
        req.setSearchBy(Arrays.asList("reportItemName"));
        req.setSelectedItemIds(Arrays.asList(1, 2));
        req.setSortBy("reportItemName");
        req.setSortOrder(1);

        PaginationResultRI pr = new PaginationResultRI();
        when(service.getReportItemsList(any(ListTableParams.class))).thenReturn(pr);

        ResponseEntity<?> resp = controller.getReportItems(req, "opioids");

        assertEquals(HttpStatus.OK, resp.getStatusCode());
        assertSame(pr, resp.getBody());
    }

    @Test
    void getReportItems_exception_returns400() {
        when(service.getReportItemsList(any(ListTableParams.class)))
                .thenThrow(new ReportSectionApiException("boom"));

        ResponseEntity<?> resp = controller.getReportItems(new ListTableParamsReq(), "x");

        assertEquals(HttpStatus.BAD_REQUEST, resp.getStatusCode());
        assertEquals(ReportSectionConstants.EXCEPTION_MESSAGE, resp.getBody());
    }

    // ---------------- getReportItemById ----------------
    @Test
    void getReportItemById_ok() {
        ReportItemDTO dto = new ReportItemDTO();
        dto.setReportItemId(10);
        when(service.getReportItemById(10)).thenReturn(dto);

        ResponseEntity<?> resp = controller.getReportItemById(10);

        assertEquals(HttpStatus.OK, resp.getStatusCode());
        assertSame(dto, resp.getBody());
    }

    @Test
    void getReportItemById_exception_returns400() {
        when(service.getReportItemById(10)).thenThrow(new ReportSectionApiException("err"));

        ResponseEntity<?> resp = controller.getReportItemById(10);

        assertEquals(HttpStatus.BAD_REQUEST, resp.getStatusCode());
        assertEquals(ReportSectionConstants.EXCEPTION_MESSAGE, resp.getBody());
    }

    // ---------------- deleteReportItemById ----------------
    @Test
    void deleteReportItemById_ok() {
        List<String> msgs = Collections.singletonList("deleted");
        when(service.deleteReportItem(10)).thenReturn(msgs);

        ResponseEntity<?> resp = controller.deleteReportItemById(10);

        assertEquals(HttpStatus.OK, resp.getStatusCode());
        assertSame(msgs, resp.getBody());
    }

    @Test
    void deleteReportItemById_exception_returns400() {
        when(service.deleteReportItem(10)).thenThrow(new ReportSectionApiException("err"));

        ResponseEntity<?> resp = controller.deleteReportItemById(10);

        assertEquals(HttpStatus.BAD_REQUEST, resp.getStatusCode());
        assertEquals(ReportSectionConstants.EXCEPTION_MESSAGE, resp.getBody());
    }

    // ---------------- newReportItem ----------------
    @Test
    void newReportItem_accessA_created() {
        mockAuth(userWithA);

        when(service.getZoneId()).thenReturn(ZoneId.systemDefault());

        ReportItemDTO out = new ReportItemDTO();
        out.setReportItemId(999);
        when(service.addReportItem(any(ReportItemDTO.class))).thenReturn(out);

        ResponseEntity<?> resp = controller.newReportItem(new ReportItemDTO());

        assertEquals(HttpStatus.CREATED, resp.getStatusCode());
        assertSame(out, resp.getBody());
    }

    @Test
    void newReportItem_accessB_created() {
        mockAuth(userWithB);

        when(service.getZoneId()).thenReturn(ZoneId.systemDefault());
        when(service.addReportItem(any())).thenReturn(new ReportItemDTO());

        ResponseEntity<?> resp = controller.newReportItem(new ReportItemDTO());

        assertEquals(HttpStatus.CREATED, resp.getStatusCode());
    }

    @Test
    void newReportItem_noAccess_forbidden() {
        mockAuth(userWithC);

        ResponseEntity<?> resp = controller.newReportItem(new ReportItemDTO());

        assertEquals(HttpStatus.FORBIDDEN, resp.getStatusCode());
        assertEquals(ReportSectionConstants.NOT_AUTHORIZED, resp.getBody());

        verify(service, never()).addReportItem(any());
    }

    @Test
    void newReportItem_exception_returns400() {
        mockAuth(userWithA);

        when(service.getZoneId()).thenReturn(ZoneId.systemDefault());
        when(service.addReportItem(any())).thenThrow(new ReportSectionApiException("err"));

        ResponseEntity<?> resp = controller.newReportItem(new ReportItemDTO());

        assertEquals(HttpStatus.BAD_REQUEST, resp.getStatusCode());
        assertEquals(ReportSectionConstants.EXCEPTION_MESSAGE, resp.getBody());
    }

    // ---------------- updateReportItem ----------------
    @Test
    void updateReportItem_accessA_ok() {
        mockAuth(userWithA);

        when(service.getZoneId()).thenReturn(ZoneId.systemDefault());
        when(service.updateReportItem(eq(9), any())).thenReturn("updated");

        ReportItemDTO dto = new ReportItemDTO();
        dto.setCreatedBySystemId("OTHER");

        ResponseEntity<String> resp = controller.updateReportItem(9, dto);

        assertEquals(HttpStatus.OK, resp.getStatusCode());
        assertEquals("updated", resp.getBody());
    }

    @Test
    void updateReportItem_accessB_owner_ok() {
        mockAuth(userWithB);

        when(service.getZoneId()).thenReturn(ZoneId.systemDefault());
        when(service.updateReportItem(eq(9), any())).thenReturn("updated");

        ReportItemDTO dto = new ReportItemDTO();
        dto.setCreatedBySystemId("U1");

        ResponseEntity<String> resp = controller.updateReportItem(9, dto);

        assertEquals(HttpStatus.OK, resp.getStatusCode());
    }

    @Test
    void updateReportItem_accessB_notOwner_forbidden() {
        mockAuth(userWithB);

        ReportItemDTO dto = new ReportItemDTO();
        dto.setCreatedBySystemId("OTHER");

        ResponseEntity<String> resp = controller.updateReportItem(9, dto);

        assertEquals(HttpStatus.FORBIDDEN, resp.getStatusCode());
        assertEquals(ReportSectionConstants.NOT_AUTHORIZED, resp.getBody());

        verify(service, never()).updateReportItem(anyInt(), any());
    }

    @Test
    void updateReportItem_noAccess_forbidden() {
        mockAuth(userWithC);

        ResponseEntity<String> resp = controller.updateReportItem(9, new ReportItemDTO());

        assertEquals(HttpStatus.FORBIDDEN, resp.getStatusCode());
        assertEquals(ReportSectionConstants.NOT_AUTHORIZED, resp.getBody());
    }

    @Test
    void updateReportItem_exception_returns400() {
        mockAuth(userWithA);

        when(service.getZoneId()).thenReturn(ZoneId.systemDefault());
        when(service.updateReportItem(eq(9), any()))
                .thenThrow(new ReportSectionApiException("err"));

        ResponseEntity<String> resp = controller.updateReportItem(9, new ReportItemDTO());

        assertEquals(HttpStatus.BAD_REQUEST, resp.getStatusCode());
        assertEquals(ReportSectionConstants.EXCEPTION_MESSAGE, resp.getBody());
    }

    // ---------------- getAvailableBehaviors ----------------
    @Test
    void getAvailableBehaviors_ok() {
        List<BehaviorPatternDTO> list = new ArrayList<>();
        list.add(new BehaviorPatternDTO());

        when(service.getAvailableBehaviorPatterns(7)).thenReturn(list);

        ResponseEntity<?> resp = controller.getAvailableBehaviors(7);

        assertEquals(HttpStatus.OK, resp.getStatusCode());
        assertSame(list, resp.getBody());
    }

    @Test
    void getAvailableBehaviors_exception_returns400() {
        when(service.getAvailableBehaviorPatterns(7)).thenThrow(new ReportSectionApiException("err"));

        ResponseEntity<?> resp = controller.getAvailableBehaviors(7);

        assertEquals(HttpStatus.BAD_REQUEST, resp.getStatusCode());
        assertEquals(ReportSectionConstants.EXCEPTION_MESSAGE, resp.getBody());
    }

    // ---------------- getSelectedBehaviors ----------------
    @Test
    void getSelectedBehaviors_ok() {
        List<BehaviorPatternDTO> list = new ArrayList<>();
        list.add(new BehaviorPatternDTO());

        when(service.getSelectedBehaviorPatterns(7)).thenReturn(list);

        ResponseEntity<?> resp = controller.getSelectedBehaviors(7);

        assertEquals(HttpStatus.OK, resp.getStatusCode());
        assertSame(list, resp.getBody());
    }

    @Test
    void getSelectedBehaviors_exception_returns400() {
        when(service.getSelectedBehaviorPatterns(7)).thenThrow(new ReportSectionApiException("err"));

        ResponseEntity<?> resp = controller.getSelectedBehaviors(7);

        assertEquals(HttpStatus.BAD_REQUEST, resp.getStatusCode());
        assertEquals(ReportSectionConstants.EXCEPTION_MESSAGE, resp.getBody());
    }

    // ---------------- getMyReportItems ----------------
    @Test
    void getMyReportItems_addsUserSystemIdFilter_ok() {
        mockAuth(userWithA);

        PaginationResultRI pr = new PaginationResultRI();
        when(service.getReportItemsList(any(ListTableParams.class))).thenReturn(pr);

        ListTableParams params = new ListTableParams();
        ResponseEntity<?> resp = controller.getMyReportItems(params);

        assertEquals(HttpStatus.OK, resp.getStatusCode());
        assertSame(pr, resp.getBody());
    }

    @Test
    void getMyReportItems_exception_returns400() {
        mockAuth(userWithA);

        when(service.getReportItemsList(any(ListTableParams.class)))
                .thenThrow(new ReportSectionApiException("err"));

        ResponseEntity<?> resp = controller.getMyReportItems(new ListTableParams());

        assertEquals(HttpStatus.BAD_REQUEST, resp.getStatusCode());
        assertEquals(ReportSectionConstants.EXCEPTION_MESSAGE, resp.getBody());
    }
}
