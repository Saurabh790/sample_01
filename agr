package com.optum.fads.pgp.jobs.api.controller;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.optum.fads.pgp.jobs.api.common.FadsConfigProperties;
import com.optum.fads.pgp.jobs.api.common.JobsConstants;
import com.optum.fads.pgp.jobs.api.common.ListTableParams;
import com.optum.fads.pgp.jobs.api.dto.FadsUser;
import com.optum.fads.pgp.jobs.api.dto.JobDTO;
import com.optum.fads.pgp.jobs.api.dto.PaginationResult;
import com.optum.fads.pgp.jobs.api.service.IJobMonitorDataService;
import com.optum.fads.pgp.jobs.api.snowflakeDomain.JobMasterT;
import com.optum.fads.pgp.jobs.api.util.TestUtil;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.mockito.junit.jupiter.MockitoSettings;
import org.mockito.quality.Strictness;
import org.springframework.http.MediaType;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.lenient;
import static org.mockito.Mockito.when;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@ExtendWith(MockitoExtension.class)
@MockitoSettings(strictness = Strictness.LENIENT) // avoids UnnecessaryStubbing errors
public class JobMonitorControllerTest {

    private MockMvc mockMvc;

    @Mock private IJobMonitorDataService iJobMonitorDataService;
    @Mock private FadsUser appUser;
    @Mock private Authentication authentication;
    @Mock private SecurityContext securityContext;

    @InjectMocks private JobMonitorController jobMonitorController;

    private ObjectMapper objectMapper;
    private PaginationResult result;
    private List<JobDTO> jobDTOS;

    @BeforeEach
    void setUp() throws Exception {
        mockMvc = MockMvcBuilders.standaloneSetup(jobMonitorController).build();

        // SecurityContextHolder setup
        SecurityContextHolder.setContext(securityContext);
        lenient().when(securityContext.getAuthentication()).thenReturn(authentication);
        lenient().when(authentication.getPrincipal()).thenReturn(appUser);
        lenient().when(appUser.getUserSystemId()).thenReturn("test-user");

        result = new PaginationResult();

        List<JobMasterT> jobMasterSnowFlakeTS = new ArrayList<>();
        jobMasterSnowFlakeTS.add(TestUtil.initializeJobs(10));
        jobDTOS = TestUtil.populateJobDataList(jobMasterSnowFlakeTS);
        result.setJobsData(jobDTOS);

        objectMapper = new ObjectMapper();
    }

    @Test
    void sanity() {
        assertNotNull(mockMvc);
        assertNotNull(jobDTOS);
    }

    @Test
    void canceljobByIdTest_ok() throws Exception {
        JobDTO dto = jobDTOS.get(0);
        dto.setStatus(10); // MUST NOT be 14/15/18/20 (nonCancelledList)

        when(iJobMonitorDataService.getJobDetailsById(anyInt())).thenReturn(dto);
        when(iJobMonitorDataService.cancelJob(any(JobDTO.class))).thenReturn(JobsConstants.JOB_CANCELED);

        mockMvc.perform(MockMvcRequestBuilders.put("/canceljob/10")
                        .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk());
    }

    @Test
    void purgeJobsByIdTest_ok() throws Exception {
        JobDTO dto = jobDTOS.get(0);
        dto.setCaseCount(0);  // controller invalid when caseCount > 0
        dto.setStatus(14);    // controller invalid when status==1 || 15 || (6..12)

        when(iJobMonitorDataService.getJobDetailsById(anyInt())).thenReturn(dto);
        when(iJobMonitorDataService.purgeJob(any(JobDTO.class))).thenReturn(JobsConstants.JOB_PURGED);

        mockMvc.perform(MockMvcRequestBuilders.delete("/purgejob/10")
                        .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk());
    }

    @Test
    void changeScheduleDateByIdTest_ok() throws Exception {
        JobDTO dto = jobDTOS.get(0);
        dto.setStatus(1); // allowed ONLY for 1 or 3

        when(iJobMonitorDataService.changeScheduleDateById(any(JobDTO.class)))
                .thenReturn(JobsConstants.RUN_DATE_SAVED);

        mockMvc.perform(MockMvcRequestBuilders.put("/changescheduledate")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(dto)))
                .andExpect(status().isOk());
    }

    @Test
    void changePurgeDateById_ok() throws Exception {
        when(iJobMonitorDataService.changePurgeDateById(any(JobDTO.class)))
                .thenReturn(JobsConstants.PURGE_DATE_SAVED);

        // MUST be status=20, and purgeDate must match JobDTO JsonFormat "MM/dd/yyyy"
        String body = """
            {
              "jobId": 10,
              "status": 20,
              "purgeDate": "12/31/2025"
            }
            """;

        mockMvc.perform(MockMvcRequestBuilders.put("/changepurgedate")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(body))
                .andExpect(status().isOk());
    }

    @Test
    void getJobsByParmsTest_ok() throws Exception {
        when(iJobMonitorDataService.getJobsByListTableParms(any(ListTableParams.class)))
                .thenReturn(result);

        mockMvc.perform(MockMvcRequestBuilders.get("/getjobs/")
                        .accept(MediaType.APPLICATION_JSON)
                        .param("pageNumber", "1")
                        .param("recordsPerPage", "10")
                        .param("sortBy", "jobId")
                        .param("sortOrder", "-1")
                        .param("searchInput", "abc"))
                .andExpect(status().isOk());
    }

    @Test
    void getMyJobsByParmsTest_ok() throws Exception {
        when(iJobMonitorDataService.getJobsByListTableParms(any(ListTableParams.class)))
                .thenReturn(result);

        mockMvc.perform(MockMvcRequestBuilders.get("/getmyjobs/")
                        .accept(MediaType.APPLICATION_JSON)
                        .param("pageNumber", "1")
                        .param("recordsPerPage", "10"))
                .andExpect(status().isOk());
    }

    @Test
    void getJobDetailsByIdTest_ok() throws Exception {
        when(iJobMonitorDataService.getJobDetailsById(eq(10))).thenReturn(jobDTOS.get(0));

        mockMvc.perform(MockMvcRequestBuilders.get("/getjobdetails/10")
                        .accept(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk());
    }

    @Test
    void changeDateByIdTest_ok() throws Exception {
        when(iJobMonitorDataService.changeDatesById(eq(10)))
                .thenReturn(JobsConstants.CHANGE_DATES_INVALID_REQUEST);

        mockMvc.perform(MockMvcRequestBuilders.get("/changedates/10")
                        .accept(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk());
    }

    @Test
    void getreportURLTest_ok() throws Exception {
        when(iJobMonitorDataService.getReportUrlByOptionCd(anyLong())).thenReturn("COGNOS_REPORT_URL");

        mockMvc.perform(MockMvcRequestBuilders.get("/getreporturl/300")
                        .accept(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk());
    }

    // ✅ Adds coverage for: getCasesDetailsByJobId(Integer)
    @Test
    void getCasesDetailsByJobId_ok() throws Exception {
        when(iJobMonitorDataService.getCasesDetailsByJobId(eq(10)))
                .thenReturn(Arrays.asList("A-2025-00001", "B-2025-00002"));

        mockMvc.perform(MockMvcRequestBuilders.get("/getCasesDetails/10")
                        .accept(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk());
    }

    // ✅ Adds coverage for: getFadsConfigDetails(List)
    @Test
    void getFadsConfigDetails_ok() throws Exception {
        FadsConfigProperties p1 = new FadsConfigProperties();
        p1.setCode(300L);
        p1.setDesc("desc");
        p1.setValue("val");

        when(iJobMonitorDataService.getFadsConfigByIds(anyList()))
                .thenReturn(List.of(p1));

        mockMvc.perform(MockMvcRequestBuilders.get("/getFadsConfigDetails")
                        .accept(MediaType.APPLICATION_JSON)
                        .param("optionCodes", "300", "301"))
                .andExpect(status().isOk());
    }

    // ✅ Covers NumberFormatException branch in getFadsConfigDetails
    @Test
    void getFadsConfigDetails_badRequest_whenOptionCodesNotNumeric() throws Exception {
        mockMvc.perform(MockMvcRequestBuilders.get("/getFadsConfigDetails")
                        .accept(MediaType.APPLICATION_JSON)
                        .param("optionCodes", "ABC"))
                .andExpect(status().isBadRequest());
    }
}
