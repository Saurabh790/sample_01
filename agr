package com.optum.fads.pgp.jobs.api.mapper;

import com.optum.fads.pgp.jobs.api.dto.JobDTO;
import com.optum.fads.pgp.jobs.api.snowflakeDomain.JobLuStatusT;
import com.optum.fads.pgp.jobs.api.snowflakeDomain.JobMasterCasesT;
import com.optum.fads.pgp.jobs.api.snowflakeDomain.JobMasterT;
import org.junit.jupiter.api.Test;
import org.mapstruct.factory.Mappers;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

class JobDetailMapperTest {

    private final JobDetailMapper mapper = Mappers.getMapper(JobDetailMapper.class);

    @Test
    void convertToJob_shouldMapAllConfiguredFields() {
        // given
        JobMasterT src = new JobMasterT();
        src.setJobId(10);
        src.setPbId(101);
        src.setPbName("Study A");
        src.setPbDesc("Study Desc");

        JobLuStatusT status = new JobLuStatusT();
        status.setStatusCd(20);
        status.setStatusDesc("Complete");
        src.setJobLuStatusT(status);

        src.setPurgeFlag(1);

        Date started = new Date();
        Date completed = new Date();
        Date submitted = new Date();
        Date created = new Date();
        Date purge = new Date();

        src.setDateBeg(started);
        src.setDateEnd(completed);

        // NOTE: your DTO has LocalDateTime scheduledRunDate.
        // If JobMasterT.dateSched is Date or LocalDateTime, mapping may differ.
        // Here we set it only if JobMasterT supports LocalDateTime.
        // If it’s Date in your entity, keep it as Date.
        try {
            src.getClass().getMethod("setDateSched", LocalDateTime.class)
                    .invoke(src, LocalDateTime.now());
        } catch (Exception ignored) {
            // If setter not present with LocalDateTime, ignore for this test
        }

        src.setJobCgRows(111);
        src.setJobBpRows(222);
        src.setJobRiRows(333);

        src.setCreateUserName("creator");
        src.setCreateDte(created);      // mapped to submittedDate and createdDate
        src.setCreatedByUserId("sys-1");

        src.setDatePurge(purge);

        src.setUpdateUserName("modifier");
        src.setUpdateDte(new Date());

        // cases list -> caseCount
        List<JobMasterCasesT> cases = new ArrayList<>();
        cases.add(new JobMasterCasesT());
        cases.add(new JobMasterCasesT());
        src.setJobMasterCasesTs(cases);

        // when
        JobDTO dto = mapper.convertToJob(src);

        // then
        assertNotNull(dto);

        assertEquals(10, dto.getJobId());
        assertEquals(101, dto.getStudyId());
        assertEquals("Study A", dto.getStudyName());
        assertEquals("Study Desc", dto.getStudyDescription());

        assertEquals(20, dto.getStatus());
        assertEquals("Complete", dto.getStatusDescription());

        assertEquals(1, dto.getPurgeFlag());

        assertEquals(started, dto.getStartedDate());
        assertEquals(completed, dto.getCompletedDate());

        assertEquals(111, dto.getStudyRows());
        assertEquals(222, dto.getBehaviorPatternRows());
        assertEquals(333, dto.getReportItemRows());

        assertEquals("creator", dto.getCreatedBy());

        // createDte is mapped twice: submittedDate & createdDate
        assertEquals(created, dto.getSubmittedDate());
        assertEquals(created, dto.getCreatedDate());

        assertEquals("sys-1", dto.getCreatedBySystemId());

        assertEquals(purge, dto.getPurgeDate());

        assertEquals("modifier", dto.getModifiedBy());
        assertNotNull(dto.getModifiedDate());

        assertEquals(2, dto.getCaseCount());
    }

    @Test
    void convertToJob_shouldSetCaseCountToZero_whenCasesNull() {
        JobMasterT src = new JobMasterT();
        src.setJobId(1);
        src.setJobMasterCasesTs(null);

        JobDTO dto = mapper.convertToJob(src);

        assertNotNull(dto);
        assertEquals(0, dto.getCaseCount());
    }

    @Test
    void convertToJobDTOs_shouldMapList() {
        JobMasterT a = new JobMasterT();
        a.setJobId(1);

        JobMasterT b = new JobMasterT();
        b.setJobId(2);

        List<JobDTO> dtos = mapper.convertToJobDTOs(List.of(a, b));

        assertNotNull(dtos);
        assertEquals(2, dtos.size());
        assertEquals(1, dtos.get(0).getJobId());
        assertEquals(2, dtos.get(1).getJobId());
    }

    @Test
    void convertToJobMasterT_shouldNotThrow() {
        JobDTO dto = new JobDTO();
        dto.setJobId(10);
        dto.setStudyId(101);
        dto.setStudyName("Study A");
        dto.setStatus(20);

        JobMasterT entity = mapper.convertToJobMasterT(dto);

        assertNotNull(entity);
        // We don’t assert every inverse field because inverse config depends on your entity fields/types.
    }
}
