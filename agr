package com.optum.fads.pgp.jobs.api.config;

import com.nimbusds.jwt.JWTClaimsSet;
import com.nimbusds.jwt.PlainJWT;
import com.optum.fads.pgp.jobs.api.service.IUserDetailsService;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.mock.web.MockHttpServletRequest;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.oauth2.jwt.Jwt;
import org.springframework.security.oauth2.jwt.JwtDecoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;

import java.time.Instant;
import java.util.Date;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest(classes = SecurityConfig.class, webEnvironment = SpringBootTest.WebEnvironment.NONE)
class SecurityConfigTest {

    @MockBean
    private IUserDetailsService userDetailsService;

    @Autowired
    private SecurityFilterChain securityFilterChain;

    @Autowired
    private JwtDecoder jwtDecoder;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @Autowired
    private CorsConfigurationSource corsConfigurationSource;

    @Test
    void filterChainBean_shouldBeCreated() {
        assertNotNull(securityFilterChain);
    }

    @Test
    void jwtDecoder_shouldConvertDateClaimsToInstant() throws Exception {
        Date now = new Date();
        Date exp = new Date(now.getTime() + 60_000);

        JWTClaimsSet claims = new JWTClaimsSet.Builder()
                .claim("iat", now)
                .claim("exp", exp)
                .claim("nbf", now)
                .claim("auth_time", now)
                .claim("sub", "test-user")
                .build();

        String token = new PlainJWT(claims).serialize();

        Jwt decoded = jwtDecoder.decode(token);

        assertNotNull(decoded);

        Object iat = decoded.getClaims().get("iat");
        Object expClaim = decoded.getClaims().get("exp");
        Object nbf = decoded.getClaims().get("nbf");
        Object authTime = decoded.getClaims().get("auth_time");

        assertTrue(iat instanceof Instant, "iat should be Instant");
        assertTrue(expClaim instanceof Instant, "exp should be Instant");
        assertTrue(nbf instanceof Instant, "nbf should be Instant");
        assertTrue(authTime instanceof Instant, "auth_time should be Instant");
    }

    @Test
    void passwordEncoder_shouldEncodeAndMatch() {
        String raw = "myPass@123";
        String encoded = passwordEncoder.encode(raw);

        assertNotNull(encoded);
        assertTrue(passwordEncoder.matches(raw, encoded));
        assertFalse(passwordEncoder.matches("wrong", encoded));
    }

    @Test
    void corsConfigurationSource_shouldAllowAll() {
        MockHttpServletRequest req = new MockHttpServletRequest("GET", "/any");
        CorsConfiguration cfg = corsConfigurationSource.getCorsConfiguration(req);

        assertNotNull(cfg);

        List<String> origins = cfg.getAllowedOrigins();
        List<String> methods = cfg.getAllowedMethods();
        List<String> headers = cfg.getAllowedHeaders();

        assertNotNull(origins);
        assertNotNull(methods);
        assertNotNull(headers);

        assertTrue(origins.contains("*"));
        assertTrue(methods.contains("*"));
        assertTrue(headers.contains("*"));
    }
}
