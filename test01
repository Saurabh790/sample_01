package com.optum.fads.userroles.api.service.impl;

import com.optum.fads.userroles.api.domain.SeCaseGrp;
import com.optum.fads.userroles.api.domain.SeFadsGrp;
import com.optum.fads.userroles.api.domain.SeSurGrp;
import com.optum.fads.userroles.api.domain.SeUsrGrp;
import com.optum.fads.userroles.api.domain.UiUserBase;
import com.optum.fads.userroles.api.dto.CreateUserRoleRequest;
import com.optum.fads.userroles.api.dto.CreateUserRoleResponse;
import com.optum.fads.userroles.api.repo.SeCaseGrpRepository;
import com.optum.fads.userroles.api.repo.SeFadsGrpRepository;
import com.optum.fads.userroles.api.repo.SeSurGrpRepository;
import com.optum.fads.userroles.api.repo.SeUsrGrpRepository;
import com.optum.fads.userroles.api.repo.UiUserBaseRepository;
import com.optum.fads.userroles.api.service.UserRoleCreateService;
import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import jakarta.transaction.Transactional;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.math.BigDecimal;

@Service
public class UserRoleCreateServiceImpl implements UserRoleCreateService {

    private final UiUserBaseRepository userRepo;
    private final SeUsrGrpRepository usrGrpRepo;
    private final SeFadsGrpRepository fadsGrpRepo;
    private final SeSurGrpRepository  surGrpRepo;
    private final SeCaseGrpRepository caseGrpRepo;

    @PersistenceContext
    private EntityManager em;

    public UserRoleCreateServiceImpl(UiUserBaseRepository userRepo,
                                     SeUsrGrpRepository usrGrpRepo,
                                     SeFadsGrpRepository fadsGrpRepo,
                                     SeSurGrpRepository surGrpRepo,
                                     SeCaseGrpRepository caseGrpRepo) {
        this.userRepo = userRepo;
        this.usrGrpRepo = usrGrpRepo;
        this.fadsGrpRepo = fadsGrpRepo;
        this.surGrpRepo = surGrpRepo;
        this.caseGrpRepo = caseGrpRepo;
    }

    @Override
    @Transactional
    public CreateUserRoleResponse createOrUpdateUser(CreateUserRoleRequest req) {
        if (req == null || !StringUtils.hasText(req.getUiSystemId())) {
            throw new IllegalArgumentException("uiSystemId is required");
        }
        final String id = req.getUiSystemId().trim();

        // 1) Upsert UI_USER_BASE
        UiUserBase user = userRepo.findById(id).orElseGet(() -> {
            UiUserBase u = new UiUserBase();
            u.setUiSystemId(id);
            return u;
        });
        user.setUiUserId(req.getUiUserId());
        user.setUiFirstName(req.getFirstName());
        user.setUiLastName(req.getLastName());
        user.setUiEMailAddress(req.getEmail());
        user.setUiTitle(req.getTitle());
        user.setUiUserInactive(req.getUserInactive());
        user = userRepo.save(user); // managed

        // 2) Upsert SE_USR_GRP
        SeUsrGrp grp = usrGrpRepo.findById(id).orElseGet(() -> {
            SeUsrGrp g = new SeUsrGrp();
            g.setUiSystemId(id);
            g.setUiUserBase(user); // @MapsId link
            return g;
        });
        // keep the @MapsId link fresh
        grp.setUiUserBase(user);

        // (Optional) validate that provided group IDs exist; gives a clear 400-ish error
        validateLookupExists(req.getFadsGrpId(), fadsGrpRepo, "FADS_GRP_ID");
        validateLookupExists(req.getFadsSurGrpId(), surGrpRepo, "FADS_SUR_GRP_ID");
        validateLookupExists(req.getFadsCaseGrpId(), caseGrpRepo, "FADS_CASE_GRP_ID");

        // 3) attach MANAGED references (avoids transient/detached errors)
        grp.setFadsGrp(     refIfPresent(req.getFadsGrpId(),     SeFadsGrp.class));
        grp.setFadsSurGrp(  refIfPresent(req.getFadsSurGrpId(),  SeSurGrp.class));
        grp.setFadsCaseGrp( refIfPresent(req.getFadsCaseGrpId(), SeCaseGrp.class));

        usrGrpRepo.save(grp);

        // 4) Build response (include names for convenience)
        CreateUserRoleResponse out = new CreateUserRoleResponse();
        out.setUiSystemId(user.getUiSystemId());
        out.setUiUserId(user.getUiUserId());
        out.setFirstName(user.getUiFirstName());
        out.setLastName(user.getUiLastName());
        out.setEmail(user.getUiEMailAddress());
        out.setTitle(user.getUiTitle());
        out.setUserInactive(user.getUiUserInactive());

        if (req.getFadsGrpId() != null) {
            out.setFadsGrpId(req.getFadsGrpId());
            out.setFadsGrpName(fadsGrpRepo.findById(req.getFadsGrpId()).map(SeFadsGrp::getFadsGrpName).orElse(null));
        }
        if (req.getFadsSurGrpId() != null) {
            out.setFadsSurGrpId(req.getFadsSurGrpId());
            out.setFadsSurGrpName(surGrpRepo.findById(req.getFadsSurGrpId()).map(SeSurGrp::getSurGrpName).orElse(null));
        }
        if (req.getFadsCaseGrpId() != null) {
            out.setFadsCaseGrpId(req.getFadsCaseGrpId());
            out.setFadsCaseGrpName(caseGrpRepo.findById(req.getFadsCaseGrpId()).map(SeCaseGrp::getCaseGrpName).orElse(null));
        }
        return out;
    }

    private <T> T refIfPresent(BigDecimal id, Class<T> type) {
        return id == null ? null : em.getReference(type, id);
    }

    private <E, ID> void validateLookupExists(ID id,
                                              org.springframework.data.repository.CrudRepository<E, ID> repo,
                                              String field) {
        if (id != null && !repo.existsById(id)) {
            throw new IllegalArgumentException(field + " " + id + " does not exist.");
        }
    }
}
