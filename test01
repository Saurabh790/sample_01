package com.optum.fads.authorization.api.service.impl;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.authorization.api.dto.CaseModule;
import com.optum.fads.authorization.api.dto.CaseNode;
import com.optum.fads.authorization.api.dto.CaseRole;
import com.optum.fads.authorization.api.dto.CaseTypeModule;
import com.optum.fads.authorization.api.dto.FADSUser;
import com.optum.fads.authorization.api.dto.FadsRole;
import com.optum.fads.authorization.api.dto.ModuleAccess;
import com.optum.fads.authorization.api.dto.PgpRole;
import com.optum.fads.authorization.api.dto.SurAccessLevel;
import com.optum.fads.authorization.api.entity.SeCaseGrp;
import com.optum.fads.authorization.api.entity.SeCaseGrpModAccess;
import com.optum.fads.authorization.api.entity.SeCaseGrpNodeAccess;
import com.optum.fads.authorization.api.entity.SeFadsGrp;
import com.optum.fads.authorization.api.entity.SeSurGrpModAccess;
import com.optum.fads.authorization.api.entity.UiUserBase;
import com.optum.fads.authorization.api.mapper.UserDetailMapper;
import com.optum.fads.authorization.api.repo.UserRepository;
import com.optum.fads.authorization.api.service.IUserDetailsService;

@Service
public class UserDetailsService implements IUserDetailsService {

    private static final Logger log = LoggerFactory.getLogger(UserDetailsService.class);

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private UserDetailMapper userDetailMapper;

    @Override
    @Transactional(readOnly = true)
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        log.info("Attempting to load user by username: {}", username);

        UiUserBase uiUserBase = userRepository.findByUiEMailAddress(username)
                .orElseThrow(() -> new UsernameNotFoundException("Not found: " + username));

        // Base user DTO
        FADSUser user = userDetailMapper.toAppUser(uiUserBase);

        // --------- FADS ROLE (MINIMAL: ONLY groupId & groupName) ----------
        SeFadsGrp fadsGrp = uiUserBase.getSeUsrGrp() != null ? uiUserBase.getSeUsrGrp().getSeFadsGrp() : null;
        if (fadsGrp != null) {
            FadsRole fadsRole = new FadsRole();
            fadsRole.setGroupId(fadsGrp.getFadsGrpId());
            fadsRole.setGroupName(fadsGrp.getFadsGrpName());
            // Do NOT populate componentPermissions/modules/elements
            user.getRole().setFadsRole(fadsRole);
        }

        // --------- PGP / SUR ROLE ----------
        if (uiUserBase.getSeUsrGrp() != null && uiUserBase.getSeUsrGrp().getSeSurGrp() != null) {
            Set<SeSurGrpModAccess> surAccesses = uiUserBase.getSeUsrGrp().getSeSurGrp().getSeSurGrpModAccesses();

            var accesses = new ArrayList<SurAccessLevel>();
            for (SeSurGrpModAccess surModuleAccess : surAccesses) {
                accesses.add(new SurAccessLevel(
                        surModuleAccess.getId().getSurModuleId(),
                        ModuleAccess.getByName(surModuleAccess.getId().getSurModuleId()).toString(),
                        surModuleAccess.getSeSurModule().getSurModuleName(),
                        surModuleAccess.getSeSurAccess().getSurAccessId()
                ));
            }

            user.getRole().setPgpRole(
                    PgpRole.builder()
                            .groupId(uiUserBase.getSeUsrGrp().getSeSurGrp().getSurGrpId())
                            .roleName(uiUserBase.getSeUsrGrp().getSeSurGrp().getSurGrpName())
                            .pgpAccesses(accesses)
                            .build()
            );
        }

        // --------- CASE ROLE ----------
        SeCaseGrp seCaseGrp = (uiUserBase.getSeUsrGrp() != null) ? uiUserBase.getSeUsrGrp().getSeCaseGrp() : null;
        if (seCaseGrp != null) {
            CaseRole caseRole = new CaseRole();
            caseRole.setGroupId(seCaseGrp.getCaseGrpId());
            caseRole.setRoleName(seCaseGrp.getCaseGrpName());

            Set<SeCaseGrpModAccess> modAccesses = seCaseGrp.getSeCaseGrpModAccesses();

            var caseTypeModules = new ArrayList<CaseTypeModule>();
            Map<String, String> caseTypes = new HashMap<>();
            Map<String, ArrayList<CaseModule>> modulePermissions = new HashMap<>();

            // Build module permissions per case type
            for (SeCaseGrpModAccess caseGrp : modAccesses) {
                CaseModule caseModule = new CaseModule();
                caseModule.setModuleId(caseGrp.getSeCaseModule().getCaseModuleId());
                caseModule.setModuleCd(caseGrp.getSeCaseModule().getCaseModuleCd());
                caseModule.setModuleName(caseGrp.getSeCaseModule().getCaseModuleName());
                caseModule.setModuleAccess(caseGrp.getSeCaseAccess().getAccessId());

                modulePermissions
                        .computeIfAbsent(caseGrp.getCaLuCaseTypeT().getTypeCd(), k -> new ArrayList<>())
                        .add(caseModule);

                caseTypes.put(caseGrp.getCaLuCaseTypeT().getTypeCd(), caseGrp.getCaLuCaseTypeT().getTypeDesc());
            }

            // Assemble CaseTypeModule list
            caseTypes.forEach((typeCd, typeDesc) -> {
                CaseTypeModule caseTypeModule = new CaseTypeModule();
                caseTypeModule.setCaseTypeId(typeCd);
                caseTypeModule.setCaseTypeName(typeDesc);
                caseTypeModule.setModulePermissions(modulePermissions.get(typeCd));
                caseTypeModules.add(caseTypeModule);
            });

            caseRole.setCaseTypeModules(caseTypeModules);

            // Node permissions
            Set<SeCaseGrpNodeAccess> nodeAccesses = seCaseGrp.getSeCaseGrpNodeAccesses();
            Collection<CaseNode> nodePermissions = new ArrayList<>();

            for (SeCaseGrpNodeAccess na : nodeAccesses) {
                CaseNode node = new CaseNode();
                node.setNodeId(na.getId().getCaseNodeId());
                node.setNodeAccess(na.getSeCaseAccess().getAccessId());
                node.setRestrictAccess(na.getAnyRestrictApply());
                node.setDeleteAccess(na.getCanDeleteCases());
                nodePermissions.add(node);
            }

            caseRole.setNodePermissions(new HashSet<>(nodePermissions));
            user.getRole().setCaseRole(caseRole);
        }

        return user;
    }
}
