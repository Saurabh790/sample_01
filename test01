package com.optum.fads.userroles.api.service.impl;

import com.optum.fads.userroles.api.domain.*;
import com.optum.fads.userroles.api.dto.CreateUserRoleRequest;
import com.optum.fads.userroles.api.dto.CreateUserRoleResponse;
import com.optum.fads.userroles.api.repo.*;
import com.optum.fads.userroles.api.service.UserRoleCreateService;
import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import jakarta.transaction.Transactional;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.math.BigDecimal;

@Service
public class UserRoleCreateServiceImpl implements UserRoleCreateService {

    private final UiUserBaseRepository userRepo;
    private final SeUsrGrpRepository usrGrpRepo;
    private final SeFadsGrpRepository fadsGrpRepo;
    private final SeSurGrpRepository  surGrpRepo;
    private final SeCaseGrpRepository caseGrpRepo;

    @PersistenceContext
    private EntityManager em;

    public UserRoleCreateServiceImpl(UiUserBaseRepository userRepo,
                                     SeUsrGrpRepository usrGrpRepo,
                                     SeFadsGrpRepository fadsGrpRepo,
                                     SeSurGrpRepository surGrpRepo,
                                     SeCaseGrpRepository caseGrpRepo) {
        this.userRepo = userRepo;
        this.usrGrpRepo = usrGrpRepo;
        this.fadsGrpRepo = fadsGrpRepo;
        this.surGrpRepo = surGrpRepo;
        this.caseGrpRepo = caseGrpRepo;
    }

    @Override
    @Transactional
    public CreateUserRoleResponse createOrUpdateUser(CreateUserRoleRequest req) {
        if (req == null || !StringUtils.hasText(req.getUiSystemId())) {
            throw new IllegalArgumentException("uiSystemId is required");
        }
        // keep a plain local; no lambdas/method-refs below
        final String id = req.getUiSystemId().trim();

        // 1) Upsert UI_USER_BASE (no lambdas)
        UiUserBase user = userRepo.findById(id).orElse(null);
        if (user == null) {
            user = new UiUserBase();
            user.setUiSystemId(id);
        }
        user.setUiUserId(req.getUiUserId());
        user.setUiFirstName(req.getFirstName());
        user.setUiLastName(req.getLastName());
        user.setUiEMailAddress(req.getEmail());
        user.setUiTitle(req.getTitle());
        user.setUiUserInactive(req.getUserInactive());
        user = userRepo.save(user); // managed

        // 2) Upsert SE_USR_GRP (no lambdas)
        SeUsrGrp grp = usrGrpRepo.findById(id).orElse(null);
        if (grp == null) {
            grp = new SeUsrGrp();
            grp.setUiSystemId(id);
        }
        // keep the @MapsId link fresh
        grp.setUiUserBase(user);

        // (Optional) validate lookups exist to avoid FK issues
        validateExists(req.getFadsGrpId(),    "FADS_GRP_ID",    fadsGrpRepo);
        validateExists(req.getFadsSurGrpId(), "FADS_SUR_GRP_ID", surGrpRepo);
        validateExists(req.getFadsCaseGrpId(), "FADS_CASE_GRP_ID", caseGrpRepo);

        // 3) attach MANAGED references via EntityManager.getReference (no lambdas)
        grp.setFadsGrp(     ref(SeFadsGrp.class, req.getFadsGrpId()));
        grp.setFadsSurGrp(  ref(SeSurGrp.class,  req.getFadsSurGrpId()));
        grp.setFadsCaseGrp( ref(SeCaseGrp.class, req.getFadsCaseGrpId()));

        usrGrpRepo.save(grp);

        // 4) Build response (no streams/lambdas)
        CreateUserRoleResponse out = new CreateUserRoleResponse();
        out.setUiSystemId(user.getUiSystemId());
        out.setUiUserId(user.getUiUserId());
        out.setFirstName(user.getUiFirstName());
        out.setLastName(user.getUiLastName());
        out.setEmail(user.getUiEMailAddress());
        out.setTitle(user.getUiTitle());
        out.setUserInactive(user.getUiUserInactive());

        if (req.getFadsGrpId() != null) {
            out.setFadsGrpId(req.getFadsGrpId());
            SeFadsGrp fg = fadsGrpRepo.findById(req.getFadsGrpId()).orElse(null);
            out.setFadsGrpName(fg != null ? fg.getFadsGrpName() : null);
        }
        if (req.getFadsSurGrpId() != null) {
            out.setFadsSurGrpId(req.getFadsSurGrpId());
            SeSurGrp sg = surGrpRepo.findById(req.getFadsSurGrpId()).orElse(null);
            out.setFadsSurGrpName(sg != null ? sg.getSurGrpName() : null);
        }
        if (req.getFadsCaseGrpId() != null) {
            out.setFadsCaseGrpId(req.getFadsCaseGrpId());
            SeCaseGrp cg = caseGrpRepo.findById(req.getFadsCaseGrpId()).orElse(null);
            out.setFadsCaseGrpName(cg != null ? cg.getCaseGrpName() : null);
        }
        return out;
    }

    private <T> T ref(Class<T> type, BigDecimal id) {
        return id == null ? null : em.getReference(type, id);
    }

    private <E, ID> void validateExists(ID id, String field,
                                        org.springframework.data.repository.CrudRepository<E, ID> repo) {
        if (id != null && !repo.existsById(id)) {
            throw new IllegalArgumentException(field + " " + id + " does not exist.");
        }
    }
}
