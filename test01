

DROP TABLE IF EXISTS TXN_SOURCE;
DROP TABLE IF EXISTS CUSTOMER;
DROP TABLE IF EXISTS PRODUCT;
DROP TABLE IF EXISTS TXN_STAGE;
DROP TABLE IF EXISTS FINAL_TXN_LINE;
DROP TABLE IF EXISTS INVOICE_FINAL;
DROP TABLE IF EXISTS TXN_ERROR;

CREATE TABLE CUSTOMER (
  customer_id VARCHAR(20) PRIMARY KEY,
  discount_rate DECIMAL(5,2) NOT NULL
);

CREATE TABLE PRODUCT (
  product_id VARCHAR(20) PRIMARY KEY,
  tax_rate DECIMAL(5,2) NOT NULL
);

-- status: N=new, D=done, E=error
CREATE TABLE TXN_SOURCE (
  txn_id BIGINT PRIMARY KEY,
  customer_id VARCHAR(20),
  product_id VARCHAR(20),
  txn_amount DECIMAL(18,2),
  txn_time TIMESTAMP NOT NULL,
  currency VARCHAR(10) NOT NULL,
  channel VARCHAR(10) NOT NULL,
  invoice_date DATE NOT NULL,
  status CHAR(1) DEFAULT 'N' NOT NULL,
  run_id VARCHAR(80)
);

CREATE INDEX IDX_TXN_SOURCE_DATE_STATUS ON TXN_SOURCE(invoice_date, status);

-- persistent staging (audit of GOOD rows)

CREATE TABLE TXN_STAGE (
  stage_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  run_id VARCHAR(80) NOT NULL,
  invoice_date DATE NOT NULL,
  txn_id BIGINT NOT NULL,
  customer_id VARCHAR(20),
  product_id VARCHAR(20),
  base_amount DECIMAL(18,2),

  -- allow NULLs for POC
  discount_rate DECIMAL(5,2),
  tax_rate DECIMAL(5,2),

  discount DECIMAL(18,2),
  tax DECIMAL(18,2),
  commission DECIMAL(18,2),
  net_amount DECIMAL(18,2),
  created_at TIMESTAMP NOT NULL
);


CREATE UNIQUE INDEX UX_STAGE_RUN_TXN ON TXN_STAGE(run_id, txn_id);

CREATE TABLE TXN_ERROR (
  error_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  run_id VARCHAR(80) NOT NULL,
  invoice_date DATE NOT NULL,
  txn_id BIGINT NOT NULL,
  customer_id VARCHAR(20),
  product_id VARCHAR(20),
  txn_amount DECIMAL(18,2),
  error_reason VARCHAR(300) NOT NULL,
  created_at TIMESTAMP NOT NULL
);

-- final per-transaction computed output
CREATE TABLE FINAL_TXN_LINE (
  txn_id BIGINT PRIMARY KEY,
  run_id VARCHAR(80) NOT NULL,
  invoice_date DATE NOT NULL,
  customer_id VARCHAR(20) NOT NULL,
  base_amount DECIMAL(18,2) NOT NULL,
  discount DECIMAL(18,2) NOT NULL,
  tax DECIMAL(18,2) NOT NULL,
  commission DECIMAL(18,2) NOT NULL,
  net_amount DECIMAL(18,2) NOT NULL,
  created_at TIMESTAMP NOT NULL
);

CREATE INDEX IDX_FINAL_RUN ON FINAL_TXN_LINE(run_id);

-- aggregated invoice per customer/day
CREATE TABLE INVOICE_FINAL (
  invoice_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  run_id VARCHAR(80) NOT NULL,
  customer_id VARCHAR(20) NOT NULL,
  invoice_date DATE NOT NULL,
  total_gross DECIMAL(18,2) NOT NULL,
  total_discount DECIMAL(18,2) NOT NULL,
  total_tax DECIMAL(18,2) NOT NULL,
  total_commission DECIMAL(18,2) NOT NULL,
  total_net DECIMAL(18,2) NOT NULL,
  created_at TIMESTAMP NOT NULL
);

CREATE INDEX IDX_INVOICE_RUN ON INVOICE_FINAL(run_id);

  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::               (v2.7.18)

2026-01-28 13:29:51.596  INFO 15392 --- [           main] c.o.f.c.poc.InvoiceBatchApplication      : Starting InvoiceBatchApplication using Java 17.0.10 on vetsodi10019581 with PID 15392 (C:\Users\sgupt664\BE_Projects\CaseEntryBatchPOC\target\classes started by sgupt664 in C:\Users\sgupt664\BE_Projects\CaseEntryBatchPOC)
2026-01-28 13:29:51.598 DEBUG 15392 --- [           main] c.o.f.c.poc.InvoiceBatchApplication      : Running with Spring Boot v2.7.18, Spring v5.3.31
2026-01-28 13:29:51.599  INFO 15392 --- [           main] c.o.f.c.poc.InvoiceBatchApplication      : No active profile set, falling back to 1 default profile: "default"
2026-01-28 13:29:52.458  INFO 15392 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...
2026-01-28 13:29:52.692  INFO 15392 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
2026-01-28 13:29:52.936  WARN 15392 --- [           main] o.s.b.c.l.AbstractListenerFactoryBean    : org.springframework.batch.item.ItemProcessor is an interface. The implementing class will not be queried for annotation based listener configurations. If using @StepScope on a @Bean method, be sure to return the implementing class so listener annotations can be used.
2026-01-28 13:29:53.003  INFO 15392 --- [           main] o.s.b.c.r.s.JobRepositoryFactoryBean     : No database type set, using meta data indicating: H2
2026-01-28 13:29:53.197  INFO 15392 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : No TaskExecutor has been set, defaulting to synchronous executor.
2026-01-28 13:29:53.304  INFO 15392 --- [           main] c.o.f.c.poc.InvoiceBatchApplication      : Started InvoiceBatchApplication in 2.278 seconds (JVM running for 2.68)
2026-01-28 13:29:53.417  INFO 15392 --- [           main] c.o.f.c.poc.data.DataSeeder              : DataSeeder: Inserted 100 TXN_SOURCE rows for invoice_date=2026-01-24
2026-01-28 13:29:53.417  INFO 15392 --- [           main] o.s.b.a.b.JobLauncherApplicationRunner   : Running default command line with: []
2026-01-28 13:29:53.458  INFO 15392 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=invoiceJob]] launched with the following parameters: [{runId=RUN_2026-01-24_2026-01-28T13:29:53.426141200, invoiceDate=2026-01-24, run.id=1}]
2026-01-28 13:29:53.500  INFO 15392 --- [           main] o.s.batch.core.job.SimpleStepHandler     : Executing step: [processTxnStep]
2026-01-28 13:29:53.738 ERROR 15392 --- [           main] o.s.batch.core.step.AbstractStep         : Encountered an error executing step processTxnStep in job invoiceJob

org.springframework.dao.DataIntegrityViolationException: PreparedStatementCallback; SQL [INSERT INTO FINAL_TXN_LINE(txn_id, run_id, invoice_date, customer_id, base_amount, discount, tax, commission, net_amount, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)]; NULL not allowed for column "DISCOUNT"; SQL statement:
INSERT INTO FINAL_TXN_LINE(txn_id, run_id, invoice_date, customer_id, base_amount, discount, tax, commission, net_amount, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP) [23502-214]; nested exception is org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: NULL not allowed for column "DISCOUNT"; SQL statement:
INSERT INTO FINAL_TXN_LINE(txn_id, run_id, invoice_date, customer_id, base_amount, discount, tax, commission, net_amount, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP) [23502-214]
        at org.springframework.jdbc.support.SQLErrorCodeSQLExceptionTranslator.doTranslate(SQLErrorCodeSQLExceptionTranslator.java:248) ~[spring-jdbc-5.3.31.jar:5.3.31]
        at org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:73) ~[spring-jdbc-5.3.31.jar:5.3.31]
        at org.springframework.jdbc.core.JdbcTemplate.translateException(JdbcTemplate.java:1577) ~[spring-jdbc-5.3.31.jar:5.3.31]
        at org.springframework.jdbc.core.JdbcTemplate.execute(JdbcTemplate.java:669) ~[spring-jdbc-5.3.31.jar:5.3.31]
        at org.springframework.jdbc.core.JdbcTemplate.execute(JdbcTemplate.java:693) ~[spring-jdbc-5.3.31.jar:5.3.31]
        at org.springframework.jdbc.core.JdbcTemplate.batchUpdate(JdbcTemplate.java:1036) ~[spring-jdbc-5.3.31.jar:5.3.31]
        at org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate.batchUpdate(NamedParameterJdbcTemplate.java:371) ~[spring-jdbc-5.3.31.jar:5.3.31]
        at org.springframework.batch.item.database.JdbcBatchItemWriter.write(JdbcBatchItemWriter.java:182) ~[spring-batch-infrastructure-4.3.10.jar:4.3.10]
        at org.springframework.batch.item.support.CompositeItemWriter.write(CompositeItemWriter.java:59) ~[spring-batch-infrastructure-4.3.10.jar:4.3.10]
        at org.springframework.batch.core.step.item.SimpleChunkProcessor.writeItems(SimpleChunkProcessor.java:193) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.batch.core.step.item.SimpleChunkProcessor.doWrite(SimpleChunkProcessor.java:159) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.batch.core.step.item.SimpleChunkProcessor.write(SimpleChunkProcessor.java:294) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.batch.core.step.item.SimpleChunkProcessor.process(SimpleChunkProcessor.java:217) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.batch.core.step.item.ChunkOrientedTasklet.execute(ChunkOrientedTasklet.java:77) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.batch.core.step.tasklet.TaskletStep$ChunkTransactionCallback.doInTransaction(TaskletStep.java:407) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.batch.core.step.tasklet.TaskletStep$ChunkTransactionCallback.doInTransaction(TaskletStep.java:331) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.transaction.support.TransactionTemplate.execute(TransactionTemplate.java:140) ~[spring-tx-5.3.31.jar:5.3.31]
        at org.springframework.batch.core.step.tasklet.TaskletStep$2.doInChunkContext(TaskletStep.java:273) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.batch.core.scope.context.StepContextRepeatCallback.doInIteration(StepContextRepeatCallback.java:82) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.batch.repeat.support.RepeatTemplate.getNextResult(RepeatTemplate.java:382) ~[spring-batch-infrastructure-4.3.10.jar:4.3.10]
        at org.springframework.batch.repeat.support.RepeatTemplate.executeInternal(RepeatTemplate.java:215) ~[spring-batch-infrastructure-4.3.10.jar:4.3.10]
        at org.springframework.batch.repeat.support.RepeatTemplate.iterate(RepeatTemplate.java:145) ~[spring-batch-infrastructure-4.3.10.jar:4.3.10]
        at org.springframework.batch.core.step.tasklet.TaskletStep.doExecute(TaskletStep.java:258) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.batch.core.step.AbstractStep.execute(AbstractStep.java:208) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.batch.core.job.SimpleStepHandler.handleStep(SimpleStepHandler.java:152) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.batch.core.job.AbstractJob.handleStep(AbstractJob.java:413) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.batch.core.job.SimpleJob.doExecute(SimpleJob.java:136) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.batch.core.job.AbstractJob.execute(AbstractJob.java:320) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.batch.core.launch.support.SimpleJobLauncher$1.run(SimpleJobLauncher.java:149) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.core.task.SyncTaskExecutor.execute(SyncTaskExecutor.java:50) ~[spring-core-5.3.31.jar:5.3.31]
        at org.springframework.batch.core.launch.support.SimpleJobLauncher.run(SimpleJobLauncher.java:140) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:na]
        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77) ~[na:na]
        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:na]
        at java.base/java.lang.reflect.Method.invoke(Method.java:568) ~[na:na]
        at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:344) ~[spring-aop-5.3.31.jar:5.3.31]
        at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:198) ~[spring-aop-5.3.31.jar:5.3.31]
        at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163) ~[spring-aop-5.3.31.jar:5.3.31]
        at org.springframework.batch.core.configuration.annotation.SimpleBatchConfiguration$PassthruAdvice.invoke(SimpleBatchConfiguration.java:128) ~[spring-batch-core-4.3.10.jar:4.3.10]
        at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186) ~[spring-aop-5.3.31.jar:5.3.31]
        at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:241) ~[spring-aop-5.3.31.jar:5.3.31]
        at jdk.proxy2/jdk.proxy2.$Proxy52.run(Unknown Source) ~[na:na]
        at org.springframework.boot.autoconfigure.batch.JobLauncherApplicationRunner.execute(JobLauncherApplicationRunner.java:213) ~[spring-boot-autoconfigure-2.7.18.jar:2.7.18]
        at org.springframework.boot.autoconfigure.batch.JobLauncherApplicationRunner.executeLocalJobs(JobLauncherApplicationRunner.java:193) ~[spring-boot-autoconfigure-2.7.18.jar:2.7.18]
        at org.springframework.boot.autoconfigure.batch.JobLauncherApplicationRunner.launchJobFromProperties(JobLauncherApplicationRunner.java:172) ~[spring-boot-autoconfigure-2.7.18.jar:2.7.18]
        at org.springframework.boot.autoconfigure.batch.JobLauncherApplicationRunner.run(JobLauncherApplicationRunner.java:167) ~[spring-boot-autoconfigure-2.7.18.jar:2.7.18]
        at org.springframework.boot.autoconfigure.batch.JobLauncherApplicationRunner.run(JobLauncherApplicationRunner.java:162) ~[spring-boot-autoconfigure-2.7.18.jar:2.7.18]
        at org.springframework.boot.SpringApplication.callRunner(SpringApplication.java:756) ~[spring-boot-2.7.18.jar:2.7.18]
        at org.springframework.boot.SpringApplication.lambda$callRunners$2(SpringApplication.java:746) ~[spring-boot-2.7.18.jar:2.7.18]
        at java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183) ~[na:na]
        at java.base/java.util.stream.SortedOps$SizedRefSortingSink.end(SortedOps.java:357) ~[na:na]
        at java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:510) ~[na:na]
        at java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499) ~[na:na]
        at java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150) ~[na:na]
        at java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173) ~[na:na]
        at java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234) ~[na:na]
        at java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596) ~[na:na]
        at org.springframework.boot.SpringApplication.callRunners(SpringApplication.java:744) ~[spring-boot-2.7.18.jar:2.7.18]
        at org.springframework.boot.SpringApplication.run(SpringApplication.java:315) ~[spring-boot-2.7.18.jar:2.7.18]
        at org.springframework.boot.SpringApplication.run(SpringApplication.java:1300) ~[spring-boot-2.7.18.jar:2.7.18]
        at org.springframework.boot.SpringApplication.run(SpringApplication.java:1289) ~[spring-boot-2.7.18.jar:2.7.18]
        at com.optum.fads.caseentrybatch.poc.InvoiceBatchApplication.main(InvoiceBatchApplication.java:9) ~[classes/:na]
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: NULL not allowed for column "DISCOUNT"; SQL statement:
INSERT INTO FINAL_TXN_LINE(txn_id, run_id, invoice_date, customer_id, base_amount, discount, tax, commission, net_amount, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP) [23502-214]
        at org.h2.message.DbException.getJdbcSQLException(DbException.java:508) ~[h2-2.1.214.jar:2.1.214]
        at org.h2.message.DbException.getJdbcSQLException(DbException.java:477) ~[h2-2.1.214.jar:2.1.214]
        at org.h2.message.DbException.get(DbException.java:223) ~[h2-2.1.214.jar:2.1.214]
        at org.h2.message.DbException.get(DbException.java:199) ~[h2-2.1.214.jar:2.1.214]
        at org.h2.table.Column.validateConvertUpdateSequence(Column.java:365) ~[h2-2.1.214.jar:2.1.214]
        at org.h2.table.Table.convertInsertRow(Table.java:926) ~[h2-2.1.214.jar:2.1.214]
        at org.h2.command.dml.Insert.insertRows(Insert.java:167) ~[h2-2.1.214.jar:2.1.214]
        at org.h2.command.dml.Insert.update(Insert.java:135) ~[h2-2.1.214.jar:2.1.214]
        at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:74) ~[h2-2.1.214.jar:2.1.214]
        at org.h2.command.CommandContainer.update(CommandContainer.java:169) ~[h2-2.1.214.jar:2.1.214]
        at org.h2.command.Command.executeUpdate(Command.java:252) ~[h2-2.1.214.jar:2.1.214]
        at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:209) ~[h2-2.1.214.jar:2.1.214]
        at org.h2.jdbc.JdbcPreparedStatement.executeBatchElement(JdbcPreparedStatement.java:1317) ~[h2-2.1.214.jar:2.1.214]
        at org.h2.jdbc.JdbcPreparedStatement.executeBatch(JdbcPreparedStatement.java:1263) ~[h2-2.1.214.jar:2.1.214]
        at com.zaxxer.hikari.pool.ProxyStatement.executeBatch(ProxyStatement.java:127) ~[HikariCP-4.0.3.jar:na]
        at com.zaxxer.hikari.pool.HikariProxyPreparedStatement.executeBatch(HikariProxyPreparedStatement.java) ~[HikariCP-4.0.3.jar:na]
        at org.springframework.jdbc.core.JdbcTemplate.lambda$batchUpdate$4(JdbcTemplate.java:1050) ~[spring-jdbc-5.3.31.jar:5.3.31]
        at org.springframework.jdbc.core.JdbcTemplate.execute(JdbcTemplate.java:650) ~[spring-jdbc-5.3.31.jar:5.3.31]
        ... 58 common frames omitted

2026-01-28 13:29:53.744  INFO 15392 --- [           main] o.s.batch.core.step.AbstractStep         : Step: [processTxnStep] executed in 243ms
2026-01-28 13:29:53.750  INFO 15392 --- [           main] o.s.b.c.l.support.SimpleJobLauncher      : Job: [SimpleJob: [name=invoiceJob]] completed with the following parameters: [{runId=RUN_2026-01-24_2026-01-28T13:29:53.426141200, invoiceDate=2026-01-24, run.id=1}] and the following status: [FAILED] in 263ms
2026-01-28 13:29:53.768  INFO 15392 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown initiated...
2026-01-28 13:29:53.775  INFO 15392 --- [ionShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown completed.
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  8.621 s
[INFO] Finished at: 2026-01-28T13:29:54+05:30
[INFO] ------------------------------------------------------------------------

C:\Users\sgupt664\BE_Projects\CaseEntryBatchPOC>
