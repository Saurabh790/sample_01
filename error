package com.optum.fads.userroles.api.controllers;

import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.optum.fads.userroles.api.dto.UserHistoryResponse;
import com.optum.fads.userroles.api.service.IUserHistory;

@RestController
public class UserRolesHistoryController {

    private static final String DEFAULT_SORT_FIELD = "changeDt";
    
    private final IUserHistory userHistoryService;

    public UserRolesHistoryController(IUserHistory userHistoryService) {
        this.userHistoryService = userHistoryService;
    }

    @GetMapping("/api/getUserHistory")
    public UserHistoryResponse getAllUserHistory(
            @RequestParam(defaultValue = "1") int pageNumber,
            @RequestParam(defaultValue = "10") int recordsPerPage,
            @RequestParam(defaultValue = DEFAULT_SORT_FIELD) String sortBy,
            @RequestParam(defaultValue = "-1") int sortOrder,
            @RequestParam(required = false) String searchBy,
            @RequestParam(required = false) String searchInput) {
        
        // Map DTO field names to entity field names
        String entitySortField = mapToEntityField(sortBy);
        
        // Create Sort object based on sortBy and sortOrder
        Sort.Direction direction = sortOrder == -1 ? Sort.Direction.DESC : Sort.Direction.ASC;
        Sort sort = Sort.by(direction, entitySortField);
        
        // Convert to zero-based page index for Spring Data
        Pageable pageable = PageRequest.of(pageNumber - 1, recordsPerPage, sort);
        
        // Call service with search parameters
        return userHistoryService.getAllUserHistory(pageable, searchBy, searchInput);
    }

    /**
     * Maps DTO field names to entity field names for sorting
     */
    private String mapToEntityField(String dtoField) {
        return switch (dtoField) {
            case "histSeqNum" -> "id.histSeqNum";
            case "changeUsr" -> "changeUsr.uiSystemId";
            case "uiSystemId" -> "uiSystem.uiSystemId";
            case "fadsGrpName" -> "fadsGrp.fadsGrpName";
            case "fadsSurGrpName" -> "fadsSurGrp.surGrpName";
            case "fadsCaseGrpName" -> "fadsCaseGrp.caseGrpName";
            case "uiUserId" -> "uiUserId";
            case "uiLastName" -> "uiLastName";
            case "uiFirstName" -> "uiFirstName";
            case "uiEmailAddress" -> "uiEMailAddress";
            case DEFAULT_SORT_FIELD -> DEFAULT_SORT_FIELD;
            default -> DEFAULT_SORT_FIELD; // default sort field
        };
    }
}
