-- Participants in batch 451 (provider cases)
SELECT DISTINCT PARTICIPANT_ID
FROM CA_UNIVERSE_BATCH_T
WHERE CT_BATCH_ID = 451
  AND CASE_TYPE_CD = 'PV';

-- Missing in provider master using exact match
SELECT DISTINCT b.PARTICIPANT_ID
FROM CA_UNIVERSE_BATCH_T b
LEFT JOIN DM_PROVIDER_T p
  ON p.PROV_ID = b.PARTICIPANT_ID
WHERE b.CT_BATCH_ID = 451
  AND b.CASE_TYPE_CD = 'PV'
  AND p.PROV_ID IS NULL;


-- Check if issue is whitespace/type formatting
SELECT DISTINCT b.PARTICIPANT_ID
FROM CA_UNIVERSE_BATCH_T b
LEFT JOIN DM_PROVIDER_T p
  ON LTRIM(RTRIM(p.PROV_ID)) = LTRIM(RTRIM(b.PARTICIPANT_ID))
WHERE b.CT_BATCH_ID = 451
  AND b.CASE_TYPE_CD = 'PV'
  AND p.PROV_ID IS NULL;



SELECT TOP 1 * FROM DM_PROVIDER_T;
SELECT COUNT(*) FROM DM_PROVIDER_T WHERE <condition_column_from_metadata> = '120403407';


SELECT COLUMN_NAME
FROM CA_META_BASE_T
WHERE CASE_TYPE = 'PV'
  AND SQL_CLAUSE_TYPE = 'CONDITION';

-- table name from metadata for PV
SELECT DISTINCT TABLE_NAME
FROM CA_META_BASE_T
WHERE CASE_TYPE = 'PV';
SELECT COUNT(*) AS row_count
FROM DM_PROVIDER_T
WHERE PROV_ID = '120403407';
SELECT *
FROM DM_PROVIDER_T
WHERE PROV_ID = '120403407';
SELECT COUNT(*) AS row_count_trim
FROM DM_PROVIDER_T
WHERE LTRIM(RTRIM(PROV_ID)) = '120403407';



-- 1) Metadata rows for provider case type
SELECT
    CASE_TYPE,
    FIELD_ID,
    SQL_CLAUSE_TYPE,
    TABLE_NAME,
    COLUMN_NAME,
    HTML_FIELD_TYPE
FROM CA_META_BASE_T
WHERE CASE_TYPE = 'PV'
ORDER BY
    CASE WHEN SQL_CLAUSE_TYPE = 'SELECT' THEN 1 ELSE 2 END,
    FIELD_ID;
-- 2) CONDITION count (should be exactly 1 for current Java method)
SELECT COUNT(*) AS condition_count
FROM CA_META_BASE_T
WHERE CASE_TYPE = 'PV'
  AND SQL_CLAUSE_TYPE = 'CONDITION';
-- 3) Build and run the same dynamic lookup for participant 120403407
DECLARE @caseType      varchar(10) = 'PV';
DECLARE @participantId varchar(50) = '120403407';
DECLARE @tableName     sysname;
DECLARE @selectCols    nvarchar(max);
DECLARE @conditionCol  sysname;
DECLARE @sql           nvarchar(max);
DECLARE @countSql      nvarchar(max);

SELECT
    @tableName = MAX(TABLE_NAME),
    @selectCols = STRING_AGG(CASE WHEN SQL_CLAUSE_TYPE = 'SELECT' THEN QUOTENAME(COLUMN_NAME) END, ','),
    @conditionCol = MAX(CASE WHEN SQL_CLAUSE_TYPE = 'CONDITION' THEN COLUMN_NAME END)
FROM CA_META_BASE_T
WHERE CASE_TYPE = @caseType;

SELECT @tableName AS table_name, @conditionCol AS condition_column, @selectCols AS select_columns;

SET @sql = N'SELECT ' + @selectCols + N' FROM ' + QUOTENAME(@tableName) + N' WHERE ' + QUOTENAME(@conditionCol) + N' = @p';
EXEC sp_executesql @sql, N'@p varchar(50)', @participantId;

SET @countSql = N'SELECT COUNT(*) AS row_count FROM ' + QUOTENAME(@tableName) + N' WHERE ' + QUOTENAME(@conditionCol) + N' = @p';
EXEC sp_executesql @countSql, N'@p varchar(50)', @participantId;
