package com.optum.fads.pgp.reportsection.api.service.impl;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.test.util.ReflectionTestUtils;

import com.optum.fads.pgp.reportsection.api.common.ListTableParams;
import com.optum.fads.pgp.reportsection.api.common.constants.ReportSectionConstants;
import com.optum.fads.pgp.reportsection.api.domain.FadsConfigT;
import com.optum.fads.pgp.reportsection.api.domain.PrmRiRptItemT;
import com.optum.fads.pgp.reportsection.api.domain.UiUserBase;
import com.optum.fads.pgp.reportsection.api.dto.PaginationResultRI;
import com.optum.fads.pgp.reportsection.api.exception.ReportSectionApiException;
import com.optum.fads.pgp.reportsection.api.mapper.ReportGroupDetailMapper;
import com.optum.fads.pgp.reportsection.api.repo.BehaviorPatternErDrRepository;
import com.optum.fads.pgp.reportsection.api.repo.BehaviorPatternsRepository;
import com.optum.fads.pgp.reportsection.api.repo.DataRulesRepository;
import com.optum.fads.pgp.reportsection.api.repo.FadsConfigRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportItemFormulasRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportItemsRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportSectionItemsRepository;
import com.optum.fads.pgp.reportsection.api.repo.ReportSectionsRepository;

@ExtendWith(MockitoExtension.class)
class ReportItemDataServiceTest {

    @Mock private ReportItemsRepository reportItemsRepository;
    @Mock private ReportItemFormulasRepository reportItemFormulasRepository;
    @Mock private ReportSectionItemsRepository reportSectionItemsRepository;
    @Mock private BehaviorPatternsRepository behaviorPatternsRepository;
    @Mock private BehaviorPatternErDrRepository behaviorPatternErDrRepository;
    @Mock private DataRulesRepository dataRulesRepository;
    @Mock private ReportSectionsRepository reportSectionsRepository;

    @Mock private FadsConfigRepository fadsConfigRepository;
    @Mock private ReportGroupDetailMapper reportGroupDetailMapper;

    private TestableReportItemDataService service;

    /** Expose protected methods for direct testing */
    static class TestableReportItemDataService extends ReportItemDataService {
        TestableReportItemDataService(ReportItemsRepository reportItemsRepository,
                                      ReportItemFormulasRepository reportItemFormulasRepository,
                                      ReportSectionItemsRepository reportSectionItemsRepository,
                                      BehaviorPatternsRepository behaviorPatternsRepository,
                                      BehaviorPatternErDrRepository behaviorPatternErDrRepository,
                                      DataRulesRepository dataRulesRepository,
                                      ReportSectionsRepository reportSectionsRepository) {
            super(reportItemsRepository,
                  reportItemFormulasRepository,
                  reportSectionItemsRepository,
                  behaviorPatternsRepository,
                  behaviorPatternErDrRepository,
                  dataRulesRepository,
                  reportSectionsRepository);
        }

        String callReplReportItemName(String s) { return replReportItemName(s); }
        String[] callGetSearchCriteria(ListTableParams p, int idx) { return getSearchCriteria(p, idx); }
        Pageable callCreatePageable(ListTableParams p) { return createPageableReports(p); }
    }

    @BeforeEach
    void setup() {
        service = new TestableReportItemDataService(
                reportItemsRepository,
                reportItemFormulasRepository,
                reportSectionItemsRepository,
                behaviorPatternsRepository,
                behaviorPatternErDrRepository,
                dataRulesRepository,
                reportSectionsRepository
        );

        // Fields not in constructor -> inject manually for tests
        ReflectionTestUtils.setField(service, "fadsConfigRepository", fadsConfigRepository);
        ReflectionTestUtils.setField(service, "reportGroupDetailMapper", reportGroupDetailMapper);
    }

    // -------------------- getReportItemsList --------------------

    @Test
    void getReportItemsList_noSearch_selectedEmpty_usesGetReportItemsAndCount() {
        ListTableParams params = baseParams();
        params.setSearchBy(null);
        params.setSelectedItemIds(new ArrayList<>()); // empty

        PrmRiRptItemT ri = realRi(99, "RI-99");

        when(reportItemsRepository.getReportItems(any(Pageable.class))).thenReturn(List.of(ri));
        when(reportItemsRepository.count()).thenReturn(1L);

        PaginationResultRI out = service.getReportItemsList(params);

        assertNotNull(out);
        assertEquals(1, out.getTotalRecordsCount());
        assertNotNull(out.getReportItemsData());
        assertEquals(1, out.getReportItemsData().size());
        assertEquals(Integer.valueOf(99), out.getReportItemsData().get(0).getReportItemId());

        verify(reportItemsRepository).getReportItems(any(Pageable.class));
        verify(reportItemsRepository).count();
        verify(reportItemsRepository, never()).getAvailableReportItems(anyList(), any());
    }

    @Test
    void getReportItemsList_noSearch_selectedNotEmpty_usesGetAvailableAndCountBySize() {
        ListTableParams params = baseParams();
        params.setSearchBy(null);
        params.setSelectedItemIds(new ArrayList<>(List.of(1, 2)));

        PrmRiRptItemT ri99 = realRi(99, "RI-99");
        PrmRiRptItemT ri100 = realRi(100, "RI-100");

        // pageable call
        when(reportItemsRepository.getAvailableReportItems(eq(params.getSelectedItemIds()), any(Pageable.class)))
                .thenReturn(List.of(ri99));

        // count call uses pageable = null
        when(reportItemsRepository.getAvailableReportItems(eq(params.getSelectedItemIds()), isNull()))
                .thenReturn(List.of(ri99, ri100));

        PaginationResultRI out = service.getReportItemsList(params);

        assertNotNull(out);
        assertEquals(2, out.getTotalRecordsCount()); // size from null pageable list
        assertEquals(1, out.getReportItemsData().size());

        verify(reportItemsRepository).getAvailableReportItems(eq(params.getSelectedItemIds()), any(Pageable.class));
        verify(reportItemsRepository).getAvailableReportItems(eq(params.getSelectedItemIds()), isNull());
        verify(reportItemsRepository, never()).count();
    }

    @Test
    void getReportItemsList_whenSearchByPresent_delegatesToSearchCriteriaMethod() {
        ReportItemDataService spy = spy(service);

        ListTableParams params = baseParams();
        params.setSearchBy(List.of(ReportSectionConstants.REPORT_ITEM_NAME));
        params.setSearchInput(List.of("abc"));
        params.setSelectedItemIds(new ArrayList<>());

        PaginationResultRI expected = new PaginationResultRI();
        doReturn(expected).when(spy).getReportItemsOnSearchCriteria(any(ListTableParams.class));

        PaginationResultRI out = spy.getReportItemsList(params);

        assertSame(expected, out);
        verify(spy).getReportItemsOnSearchCriteria(params);
        verify(reportItemsRepository, never()).getReportItems(any());
    }

    // -------------------- getReportItemsOnSearchCriteria (one representative branch) --------------------

    @Test
    void getReportItemsOnSearchCriteria_selectedEmpty_noSpChar_callsGetReportItemsBySearchCrit() {
        ListTableParams params = baseParams();
        params.setSelectedItemIds(new ArrayList<>());
        params.setSearchBy(List.of(ReportSectionConstants.REPORT_ITEM_NAME));
        params.setSearchInput(List.of("abc"));

        PrmRiRptItemT ri = realRi(10, "ABC");
        PrmRiRptItemT ri2 = realRi(11, "ABC2");

        when(reportItemsRepository.getReportItemsBySearchCrit(anyString(), anyString(), anyString(), any(Pageable.class)))
                .thenReturn(List.of(ri));
        when(reportItemsRepository.getReportItemsBySearchCrit(anyString(), anyString(), anyString(), isNull()))
                .thenReturn(List.of(ri, ri2));

        PaginationResultRI out = service.getReportItemsOnSearchCriteria(params);

        assertNotNull(out);
        assertEquals(2, out.getTotalRecordsCount());
        assertEquals(1, out.getReportItemsData().size());

        // Validate first argument contains "%abc%"
        ArgumentCaptor<String> nameCaptor = ArgumentCaptor.forClass(String.class);
        verify(reportItemsRepository).getReportItemsBySearchCrit(nameCaptor.capture(), anyString(), anyString(), any(Pageable.class));
        assertTrue(nameCaptor.getValue().contains("abc"));
        assertTrue(nameCaptor.getValue().startsWith("%"));
        assertTrue(nameCaptor.getValue().endsWith("%"));
    }

    @Test
    void getReportItemsList_wrapsAnyExceptionIntoReportSectionApiException() {
        ListTableParams params = baseParams();
        params.setSearchBy(null);
        params.setSelectedItemIds(new ArrayList<>());

        when(reportItemsRepository.getReportItems(any(Pageable.class)))
                .thenThrow(new RuntimeException("db down"));

        assertThrows(ReportSectionApiException.class, () -> service.getReportItemsList(params));
    }

    // -------------------- protected method coverage: replReportItemName --------------------

    @Test
    void replReportItemName_noSpecialChars_wrapsWithPercent() {
        assertEquals("%abc%", service.callReplReportItemName("abc"));
    }

    @Test
    void replReportItemName_withPercent_escapesPercent() {
        String out = service.callReplReportItemName("a%");
        assertTrue(out.startsWith("%"));
        assertTrue(out.endsWith("%"));
        assertTrue(out.contains("\\%")); // escaped %
    }

    @Test
    void replReportItemName_withUnderscore_escapesUnderscore() {
        String out = service.callReplReportItemName("a_");
        assertTrue(out.contains("\\_")); // escaped _
    }

    @Test
    void replReportItemName_replacesEncodedSpace_plus_comma() {
        // %20 -> ""  ,  %2B -> + , %2C -> ,
        // Using your constants (space encoded, plus repl, comma repl)
        String in = "ab" + ReportSectionConstants.SPACE_ENCODED_STR
                + "cd" + ReportSectionConstants.PLUS_REPL_STR
                + "ef" + ReportSectionConstants.COMMA_REPL_STR + "gh";

        String out = service.callReplReportItemName(in.toLowerCase());

        assertTrue(out.startsWith("%"));
        assertTrue(out.endsWith("%"));
        assertFalse(out.contains(ReportSectionConstants.SPACE_ENCODED_STR));
        assertTrue(out.contains(ReportSectionConstants.PLUS_STR));
        assertTrue(out.contains(ReportSectionConstants.COMMA_STR));
    }

    // -------------------- getZoneId --------------------

    @Test
    void getZoneId_whenConfigPresent_returnsConfiguredZone() {
        FadsConfigT cfg = mock(FadsConfigT.class);
        when(cfg.getOptionValue()).thenReturn("UTC");
        when(fadsConfigRepository.findById(eq(ReportSectionConstants.DATE_TIME_ZONE_ID)))
                .thenReturn(Optional.of(cfg));

        ZoneId zid = service.getZoneId();

        assertEquals(ZoneId.of("UTC"), zid);
    }

    @Test
    void getZoneId_whenConfigMissing_returnsSystemDefault() {
        when(fadsConfigRepository.findById(eq(ReportSectionConstants.DATE_TIME_ZONE_ID)))
                .thenReturn(Optional.empty());

        ZoneId zid = service.getZoneId();

        assertEquals(ZoneId.systemDefault(), zid);
    }

    // -------------------- helpers --------------------

    private static ListTableParams baseParams() {
        ListTableParams p = new ListTableParams();
        p.setPageNumber(1);
        p.setRecordsPerPage(10);
        p.setSortBy(ReportSectionConstants.REPORT_ITEM_NAME);
        p.setSortOrder(1);
        // intentionally leave searchBy/searchInput null unless test sets them
        return p;
    }

    /**
     * IMPORTANT: Real entity (no Mockito). This prevents UnfinishedStubbing & UnnecessaryStubbing.
     */
    private static PrmRiRptItemT realRi(int id, String name) {
        PrmRiRptItemT ri = new PrmRiRptItemT();
        ri.setRiId(id);
        ri.setReportItemName(name);
        ri.setRiCalcFmt("1");
        ri.setRiMinimumDenom(5);
        ri.setConstantDen(2);
        ri.setConstantNum(3);

        UiUserBase cr = new UiUserBase();
        cr.setUiFirstName("C");
        cr.setUiLastName("R");
        cr.setUiSystemId("UCR");
        ri.setUiUserBaseCr(cr);

        UiUserBase upd = new UiUserBase();
        upd.setUiFirstName("U");
        upd.setUiLastName("P");
        upd.setUiSystemId("UUPD");
        ri.setUiUserBaseUpd(upd);

        ri.setCreateDate(LocalDateTime.now().minusDays(1));
        ri.setUpdateDate(LocalDateTime.now());
        return ri;
    }
}
