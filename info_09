package com.optum.fads.caseentrybatch.batch;

import org.springframework.batch.core.Job;
import org.springframework.batch.core.Step;
import org.springframework.batch.core.configuration.annotation.EnableBatchProcessing;
import org.springframework.batch.core.job.builder.JobBuilder;
import org.springframework.batch.core.repository.JobRepository;
import org.springframework.batch.core.step.builder.StepBuilder;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.transaction.PlatformTransactionManager;

@Configuration
@EnableBatchProcessing
public class CaseBatchJobConfig {

    private static final int CHUNK_SIZE = 1;

    @Bean(name = "caseEntryBatchJob")
    public Job caseEntryBatchJob(
            JobRepository jobRepository,
            Step processBatchIdStep
    ) {
        return new JobBuilder("caseEntryBatchJob", jobRepository)
                .start(processBatchIdStep)
                .build();
    }

    @Bean
    public Step processBatchIdStep(
            JobRepository jobRepository,
            @Qualifier("txManagerSQL") PlatformTransactionManager transactionManager,
            BatchIdReader batchIdReader,
            BatchIdProcessor batchIdProcessor
    ) {
        return new StepBuilder("processBatchIdStep", jobRepository)
                .<Integer, Integer>chunk(CHUNK_SIZE, transactionManager)
                .reader(batchIdReader)
                .processor(batchIdProcessor)
                .writer(items -> { /* no-op: processor executes existing service flow */ })
                .build();
    }
}
package com.optum.fads.caseentrybatch.batch;

import java.util.Iterator;
import java.util.List;

import org.springframework.batch.core.configuration.annotation.StepScope;
import org.springframework.batch.item.ItemReader;
import org.springframework.stereotype.Component;

import com.optum.fads.caseentrybatch.api.repo.CaUniverseBatchRepository;

@Component
@StepScope
public class BatchIdReader implements ItemReader<Integer> {

    private final CaUniverseBatchRepository repo;
    private Iterator<Integer> iterator;

    public BatchIdReader(CaUniverseBatchRepository repo) {
        this.repo = repo;
    }

    @Override
    public Integer read() {
        if (iterator == null) {
            List<Integer> ids = repo.findDistinctBatchIds();
            iterator = ids.iterator();
        }
        return iterator.hasNext() ? iterator.next() : null;
    }
}
package com.optum.fads.caseentrybatch.batch;

import org.springframework.batch.item.ItemProcessor;
import org.springframework.stereotype.Component;

import com.optum.fads.caseentrybatch.api.service.CaseBatchProcessingService;

@Component
public class BatchIdProcessor implements ItemProcessor<Integer, Integer> {

    private final CaseBatchProcessingService service;

    public BatchIdProcessor(CaseBatchProcessingService service) {
        this.service = service;
    }

    @Override
    public Integer process(Integer batchId) {
        service.processBatchId(batchId);
        return batchId;
    }
}
package com.optum.fads.caseentrybatch.api.service;

public interface CaseBatchProcessingService {
    void processBatchId(Integer batchId);
}
package com.optum.fads.caseentrybatch.api.service;

public interface CaseBatchProcessingService {
    void processBatchId(Integer batchId);
}
package com.optum.fads.caseentrybatch.api.service.impl;

import java.util.List;

import org.springframework.stereotype.Service;

import com.optum.fads.caseentrybatch.api.domain.CaUniverseBatchT;
import com.optum.fads.caseentrybatch.api.repo.CaUniverseBatchRepository;
import com.optum.fads.caseentrybatch.api.service.CaseBatchProcessingService;

@Service
public class CaseBatchProcessingServiceImpl implements CaseBatchProcessingService {

    private final CaUniverseBatchRepository caUniverseBatchRepository;
    private final CaseBatchService caseBatchService;

    public CaseBatchProcessingServiceImpl(
            CaUniverseBatchRepository caUniverseBatchRepository,
            CaseBatchService caseBatchService
    ) {
        this.caUniverseBatchRepository = caUniverseBatchRepository;
        this.caseBatchService = caseBatchService;
    }

    @Override
    public void processBatchId(Integer batchId) {
        List<CaUniverseBatchT> list = caUniverseBatchRepository.findAllByBatchId(batchId);
        if (list != null && !list.isEmpty()) {
            caseBatchService.processBatchEntries(list);
        }
    }
}
package com.optum.fads.caseentrybatch.api.service;

import org.springframework.batch.core.JobExecution;

public interface ICaseBatchService {

    @Deprecated
    String createBatchCase();

    JobExecution executeBatchJob();
}
@Autowired
private org.springframework.batch.core.launch.JobLauncher jobLauncher;

@Autowired
@Qualifier("caseEntryBatchJob")
private org.springframework.batch.core.Job caseEntryBatchJob;

@Override
public JobExecution executeBatchJob() {
    try {
        JobParameters params = new JobParametersBuilder()
                .addLong("startTime", System.currentTimeMillis())
                .toJobParameters();
        return jobLauncher.run(caseEntryBatchJob, params);
    } catch (Exception e) {
        throw new RuntimeException("Failed to execute batch job", e);
    }
}
package com.optum.fads.caseentrybatch.api.scheduler;

import org.springframework.batch.core.Job;
import org.springframework.batch.core.JobParameters;
import org.springframework.batch.core.JobParametersBuilder;
import org.springframework.batch.core.launch.JobLauncher;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import lombok.extern.slf4j.Slf4j;

@Component
@Slf4j
public class CaseBatchScheduler {

    private final JobLauncher jobLauncher;
    private final Job caseEntryBatchJob;

    public CaseBatchScheduler(
            JobLauncher jobLauncher,
            @Qualifier("caseEntryBatchJob") Job caseEntryBatchJob
    ) {
        this.jobLauncher = jobLauncher;
        this.caseEntryBatchJob = caseEntryBatchJob;
    }

    @Scheduled(cron = "${batch.schedule.cron:0 0 2 * * ?}")
    public void runScheduledBatch() {
        try {
            JobParameters params = new JobParametersBuilder()
                    .addLong("startTime", System.currentTimeMillis())
                    .addString("triggeredBy", "scheduler")
                    .toJobParameters();
            jobLauncher.run(caseEntryBatchJob, params);
        } catch (Exception e) {
            log.error("Failed to execute scheduled batch job", e);
        }
    }
}
