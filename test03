package com.optum.fads.caseentrybatch.api.util;

import java.sql.Timestamp;

import com.optum.fads.caseentrybatch.api.domain.*;
import org.springframework.stereotype.Component;

import com.optum.fads.caseentrybatch.api.common.CaseEntryConstants;
import com.optum.fads.caseentrybatch.api.exception.CaseEntryApiException;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@Component
public class ClaimsCorrectionsHistAssist  {

    public CaClaimCorrectionsHistT createClaimCorrectionsHistT(CaIntelligentKeyT caIntelligentKeyT,String uiSystemId, Integer clmSeqNum,
                                                               CaClaimCorrectionsT caClaimCorrectionsT) throws CaseEntryApiException {
    	
        Timestamp currentSqlDate = new Timestamp(System.currentTimeMillis());
        CaClaimCorrectionsHistT caClaimCorrectionsHistT = new CaClaimCorrectionsHistT();
        CaClaimCorrectionsHistTPK caClaimCorrectionsHistTPK = new CaClaimCorrectionsHistTPK();
        try {	
        		caClaimCorrectionsHistTPK.setCaseId(caClaimCorrectionsT.getId().getCaseId());
        		caClaimCorrectionsHistTPK.setHistSeqNum(CaseEntryConstants.ONE);	// One hist Seq num per TCN
        		caClaimCorrectionsHistTPK.setClmSeqNum(clmSeqNum);	// Multiple record numbers 
        		caClaimCorrectionsHistT.setId(caClaimCorrectionsHistTPK);
        		caClaimCorrectionsHistT.setChangeDt(currentSqlDate);
        		UiUserBase uiUserBase = new UiUserBase();
        	//	uiUserBase.setUiSystemId(CaseEntryConstants.SYS_ADMIN_ID);	// in SQL Server DB
        		uiUserBase.setUiSystemId(uiSystemId);
        		caClaimCorrectionsHistT.setUiUserBaseChangeUsr(uiUserBase);	
        		caClaimCorrectionsHistT.setHdrClmTcn(caClaimCorrectionsT.getHdrClmTcn());
        		caClaimCorrectionsHistT.setLiNum(caClaimCorrectionsT.getLiNum());
        		caClaimCorrectionsHistT.setHdrClmPdDt(caClaimCorrectionsT.getHdrClmPdDt());
        		caClaimCorrectionsHistT.setLiDrugNdc(caClaimCorrectionsT.getLiDrugNdc());
        		caClaimCorrectionsHistT.setLiPdUosQty(caClaimCorrectionsT.getLiPdUosQty());
        		caClaimCorrectionsHistT.setLiDrugRouteCd(caClaimCorrectionsT.getLiDrugRouteCd());
        		caClaimCorrectionsHistT.setLiDrugDaysSupply(caClaimCorrectionsT.getLiDrugDaysSupply());
        		caClaimCorrectionsHistT.setLiDrugDispFeeAmt(caClaimCorrectionsT.getLiDrugDispFeeAmt());
        		caClaimCorrectionsHistT.setLiPdAmt(caClaimCorrectionsT.getLiPdAmt());
        		caClaimCorrectionsHistT.setLiCopayAmt(caClaimCorrectionsT.getLiCopayAmt());	
        		caClaimCorrectionsHistT.setCtIngredientCost(caClaimCorrectionsT.getCtIngredientCost());
        		caClaimCorrectionsHistT.setCtFindingsCd(caClaimCorrectionsT.getCtFindingsCd());
        		
        		caClaimCorrectionsHistT.setHdrPdAmt(caClaimCorrectionsT.getHdrPdAmt());
        		caClaimCorrectionsHistT.setHdrCopayAmt(caClaimCorrectionsT.getHdrCopayAmt());
        		caClaimCorrectionsHistT.setHdrDrugDispensingFee(caClaimCorrectionsT.getHdrDrugDispensingFee());
        		caClaimCorrectionsHistT.setLiDrugDosageFormDesc(caClaimCorrectionsT.getLiDrugDosageFormDesc());

        } catch (RuntimeException e) {
            log.error("Exception in ClaimsCorrectionsHistAssist :: createClaimCorrectionsHistT()", e);
            throw new CaseEntryApiException(e);
        }
        caClaimCorrectionsHistT.setCaIntelligentKeyT(caIntelligentKeyT);
        return caClaimCorrectionsHistT;
    }
    
}

package com.optum.fads.caseentrybatch.api.util;


import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.Collection;
import java.util.Locale;
import java.util.Optional;
import java.util.stream.Collectors;

import com.optum.fads.caseentrybatch.api.dto.CaseMetabaseField;
import org.apache.commons.mail.Email;
import org.apache.commons.mail.SimpleEmail;
import org.apache.http.Consts;
import org.apache.http.HttpResponse;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.ContentType;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.HttpClients;
import org.codehaus.jettison.json.JSONException;
import org.codehaus.jettison.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.optum.fads.caseentrybatch.api.common.CaseEntryConstants;
import com.optum.fads.caseentrybatch.api.domain.FadsConfigT;
import com.optum.fads.caseentrybatch.api.domain.UiUserBase;
import com.optum.fads.caseentrybatch.api.dto.EmailSpecification;
import com.optum.fads.caseentrybatch.api.repo.CaseConfigRepository;
import com.optum.fads.caseentrybatch.api.repo.FadsConfigRepository;
import com.optum.fads.caseentrybatch.api.repo.UserRepository;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@Component
public class CaseBatchUtil {
	
	@Autowired
	private FadsConfigRepository fadsConfigRepository;
	
	@Autowired
	private UserRepository userRepository;
	
	@Autowired
	private CaseConfigRepository caseConfigRepository;
	
	private static final int PORT = 25;
    private static final boolean SSL_FLAG = false; 
	
	public String createJsonInput(String sendToEmail, String ccEmail, String bccEmail, String emailSubject, String emailText) {
		
		JSONObject emailTriggerProperties = new JSONObject();
		try {
			emailTriggerProperties.put("EmailSubject", emailSubject);
			emailTriggerProperties.put("EmailText", emailText);
			emailTriggerProperties.put("SendTo", sendToEmail);
			if (ccEmail != null) {
				emailTriggerProperties.put("cc", ccEmail);
			}
			if (bccEmail != null) {
				emailTriggerProperties.put("bcc", bccEmail);
			}
		} catch (JSONException e) {
	        log.error("Error at createJsonInput::", e);
	    }
		log.info("CaseBatchUtil:createJsonInput " + emailTriggerProperties.toString());
		return emailTriggerProperties.toString();
	}
	
	/**
	  * this method will send an email via the Azure Logic App
	  * 
	  * Parameters - HttpPost, HttpClient, jsonInputString 
	  */
	
	public synchronized  boolean sendMailLogicAppPost(HttpPost httpPost, HttpClient httpClient, String jsonInputString) {
		boolean mailStatus = false;
		try {
			log.info("sendMailLogicAppPost - use HttpPost to send email");
			//Execute and get the response.
			StringEntity stringEntity = new StringEntity(jsonInputString,
			        ContentType.create("plain/text", Consts.UTF_8));
			httpPost.setEntity(stringEntity);
			HttpResponse response = httpClient.execute(httpPost);
			/*
			HttpEntity entity = response.getEntity();
			if (entity != null) {
				BufferedReader br = new BufferedReader(new InputStreamReader(entity.getContent()));
				StringBuilder totalResponse = new StringBuilder();
			    String responseLine = CaseEntryConstants.EMPTY_STR;
			    while ((responseLine = br.readLine()) != null) {
			    	totalResponse.append(responseLine.trim());
			    }
			    log.info("sendMailLogicAppPost response = " + totalResponse.toString());
			}
			*/
			mailStatus = true;
		} catch (Exception e) {
			log.error("Error at CaseBatchUtil.sendMailLogicApp::", e);
		}
		
		return mailStatus;
	}
	/**
	  * New method, that will send an email via Azure logic app or SMTP server
	  * 
	  * Parameters - EmailSpecification
	  */
	//public synchronized  boolean sendMail(String sendToEmail, String ccEmail, String bccEmail, String emailSubject, String emailText) {
	public synchronized  boolean sendMail(EmailSpecification emailSpecs) {
		boolean mailStatus = false;
		String jsonInputString;
		
		try { 
		//	String smtpHostName = caseConfigRepository.getOptionValue(CaseEntryConstants.SMTP_HOST_NAME);
			if (emailSpecs.getSmtpHostName() == null) {
				jsonInputString = createJsonInput(emailSpecs.getSendToEmail(), emailSpecs.getCcEmail(), emailSpecs.getBccEmail(), 
						emailSpecs.getEmailSubject(), emailSpecs.getEmailText());
			//	mailStatus = sendMailLogicApp(emailSpecs.getHttpURLConnection(), jsonInputString);
				mailStatus = sendMailLogicAppPost(emailSpecs.getHttpPost(), emailSpecs.getHttpClient(), jsonInputString);
			} else {
				mailStatus = sendSimpleMailSmtp(emailSpecs);
			}
		} catch (Exception e) {
			log.error("Error at CaseBatchUtil:sendMail:: ", e);
		}
		
		return mailStatus;
	}
	/**
	  * this method will send an email using SMTP Mail Server
	  * 
	  * Parameters - EmailSpecification
	  */
	public synchronized  boolean sendSimpleMailSmtp(EmailSpecification emailSpecs) {
		boolean mailStatus = false;
		try {
			Email email = emailSpecs.getEmail();
            email.setFrom(emailSpecs.getCtAdminEmailAddress());
            email.setSubject(emailSpecs.getEmailSubject());
            email.setMsg(emailSpecs.getEmailText());
            email.addTo(emailSpecs.getSendToEmail());
            if (emailSpecs.getCcEmail() != null && !emailSpecs.getCcEmail().isEmpty()) {
            	email.addCc(emailSpecs.getCcEmail());
            }
            if (emailSpecs.getBccEmail() != null && !emailSpecs.getBccEmail().isEmpty()) {
            	email.addBcc(emailSpecs.getBccEmail());
            }
            email.send();
		} catch (Exception e) {
			log.error("Error at CaseBatchUtil:sendMailSmtp:: ", e);
		}
		return mailStatus;
	}	
	/** 
	 * This method will get the Email Specs that contain entries needed for sending emails 
	 * Parameters: None
	 */
	public EmailSpecification getEmailSpecs()
	{
		EmailSpecification emailSpecs = new EmailSpecification();
		try {
			emailSpecs.setCtAdminEmailAddress(caseConfigRepository.getOptionValue(CaseEntryConstants.CT_ADMIN_ID));
			emailSpecs.setAzureLogicAppUrl(caseConfigRepository.getOptionValue(CaseEntryConstants.AZURE_LOGIC_APP_URL));
			emailSpecs.setSmtpHostName(caseConfigRepository.getOptionValue(CaseEntryConstants.SMTP_HOST_NAME)); 
			emailSpecs.setCtAdminSystemId(getCtAdminSystemId());
			if (emailSpecs.getSmtpHostName() == null) {
				log.info("CaseBatchUtil:getEmailSpecs SmtpHostName is null, Using Azure Logic App");
				HttpPost httpPost = new HttpPost(emailSpecs.getAzureLogicAppUrl());
				httpPost.setHeader("Content-Type", "application/json; charset=UTF-8");
				httpPost.setHeader("Accept", "application/json");
				emailSpecs.setHttpPost(httpPost);
				HttpClient httpClient = HttpClients.createDefault();
				emailSpecs.setHttpClient(httpClient);			
			} else {
				log.info("CaseBatchUtil:getEmailSpecs AzureLogicAppUrl is null, Using SMTP Email Server");
				Email email = new SimpleEmail();
	            email.setHostName(emailSpecs.getSmtpHostName());
	            email.setSmtpPort(PORT);
	            email.setSSLOnConnect(SSL_FLAG);
				emailSpecs.setEmail(email);
			}
		} catch (Exception e) {
			log.error("Error at CaseBatchUtil:sendMailSmtp:getEmailSpecs:: ", e);
		}
		return emailSpecs;
	}	
	/** 
	 * This method will get the User System Id corresponding CT_ADMIN which has corresponding email address stored in CASE_CONFIG
	 * Parameters: None
	 */
	public String getCtAdminSystemId()
	{
		UiUserBase uiUserBase = null;
		String adminSystemId = null;
		
		String adminEmailAddress = caseConfigRepository.getOptionValue(CaseEntryConstants.CT_ADMIN_ID);
			
		Optional<UiUserBase> userBaseOptional = userRepository.findByUiEMailAddress(adminEmailAddress);
		if (userBaseOptional.isPresent()) {
			uiUserBase = userBaseOptional.get();
			adminSystemId = uiUserBase.getUiSystemId();
		} else {
			log.error("No UiUserBase Record found with Email Address " + adminEmailAddress); 
		}
		return adminSystemId;
	}	
	/** 
	 * This method will get the ZoneId corresponding to the time zone used at the customer site
	 * Parameters: the time zone is stored in an entry in the FADS_CONFIG_T table 
	 */
	public ZoneId getZoneId() {
		ZoneId zid = ZoneId.systemDefault();;
		Optional<FadsConfigT> optional = fadsConfigRepository.findById(CaseEntryConstants.DATE_TIME_ZONE_ID);
		if (optional.isPresent()) {
			FadsConfigT fadsConfigT = optional.get();
			zid = ZoneId.of(fadsConfigT.getOptionValue());	//  the zone ID corresponding to date-time zone used
		}
		return zid;
	}

    public String findFieldName(Collection<CaseMetabaseField> fieldKeyValue, String fieldkey){
        CaseMetabaseField filteredData=  fieldKeyValue.stream().filter(i->i.getMappedField().equalsIgnoreCase(fieldkey)).collect(Collectors.toList()).stream().findFirst().get();
        return filteredData.getFieldName();
    }

    public CaseMetabaseField findCaseMetabaseField(Collection<CaseMetabaseField> fieldKeyValue, String fieldkey){
        CaseMetabaseField filteredData=  fieldKeyValue.stream().filter(i->i.getMappedField().equalsIgnoreCase(fieldkey)).collect(Collectors.toList()).stream().findFirst().get();
        return filteredData;
    }
    public static LocalDate convertToLocalDate(Object date) {
        LocalDate newDate = null;
        if (date != null) {
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd");
           try {
                newDate = LocalDate.parse(date.toString(), formatter);
            } catch (Exception e) {
                //    logger.error("Error at Dateutil.createDateWithTime" + e);
            }
        }
        return newDate;
    }

}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.snowflakeRepo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.snowflakeDomain.DmRecipientT;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface DmRecipientRepository extends JpaRepository<DmRecipientT, String> {
	
	//@Query(value = "Select RECIP_FULL_NM from DM_PROVIDER_T where RECIP_ORIG_ID = :recipId", nativeQuery = true)
	@Query(value = "Select RECIP_FULL_NM from DM_RECIPIENT_T where RECIP_ORIG_ID = :recipId", nativeQuery = true)
	String findRecipFullNmById(@Param("recipId") String recipId);
		 
}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.snowflakeRepo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.snowflakeDomain.DmProviderT;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface DmProviderRepository extends JpaRepository<DmProviderT, String> {
	
	 
	@Query(value = "Select PROV_NM from DM_PROVIDER_T where PROV_ID = :provId", nativeQuery = true)
	String findProvNMById(@Param("provId") String provId);
	
}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.snowflakeRepo;

import java.time.LocalDate;
import java.util.Date;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.snowflakeDomain.DmClaimDrugT;
import com.optum.fads.caseentrybatch.api.snowflakeDomain.DmClaimDrugTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface DmClaimDrugRepository extends JpaRepository<DmClaimDrugT, DmClaimDrugTPK> , JpaSpecificationExecutor<DmClaimDrugT>{
	
	@Query(value = "SELECT * FROM DM_CLAIM_DRUG_T  where HDR_CLM_TCN=:hdrClmTcn and LI_NUM = :liNum and HDR_CLM_PD_DT = :hdrClmPdDt", nativeQuery = true)
	DmClaimDrugT findClaimDrugTbyId(@Param("hdrClmTcn") String hdrClmTcn, @Param("liNum") String liNum, @Param("hdrClmPdDt") LocalDate hdrClmPdDt);
	
}
package com.optum.fads.caseentrybatch.api.service.impl;

import java.text.SimpleDateFormat;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Locale;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.common.CaseEntryConstants;
import com.optum.fads.caseentrybatch.api.domain.CaEmailsBatchT;
import com.optum.fads.caseentrybatch.api.domain.CaEmailsBatchTPK;
import com.optum.fads.caseentrybatch.api.domain.CaLuValuesT;
import com.optum.fads.caseentrybatch.api.domain.CaMetaBaseNoticeT;
import com.optum.fads.caseentrybatch.api.domain.CaseConfigT;
import com.optum.fads.caseentrybatch.api.domain.UiUserBase;
import com.optum.fads.caseentrybatch.api.dto.EmailData;
import com.optum.fads.caseentrybatch.api.dto.EmailSpecification;
import com.optum.fads.caseentrybatch.api.exception.CaseEntryApiException;
import com.optum.fads.caseentrybatch.api.util.CaseBatchUtil;
import com.optum.fads.caseentrybatch.api.repo.CaEmailsBatchRepository;
import com.optum.fads.caseentrybatch.api.repo.CaLuValuesRepository;
import com.optum.fads.caseentrybatch.api.repo.CaMetaBaseNoticeRepository;
import com.optum.fads.caseentrybatch.api.repo.CaseConfigRepository;
import com.optum.fads.caseentrybatch.api.repo.UserRepository;
//import com.optum.fads.caseentrybatch.api.repo.specs.CaseEntryBatchSpecification;
import com.optum.fads.caseentrybatch.api.service.ICaseBatchEmailService;

import lombok.extern.slf4j.Slf4j;

@Service
@Slf4j
public class CaseBatchEmailService  implements ICaseBatchEmailService{
	
	@Autowired
	private UserRepository userRepository;
	
	@Autowired
	private CaMetaBaseNoticeRepository caMetaBaseNoticeRepository;
	
	@Autowired
	private CaEmailsBatchRepository caEmailsBatchRepository;
	
	@Autowired
	private CaseBatchUtil caseBatchUtil;
	
	@Autowired
	private CaseConfigRepository caseConfigTRepository;
	
	@Autowired
	private CaLuValuesRepository caLuValuesRepository;
	
	/**
	  * this method is called from method caseBatchMail in Controller for a simple test
	  * 
	  * Parameters - EmailSpecification
	  */
	@Transactional 
	public synchronized boolean sendMail(String sendToEmail, String emailSubject, String emailText) {
		log.info("CaseBatchEmailService: sendMail start\n");
		String ccMail = null;
		String bccMail = null;
		EmailSpecification emailSpecs = caseBatchUtil.getEmailSpecs();
		emailSpecs.setSendToEmail(sendToEmail);
		emailSpecs.setCcEmail(ccMail);
		emailSpecs.setBccEmail(bccMail);
		emailSpecs.setEmailSubject(emailSubject);
		emailSpecs.setEmailText(emailText);
		//String jsonInputString = caseBatchUtil.createJsonInput(sendToEmail, emailSubject, emailText);
		//boolean mailStatus = caseBatchUtil.sendMail(jsonInputString);
		boolean mailStatus = caseBatchUtil.sendMail(emailSpecs);
		log.info("CaseBatchEmailService: sendMail end");
		return mailStatus;
	}

	/**
	  * this method is called from CaseBatchService.java, also from sendCaseBatchMail method in Controller
	  * 
	  * Parameters - EmailData 
	  */
	public synchronized  void postBatchProcessMail(EmailData emailData, EmailSpecification emailSpecs) {
		
		log.info("CaseBatchEmailService: postBatchProcessMail start\n");
		
		boolean mailStatus = false;
		UiUserBase uiUserBase = null;
		//Date assignedDate = new Date();
		String sendToEmail = CaseEntryConstants.EMPTY_STR;
		String ccMail = null;
		String bccMail = null;
		String firstName = CaseEntryConstants.EMPTY_STR;
		String lastName = CaseEntryConstants.EMPTY_STR;
		try {
			CaMetaBaseNoticeT caMetaBaseNoticeT = getMetaBaseNoticeT(emailData.getNoticeId());
			
			if (caMetaBaseNoticeT.getNoticeFlag().equals(CaseEntryConstants.ONE_STR)) {
				switch (emailData.getNoticeId()) {
					// Change in assignment, send to assigned user
			       case CaseEntryConstants.BATCH_ASSIGNMENT_NOTIFICATION:	
			    	   uiUserBase = getUiUserBase(emailData.getAssignUser());
			    	   //sendToEmail = uiUserBase.getUiEMailAddress();
			    	   sendToEmail = uiUserBase.getUiEMailAddress();
			    	   firstName = uiUserBase.getUiFirstName();
			    	   lastName = uiUserBase.getUiLastName();
			           break;
			       // Success or fail, send email to submitted by 
			       case CaseEntryConstants.BATCH_SUCCESS_NOTIFICATION:	
			       case CaseEntryConstants.BATCH_FAIL_NOTIFICATION_USER:
			       case CaseEntryConstants.BATCH_INVALID_NOTIFICATION_USER:
			    	   uiUserBase = getUiUserBase(emailData.getSubmittedBy());
			    	   //sendToEmail = uiUserBase.getUiEMailAddress();
			    	   sendToEmail = uiUserBase.getUiEMailAddress();
			           break;
			       // File notification to admin
			       case CaseEntryConstants.BATCH_FAIL_NOTIFICATION_ADMIN:
			   			Optional <CaseConfigT> optional = caseConfigTRepository.findById(CaseEntryConstants.SYSTEM_ADMIN_DIST_LIST);
			   			if (optional.isPresent()) {
			   				CaseConfigT caseConfig = optional.get();
			   				sendToEmail = caseConfig.getOptionValue();
			   			} else {
			   				log.error("No Config Record found with id " + CaseEntryConstants.SYSTEM_ADMIN_DIST_LIST); 
			   			}
			           break;
			       default: 
		               break;
				}
				EmailData emailDataset = setEmailSubjText(emailData, firstName, lastName, caMetaBaseNoticeT);
				/*
				String jsonInputString = caseBatchUtil.createJsonInput(sendToEmail, emailDataset.getEmailSubject(), emailDataset.getEmailText());
				
				log.info("json input string = " + jsonInputString);
				
				mailStatus = caseBatchUtil.sendMail(jsonInputString); 
				*/
				if (sendToEmail != null) {
					emailSpecs.setSendToEmail(sendToEmail);
					emailSpecs.setCcEmail(ccMail);
					emailSpecs.setBccEmail(bccMail);
					emailSpecs.setEmailSubject(emailDataset.getEmailSubject());
					emailSpecs.setEmailText(emailDataset.getEmailText());
					mailStatus = caseBatchUtil.sendMail(emailSpecs);
					if (mailStatus) {
						saveEmailBatchT(emailDataset, sendToEmail);
					}
				}
			}

		} catch (Exception e) {
			log.error("Error at sendMail::", e);
			throw new CaseEntryApiException(e);
		}
		
		log.info("CaseBatchEmailService: postBatchProcessMail end");
	} 
	
	public UiUserBase getUiUserBase(String userSystemId)
	{
		UiUserBase uiUserBase = null;
		Optional<UiUserBase> userBaseOptional = Optional.empty();
		userBaseOptional = userRepository.findById(userSystemId);
		if (userBaseOptional.isPresent()) {
			uiUserBase = userBaseOptional.get();
		} else {
			log.error("No UiUserBase Record found with System id " + userSystemId); 
		}
		return uiUserBase;
	}
	/**
	  * this method is called by method sendMail to set email subject and text
	  * 
	  * Parameters - EmailData, UiUserBase, CaMetaBaseNoticeT) 
	  */
	public EmailData setEmailSubjText(EmailData emailData, String firstName, String lastName, CaMetaBaseNoticeT caMetaBaseNoticeT) {
		
		String emailSubjectRepl = CaseEntryConstants.EMPTY_STR;
		String emailTextRepl = CaseEntryConstants.EMPTY_STR;
		String investigationTypePreliminaryLabel = CaseEntryConstants.EMPTY_STR;
		String investigationTypeFullscaleLabel = CaseEntryConstants.EMPTY_STR;
		List<CaLuValuesT> caLuValuesTList = caLuValuesRepository.findByIdFieldId(CaseEntryConstants.INVST_TYPE_CODE);
		for (CaLuValuesT caLuValuesT : caLuValuesTList) {
			if (caLuValuesT.getId().getLuValue().equals(CaseEntryConstants.INVESTIGATION_TYPE_PRELIMINARY)) {
				investigationTypePreliminaryLabel = caLuValuesT.getLuLabel();
			}
			if (caLuValuesT.getId().getLuValue().equals(CaseEntryConstants.INVESTIGATION_TYPE_FULLSCALE)) {
				investigationTypeFullscaleLabel = caLuValuesT.getLuLabel();
			}	
		}

		int caseIdListLength = 0;
		SimpleDateFormat simpleDateFormatter = new SimpleDateFormat(CaseEntryConstants.DATE_FORMAT_MMDDYYYY_D, Locale.ENGLISH);
		switch (emailData.getNoticeId()) {
	    	case CaseEntryConstants.BATCH_ASSIGNMENT_NOTIFICATION:
	    		caseIdListLength = emailData.getCaseIdList().size();
	    		emailSubjectRepl = caMetaBaseNoticeT.getSubjEmail().replace(CaseEntryConstants.BATCH_ID_IN, String.valueOf(emailData.getBatchId()));
	    		
	    		emailTextRepl = caMetaBaseNoticeT.getRemComment().replace(CaseEntryConstants.ASSIGNED_TO, firstName + " " + lastName);
	    		if (emailData.getInvestigationType().equals(CaseEntryConstants.INVESTIGATION_TYPE_PRELIMINARY)) {
	    			emailTextRepl = emailTextRepl.replace(CaseEntryConstants.INVESTIGATION_TYPE, investigationTypePreliminaryLabel);
	    		} else {
	    			emailTextRepl = emailTextRepl.replace(CaseEntryConstants.INVESTIGATION_TYPE, investigationTypeFullscaleLabel);
	    		}
	    		StringBuilder caseIdAssignUserText = new StringBuilder();
	    		for (String caseId : emailData.getCaseIdList()) {
	    			caseIdAssignUserText.append(caseId);
	    			caseIdListLength--;
	    			if(caseIdListLength > 0) {
	    				caseIdAssignUserText.append(CaseEntryConstants.TEXT_SEPERATOR);
	    			}
	    		}
	    		emailTextRepl = emailTextRepl.replace(CaseEntryConstants.CASE_ID, caseIdAssignUserText.toString());
	    		emailTextRepl = emailTextRepl.replace(CaseEntryConstants.ASSIGNED_DATE, simpleDateFormatter.format(emailData.getAssignDate()));
	            break;
	    	//case CaseEntryConstants.SUBMITTED_ID:
	    	case CaseEntryConstants.BATCH_FAIL_NOTIFICATION_USER:
	    		emailSubjectRepl = caMetaBaseNoticeT.getSubjEmail().replace(CaseEntryConstants.BATCH_ID_IN, String.valueOf(emailData.getBatchId()));
	    		log.info("emailSubject: " + emailSubjectRepl);
	    		emailTextRepl = caMetaBaseNoticeT.getRemComment().replace(CaseEntryConstants.BATCH_ID_IN, String.valueOf(emailData.getBatchId()));
	    		break;
	    	case CaseEntryConstants.BATCH_INVALID_NOTIFICATION_USER:
	    		emailSubjectRepl = caMetaBaseNoticeT.getSubjEmail().replace(CaseEntryConstants.BATCH_ID_IN, String.valueOf(emailData.getBatchId()));
	    		log.info("emailSubject: " + emailSubjectRepl);
	    		emailTextRepl = caMetaBaseNoticeT.getRemComment().replace(CaseEntryConstants.BATCH_ID_IN, String.valueOf(emailData.getBatchId()));
	    		emailTextRepl = emailTextRepl.replace(CaseEntryConstants.TCNS, emailData.getErrorLog());
	    		break;
	    	case CaseEntryConstants.BATCH_SUCCESS_NOTIFICATION:
	    		caseIdListLength = emailData.getCaseIdList().size();
	    		emailSubjectRepl = caMetaBaseNoticeT.getSubjEmail().replace(CaseEntryConstants.BATCH_ID_IN, String.valueOf(emailData.getBatchId()));
	    		log.info("emailSubject: " + emailSubjectRepl);
	    		
	    		emailTextRepl = caMetaBaseNoticeT.getRemComment().replace(CaseEntryConstants.BATCH_ID_IN, String.valueOf(emailData.getBatchId()));
	    		
	    		emailTextRepl = caMetaBaseNoticeT.getRemComment().replace(CaseEntryConstants.BATCH_ID_IN, String.valueOf(emailData.getBatchId()));
	    		StringBuilder caseIdText = new StringBuilder();
	    		for (String caseId : emailData.getCaseIdList()) {
	    			caseIdText.append(caseId);
	    			caseIdListLength--;
	    			if(caseIdListLength > 0) {
	    				caseIdText.append(CaseEntryConstants.TEXT_SEPERATOR);
	    			}
	    		}
	    		emailTextRepl = emailTextRepl.replace(CaseEntryConstants.CASE_ID, caseIdText.toString());
	            break;
	    	case CaseEntryConstants.BATCH_FAIL_NOTIFICATION_ADMIN:
	    		emailSubjectRepl = caMetaBaseNoticeT.getSubjEmail().replace(CaseEntryConstants.BATCH_ID_IN, String.valueOf(emailData.getBatchId()));
	    		log.info("emailSubject: " + emailSubjectRepl);
	    		
	    		emailTextRepl = caMetaBaseNoticeT.getRemComment().replace(CaseEntryConstants.BATCH_ID_IN, String.valueOf(emailData.getBatchId()));
	    		emailTextRepl = emailTextRepl.replace(CaseEntryConstants.ERROR_LOG_INFO, emailData.getErrorLog());
	            break;
	    	default: 
          break;
	}
		emailData.setEmailSubject(emailSubjectRepl);
		emailData.setEmailText(emailTextRepl);
		return emailData;
	}
	/**
	  * this method will save a row in CaEmailsBatchT
	  * 
	  * Parameters - EmailData revised, UiUserBase) 
	  */
	
	public void saveEmailBatchT(EmailData emailDataset, String toEmail ) {
		
		LocalDateTime currentDate = LocalDateTime.now(caseBatchUtil.getZoneId());
		CaEmailsBatchT caEmailsBatchT = new CaEmailsBatchT();
		CaEmailsBatchTPK caEmailsBatchTPK = new CaEmailsBatchTPK();
		caEmailsBatchTPK.setCtBatchId(emailDataset.getBatchId());
		Integer sequenceId = caEmailsBatchRepository.getNextSequenceId(emailDataset.getBatchId());
		if (sequenceId == null) {
			caEmailsBatchTPK.setSeqNum(CaseEntryConstants.ONE);
		} else {
			caEmailsBatchTPK.setSeqNum(sequenceId);
		}
		caEmailsBatchT.setId(caEmailsBatchTPK);
		
		switch (emailDataset.getNoticeId()) {
	        case CaseEntryConstants.BATCH_SUCCESS_NOTIFICATION:
	        	caEmailsBatchT.setEmailType(CaseEntryConstants.SUCCESS_MESSAGE);
	            break;
	        case CaseEntryConstants.BATCH_ASSIGNMENT_NOTIFICATION:
	        	caEmailsBatchT.setEmailType(CaseEntryConstants.ASSIGNMENT);
	            break;
	        case CaseEntryConstants.BATCH_FAIL_NOTIFICATION_USER:
	        	caEmailsBatchT.setEmailType(CaseEntryConstants.FAIL_MESSAGE);
	            break;
	        case CaseEntryConstants.BATCH_FAIL_NOTIFICATION_ADMIN:
	        	caEmailsBatchT.setEmailType(CaseEntryConstants.FAIL_MESSAGE);
	            break;
	        case CaseEntryConstants.BATCH_INVALID_NOTIFICATION_USER:
	        	caEmailsBatchT.setEmailType(CaseEntryConstants.FAIL_MESSAGE);
	            break;
	        default: 
	            break;
		}
		caEmailsBatchT.setToEmail(toEmail);
		//String systemId = getUserSystemId(CaseEntryConstants.CT_ADMIN_ID);
		String systemId = caseBatchUtil.getCtAdminSystemId();
		caEmailsBatchT.setUserId(systemId);
		log.info("saveEmailBatchT Batch Id " + emailDataset.getBatchId() + " Notice ID " + emailDataset.getNoticeId() 
			+ " toEmail " + toEmail + " User ID " + caEmailsBatchT.getUserId() + " Email Type " + caEmailsBatchT.getEmailType());
		caEmailsBatchT.setEmailDt(currentDate);
		caEmailsBatchT.setEmailSubj(emailDataset.getEmailSubject());
		caEmailsBatchT.setEmailText(emailDataset.getEmailText());
		caEmailsBatchRepository.saveAndFlush(caEmailsBatchT);	// DB Operation 15
	}
	
	
	/**
	  * this method will return CaMetaBaseNoticeT
	  * 
	  * Parameters - noticeId 
	  */	
	public CaMetaBaseNoticeT getMetaBaseNoticeT(String noticeId) {
		
		CaMetaBaseNoticeT caMetaBaseNoticeT = null;
//		Specification<CaMetaBaseNoticeT> caseMetaBaseNoticeSpecs = 
	//			CaseEntryBatchSpecification.findMetaBaseNoticeSpecification(tableName, columnName);
//		Optional<CaMetaBaseNoticeT> metaBaseNoticeOptional = caMetaBaseNoticeRepository.findOne(caseMetaBaseNoticeSpecs);
		Optional<CaMetaBaseNoticeT> metaBaseNoticeOptional = caMetaBaseNoticeRepository.findById(noticeId);
		if (metaBaseNoticeOptional.isPresent()) {
			caMetaBaseNoticeT= metaBaseNoticeOptional.get(); 
		}
		return caMetaBaseNoticeT;
	}
	
	/*
	private boolean patternMatches(String emailAddress, String regexPattern) {
	    return Pattern.compile(regexPattern)
	      .matcher(emailAddress)
	      .matches();
	}
	*/
}
package com.optum.fads.caseentrybatch.api.service.impl;

import java.lang.reflect.Field;
import java.text.SimpleDateFormat;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.stream.Collectors;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.Comparator;

import org.modelmapper.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.ReflectionUtils;

import com.optum.fads.caseentrybatch.api.common.CaseEntryConstants;
import com.optum.fads.caseentrybatch.api.domain.CaClaimCorrectionsHistT;
import com.optum.fads.caseentrybatch.api.domain.CaClaimCorrectionsT;
import com.optum.fads.caseentrybatch.api.domain.CaClaimCorrectionsTPK;
import com.optum.fads.caseentrybatch.api.domain.CaClaimListT;
import com.optum.fads.caseentrybatch.api.domain.CaClaimListTPK;
import com.optum.fads.caseentrybatch.api.domain.CaGeneralT;
import com.optum.fads.caseentrybatch.api.domain.CaIntelligentKeyT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsAssignHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsAssignHistTPK;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsAssignT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsAssignTPK;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsHistTPK;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsIssueHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsIssueHistTPK;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsIssueT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsIssueTPK;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsStatusHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsStatusHistTPK;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFullscaleT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrAssignHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrAssignHistTPK;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrAssignT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrAssignTPK;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrHistTPK;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrIssueHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrIssueHistTPK;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrIssueT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrIssueTPK;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrStatusHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrStatusHistTPK;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPreliminaryT;
import com.optum.fads.caseentrybatch.api.domain.CaLuCaseSourceT;
import com.optum.fads.caseentrybatch.api.domain.CaLuCaseTypeT;
import com.optum.fads.caseentrybatch.api.domain.CaLuFullscaleSectionT;
import com.optum.fads.caseentrybatch.api.domain.CaLuFullscaleStatusT;
import com.optum.fads.caseentrybatch.api.domain.CaLuPrelimIssueT;
import com.optum.fads.caseentrybatch.api.domain.CaLuPrelimSectionT;
import com.optum.fads.caseentrybatch.api.domain.CaLuPrelimStatusT;
import com.optum.fads.caseentrybatch.api.domain.CaLuPrmNodeT;
import com.optum.fads.caseentrybatch.api.domain.CaMetaBaseT;
import com.optum.fads.caseentrybatch.api.domain.CaProviderT;
import com.optum.fads.caseentrybatch.api.domain.CaRecipientT;
import com.optum.fads.caseentrybatch.api.domain.CaUniverseT;
import com.optum.fads.caseentrybatch.api.domain.UiUserBase;
import com.optum.fads.caseentrybatch.api.dto.CaseBaseInfo;
import com.optum.fads.caseentrybatch.api.dto.CaseMetabaseField;
import com.optum.fads.caseentrybatch.api.dto.CaseMetabaseProvider;
import com.optum.fads.caseentrybatch.api.dto.CaseMetabaseRecipient;
import com.optum.fads.caseentrybatch.api.dto.CaseProviderDTO;
import com.optum.fads.caseentrybatch.api.dto.CaseRecipientDTO;
import com.optum.fads.caseentrybatch.api.dto.EmailData;
import com.optum.fads.caseentrybatch.api.dto.EmailSpecification;
import com.optum.fads.caseentrybatch.api.repo.CaIntelligentKeyRepository;
import com.optum.fads.caseentrybatch.api.repo.CaMetaBaseRepository;
import com.optum.fads.caseentrybatch.api.repo.CaUniverseRepository;
import com.optum.fads.caseentrybatch.api.service.ICaseBatchIndividualService;
import com.optum.fads.caseentrybatch.api.snowflakeDomain.DmClaimDrugT;
import com.optum.fads.caseentrybatch.api.snowflakeRepo.DmClaimDrugRepository;
import com.optum.fads.caseentrybatch.api.util.CaseBatchUtil;
import com.optum.fads.caseentrybatch.api.util.ClaimsCorrectionsHistAssist;

import lombok.extern.slf4j.Slf4j;

@Service
@Slf4j
public class CaseBatchIndividualService  implements ICaseBatchIndividualService {
	
	@Autowired
	private CaUniverseRepository caUniverseRepository;
	
	@Autowired
	private CaIntelligentKeyRepository caIntelligentKeyRepository;
	
	@Autowired
	private DmClaimDrugRepository dmClaimDrugRepository;

	@Autowired
	private CaMetaBaseRepository caMetaBaseRepository;
    
    @Autowired
    private ClaimsCorrectionsHistAssist claimsCorrectionsHistAssist;

    @Autowired
    private	CaseBatchEmailService caseBatchEmailService;

    @Autowired
    private CaseBatchUtil caseBatchUtil;

    @Autowired
    @Qualifier("jdbcSnowflake")
    private JdbcTemplate jdbcTemplate;

    @Autowired
    private ModelMapper modelMapper;

    /**
      * this method will create cases and entries in CA_UNIVERSE_T table
      *
      * Input - CA_UNIVERSE_BATCH_T table entries
     */
	
	 /**
	  * this method will create Batch Case Entries in various Case Tracking tables
	  * 
	  * Parameters - Integer caseBatchId, List<CaUniverseBatchT> caUniverseBatchTList  
	  */	
	@Transactional
	public void createIndBatchCaseEntries(List<CaUniverseT> caUniverseTList) {
		
		Integer caseIdInit = 0;
		Integer caseIdFinal = 0;

		List<CaseBaseInfo> caseIndValuesList = new ArrayList<>();
        List<String> partcipants = caUniverseTList.stream().map(CaUniverseT::getParticipantId)
                .collect(Collectors.toList()).stream().distinct().toList();

		Integer numOfCases = partcipants.size();
		String emailText; 
		String submittedBy = caUniverseTList.get(0).getUiUserBase().getUiSystemId();
		String invstTypeCd = caUniverseTList.get(0).getInvstTypeCd();
		String assignUser = caUniverseTList.get(0).getAssignUsr();
		Date assignDate = caUniverseTList.get(0).getAssignDate();

		LocalDateTime currentSqlDate = LocalDateTime.now(caseBatchUtil.getZoneId());
		Integer caseUniverseBatchId = caUniverseTList.get(0).getId().getCtBatchId();
		
		EmailSpecification emailSpecs = caseBatchUtil.getEmailSpecs();
			for (String participantId : partcipants){
                List<CaUniverseT> partcipantCaUniverseList= new ArrayList<CaUniverseT>();
                CaseBaseInfo caseBatchIndValues = getCaseIndValue(caUniverseTList.get(0).getCaPrmNodeCd(), caUniverseTList.get(0).getCaYearId(), participantId);
//              partcipantCaUniverseList= caUniverseTList.stream().filter(p->p.getParticipantId().equalsIgnoreCase(participantId)).collect(Collectors.toList());
              partcipantCaUniverseList= 
              	caUniverseTList.stream().filter(p->p.getParticipantId().equalsIgnoreCase(participantId)).sorted(Comparator.comparing(p->p.getHdrRecipFullNm())).collect(Collectors.toList());
                AtomicInteger count=new AtomicInteger(1);
                partcipantCaUniverseList.forEach(p->{
                    p.setCaseId(caseBatchIndValues.getCaseId());
                    p.setCaSequenceId(caseBatchIndValues.getSequenceId());
                    p.setClmSeqNum(count.getAndIncrement());
                });

                CaIntelligentKeyT caIntelligentKeyT=	createIntGenPrRpInvstEntries(caseBatchIndValues, currentSqlDate, caUniverseTList.get(0));
                createClaimsList(caIntelligentKeyT,partcipantCaUniverseList, caseBatchIndValues.getParticpantId(), caseBatchIndValues.getParticpantName());
                log.info(" Save caUniverseT entries Batch ID " + caseUniverseBatchId);

                saveCaIntelligentKeyTentry(caIntelligentKeyT);
                caUniverseRepository.saveAll(partcipantCaUniverseList);	// DB Operation 14
                caUniverseRepository.flush();					// DB Operation

                caseIndValuesList.add(caseBatchIndValues);
            }
     				log.info("Case Batch ID " + caseUniverseBatchId + CaseEntryConstants.PROCESSED);
					caseIdInit = caseIndValuesList.get(0).getCaseId();
					caseIdFinal = caseIdInit + numOfCases - CaseEntryConstants.ONE;
					if (numOfCases == CaseEntryConstants.ONE) {	
						emailText = "Case ID created = " + caseIdFinal;
					} else {
						emailText = "Number of Cases created = " + numOfCases +  ", Case IDs " + caseIdInit + " to " + caseIdFinal;
					}
					log.info(emailText);
				//	caseBatchEmailService.sendBatchProcesedMail(userSystemId, emailSubject, emailText);
					EmailData emailData = new EmailData();
					emailData.setBatchId(caseUniverseBatchId);
					
					emailData.setNoticeId(CaseEntryConstants.BATCH_SUCCESS_NOTIFICATION);
					emailData.setSubmittedBy(submittedBy);
					emailData.setAssignUser(assignUser);
					log.info("Submitted By, Assigned User = " + emailData.getSubmittedBy() + " " + emailData.getAssignUser());
					
					emailData.setInvestigationType(invstTypeCd);
					
					List<String> caseIdList = new ArrayList<>();
					for (CaseBaseInfo caseBatchIndValues : caseIndValuesList) {
						caseIdList.add(caseBatchIndValues.getCaseIdStr());
					}
					
					// Upon successful completion of a batch
					emailData.setCaseIdList(caseIdList);
					caseBatchEmailService.postBatchProcessMail(emailData, emailSpecs);
					
					// Send email to assigned user
					if (!(invstTypeCd == null ||  (invstTypeCd.equals(CaseEntryConstants.EMPTY_STR)))) {
						emailData.setNoticeId(CaseEntryConstants.BATCH_ASSIGNMENT_NOTIFICATION);
						emailData.setAssignUser(assignUser);
						emailData.setInvestigationType(invstTypeCd);
						emailData.setAssignDate(assignDate);
						caseBatchEmailService.postBatchProcessMail(emailData, emailSpecs);	// To assigned user
					}
					


		log.info(" Number of Cases created = " + numOfCases +  ", Case ID(s) " + caseIdInit + " to " + caseIdFinal );
		if (numOfCases == 1) {	
			emailText = "Case ID created = " + caseIdFinal;
		} else {
			emailText = "Number of Cases created = " + numOfCases +  ", Case IDs " + caseIdInit + " to " + caseIdFinal;
		}

	}	
	public CaseBaseInfo getCaseIndValue(String prmNodeCd, Integer yearId, String participantId) {
		
		CaseBaseInfo caseBatchIndValues = new CaseBaseInfo();
		Integer caseId = caIntelligentKeyRepository.getNextCaseId();
		if (caseId == null) {
			caseId = CaseEntryConstants.ONE;
		}
		caseBatchIndValues.setCaseId(caseId);
		Integer sequenceId = caIntelligentKeyRepository.getNextSequenceId(prmNodeCd, yearId.shortValue());
		if (sequenceId == null) {
			sequenceId = 1;
		}
				
		caseBatchIndValues.setSequenceId(sequenceId);
		String caseIdStr = prmNodeCd+"-"+String.valueOf(yearId)+"-"+String.format("%05d", sequenceId);
		caseBatchIndValues.setCaseIdStr(caseIdStr);
		log.info("Next caseId = " + caseId + " " + caseIdStr + " participantId " + participantId);
		caseBatchIndValues.setParticpantId(participantId);
		
		return caseBatchIndValues;
	}

	/**
	  * this method will create CaIntelligentKey, CaGeneralT, Provider, Recipient, Investigation entries
	  * 
	  * Parameters - caseBatchId, caseId, currentSqlDate, caUniverseBatchT, clmSeqNum, sequenceId  
	  */	
	public  CaIntelligentKeyT createIntGenPrRpInvstEntries(CaseBaseInfo caseIndValues, LocalDateTime currentSqlDate,
                                             CaUniverseT caUniverseT) {

		//	CaIntelligentKeyT generation
       // CaIntelligentKeyT caIntelligentKeyT =  createCaIntelligentKeyTentry(caseIndValues.getCaseId(), caseIndValues.getSequenceId(), currentSqlDate, caUniverseT);
        CaIntelligentKeyT caIntelligentKeyT = CaIntelligentKeyT.builder().caseId(caseIndValues.getCaseId())
                .caLuCaseTypeT(CaLuCaseTypeT.builder().typeCd(caUniverseT.getCaseTypeCd()).build())
                .caLuPrmNodeT(CaLuPrmNodeT.builder().nodeCd(caUniverseT.getCaPrmNodeCd()).build())
                .caYearId(caUniverseT.getCaYearId().shortValue()).caSequenceId(caseIndValues.getSequenceId())
                .uiUserBaseByCreatedBy(UiUserBase.builder().uiSystemId(caUniverseT.getUiUserBase().getUiSystemId()).build())
                .uiUserBaseByUpdatedBy(UiUserBase.builder().uiSystemId(caUniverseT.getUiUserBase().getUiSystemId()).build())
                .createdDt(currentSqlDate).updatedDt(currentSqlDate).build();

		//	CaGeneralT generation
        //CaGeneralT caGeneralT = createCaGeneralTentry(caIntelligentKeyT, caseIndValues.getParticpantId(), caseIndValues.getParticpantName(), caUniverseT);
        //caIntelligentKeyT.setCaGeneralT(caGeneralT);

		if (CaseEntryConstants.PROVIDER.equals(caUniverseT.getCaseTypeCd())) {
            CaseProviderDTO provider=findCaseProvider(caUniverseT.getCaseTypeCd(),caseIndValues.getParticpantId());
            caseIndValues.setParticpantName(provider.getParticipantName());
            //  CaGeneralT generation
            CaGeneralT caGeneralT = createCaGeneralTentry(caIntelligentKeyT, caseIndValues.getParticpantId(), caseIndValues.getParticpantName(), caUniverseT);
            caIntelligentKeyT.setCaGeneralT(caGeneralT);
            CaProviderT caProviderT =   createProviderEntry(caIntelligentKeyT,provider);
            caIntelligentKeyT.setCaProviderT(caProviderT);

		} else if (CaseEntryConstants.MEMBER.equals(caUniverseT.getCaseTypeCd())) {
            CaseRecipientDTO recipient = findCaseRecipient(caUniverseT.getCaseTypeCd(),caseIndValues.getParticpantId());
            caseIndValues.setParticpantName(recipient.getParticipantName());
            CaGeneralT caGeneralT = createCaGeneralTentry(caIntelligentKeyT, caseIndValues.getParticpantId(), caseIndValues.getParticpantName(), caUniverseT);
            caIntelligentKeyT.setCaGeneralT(caGeneralT);
            CaRecipientT caRecipientT = createRecipientEntry(caIntelligentKeyT, recipient );

            caIntelligentKeyT.setCaRecipientT(caRecipientT);
		} else {
			log.info(" Input Case Type Code in error " + caUniverseT.getCaseTypeCd());
		}



        if ((caUniverseT.getInvstTypeCd()!= null)&&(!caUniverseT.getInvstTypeCd().isEmpty())){
			// CA_INVST_PRELIMINARY_T or CA_INVST_FULLSCALE_T

			createinvstPrFsEntry(caIntelligentKeyT, caUniverseT);

			//  CA_INVST_PR_ASSIGN_T or CA_INVST_FS_ASSIGN_T

			createinvstPrFsAssignEntry(caIntelligentKeyT, caseIndValues.getSequenceId(), caUniverseT);
		}
        return caIntelligentKeyT;
	}
	
	
	/**
	  * this method will create CaIntelligentKeyTentry
	  * 
	  * Parameters - caseId, sequenceId, currentSqlDate, CaUniverseBatchT  
	  */
    /*
	public CaIntelligentKeyT XcreateCaIntelligentKeyTentry(Integer caseId, Integer sequenceId, LocalDateTime currentSqlDate, CaUniverseT caUniverseT) {
		
		CaIntelligentKeyT caIntelligentKeyT = CaIntelligentKeyT.builder().caseId(caseId)
				.caLuCaseTypeT(CaLuCaseTypeT.builder().typeCd(caUniverseT.getCaseTypeCd()).build())
				.caLuPrmNodeT(CaLuPrmNodeT.builder().nodeCd(caUniverseT.getCaPrmNodeCd()).build())
				.caYearId(caUniverseT.getCaYearId().shortValue()).caSequenceId(sequenceId)
				.uiUserBaseByCreatedBy(UiUserBase.builder().uiSystemId(caUniverseT.getUiUserBase().getUiSystemId()).build())
				.uiUserBaseByUpdatedBy(UiUserBase.builder().uiSystemId(caUniverseT.getUiUserBase().getUiSystemId()).build())
				.createdDt(currentSqlDate).updatedDt(currentSqlDate).build();
		log.info(" Save caIntelligentKeyT Case ID " + caseId);
	//	caIntelligentKeyRepository.save(caIntelligentKeyT);	// DB operation 1
        return caIntelligentKeyT;
	}*/
    public void  saveCaIntelligentKeyTentry(CaIntelligentKeyT caIntelligentKeyT) {

        caIntelligentKeyRepository.save(caIntelligentKeyT); // DB operation 1
    }


	/**
	  * this method will create CaGeneralTentry
	  * 
	  * Parameters - caseId, providerMap, caUniverseBatchT
	  */	
	public CaGeneralT  createCaGeneralTentry(CaIntelligentKeyT caIntelligentKeyT, String participantId, String participantName,CaUniverseT caUniverseT) {
	
		CaGeneralT caGeneralT ;
		if (caUniverseT.getCaseSourceCd() == null || caUniverseT.getCaseSourceCd().isEmpty()) {
			caGeneralT = CaGeneralT.builder().caseId(caIntelligentKeyT.getCaseId()).participantId(participantId)
					.participantName(participantName)
					.trackingId(CaseEntryConstants.BATCH_CASE + caUniverseT.getId().getCtBatchId())	// Tracking Number
					.protectStatus(caUniverseT.getProjectStatus())
                    .caIntelligentKeyT(caIntelligentKeyT).build();
		} else {
			caGeneralT = CaGeneralT.builder().caseId(caIntelligentKeyT.getCaseId()).participantId(participantId)
					.participantName(participantName)
					.trackingId(CaseEntryConstants.BATCH_CASE + caUniverseT.getId().getCtBatchId())	// Tracking Number
					.caLuCaseSourceT(CaLuCaseSourceT.builder().sourceCd(caUniverseT.getCaseSourceCd()).build())
                    .protectStatus(caUniverseT.getProjectStatus())
                    .caIntelligentKeyT(caIntelligentKeyT).build();
		}


        log.info(" Save CaGeneralT Case ID " + caIntelligentKeyT.getCaseId());
        //    	caGeneralRepository.save(caGeneralT);			// DB Operation 2
        return caGeneralT;
	}
	 /**
	  * this method will complete claims, corrections list
	  * 
	  * Parameters - Claims list  
	  */	
	public void createClaimsList(CaIntelligentKeyT caIntelligentKeyT,List<CaUniverseT> caUniverseTList, String participantId, String participantName) {
		
		List<CaClaimListT> claimsList = new ArrayList<>();
		List<CaClaimCorrectionsT> claimCorrectionsList = new ArrayList<>();
		List<CaClaimCorrectionsHistT> claimCorrectionsHistList = new ArrayList<>();

		for (CaUniverseT caUniverseT : caUniverseTList) {
			
			CaClaimListT caClaimListT = new CaClaimListT();
    		CaClaimListTPK caClaimListTPK = new CaClaimListTPK();
    		caClaimListTPK.setCaseId(caUniverseT.getCaseId());
    		caClaimListTPK.setClmSeqNum(caUniverseT.getClmSeqNum());
    		caClaimListT.setId(caClaimListTPK);
    		caClaimListT.setHdrClmTcn(caUniverseT.getId().getHdrClmTcn());
    		caClaimListT.setLiNum(caUniverseT.getId().getLiNum());
        	caClaimListT.setHdrClmPdDt(caUniverseT.getId().getHdrClmPdDt());
//        	caClaimListT.setHdrRecipFullNm(caUniverseT.getAssignUsr());
        	caClaimListT.setCtCorrectPdAmt(CaseEntryConstants.ZERO);
            caClaimListT.setCaIntelligentKeyT(caIntelligentKeyT);

			
			CaClaimCorrectionsT caClaimCorrectionsT = new CaClaimCorrectionsT();
			CaClaimCorrectionsTPK caClaimCorrectionsTPK = new CaClaimCorrectionsTPK();
			caClaimCorrectionsTPK.setCaseId(caClaimListT.getId().getCaseId());
			caClaimCorrectionsTPK.setClmSeqNum(caUniverseT.getClmSeqNum());
			caClaimCorrectionsT.setId(caClaimCorrectionsTPK);
			caClaimCorrectionsT.setHdrClmTcn(caClaimListT.getHdrClmTcn());
			caClaimCorrectionsT.setLiNum(caClaimListT.getLiNum());
			caClaimCorrectionsT.setHdrClmPdDt(caClaimListT.getHdrClmPdDt());
            caClaimCorrectionsT.setCaIntelligentKeyT(caIntelligentKeyT);

//			Optional<DmClaimT> dmClaimToptional =  
//				dmClaimRepository.findById(DmClaimTPK.builder().hdrClmTcn(caClaimListT.getHdrClmTcn()).liNum(caClaimListT.getLiNum()).hdrClmPdDt(caClaimListT.getHdrClmPdDt()).build());
//			if (dmClaimToptional.isPresent()) {
//				DmClaimT dmClaimT = dmClaimToptional.get();
			caClaimListT.setHdrClmTypeCd(caUniverseT.getHdrClmTypeCd());
			caClaimListT.setHdrRecipOrigId(caUniverseT.getHdrRecipOrigId());
			caClaimListT.setHdrRecipCurrId(caUniverseT.getHdrRecipCurrId());
			caClaimListT.setHdrRecipFullNm(caUniverseT.getHdrRecipFullNm());
//			caClaimListT.setHdrAttendProvId(caUniverseT.getHdrAttendProvId());
			caClaimListT.setHdrPayToProvId(caUniverseT.getHdrPayToProvId());
			caClaimListT.setHdrPrescrProvId(caUniverseT.getHdrPrescrProvId());
//			caClaimListT.setHdrReferProvId(caUniverseT.getHdrReferProvId());
//			caClaimListT.setLiTreatProvId(caUniverseT.getLiTreatProvId());
			caClaimListT.setLiSrvFromDt(caUniverseT.getLiSrvFromDt());
//			caClaimListT.setLiSrvToDt(caUniverseT.getLiSrvToDt());
			if (caUniverseT.getLiBillAmt() != null) 
				caClaimListT.setLiBillAmt(caUniverseT.getLiBillAmt().doubleValue());
			if (caUniverseT.getLiPdAmt() != null)
				caClaimListT.setLiPdAmt(caUniverseT.getLiPdAmt().doubleValue());
			if (caUniverseT.getHdrPdAmt() != null) {
				caClaimListT.setHdrPdAmt(caUniverseT.getHdrPdAmt().doubleValue());
				caClaimListT.setCtCorrectPdAmt(caUniverseT.getHdrPdAmt().doubleValue());
			}
			caClaimListT.setLiDrugPrescrNum(caUniverseT.getLiDrugPrescrNum());
			caClaimListT.setLiDrugNdc(caUniverseT.getLiDrugNdc());
			caClaimListT.setLiDrugValidClmInd(caUniverseT.getLiDrugValidClmInd());
            caClaimListT.setCaIntelligentKeyT(caIntelligentKeyT);
				 
			caClaimCorrectionsT.setLiDrugNdc(caUniverseT.getLiDrugNdc());
			if (caUniverseT.getLiPdAmt() != null)
				caClaimCorrectionsT.setLiPdAmt(caUniverseT.getLiPdAmt().doubleValue());
			if (caUniverseT.getHdrPdAmt() != null)
				caClaimCorrectionsT.setHdrPdAmt(caUniverseT.getHdrPdAmt().doubleValue());
			if (caUniverseT.getLiPdUosQty() != null)
				caClaimCorrectionsT.setLiPdUosQty(caUniverseT.getLiPdUosQty().doubleValue());
//			caClaimCorrectionsT.setLiDrugRouteCd(caUniverseT.getLiDrugRouteCd());
			caClaimCorrectionsT.setLiDrugDaysSupply(caUniverseT.getLiDrugDaysSupply());
//			caClaimCorrectionsT.setLiDrugDispFeeAmt(dmClaimT.getLiDrugDispFeeAmt());	// LiDrugDispFeeAmt not available in AR
			if (caUniverseT.getHdrDrugDispensingFee() != null)
				caClaimCorrectionsT.setHdrDrugDispensingFee(caUniverseT.getHdrDrugDispensingFee().doubleValue());
			caClaimCorrectionsT.setLiDrugDosageFormDesc(caUniverseT.getLiDrugDosageFormDesc());
			if (caUniverseT.getHdrCopayAmt() != null)
				caClaimCorrectionsT.setHdrCopayAmt(caUniverseT.getHdrCopayAmt().doubleValue());
			if (caUniverseT.getLiCopayAmt1() != null)
				caClaimCorrectionsT.setLiCopayAmt(caUniverseT.getLiCopayAmt1().doubleValue());
            caClaimCorrectionsT.setCaIntelligentKeyT(caIntelligentKeyT);
				 
			if (caUniverseT.getCaseTypeCd().equals(CaseEntryConstants.PROVIDER) || caUniverseT.getCaseTypeCd().equals(CaseEntryConstants.NATIONAL_SETTLEMENT)) {
				switch (caUniverseT.getProvRole()) {
			        case CaseEntryConstants.PROVIDER_ROLE_ATTENDING:
			        	caClaimListT.setHdrAttendProvId(participantId);
			        	caClaimListT.setHdrAttendProvNm(participantName);
			                 break;
			        case CaseEntryConstants.PROVIDER_ROLE_BILLING:
			        	caClaimListT.setHdrPayToProvNm(participantName);
			                  break;
			        case CaseEntryConstants.PROVIDER_ROLE_REFERRING:
			        	caClaimListT.setHdrReferProvId(participantId);
			        	caClaimListT.setHdrReferProvNm(participantName);
			                 break;
			        case CaseEntryConstants.PROVIDER_ROLE_TREATING:
			        	caClaimListT.setLiTreatProvId(participantId);
			        	caClaimListT.setLiTreatProvNm(participantName);
			                  break;
			        case CaseEntryConstants.PROVIDER_ROLE_PRESCRIBING:
			        	caClaimListT.setHdrPrescrProvNm(participantName);
			                  break;
			        default: 
		                  break;
				}	
			}
				 

			claimsList.add(caClaimListT);
			claimCorrectionsList.add(caClaimCorrectionsT);
			CaClaimCorrectionsHistT caClaimCorrectionsHistT = claimsCorrectionsHistAssist.createClaimCorrectionsHistT(caIntelligentKeyT,caUniverseT.getUiUserBase().getUiSystemId(),
					caUniverseT.getClmSeqNum(), caClaimCorrectionsT);
			claimCorrectionsHistList.add(caClaimCorrectionsHistT);
		}
		
		log.info(" Save claims list size = " + claimsList.size());
		//		caClaimListRepository.saveAll(claimsList);				// DB Operation 11
        caIntelligentKeyT.setCaClaimListTs(new HashSet<>(claimsList));
		
		log.info(" Save claims corrections list size = " + claimCorrectionsList.size());
		//		caClaimCorrectionsRepository.saveAll(claimCorrectionsList);	// DB Operation 12
        caIntelligentKeyT.setCaClaimCorrectionsTs(new HashSet<CaClaimCorrectionsT>(claimCorrectionsList));
		log.info(" Save claims corrections history list size = " + claimCorrectionsHistList.size());
		//		caClaimCorrectionsHistRepository.saveAll(claimCorrectionsHistList); // DB Operation 13
        caIntelligentKeyT.setCaClaimCorrectionsHistTs(new HashSet<>(claimCorrectionsHistList));
	}
	
	/**
	  * this method will create CA_PROVIDER_T entries
	  * 
	  * Parameters - Case ID,  String Participant ID, List CaMetaBaseT Provider
	  */
	public CaProviderT createProviderEntry(CaIntelligentKeyT caIntelligentKeyT, CaseProviderDTO provider) {

        CaProviderT caProviderT = modelMapper.map(provider, CaProviderT.class);
		caProviderT.setCaseId(caIntelligentKeyT.getCaseId());
        caProviderT.setCaIntelligentKeyT(caIntelligentKeyT);
	    log.info(" Save caProviderT, Case Id = " + caIntelligentKeyT.getCaseId() + " participantID " + provider.getParticipantId());

        //	caProviderRepository.save(caProviderT);	// DB Operation 3 Provider

        return caProviderT;
	}
	/**
	  * this method will create CA_RECIPIENT_T entries
	  * 
	  * Parameters - Case ID, String Case Type, String Participant ID
	  */
	public CaRecipientT createRecipientEntry(CaIntelligentKeyT caIntelligentKeyT, CaseRecipientDTO recipient) {
		
		SimpleDateFormat simpleDateFormatter = new SimpleDateFormat(CaseEntryConstants.DATE_FORMAT_MMDDYYYY_D, Locale.ENGLISH);
		CaRecipientT caRecipientT = modelMapper.map(recipient,CaRecipientT.class);
		caRecipientT.setCaseId(caIntelligentKeyT.getCaseId());
        caRecipientT.setCaIntelligentKeyT(caIntelligentKeyT);
	     log.info(" Save caRecipientT caseID " + caIntelligentKeyT.getCaseId() + " participantID " + recipient.getParticipantId());
		//		caRecipientRepository.save(caRecipientT);	// DB Operation 3
        return caRecipientT;
	}

	 /**
	  * this method will create CA_INVST_PRELIMINARY_T, CaInvstPrHistT, CaInvstPrStatusHistT
	  * 		CaInvstPrIssueT, CaInvstPrIssueHistT
	  *   and CA_INVST_FULLSCALE_T, CaInvstFsHistT, CaInvstFsStatusHistT,
	  *			CaInvstFsIssueT, CaInvstFsIssueHistT entries
	  * 
	  * Parameters - Case ID, Invst Type, Case Status, Case Status Date
	  */	
//	private void createinvstPrFsEntry(Integer caseId, String invstType, String caseStatus,
//			Date caseStatusDate, String issueCd) {
	public void createinvstPrFsEntry(CaIntelligentKeyT caIntelligentKeyT, CaUniverseT caUniverseT) {

		Date today = Calendar.getInstance().getTime();
		if (caUniverseT.getInvstTypeCd().equals(CaseEntryConstants.INVESTIGATION_TYPE_PRELIMINARY)) {
			CaInvstPreliminaryT caInvstPreliminaryT = CaInvstPreliminaryT.builder().caseId(caIntelligentKeyT.getCaseId()).caseStatusCd(caUniverseT.getCaseStatusCd())
					.caseStatusDt(caUniverseT.getCaseStatusDt()).caIntelligentKeyT(caIntelligentKeyT).build();
			log.info(" Save caInvstPreliminaryT Case ID " + caIntelligentKeyT.getCaseId());
		//	caInvstPrelimRepository.save(caInvstPreliminaryT);	// DB Operation 4 Pr
            caIntelligentKeyT.setCaInvstPreliminaryT(caInvstPreliminaryT);


			CaInvstPrHistT caInvstPrHistT = CaInvstPrHistT.builder().id(CaInvstPrHistTPK.builder().caseId(caIntelligentKeyT.getCaseId()).histSeqNum(CaseEntryConstants.ONE).build())
					.uiUserBaseChangeUsr(UiUserBase.builder().uiSystemId(caUniverseT.getUiUserBase().getUiSystemId()).build())
					.caLuPrelimStatusT(CaLuPrelimStatusT.builder().statusCd(caUniverseT.getCaseStatusCd()).build())
					.caseStatusDt(caUniverseT.getCaseStatusDt()).changeDt(today)
                    .caIntelligentKeyT(caIntelligentKeyT).build();
			log.info(" Save caInvstPrHistT Case ID " + caIntelligentKeyT.getCaseId());
				//	caInvstPrHistRepository.save(caInvstPrHistT);	// DB Operation 5 Pr Hist
            HashSet<CaInvstPrHistT> caInvstPrHistTs= new HashSet<CaInvstPrHistT>();
            caInvstPrHistTs.add(caInvstPrHistT);
            caIntelligentKeyT.setCaInvstPrHistTs(caInvstPrHistTs);
			
			CaInvstPrStatusHistT caInvstPrStatusHistT = CaInvstPrStatusHistT.builder().id(CaInvstPrStatusHistTPK.builder().caseId(caIntelligentKeyT.getCaseId()).build())
					.caLuPrelimStatusT(CaLuPrelimStatusT.builder().statusCd(caUniverseT.getCaseStatusCd()).build())
					.statusBeginDt(caUniverseT.getCaseStatusDt())
                    .caIntelligentKeyT(caIntelligentKeyT).build();
			log.info(" Save caInvstPrStatusHistT Case ID " + caIntelligentKeyT.getCaseId());
			//		caInvstPrStatusHistRepository.save(caInvstPrStatusHistT);	// DB Operation 6 Pr Status Hist
            HashSet<CaInvstPrStatusHistT> caInvstPrStatusHistTs = new HashSet<>();
            caInvstPrStatusHistTs.add(caInvstPrStatusHistT);
            caIntelligentKeyT.setCaInvstPrStatusHistTs(caInvstPrStatusHistTs);

			if (!(caUniverseT.getIssueCd() == null || caUniverseT.getIssueCd().isEmpty())) {
				CaInvstPrIssueT caInvstPrIssueT = CaInvstPrIssueT.builder().id(CaInvstPrIssueTPK.builder().caseId(caIntelligentKeyT.getCaseId()).issueCd(caUniverseT.getIssueCd()).build())
				.caLuPrelimIssueT(CaLuPrelimIssueT.builder().issueCd(caUniverseT.getIssueCd()).build())
                        .caIntelligentKeyT(caIntelligentKeyT).build();
				
				log.info(" Save caInvstPrIssueT Case ID " + caIntelligentKeyT.getCaseId());
				//		caInvstPrIssueRepository.save(caInvstPrIssueT);	// DB Operation 7 Pr Issue
                HashSet<CaInvstPrIssueT> caInvstPrIssueTs = new HashSet<CaInvstPrIssueT>();
                caInvstPrIssueTs.add(caInvstPrIssueT);
                caIntelligentKeyT.setCaInvstPrIssueTs(caInvstPrIssueTs);
				
				CaInvstPrIssueHistT caInvstPrIssueHistT = CaInvstPrIssueHistT.builder().id(CaInvstPrIssueHistTPK.builder().caseId(caIntelligentKeyT.getCaseId()).issueCd(caUniverseT.getIssueCd()).build())
						.changeUsr(caUniverseT.getUiUserBase().getUiSystemId()).changeDt(today)
                        .caIntelligentKeyT(caIntelligentKeyT).build();
				log.info(" Save caInvstPrIssueHistT Case ID " + caIntelligentKeyT.getCaseId());
				//		caInvstPrIssueHistRepository.save(caInvstPrIssueHistT);	// DB Operation 8 Pr Issue Hist
                HashSet<CaInvstPrIssueHistT> caInvstPrIssueHistTs= new HashSet<CaInvstPrIssueHistT>();
                caIntelligentKeyT.setCaInvstPrIssueHistTs(caInvstPrIssueHistTs);
			}	
		} else {
			CaInvstFullscaleT caInvstFullscaleT = CaInvstFullscaleT.builder().caseId(caIntelligentKeyT.getCaseId())
					.caseStatusCd(caUniverseT.getCaseStatusCd()).caseStatusDt(caUniverseT.getCaseStatusDt())
                    .caIntelligentKeyT(caIntelligentKeyT).build();
			log.info(" Save caInvstFullscaleT Case ID " + caIntelligentKeyT.getCaseId());
		//		caInvstFsRepository.save(caInvstFullscaleT);	// DB Operation 4 Fs
            caIntelligentKeyT.setCaInvstFullscaleT(caInvstFullscaleT);
			
			CaInvstFsHistT caInvstFsHistT = CaInvstFsHistT.builder().id(CaInvstFsHistTPK.builder().caseId(caIntelligentKeyT.getCaseId()).build())
					.uiUserBaseChangeUsr(UiUserBase.builder().uiSystemId(caUniverseT.getUiUserBase().getUiSystemId()).build())
					.caLuFullscaleStatusT(CaLuFullscaleStatusT.builder().statusCd(caUniverseT.getCaseStatusCd()).build())
					.caseStatusDt(caUniverseT.getCaseStatusDt()).changeDt(today)
                    .caIntelligentKeyT(caIntelligentKeyT).build();
			log.info(" Save caInvstFsHistT Case ID " + caIntelligentKeyT.getCaseId());
			//		caInvstFsHistRepository.save(caInvstFsHistT);	// DB Operation 5 Fs Hist

            HashSet<CaInvstFsHistT> caInvstFsHistTs= new HashSet<CaInvstFsHistT>();
            caInvstFsHistTs.add(caInvstFsHistT);
            caIntelligentKeyT.setCaInvstFsHistTs(caInvstFsHistTs);
			
			CaInvstFsStatusHistT caInvstFsStatusHistT = CaInvstFsStatusHistT.builder().id(CaInvstFsStatusHistTPK.builder().caseId(caIntelligentKeyT.getCaseId()).build())
					.caLuFullscaleStatusT(CaLuFullscaleStatusT.builder().statusCd(caUniverseT.getCaseStatusCd()).build())
					.statusBeginDt(caUniverseT.getCaseStatusDt())
                    .caIntelligentKeyT(caIntelligentKeyT).build();
			log.info(" Save CaInvstFsStatusHistT Case ID " + caIntelligentKeyT.getCaseId());
		//	caInvstFsStatusHistRepository.save(caInvstFsStatusHistT);	// DB Operation 6 Fs Status Hist
            HashSet<CaInvstFsStatusHistT> caInvstFsStatusHistTs= new HashSet<>();
            caInvstFsStatusHistTs.add(caInvstFsStatusHistT);

            caIntelligentKeyT.setCaInvstFsStatusHistTs(caInvstFsStatusHistTs);
			
			if (caUniverseT.getIssueCd() != null) {
				CaInvstFsIssueT caInvstFsIssueT = CaInvstFsIssueT.builder().id(CaInvstFsIssueTPK.builder().caseId(caIntelligentKeyT.getCaseId()).issueCd(caUniverseT.getIssueCd()).build())
                        .caIntelligentKeyT(caIntelligentKeyT).build();
				log.info(" Save caInvstFsIssueT Case ID " + caIntelligentKeyT.getCaseId());
			//	caInvstFsIssueRepository.save(caInvstFsIssueT);	// DB Operation 18
                HashSet<CaInvstFsIssueT>  caInvstFsIssueTs=new HashSet<CaInvstFsIssueT>();
                caInvstFsIssueTs.add(caInvstFsIssueT);
                caIntelligentKeyT.setCaInvstFsIssueTs(caInvstFsIssueTs);
				
				CaInvstFsIssueHistT caInvstFsIssueHistT = CaInvstFsIssueHistT.builder().id(CaInvstFsIssueHistTPK.builder().caseId(caIntelligentKeyT.getCaseId()).issueCd(caUniverseT.getIssueCd()).build())
						.changeUsr(caUniverseT.getUiUserBase().getUiSystemId()).changeDt(today)
                        .caIntelligentKeyT(caIntelligentKeyT).build();
				log.info(" Save caInvstFsIssueHistT Case ID " + caIntelligentKeyT.getCaseId());
			//	caInvstFsIssueHistRepository.save(caInvstFsIssueHistT);	// DB Operation 7 Fs Issue
                HashSet<CaInvstFsIssueHistT> caInvstFsIssueHistTs= new HashSet<CaInvstFsIssueHistT>();
                caInvstFsIssueHistTs.add(caInvstFsIssueHistT);
                caIntelligentKeyT.setCaInvstFsIssueHistTs(caInvstFsIssueHistTs);
			}
		}
	}
	/**
	  * this method will create CA_INVST_PR_ASSIGN_T and CA_INVST_FS_ASSIGN_T entries
	  * 
	  * Parameters - Case ID, Invst Type, Case Status, Case Status Date
	  */	
//	private void createinvstPrFsAssignEntry(Integer caseId, String invstType, String assignUser,
//			String sectionCd, Date assignDate){
	public void createinvstPrFsAssignEntry(CaIntelligentKeyT caIntelligentKeyT, Integer sequenceId, CaUniverseT caUniverseT) {
		
		Date today = Calendar.getInstance().getTime();
		if (caUniverseT.getInvstTypeCd().equals(CaseEntryConstants.INVESTIGATION_TYPE_PRELIMINARY)) {
			CaInvstPrAssignT caInvstPrAssignT = CaInvstPrAssignT.builder().id(CaInvstPrAssignTPK.builder().caseId(caIntelligentKeyT.getCaseId()).build())
					.caLuPrelimSectionT(CaLuPrelimSectionT.builder().sectionCd(caUniverseT.getAssignSectionCd()).build())
					.assignDate(caUniverseT.getAssignDate())
					.uiUserBaseAssignUsr(UiUserBase.builder().uiSystemId(caUniverseT.getAssignUsr()).build())
                    .caIntelligentKeyT(caIntelligentKeyT).build();
			log.info(" Save caInvstPrAssignT Case ID " + caIntelligentKeyT.getCaseId());
				//	caInvstPrAssignRepository.save(caInvstPrAssignT);	// DB Operation 9 Pr Assign
            HashSet<CaInvstPrAssignT> caInvstPrAssignTs= new HashSet<CaInvstPrAssignT>();
            caInvstPrAssignTs.add(caInvstPrAssignT);
            caIntelligentKeyT.setCaInvstPrAssignTs(caInvstPrAssignTs);
			
			CaInvstPrAssignHistT caInvstPrAssignHistT = CaInvstPrAssignHistT.builder().id(CaInvstPrAssignHistTPK.builder().caseId(caIntelligentKeyT.getCaseId()).build())
					.uiUserBaseByAssignTo(UiUserBase.builder().uiSystemId(caUniverseT.getAssignUsr()).build())
					.caLuPrelimSectionT(CaLuPrelimSectionT.builder().sectionCd(caUniverseT.getAssignSectionCd()).build())
					.assignDt(caUniverseT.getAssignDate())
					.uiUserBaseByChangeUsr(UiUserBase.builder().uiSystemId(caUniverseT.getUiUserBase().getUiSystemId()).build())
					.changeDt(today).assignDt(caUniverseT.getAssignDate())
                    .caIntelligentKeyT(caIntelligentKeyT).build();
			log.info(" Save caInvstPrAssignHistT Case ID " + caIntelligentKeyT.getCaseId());
			//	caInvstPrAssignHistRepository.save(caInvstPrAssignHistT);	// DB Operation 10 Pr Assign Hist
            HashSet<CaInvstPrAssignHistT>  caInvstPrAssignHistTs= new   HashSet<CaInvstPrAssignHistT>();
            caInvstPrAssignHistTs.add(caInvstPrAssignHistT);
            caIntelligentKeyT.setCaInvstPrAssignHistTs(caInvstPrAssignHistTs);

		} else {
			CaInvstFsAssignT caInvstFsAssignT = CaInvstFsAssignT.builder().id(CaInvstFsAssignTPK.builder().caseId(caIntelligentKeyT.getCaseId()).build())
					.caLuFullscaleSectionT(CaLuFullscaleSectionT.builder().sectionCd(caUniverseT.getAssignSectionCd()).build())
					.assignDate(caUniverseT.getAssignDate())
					.uiUserBaseAssignUsr(UiUserBase.builder().uiSystemId(caUniverseT.getAssignUsr()).build())
                    .caIntelligentKeyT(caIntelligentKeyT).build();
			log.info(" Save caInvstFsAssignT Case ID " + caIntelligentKeyT.getCaseId());
				//	caInvstFsAssignRepository.save(caInvstFsAssignT);	// DB Operation 9 Fs Assign
            HashSet<CaInvstFsAssignT> caInvstFsAssignTs= new HashSet<CaInvstFsAssignT>();
            caInvstFsAssignTs.add(caInvstFsAssignT);
            caIntelligentKeyT.setCaInvstFsAssignTs(caInvstFsAssignTs);
			
			CaInvstFsAssignHistT caInvstFsAssignHistT = CaInvstFsAssignHistT.builder().id(CaInvstFsAssignHistTPK.builder().caseId(caIntelligentKeyT.getCaseId()).build())
					.uiUserBaseByAssignTo(UiUserBase.builder().uiSystemId(caUniverseT.getAssignUsr()).build())
					.caLuFullscaleSectionT(CaLuFullscaleSectionT.builder().sectionCd(caUniverseT.getAssignSectionCd()).build())
					.uiUserBaseChangeUsr(UiUserBase.builder().uiSystemId(caUniverseT.getUiUserBase().getUiSystemId()).build())
					.changeDt(today).assignDt(caUniverseT.getAssignDate())
                    .caIntelligentKeyT(caIntelligentKeyT).build();
			log.info(" Save caInvstFsAssignHistT Case ID " + caIntelligentKeyT.getCaseId());
				//	caInvstFsAssignHistRepository.save(caInvstFsAssignHistT);	// DB Operation 10 Fs Assign Hist
            HashSet<CaInvstFsAssignHistT> caInvstFsAssignHistTs= new HashSet<CaInvstFsAssignHistT>();
            caInvstFsAssignHistTs.add(caInvstFsAssignHistT);
            caIntelligentKeyT.setCaInvstFsAssignHistTs(caInvstFsAssignHistTs);
		}	

	}

    @Transactional
    public CaseProviderDTO findCaseProvider(String caseType, String value) {
        CaseProviderDTO provider= new CaseProviderDTO();
        provider.setParticipantId(value);
        Object[] sqlAndFields = findSqlAndPopulateFields(caseType);
        String sql = sqlAndFields[0].toString();
        Collection<CaseMetabaseField> fieldKeyValue = (Collection<CaseMetabaseField>) sqlAndFields[1];
        Map<String, Object> map = jdbcTemplate.queryForMap(sql,new Object[]{value});

        if (map != null) {
            map.forEach((k, v) ->{
                CaseMetabaseField caseMetabaseField = caseBatchUtil.findCaseMetabaseField(fieldKeyValue,k);
                Field field = ReflectionUtils.findField(CaseProviderDTO.class,caseMetabaseField.getFieldName());
                ReflectionUtils.makeAccessible(field);
                if(caseMetabaseField.getFieldType().equalsIgnoreCase("DATE")){

                    ReflectionUtils.setField(field, provider,caseBatchUtil.convertToLocalDate(v) );
                }else {
                    ReflectionUtils.setField(field, provider, v);
                }
            });
        }
        return provider;
    }

    @Transactional
    public CaseRecipientDTO findCaseRecipient(String caseType, String value)
    {
     CaseRecipientDTO recipient= new CaseRecipientDTO();
        Object[] sqlAndFields = findSqlAndPopulateFields(caseType);
        String sql = sqlAndFields[0].toString();
        Collection<CaseMetabaseField> fieldKeyValue = (Collection<CaseMetabaseField>) sqlAndFields[1];
        Map<String, Object> map = jdbcTemplate.queryForMap(sql,new Object[]{value});

        if (map != null) {
            map.forEach((k, v) ->{
                Field field = ReflectionUtils.findField(CaseRecipientDTO.class,caseBatchUtil.findFieldName(fieldKeyValue,k));
                ReflectionUtils.makeAccessible(field);
                ReflectionUtils.setField(field, recipient, v);
            });
        }
        return recipient;
    }
    @Transactional
    public Object[] findSqlAndPopulateFields(String caseType){
        Object[] obj=new Object[2];
        Collection<CaMetaBaseT> list = caMetaBaseRepository.findAllByCaseType(caseType);
        List<CaseMetabaseField> fieldsAndColumns = new ArrayList<CaseMetabaseField>();
        String TableName = "";
        String Select = "";
        String Where = " WHERE ";
        Iterator<CaMetaBaseT> itr=list.iterator();
        while (itr.hasNext()) {
            CaMetaBaseT caMetaBase=(CaMetaBaseT)itr.next();
            String sqlType = caMetaBase.getSqlClauseType();
            TableName = caMetaBase.getTableName();
            String columnName =caMetaBase.getColumnName();
            String htmlType =caMetaBase.getHtmlFieldType();
            if ((sqlType !=null) &&("SELECT".equalsIgnoreCase(sqlType))) {
                if ("".equalsIgnoreCase(Select)) {
                    Select = Select + columnName;
                } else {
                    Select = Select + "," + columnName;
                }
                CaseMetabaseField opfData = null;
                if (caseType.equalsIgnoreCase(CaseEntryConstants.PROVIDER) ){
                    opfData = new CaseMetabaseField(caMetaBase.getId().getFieldId(), columnName,
                            CaseMetabaseProvider.valueOf(caMetaBase.getId().getFieldId()).getName(), null,caMetaBase.getHtmlFieldType());
                } else if (caseType.equalsIgnoreCase(CaseEntryConstants.MEMBER) ){
                    opfData = new CaseMetabaseField(caMetaBase.getId().getFieldId(), columnName,
                            CaseMetabaseRecipient.valueOf(caMetaBase.getId().getFieldId()).getName(),null,caMetaBase.getHtmlFieldType());
                }
                fieldsAndColumns.add(opfData);
            }
            if ((sqlType !=null) &&("CONDITION".equalsIgnoreCase(sqlType))) {
                Where = Where + columnName + "= ? ";
            }
        }
        String sql = "SELECT " + Select + " FROM " + TableName + Where;

        obj[0]=sql;
        obj[1]=fieldsAndColumns;
        return obj;
    }
    public Integer getSequenceIdFromCaIntelligentKey(CaUniverseT caUniverseT) {

        Integer sequenceId = caIntelligentKeyRepository.getNextSequenceId(caUniverseT.getCaPrmNodeCd(),
                caUniverseT.getCaYearId().shortValue() );

        if (sequenceId == null) {
            sequenceId = 1;
        }
        log.info(" sequenceId = " + sequenceId);
        return sequenceId;
    }
}
package com.optum.fads.caseentrybatch.api.service.impl;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import org.apache.commons.lang3.tuple.Pair;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.microsoft.sqlserver.jdbc.SQLServerException;
import com.optum.fads.caseentrybatch.api.common.CaseEntryConstants;
import com.optum.fads.caseentrybatch.api.domain.CaUniverseBatchT;
import com.optum.fads.caseentrybatch.api.domain.CaUniverseT;
import com.optum.fads.caseentrybatch.api.domain.CaUniverseTPK;
import com.optum.fads.caseentrybatch.api.domain.UiUserBase;
import com.optum.fads.caseentrybatch.api.dto.EmailData;
import com.optum.fads.caseentrybatch.api.dto.EmailSpecification;
import com.optum.fads.caseentrybatch.api.repo.CaUniverseBatchRepository;
import com.optum.fads.caseentrybatch.api.service.ICaseBatchIndividualService;
import com.optum.fads.caseentrybatch.api.service.ICaseBatchService;
import com.optum.fads.caseentrybatch.api.snowflakeDomain.DmClaimDrugT;
import com.optum.fads.caseentrybatch.api.snowflakeRepo.DmClaimDrugRepository;
import com.optum.fads.caseentrybatch.api.util.CaseBatchUtil;

import lombok.extern.slf4j.Slf4j;

/**
 * @author anil wagh
 * CaseBatchService
 */

@Service
@Slf4j
public class CaseBatchService  implements ICaseBatchService {

    @Autowired
    private CaUniverseBatchRepository caUniverseBatchRepository;

    @Autowired
    private	CaseBatchEmailService caseBatchEmailService;

    @Autowired
    private	ICaseBatchIndividualService iCaseBatchIndividualService;

    @Autowired
    private CaseBatchUtil caseBatchUtil;
    
    @Autowired
	private DmClaimDrugRepository dmClaimDrugRepository;


    /**
     * this method will create cases and entries in CA_UNIVERSE_T table
     *
     * Input - CA_UNIVERSE_BATCH_T table entries
     */
    public String createBatchCase(){

        log.info(" Run Case Batch " );

        // Get a list of Batch IDs from CaUniverseBatchT
        List<CaUniverseBatchT> caUniverseBatchTList = null;
        List<Integer> caUniverseBatchTIdList = caUniverseBatchRepository.findDistinctBatchIds();

        // Get a list of CaUniverseBatchT records for each batch sorted by participant ID
        for (Integer caUniverseBatchTId : caUniverseBatchTIdList) {
            log.info("Next Batch Id = " + caUniverseBatchTId);
            caUniverseBatchTList = caUniverseBatchRepository.findAllByBatchId(caUniverseBatchTId);
            createBatchCaseEntries(caUniverseBatchTList);

        }

        return CaseEntryConstants.SUCCESS_MESSAGE;
    }	// Create Batch Case End

    /**
     * this method will create Batch Case Entries in various Case Tracking tables for a batch
     *
     * Parameters - List<CaUniverseBatchT> caUniverseBatchTList
     */
    private synchronized void createBatchCaseEntries(List<CaUniverseBatchT> caUniverseBatchTList) {

        boolean batchFailed = false;
        List<CaUniverseT> caUniverseTList;
        Integer caseUniverseBatchIdin = caUniverseBatchTList.get(0).getId().getCtBatchId();
        String userId = caUniverseBatchTList.get(0).getUiUserBase().getUiSystemId();
        try {
        	caUniverseTList = createCaUniverseTList(caUniverseBatchTList);
        	if (caUniverseTList.size() == caUniverseBatchTList.size()) {	
        		iCaseBatchIndividualService.createIndBatchCaseEntries(caUniverseTList);
        	} else {
        		caUniverseBatchRepository.saveAll(caUniverseBatchTList);	// DB Operation 1
                caUniverseBatchRepository.flush();					// DB Operation
        		sendInvalidClaimsMail(caUniverseBatchTList);
        		batchFailed = true;	
        	}
        	caUniverseTList.clear();
        } catch (Exception e) {
            batchFailed = true;
            log.error(" Case Batch Processing failed for Batch ID " + caseUniverseBatchIdin);
            log.info(e.getMessage());
            log.error("Exception Trace: ", e);
            EmailData emailData = new EmailData();
            emailData.setNoticeId(CaseEntryConstants.BATCH_FAIL_NOTIFICATION_USER);
            emailData.setBatchId(caseUniverseBatchIdin);
            emailData.setSubmittedBy(userId);
            StringBuilder exceptionMessage = new StringBuilder();
            if (e.getMessage() != null) {
                if (e.getMessage().length() > CaseEntryConstants.ERROR_LOG_LENGTH) {
                    exceptionMessage.append(e.getMessage().substring(0, CaseEntryConstants.ERROR_LOG_LENGTH));
                } else {
                    exceptionMessage.append(e.getMessage().substring(0, e.getMessage().length()));
                }
            } else {
                exceptionMessage.append("Exception message is null.");
            }
            if (e.getCause() != null) {
                if (e.getCause().getCause() instanceof SQLServerException) {
                    exceptionMessage.append(CaseEntryConstants.TEXT_SEPERATOR);
                    SQLServerException sqlServerException = (SQLServerException) e.getCause().getCause();
                    log.info(sqlServerException.getMessage());
                    if (sqlServerException.getMessage() != null) {
                        if (sqlServerException.getMessage().length() > CaseEntryConstants.ERROR_LOG_LENGTH) {
                            exceptionMessage.append(sqlServerException.getMessage().substring(0, CaseEntryConstants.ERROR_LOG_LENGTH));
                        } else {
                            exceptionMessage.append(sqlServerException.getMessage().substring(0, sqlServerException.getMessage().length()));
                        }
                    } else {
                        exceptionMessage.append("SqlServerException message is null.");
                    }
                }
            }
            EmailSpecification emailSpecs = caseBatchUtil.getEmailSpecs();
            emailData.setErrorLog(exceptionMessage.toString());
            caseBatchEmailService.postBatchProcessMail(emailData, emailSpecs);	// Upon fail/exception send email to User
            emailData.setNoticeId(CaseEntryConstants.BATCH_FAIL_NOTIFICATION_ADMIN);
            caseBatchEmailService.postBatchProcessMail(emailData, emailSpecs);	// Upon fail/exception send email to admin
        } // try
        if (!batchFailed) {
            log.info(" Delete caUniverseBatchT entries in Batch ID " + caseUniverseBatchIdin);
            caUniverseBatchRepository.deleteByBatchId(caseUniverseBatchIdin); // DB Operation 2
        }

    }
    
    /**
     * this method will create CaUniverseT List
     *
     * Parameters - caUniverseBatchTList
     */
    
    private void  sendInvalidClaimsMail(List<CaUniverseBatchT> caUniverseBatchTList) {
    	
    	HashSet<String> uniqueTcns = new HashSet<>();
    	
			log.error("Found invalid/Duplicate TCNs in Batch ID " + caUniverseBatchTList.get(0).getId().getCtBatchId());
            EmailData emailData = new EmailData();
            emailData.setNoticeId(CaseEntryConstants.BATCH_INVALID_NOTIFICATION_USER);
            emailData.setBatchId(caUniverseBatchTList.get(0).getId().getCtBatchId());
            emailData.setSubmittedBy(caUniverseBatchTList.get(0).getUiUserBase().getUiSystemId());
            EmailSpecification emailSpecs = caseBatchUtil.getEmailSpecs();
            StringBuilder invalidTcnsText = new StringBuilder();
            for (CaUniverseBatchT caUniverseBatchT : caUniverseBatchTList) {
            	if (caUniverseBatchT.getRecMatchInd().equals(CaseEntryConstants.NO) || caUniverseBatchT.getRecMatchInd().equals(CaseEntryConstants.DUPLICATE)) {
            		if (uniqueTcns.add(caUniverseBatchT.getHdrClmTcn())) {
            			invalidTcnsText.append(caUniverseBatchT.getHdrClmTcn()+CaseEntryConstants.TEXT_SEPERATOR);
            		}
            	}
    		}
            invalidTcnsText.setLength(invalidTcnsText.length() - 2);
            emailData.setErrorLog(invalidTcnsText.toString());
            caseBatchEmailService.postBatchProcessMail(emailData, emailSpecs);	

    }
    /**
	  * this method will create CaUniversT list and append to CaUniverseT the data from DM_CLAIM_DRUG_T
	  * it also validates the input claims data against DM_CLAIM_DRUG_T and checks for duplicate TCN+LiNum records
	  * Parameters - caUniverseBatchTList
	  */
	public List<CaUniverseT> createCaUniverseTList(List<CaUniverseBatchT> caUniverseBatchTList) {
		
		log.info("Start Create CaUniverseT list in Batch ID " + caUniverseBatchTList.get(0).getId().getCtBatchId());
		boolean validBatch = true;
		List<CaUniverseT> caUniverseTList = new ArrayList<>();
		LocalDateTime currentSqlDate = LocalDateTime.now(caseBatchUtil.getZoneId());
		DmClaimDrugT dmClaimDrugT = null;
		
		// Get a map of TCN + Line Number and their occurrences
		Map<Pair<String, String>, Long> tcnLiNumsMapPairs = caUniverseBatchTList.stream()
		        .collect(Collectors.groupingBy(e -> Pair.of(e.getHdrClmTcn(), e.getLiNum()), Collectors.counting()));

		// case ID, caSequenceId, clmSeqNum set in CaseBatchIndividual Service
		
		for (CaUniverseBatchT caUniverseBatchT : caUniverseBatchTList) {
			
//			Date dtHdrClaimPaidDate = caUniverseBatchT.getId().getHdrClmPdDt();
			Date dtHdrClaimPaidDate = caUniverseBatchT.getHdrClmPdDt();
			LocalDate localHdrClaimPdDate = dtHdrClaimPaidDate.toInstant().atZone(ZoneId.systemDefault()).toLocalDate();
			caUniverseBatchT.setRecMatchInd(CaseEntryConstants.YES);
			
			// Check if duplicate
			Pair<String, String> pair = Pair.of(caUniverseBatchT.getHdrClmTcn(), caUniverseBatchT.getLiNum());
			if (tcnLiNumsMapPairs.containsKey(pair) && tcnLiNumsMapPairs.get(pair) > 1) {
					caUniverseBatchT.setRecMatchInd(CaseEntryConstants.DUPLICATE);
					validBatch = false;
			} else {
				dmClaimDrugT = dmClaimDrugRepository.findClaimDrugTbyId(caUniverseBatchT.getHdrClmTcn(), caUniverseBatchT.getLiNum(), localHdrClaimPdDate);
					
				if (dmClaimDrugT == null) {
					caUniverseBatchT.setRecMatchInd(CaseEntryConstants.NO);
					validBatch = false;
				} else {			// Provider ID or Recipient ID must match participant ID
					String origId =  CaseEntryConstants.BLANK_STR;
					if (CaseEntryConstants.MEMBER.equals(caUniverseBatchT.getCaseTypeCd())) {
							origId = dmClaimDrugT.getHdrRecipOrigId();
					} else {
						switch (caUniverseBatchT.getProvRole()) {
					    /*    case CaseEntryConstants.PROVIDER_ROLE_ATTENDING:
					        	origId = dmClaimDrugT.getHdrAttendProvId();
					                 break; */
					        case CaseEntryConstants.PROVIDER_ROLE_BILLING:
					        	origId = dmClaimDrugT.getHdrPayToProvId();
					               break;
					    /*    case CaseEntryConstants.PROVIDER_ROLE_REFERRING:
					        	origId = dmClaimDrugT.getHdrReferProvId();
					                 break;
					        case CaseEntryConstants.PROVIDER_ROLE_TREATING:
					        	 origId = dmClaimDrugT.getLiTreatProvId();
					                  break; */
					        case CaseEntryConstants.PROVIDER_ROLE_PRESCRIBING:
					        	origId = dmClaimDrugT.getHdrPrescrProvId();
					              break;
					        default: 
					        	origId = dmClaimDrugT.getHdrPayToProvId();
				                  break;
						}	
					}
					if (!origId.equals(caUniverseBatchT.getParticipantId()) || dmClaimDrugT.getHdrRecipFullNm() == null) {
						caUniverseBatchT.setRecMatchInd(CaseEntryConstants.NO);
						validBatch = false;
					}
				}
			}
			if (validBatch) {
				CaUniverseT	caUniverseT = CaUniverseT.builder().id(CaUniverseTPK.builder().ctBatchId(caUniverseBatchT.getId().getCtBatchId()).ctBatchDate(currentSqlDate)
//		                      .hdrClmTcn(caUniverseBatchT.getId().getHdrClmTcn()).liNum(caUniverseBatchT.getId().getLiNum()).hdrClmPdDt(caUniverseBatchT.getId().getHdrClmPdDt()).build())
		        		.hdrClmTcn(caUniverseBatchT.getHdrClmTcn()).liNum(caUniverseBatchT.getLiNum()).hdrClmPdDt(caUniverseBatchT.getHdrClmPdDt()).build())
		                .uiUserBase(UiUserBase.builder().uiSystemId(caUniverseBatchT.getUiUserBase().getUiSystemId()).build())
		                .caseTypeCd(caUniverseBatchT.getCaseTypeCd()).provRole(caUniverseBatchT.getProvRole()).caPrmNodeCd(caUniverseBatchT.getCaPrmNodeCd())
		                .caYearId(caUniverseBatchT.getCaYearId()).projectStatus(caUniverseBatchT.getProjectStatus()).invstTypeCd(caUniverseBatchT.getInvstTypeCd())
		                .caseSourceCd(caUniverseBatchT.getCaseSourceCd()).caseStatusCd(caUniverseBatchT.getCaseStatusCd()).caseStatusDt(caUniverseBatchT.getCaseStatusDt())
		                .issueCd(caUniverseBatchT.getIssueCd()).assignUsr(caUniverseBatchT.getAssignUsr()).assignSectionCd(caUniverseBatchT.getAssignSectionCd())
		                .assignDate(caUniverseBatchT.getAssignDate()).participantId(caUniverseBatchT.getParticipantId()).liDrugValidClmInd(caUniverseBatchT.getLiDrugValidClmInd()).build();
		        
			    caUniverseT.setHdrClmAdjStsCd(dmClaimDrugT.getHdrClmAdjStsCd());
				caUniverseT.setClaimjStatusDesc(dmClaimDrugT.getClaimjStatusDesc());
				caUniverseT.setHdrPayToProvId(dmClaimDrugT.getHdrPayToProvId());
				caUniverseT.setHdrPayToProvNm(dmClaimDrugT.getHdrPayToProvNm());
				caUniverseT.setHdrPrescrProvId(dmClaimDrugT.getHdrPrescrProvId());
				caUniverseT.setHdrPrescrProvNpi(dmClaimDrugT.getHdrPrescrProvNpi());
				caUniverseT.setHdrCosCd(dmClaimDrugT.getHdrCosCd());
				caUniverseT.setCosDesc(dmClaimDrugT.getCosDesc());
				caUniverseT.setHdrRecipOrigId(dmClaimDrugT.getHdrRecipOrigId());
				caUniverseT.setHdrRecipFullNm(dmClaimDrugT.getHdrRecipFullNm());
				caUniverseT.setHdrClmTcnOld(dmClaimDrugT.getHdrClmTcnOld());
				caUniverseT.setLiSrvFromDt(dmClaimDrugT.getLiSrvFromDt());
				caUniverseT.setLiDrugPrescrNum(dmClaimDrugT.getLiDrugPrescrNum());
				caUniverseT.setLiDrugRefillNum(dmClaimDrugT.getLiDrugRefillNum());
				caUniverseT.setLiDrugPrescrDt(dmClaimDrugT.getLiDrugPrescrDt());
				caUniverseT.setLiDrugNdc(dmClaimDrugT.getLiDrugNdc());
				caUniverseT.setNdcDesc(dmClaimDrugT.getNdcDesc());
				caUniverseT.setLiDrugSpecTheraClsCd(dmClaimDrugT.getLiDrugSpecTheraClsCd());
				caUniverseT.setTheraClassSpecDesc(dmClaimDrugT.getTheraClassSpecDesc());
				caUniverseT.setLiDrugDaysSupply(dmClaimDrugT.getLiDrugDaysSupply());
				caUniverseT.setLiBillUosQty(dmClaimDrugT.getLiBillUosQty());
				caUniverseT.setLiPdUosQty(dmClaimDrugT.getLiPdUosQty());
				caUniverseT.setHdrBillAmt(dmClaimDrugT.getHdrBillAmt());
				caUniverseT.setLiBillAmt(dmClaimDrugT.getLiBillAmt());
				caUniverseT.setLiPdAmt(dmClaimDrugT.getLiPdAmt());
				if (caUniverseT.getId().getLiNum().equals(CaseEntryConstants.ONE_STR)) {
					caUniverseT.setHdrPdAmt(dmClaimDrugT.getHdrPdAmt());
				} else {
					caUniverseT.setHdrPdAmt(BigDecimal.valueOf(CaseEntryConstants.ZERO));
				}
				caUniverseT.setHdrCleanClmInd(dmClaimDrugT.getHdrCleanClmInd());
				caUniverseT.setLiCleanClmInd(dmClaimDrugT.getLiCleanClmInd());
				caUniverseT.setHdrClmTypeCd(dmClaimDrugT.getHdrClmTypeCd());
				caUniverseT.setHdrClmTypeDesc(dmClaimDrugT.getHdrClmTypeDesc());
				caUniverseT.setHdrPayToProvNpiId(dmClaimDrugT.getHdrPayToProvNpiId());
				caUniverseT.setGcnDesc(dmClaimDrugT.getGcnDesc());
				caUniverseT.setHdrRecipCurrId(dmClaimDrugT.getHdrRecipCurrId());
				caUniverseT.setHdrEncounterCd(dmClaimDrugT.getHdrEncounterCd());
				caUniverseT.setLiMcoShadowPrice(dmClaimDrugT.getLiMcoShadowPrice());
				caUniverseT.setHdrMcoTcn(dmClaimDrugT.getHdrMcoTcn());
				caUniverseT.setHdrMcoTcn(dmClaimDrugT.getHdrMcoId());
				caUniverseT.setHdrMcoNm(dmClaimDrugT.getHdrMcoNm());
				caUniverseT.setHdrMcoPdDt(dmClaimDrugT.getHdrMcoPdDt());
				caUniverseT.setHdrMcoShadowPrice(dmClaimDrugT.getHdrMcoShadowPrice());
				caUniverseT.setHdrPayToProvTyCd(dmClaimDrugT.getHdrPayToProvTyCd());
				caUniverseT.setHdrPayToProvTyDesc(dmClaimDrugT.getHdrPayToProvTyDesc());
				caUniverseT.setHdrPayToProvSpecCd(dmClaimDrugT.getHdrPayToProvSpecCd());
				caUniverseT.setHdrPayToProvSpecDesc(dmClaimDrugT.getHdrPayToProvSpecDesc());
				caUniverseT.setProvFein(dmClaimDrugT.getProvFein());
				caUniverseT.setProvPracAddrLine1(dmClaimDrugT.getProvPracAddrLine1());
				caUniverseT.setProvPracAddrLine2(dmClaimDrugT.getProvPracAddrLine2());
				caUniverseT.setHdrPrescrProvNm(dmClaimDrugT.getHdrPrescrProvNm());
				caUniverseT.setHdrPrescrProvTyCd(dmClaimDrugT.getHdrPrescrProvTyCd());
				caUniverseT.setHdrPrescrProvTyDesc(dmClaimDrugT.getHdrPrescrProvTyDesc());
				caUniverseT.setHdrPrescrProvSpecCd(dmClaimDrugT.getHdrPrescrProvSpecCd());
				caUniverseT.setHdrPrescrProvSpecDesc(dmClaimDrugT.getHdrPrescrProvSpecDesc());
				caUniverseT.setHdrRecipAgeMthsQty(dmClaimDrugT.getHdrRecipAgeMthsQty());
				caUniverseT.setHdrRecipAgeYrsQty(dmClaimDrugT.getHdrRecipAgeYrsQty());
				caUniverseT.setRecipBirthDt(dmClaimDrugT.getRecipBirthDt());
				caUniverseT.setRecipDeathDt(dmClaimDrugT.getRecipDeathDt());
				caUniverseT.setRecipCntyCd(dmClaimDrugT.getRecipCntyCd());
				caUniverseT.setRecipCntyDesc(dmClaimDrugT.getRecipCntyDesc());
				caUniverseT.setRecipCityNm(dmClaimDrugT.getRecipCityNm());
				caUniverseT.setRecipStateCd(dmClaimDrugT.getRecipStateCd());
				caUniverseT.setRecipZipCd(dmClaimDrugT.getRecipZipCd());
				caUniverseT.setRecipGenderCd(dmClaimDrugT.getRecipGenderCd());
				caUniverseT.setRecipGenderDesc(dmClaimDrugT.getRecipGenderDesc());
				caUniverseT.setRecipAddrLine1(dmClaimDrugT.getRecipAddrLine1());
				caUniverseT.setRecipAddrLine2(dmClaimDrugT.getRecipAddrLine2());
				caUniverseT.setHdrRecipMcareId(dmClaimDrugT.getHdrRecipMcareId());
				caUniverseT.setRecipTefraInd(dmClaimDrugT.getRecipTefraInd());
				caUniverseT.setRecipBnftPlanCd(dmClaimDrugT.getRecipBnftPlanCd());
				caUniverseT.setRecipBnftPlanDesc(dmClaimDrugT.getRecipBnftPlanDesc());
				caUniverseT.setHdrDrugNhInd(dmClaimDrugT.getHdrDrugNhInd());
				caUniverseT.setHdrSrvFromDt(dmClaimDrugT.getHdrSrvFromDt());
				caUniverseT.setHdrCopayAmt(dmClaimDrugT.getHdrCopayAmt());
				caUniverseT.setHdrTplAmt(dmClaimDrugT.getHdrTplAmt());
				caUniverseT.setHdrDrugDispensingFee(dmClaimDrugT.getHdrDrugDispensingFee());
				caUniverseT.setLiTplAmt(dmClaimDrugT.getLiTplAmt());
				caUniverseT.setLiDrugCompoundInd(dmClaimDrugT.getLiDrugCompoundInd());
				caUniverseT.setLiDrugGcn(dmClaimDrugT.getLiDrugGcn());
				caUniverseT.setLiDrugDosageFormDesc(dmClaimDrugT.getLiDrugDosageFormDesc());
				caUniverseT.setRPackageSize(dmClaimDrugT.getRPackageSize());
				caUniverseT.setRStrengthDesc(dmClaimDrugT.getRStrengthDesc());
				caUniverseT.setRClassCd(dmClaimDrugT.getRClassCd());
				caUniverseT.setRDrugCat(dmClaimDrugT.getRDrugCat());
				caUniverseT.setRDrugDea(dmClaimDrugT.getRDrugDea());
				caUniverseT.setRRouteDesc(dmClaimDrugT.getRRouteDesc());
				caUniverseT.setLiHeaderPayInd(dmClaimDrugT.getLiHeaderPayInd());
				caUniverseT.setLiClmAdjStsCd(dmClaimDrugT.getLiClmAdjStsCd());
				caUniverseT.setLiCoeCd(dmClaimDrugT.getLiCoeCd());
				caUniverseT.setLiCopayAmt1(dmClaimDrugT.getLiCopayAmt1());
				caUniverseT.setHdrFundCd(dmClaimDrugT.getHdrFundCd());
				caUniverseT.setFundDesc(dmClaimDrugT.getFundDesc());
	//			caUniverseT.setFinFundCd(dmClaimDrugT.getFinFundCd()); - not needed
				caUniverseT.setCompDrugIngredCount(dmClaimDrugT.getCompDrugIngredCount());
				caUniverseT.setCompDrugProductIdQlfr(dmClaimDrugT.getCompDrugProductIdQlfr());
				caUniverseT.setCompDrugIngredQty(dmClaimDrugT.getCompDrugIngredQty());
				caUniverseT.setCompDrugIngredCost(dmClaimDrugT.getCompDrugIngredCost());
				caUniverseTList.add(caUniverseT);
			}
	       }
		log.info("End Create CaUniverseT list in Batch ID " + caUniverseBatchTList.get(0).getId().getCtBatchId());
		return caUniverseTList;
	}
    
}
package com.optum.fads.caseentrybatch.api.service;

import com.optum.fads.caseentrybatch.api.dto.EmailData;
import com.optum.fads.caseentrybatch.api.dto.EmailSpecification;

public interface ICaseBatchEmailService {

	public void postBatchProcessMail(EmailData emailData, EmailSpecification emailSpecs);
	
	public boolean sendMail(String sendToUser, String emailSubject,  String emailText);
	
}
package com.optum.fads.caseentrybatch.api.service;

import java.time.LocalDateTime;
import java.util.Collection;
import java.util.List;

import com.optum.fads.caseentrybatch.api.domain.CaUniverseBatchT;
import com.optum.fads.caseentrybatch.api.domain.CaUniverseT;

/**
 * @author anil wagh 
 * ICaseBatchService
 */
public interface ICaseBatchService {
    public String createBatchCase();

}
package com.optum.fads.caseentrybatch.api.service;

import java.util.List;

import com.optum.fads.caseentrybatch.api.domain.CaUniverseT;

/**
 * @author anil wagh 
 * ICaseIndividualBatchService
 */
public interface ICaseBatchIndividualService {

    public void createIndBatchCaseEntries(List<CaUniverseT> caUniverseTList);



}

package com.optum.fads.caseentrybatch.api.service;

import java.util.List;

import com.optum.fads.caseentrybatch.api.domain.CaUniverseT;

/**
 * @author anil wagh 
 * ICaseIndividualBatchService
 */
public interface ICaseBatchIndividualService {

    public void createIndBatchCaseEntries(List<CaUniverseT> caUniverseTList);



}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaClaimCorrectionsHistT;
import com.optum.fads.caseentrybatch.api.domain.CaClaimCorrectionsHistTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaClaimCorrectionsHistRepository extends JpaRepository<CaClaimCorrectionsHistT, CaClaimCorrectionsHistTPK>, JpaSpecificationExecutor<CaClaimCorrectionsHistT>{

}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaClaimCorrectionsT;
import com.optum.fads.caseentrybatch.api.domain.CaClaimCorrectionsTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaClaimCorrectionsRepository extends JpaRepository<CaClaimCorrectionsT, CaClaimCorrectionsTPK>, JpaSpecificationExecutor<CaClaimCorrectionsT>{

}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaClaimListT;
import com.optum.fads.caseentrybatch.api.domain.CaClaimListTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaClaimListRepository extends JpaRepository<CaClaimListT, CaClaimListTPK>, JpaSpecificationExecutor<CaClaimListT>{

}
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaEmailsBatchT;
import com.optum.fads.caseentrybatch.api.domain.CaEmailsBatchTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaEmailsBatchRepository extends JpaRepository<CaEmailsBatchT, CaEmailsBatchTPK> {
	
	@Query(value = "SELECT  Max(SEQ_NUM+1) FROM CA_EMAILS_BATCH_T where CT_BATCH_ID=:ctBatchId ", nativeQuery = true)
	Integer getNextSequenceId(@Param("ctBatchId") Integer ctBatchId);
	
}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaGeneralT;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaGeneralRepository extends JpaRepository<CaGeneralT, Integer> {

}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaIntelligentKeyT;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaIntelligentKeyRepository extends JpaRepository<CaIntelligentKeyT, Integer>, JpaSpecificationExecutor<CaIntelligentKeyT> {
	@Query(value = "SELECT  Max(CASE_ID+1) FROM CA_INTELLIGENT_KEY_T", nativeQuery = true)
	Integer getNextCaseId();
	
	@Query(value = "SELECT  Max(CA_SEQUENCE_ID+1) FROM CA_INTELLIGENT_KEY_T where CA_PRM_NODE_CD=:nodeCd and CA_YEAR_ID = :caYearId ", nativeQuery = true)
	Integer getNextSequenceId(@Param("nodeCd") String nodeCd, @Param("caYearId") Short caYearId);
}
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaInvstFsAssignHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsAssignHistTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaInvstFsAssignHistRepository extends JpaRepository<CaInvstFsAssignHistT, CaInvstFsAssignHistTPK> {
	
}
package com.optum.fads.caseentrybatch.api.repo;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaInvstFsAssignT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsAssignTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaInvstFsAssignRepository extends JpaRepository<CaInvstFsAssignT, CaInvstFsAssignTPK> {
	
	List<CaInvstFsAssignT> findByIdCaseId(Integer caseId);
	
}
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaInvstFsHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsHistTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaInvstFsHistRepository extends JpaRepository<CaInvstFsHistT, CaInvstFsHistTPK> {
	
}
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaInvstFsIssueHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsIssueHistTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaInvstFsIssueHistRepository extends JpaRepository<CaInvstFsIssueHistT, CaInvstFsIssueHistTPK> {
	
}
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaInvstFsIssueT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsIssueTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaInvstFsIssueRepository extends JpaRepository<CaInvstFsIssueT, CaInvstFsIssueTPK> {
	
}
package com.optum.fads.caseentrybatch.api.repo;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaInvstFullscaleT;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaInvstFsRepository extends JpaRepository<CaInvstFullscaleT, Integer> {
	
	@Query(value = "SELECT cf.CASE_ID, ci.CA_PRM_NODE_CD, ci.CA_YEAR_ID, ci.CA_SEQUENCE_ID, cf.CASE_STATUS_CD, cf.CASE_STATUS_DT,"
			+ " clf.STATUS_DESC"
			+ " FROM CA_INVST_FULLSCALE_T cf JOIN CA_INTELLIGENT_KEY_T ci on cf.CASE_ID = ci.CASE_ID"
			+ " JOIN CA_LU_FULLSCALE_STATUS_T clf on cf.CASE_STATUS_CD = clf.STATUS_CD"
			+  " WHERE clf.STATUS_VIEW = '1' and (clf.STATUS_CLS_IND != 1 or  clf.STATUS_CLS_IND is null)"
			+ " ORDER BY cf.CASE_ID", nativeQuery = true)
	List<Object[]> findAllFullscale();
	
}
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaInvstFsStatusHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstFsStatusHistTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaInvstFsStatusHistRepository extends JpaRepository<CaInvstFsStatusHistT, CaInvstFsStatusHistTPK> {
	
}
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaInvstPrAssignHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrAssignHistTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaInvstPrAssignHistRepository extends JpaRepository<CaInvstPrAssignHistT, CaInvstPrAssignHistTPK> {
	
}
package com.optum.fads.caseentrybatch.api.repo;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaInvstPrAssignT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrAssignTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaInvstPrAssignRepository extends JpaRepository<CaInvstPrAssignT, CaInvstPrAssignTPK> {
	
	List<CaInvstPrAssignT> findByIdCaseId(Integer caseId);
	
}
package com.optum.fads.caseentrybatch.api.repo;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaInvstPreliminaryT;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaInvstPrelimRepository extends JpaRepository<CaInvstPreliminaryT, Integer> {
	/*
	@Query(value = "SELECT cp.CASE_ID, ci.CA_PRM_NODE_CD, ci.CA_YEAR_ID, ci.CA_SEQUENCE_ID, cp.CASE_STATUS_CD, cp.CASE_STATUS_DT,"
			+ " clp.STATUS_DESC"
			+ " FROM CA_INVST_PRELIMINARY_T cp JOIN CA_INTELLIGENT_KEY_T ci on cp.CASE_ID = ci.CASE_ID"
			+ " JOIN CA_LU_PRELIM_STATUS_T clp on cp.CASE_STATUS_CD = clp.STATUS_CD"
			+  " WHERE ci.CA_YEAR_ID >=  :caYearId and clp.STATUS_DESC != :statusCdIgnore and clp.STATUS_VIEW = '1'"
			+ " ORDER BY cp.CASE_ID", nativeQuery = true)
	List<Object[]> findAllPrelim(@Param("caYearId") Integer caYearId, @Param("statusCdIgnore") String statusCdIgnore);
	*/
	@Query(value = "SELECT cp.CASE_ID, ci.CA_PRM_NODE_CD, ci.CA_YEAR_ID, ci.CA_SEQUENCE_ID, cp.CASE_STATUS_CD, cp.CASE_STATUS_DT,"
			+ " clp.STATUS_DESC"
			+ " FROM CA_INVST_PRELIMINARY_T cp JOIN CA_INTELLIGENT_KEY_T ci on cp.CASE_ID = ci.CASE_ID"
			+ " JOIN CA_LU_PRELIM_STATUS_T clp on cp.CASE_STATUS_CD = clp.STATUS_CD"
			+  " WHERE clp.STATUS_VIEW = '1' and (clp.STATUS_CLS_IND != 1 or  clp.STATUS_CLS_IND is null)"
			+ " ORDER BY cp.CASE_ID", nativeQuery = true)
	List<Object[]> findAllPrelim();
	
}
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaInvstPrHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrHistTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaInvstPrHistRepository extends JpaRepository<CaInvstPrHistT, CaInvstPrHistTPK> {
	
}
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaInvstPrIssueHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrIssueHistTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaInvstPrIssueHistRepository extends JpaRepository<CaInvstPrIssueHistT, CaInvstPrIssueHistTPK> {
	
}
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaInvstPrIssueT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrIssueTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaInvstPrIssueRepository extends JpaRepository<CaInvstPrIssueT, CaInvstPrIssueTPK> {
	
}
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaInvstPrStatusHistT;
import com.optum.fads.caseentrybatch.api.domain.CaInvstPrStatusHistTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaInvstPrStatusHistRepository extends JpaRepository<CaInvstPrStatusHistT, CaInvstPrStatusHistTPK> {
	
}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.repo;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaLuValuesT;
import com.optum.fads.caseentrybatch.api.domain.CaLuValuesTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaLuValuesRepository extends JpaRepository<CaLuValuesT, CaLuValuesTPK> , JpaSpecificationExecutor<CaLuValuesT>{
	
	List<CaLuValuesT> findByIdFieldId(String invstTypeCode);

}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaMetaBaseNoticeT;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaMetaBaseNoticeRepository extends JpaRepository<CaMetaBaseNoticeT, String>, JpaSpecificationExecutor<CaMetaBaseNoticeT> {

}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.repo;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaMetaBaseT;
import com.optum.fads.caseentrybatch.api.domain.CaMetaBaseTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaMetaBaseRepository extends JpaRepository<CaMetaBaseT, CaMetaBaseTPK>, JpaSpecificationExecutor<CaMetaBaseT>{

    @Query(" from CaMetaBaseT as t where t.visibleType='Y' and t.sqlClauseType is not null and t.id.caseType = :caseType ")
    List<CaMetaBaseT> findAllByCaseType(@Param("caseType") String caseType);
}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaProviderT;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaProviderRepository extends JpaRepository<CaProviderT, Integer> {
	
}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaRecipientT;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaRecipientRepository extends JpaRepository<CaRecipientT, Integer> {
	
}
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import com.optum.fads.caseentrybatch.api.domain.CaseConfigT;

@Repository
public interface CaseConfigRepository extends JpaRepository<CaseConfigT, String>{
	
	@Query("select e.optionValue from CaseConfigT e where e.optionCode = :optionCode")
	public String getOptionValue(@Param("optionCode") String optionCode);
	
}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaUniverseBatchT;
import com.optum.fads.caseentrybatch.api.domain.CaUniverseBatchTPK;

import java.util.List;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaUniverseBatchRepository extends JpaRepository<CaUniverseBatchT, CaUniverseBatchTPK>, JpaSpecificationExecutor<CaUniverseBatchT>{
	
	@Modifying
	@Query("DELETE FROM CaUniverseBatchT cub  WHERE cub.id.ctBatchId = :batchId") 
	int deleteByBatchId(@Param("batchId") Integer  batchId);

    @Query("select distinct c.id.ctBatchId from CaUniverseBatchT c where c.recMatchInd is null order by c.id.ctBatchId")
    List<Integer> findDistinctBatchIds();

    @Query("select c from CaUniverseBatchT c where  c.id.ctBatchId  = :batchId order by c.participantId")
    List<CaUniverseBatchT> findAllByBatchId(@Param("batchId") Integer  batchId);
}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.caseentrybatch.api.domain.CaUniverseT;
import com.optum.fads.caseentrybatch.api.domain.CaUniverseTPK;

/**
 * @author awagh
 *
 */

@Transactional
@Repository
public interface CaUniverseRepository extends JpaRepository<CaUniverseT, CaUniverseTPK>, JpaSpecificationExecutor<CaUniverseT>{
	@Query(value = "SELECT  Max(CT_BATCH_ID+1) FROM CA_UNIVERSE_T", nativeQuery = true)
	Integer getNextCaseBatchId();
}
/**
 * 
 */
package com.optum.fads.caseentrybatch.api.repo;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;

import com.optum.fads.caseentrybatch.api.domain.FadsConfigT;
/**
 * @author awagh
 *
 */
public interface FadsConfigRepository extends JpaRepository<FadsConfigT,Long> , JpaSpecificationExecutor<FadsConfigT> {

}
package com.optum.fads.caseentrybatch.api.repo;

import java.util.Optional;

import org.springframework.transaction.annotation.Transactional;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import com.optum.fads.caseentrybatch.api.domain.UiUserBase;

@Transactional
@Repository
public interface UserRepository extends JpaRepository<UiUserBase, String> {

	Optional<UiUserBase> findByUiUserId(String userId);
	
	Optional<UiUserBase> findByUiEMailAddress(String userEmail);

}
package com.optum.fads.caseentrybatch.api.job;

import org.quartz.JobExecutionContext;
import org.quartz.JobExecutionException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.quartz.QuartzJobBean;

import com.optum.fads.caseentrybatch.api.service.ICaseBatchService;

import lombok.extern.slf4j.Slf4j;

@Slf4j
public class CaseEntryBatchJob extends QuartzJobBean {

	 @Autowired
	private ICaseBatchService iCaseBatchService;

	@Override
	protected void executeInternal(JobExecutionContext context) throws JobExecutionException {
		log.info("Create Batch Case job is starting...");
		iCaseBatchService.createBatchCase();
		log.info("Create Batch Case job end...");
	}

	

}
package com.optum.fads.caseentrybatch.api.config;

import org.quartz.CronScheduleBuilder;
import org.quartz.JobBuilder;
import org.quartz.JobDetail;
import org.quartz.Trigger;
import org.quartz.TriggerBuilder;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import com.optum.fads.caseentrybatch.api.job.CaseEntryBatchJob;
import com.optum.fads.caseentrybatch.api.repo.CaseConfigRepository;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@Configuration
public class CaseEntryBatchJobConfig {
	private static final String BATCH_CASE_SCHEDULE = "BATCH_CASE_ENTRY_SCHEDULE";
	
	@Autowired
	private CaseConfigRepository caseConfigTRepository;
	
	@Bean
	public JobDetail caseBatchJobDetails() {
		
	//	return JobBuilder.newJob(casebatchJob.class).withIdentity("casebatchJob").usingJobData("casebatchJobDetail", "test")
		return JobBuilder.newJob(CaseEntryBatchJob.class).withIdentity("caseEntryBatchJob")
				.storeDurably().build();
	}

	@Bean
	public Trigger caseBatchJobTrigger() {
		String batchCaseCronDb = caseConfigTRepository.getOptionValue(BATCH_CASE_SCHEDULE);
		
		log.info("casebatchJobTrigger set up with Cron Expression " + batchCaseCronDb);
		return TriggerBuilder.newTrigger().forJob(caseBatchJobDetails()).withIdentity("CaseBatchJobTrigger", "CaseBatchGroup")
				.withSchedule(CronScheduleBuilder.cronSchedule(batchCaseCronDb)).build();
	}
	
	
}

/*
//***********************************************
// Copyright UNITEDHEALTH GROUP CORPORATION 2018.
// This software and documentation contain confidential and
// proprietary information owned by UnitedHealth Group Corporation.
// Unauthorized use and distribution are prohibited.
//***********************************************
*/

package com.optum.fads.caseentrybatch.api.config;

import com.azure.identity.ClientSecretCredentialBuilder;
import com.azure.security.keyvault.secrets.SecretClient;
import com.azure.identity.ClientSecretCredential;
import com.azure.security.keyvault.secrets.SecretClientBuilder;
import org.modelmapper.ModelMapper;
import org.modelmapper.convention.MatchingStrategies;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Scope;

import static org.springframework.beans.factory.config.ConfigurableBeanFactory.SCOPE_PROTOTYPE;

/**
 * The CommonConfig holds spring based configuration
 */
@Configuration
public class CommonConfig {

    @Value("${spring.cloud.azure.keyvault.secrets.endpoint}")
    private String azureKeyVaultUrl;
    @Value("${spring.cloud.azure.keyvault.credential.tenant-id}")
    private String azureKeyVaultTenant;
    @Value("${spring.cloud.azure.keyvault.credential.client-secret}")
    private String azureKeyVaultSecret;
    @Value("${spring.cloud.azure.keyvault.credential.client-id}")
    private String azureKeyVaultClientId;

    /**
     * Model Mapper for mapping objects
     *
     * @return modelMapper
     */
    @Bean
    @Scope(SCOPE_PROTOTYPE)
    public ModelMapper modelMapper() {
        final var modelMapper = new ModelMapper();
        modelMapper.getConfiguration().setAmbiguityIgnored(true);
        modelMapper.getConfiguration().setMatchingStrategy(MatchingStrategies.STRICT);
        return modelMapper;
    }

    @Bean
    public SecretClient secretClient() {
        ClientSecretCredential clientSecretCredential = new ClientSecretCredentialBuilder()
                .clientId(azureKeyVaultClientId)
                .clientSecret(azureKeyVaultSecret)
                .tenantId(azureKeyVaultTenant)
                .build();

        return new SecretClientBuilder()
                .vaultUrl(azureKeyVaultUrl)
                .credential(clientSecretCredential)
                .buildClient();
    }
}
package com.optum.fads.caseentrybatch.api.config;

import java.io.StringReader;
import java.security.PrivateKey;
import java.security.interfaces.RSAPrivateCrtKey;
import java.security.spec.RSAPrivateCrtKeySpec;
import net.snowflake.client.jdbc.internal.org.bouncycastle.asn1.pkcs.PrivateKeyInfo;
import net.snowflake.client.jdbc.internal.org.bouncycastle.jce.provider.BouncyCastleProvider;
import net.snowflake.client.jdbc.internal.org.bouncycastle.openssl.PEMEncryptedKeyPair;
import net.snowflake.client.jdbc.internal.org.bouncycastle.openssl.PEMParser;
import net.snowflake.client.jdbc.internal.org.bouncycastle.openssl.jcajce.JcaPEMKeyConverter;
import net.snowflake.client.jdbc.internal.org.bouncycastle.openssl.jcajce.JceOpenSSLPKCS8DecryptorProviderBuilder;
import net.snowflake.client.jdbc.internal.org.bouncycastle.operator.InputDecryptorProvider;
import net.snowflake.client.jdbc.internal.org.bouncycastle.pkcs.PKCS8EncryptedPrivateKeyInfo;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import java.security.KeyFactory;
import java.security.PrivateKey;
import java.security.Security;
import java.security.interfaces.RSAPrivateCrtKey;
import java.security.spec.RSAPrivateCrtKeySpec;


public class PemKeyLoader {
    private static final Logger logger =
            LoggerFactory.getLogger(PemKeyLoader.class);

    static {
        Security.addProvider(new BouncyCastleProvider());
    }

    public static PrivateKey loadPrivateKeyPem(String pemContent, char[] passphrase) throws Exception {
        logger.debug("Parsing PEM content...");
        try (PEMParser pemParser = new PEMParser(new StringReader(pemContent))) {
            Object pemObject = pemParser.readObject();
            PrivateKeyInfo privateKeyInfo = null;

            if (pemObject instanceof PKCS8EncryptedPrivateKeyInfo) {
                if (passphrase == null) {
                    throw new IllegalArgumentException(
                            "Encrypted key found but no passphrase provided."
                    );
                }
                logger.debug("Detected PKCS#8 encrypted key.");
                PKCS8EncryptedPrivateKeyInfo encInfo =
                        (PKCS8EncryptedPrivateKeyInfo) pemObject;
                InputDecryptorProvider decProv =
                        new JceOpenSSLPKCS8DecryptorProviderBuilder().build(passphrase);
                privateKeyInfo = encInfo.decryptPrivateKeyInfo(decProv);

            } else if (pemObject instanceof PEMEncryptedKeyPair) {
                logger.debug("Detected old-format encrypted key (PEM).");
                // Add necessary decryption if needed
            } else if (pemObject instanceof PrivateKeyInfo) {
                logger.debug("Detected unencrypted PKCS#8 key.");
                privateKeyInfo = (PrivateKeyInfo) pemObject;
            } else {
                logger.debug("Unknown PEM object type: {}",
                        pemObject == null ? "null" : pemObject.getClass().getName());
            }

            // Convert to BC key first
            JcaPEMKeyConverter converter = new JcaPEMKeyConverter()
                    .setProvider(BouncyCastleProvider.PROVIDER_NAME);
            PrivateKey bcKey = converter.getPrivateKey(privateKeyInfo);

            // Convert BC key to standard JDK RSA key
            KeyFactory keyFactory = KeyFactory.getInstance("RSA");
            RSAPrivateCrtKey rsaKey = (RSAPrivateCrtKey) bcKey;

            RSAPrivateCrtKeySpec keySpec = new RSAPrivateCrtKeySpec(
                    rsaKey.getModulus(),
                    rsaKey.getPublicExponent(),
                    rsaKey.getPrivateExponent(),
                    rsaKey.getPrimeP(),
                    rsaKey.getPrimeQ(),
                    rsaKey.getPrimeExponentP(),
                    rsaKey.getPrimeExponentQ(),
                    rsaKey.getCrtCoefficient()
            );

            PrivateKey jdkKey = keyFactory.generatePrivate(keySpec);
            logger.debug("Key conversion successfull ***");

            return jdkKey;
        }
    }
}
package com.optum.fads.caseentrybatch.api.config;

import java.io.IOException;
import java.security.PrivateKey;
import java.util.HashMap;
import java.util.Properties;

import javax.sql.DataSource;

import org.bouncycastle.pkcs.PKCSException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.datasource.DriverManagerDataSource;
import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.annotation.EnableTransactionManagement;

import com.azure.security.keyvault.secrets.SecretClient;
import com.zaxxer.hikari.HikariDataSource;

import jakarta.persistence.EntityManagerFactory;
import net.snowflake.client.jdbc.SnowflakeBasicDataSource;

/**
 * @author sbajaj8
 *
 */
@Configuration
@EnableAutoConfiguration(exclude={DataSourceAutoConfiguration.class})
@EnableTransactionManagement
@EnableJpaRepositories(entityManagerFactoryRef = "snfkEntityManagerFactory",
						transactionManagerRef = "txManagerSnFk",
						basePackages = {"com.optum.fads.caseentrybatch.api.snowflakeRepo"}
						)
public class ServiceConfig 
{
    private static final Logger logger =
            LoggerFactory.getLogger(ServiceConfig.class);

	
	@Value("${spring.datasource.snfk.jdbcUrl}")
    private String url;

    @Value("${spring.datasource.snfk.userName}")
    private String username;

    @Value("${spring.datasource.snfk.password}")
    private String password;

    @Value("${spring.datasource.snfk.certKey}")
    private String certKey;

    @Value("${spring.datasource.snfk.passphrase}")
    private String passphrase;

    @Value("${spring.datasource.snfk.database}")
    private String database;

    @Value("${spring.datasource.snfk.schema}")
    private String schema;

    @Value("${spring.datasource.snfk.warehouse}")
    private String warehouse;

    @Value("${spring.datasource.snfk.account}")
    private String account;
    
    @Value("${spring.datasource.snfk.role}")
    private String role;

    @Value("${db.snfk-login.useCert}")
    private Boolean useCert;

    private final SecretClient secretClient;

    public ServiceConfig(SecretClient secretClient) {
        this.secretClient = secretClient;
    }
	
    @Primary
	@Bean(name="fadsDataSource")
    public DataSource customDataSource() throws Exception, IOException {
        if(useCert){
            String pemContent = secretClient.getSecret(certKey).getValue();
            logger.info("snowflake login using certificate");

            char[] password = secretClient.getSecret(passphrase).getValue()  != null ? secretClient.getSecret(passphrase).getValue().toCharArray() : null;
            PrivateKey privateKey = PemKeyLoader.loadPrivateKeyPem(pemContent, password);
            // Add more logging
            logger.info("Private key class: {}", privateKey.getClass().getName());
            logger.info("Private key implements RSAPrivateCrtKey? {}", privateKey instanceof java.security.interfaces.RSAPrivateCrtKey);

            SnowflakeBasicDataSource dataSource = new SnowflakeBasicDataSource();

            dataSource.setUrl(url);
            dataSource.setDatabaseName(database);
            dataSource.setSchema(schema);
            dataSource.setWarehouse(warehouse);
            if(account != null && !account.isEmpty()) {
                dataSource.setAccount(account);
            }
            if(role != null && !role.isEmpty()) {
                dataSource.setRole(role);
            }

            dataSource.setUser(username);
            dataSource.setPrivateKey(privateKey);

            HikariDataSource hikariDs = new HikariDataSource();
            hikariDs.setDataSource(dataSource);

            return hikariDs;

        } else {
            String user = secretClient.getSecret(username).getValue();
            String pass = secretClient.getSecret(password).getValue();
            logger.info("snowflake login using username and password");
            Properties props = new Properties();
            props.put("user", user);
            props.put("password", pass);
            props.put("database", database);
            props.put("schema", schema);
            props.put("warehouse", warehouse);
            if(role != null && !role.isEmpty()){
                props.put("role", role);
            }
            if(account != null && !account.isEmpty()){
                props.put("account", account);
            }
            return new DriverManagerDataSource(url, props);
        }

    }
	
    @Primary
	@Bean("snfkEntityManagerFactory")
    public LocalContainerEntityManagerFactoryBean 
    snfkEntityManagerFactory( ) throws IOException, PKCSException, Exception
	 {
	  LocalContainerEntityManagerFactoryBean em
	          = new LocalContainerEntityManagerFactoryBean();
	        em.setDataSource(customDataSource());
	        em.setPackagesToScan(
	          new String[] { "com.optum.fads.caseentrybatch.api.snowflakeDomain" });
	        HibernateJpaVendorAdapter vendorAdapter
	          = new HibernateJpaVendorAdapter();
	        em.setJpaVendorAdapter(vendorAdapter);
	        HashMap<String, Object> properties = new HashMap<>();
	        properties.put("hibernate.allow_update_outside_transaction",true);
	        properties.put("hibernate.dialect", "com.optum.fads.caseentrybatch.api.config.SnowflakeDialect");
	        em.setJpaPropertyMap(properties);
	    return em;
	}
	
    @Primary
	@Bean ("txManagerSnFk")
	public PlatformTransactionManager txManagerSnFk(@Qualifier("snfkEntityManagerFactory")EntityManagerFactory snfkEntityManagerFactory) throws IOException, PKCSException, Exception
	 {
    	JpaTransactionManager txManager = new JpaTransactionManager();
        txManager.setEntityManagerFactory(snfkEntityManagerFactory().getObject());
        return txManager;
	 }

    @Bean(name = "jdbcSnowflake")
    public JdbcTemplate snowflakeJdbcTemplate(@Qualifier("fadsDataSource") DataSource dsSlave) {
        return new JdbcTemplate(dsSlave);
    }
	}


	

package com.optum.fads.caseentrybatch.api.config;

import javax.sql.DataSource;

import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.boot.jdbc.DataSourceBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.jdbc.datasource.DriverManagerDataSource;
import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.annotation.EnableTransactionManagement;

import com.azure.security.keyvault.secrets.SecretClient;

import jakarta.persistence.EntityManagerFactory;

/**
 * @author sbajaj8
 *
 */
@Configuration
@EnableAutoConfiguration(exclude={DataSourceAutoConfiguration.class})
@EnableTransactionManagement
@EnableJpaRepositories(entityManagerFactoryRef = "sqlEntityManagerFactory",
						transactionManagerRef = "txManagerSQL",
						basePackages = "com.optum.fads.caseentrybatch.api.repo" )
		public class ServiceConfigSQL 
		{
			@Value("${spring.datasource.sql.userName}")
			private String userName;

			@Value("${spring.datasource.sql.password}")
			private String password;

			@Value("${spring.datasource.sql.jdbcUrl}")
			private String url;

			@Value("${spring.datasource.sql.driverClassName}")
			private String driverClassName;

			private final SecretClient secretClient;

			public ServiceConfigSQL(SecretClient secretClient) {
				this.secretClient = secretClient;
			}

			@Primary
			@Bean(name = "fadsSQLDataSource")
			public DataSource fadsSQLDataSource() {
				String userNameValue = secretClient.getSecret(userName).getValue();
				String passwordValue = secretClient.getSecret(password).getValue();

				DriverManagerDataSource dataSource = new DriverManagerDataSource();
				dataSource.setDriverClassName(driverClassName);
				dataSource.setUsername(userNameValue);
				dataSource.setPassword(passwordValue);
				dataSource.setUrl(url);

				return dataSource;
			}
	
			@Bean(name = "sqlEntityManagerFactory")
				public LocalContainerEntityManagerFactoryBean sqlEntityManagerFactory()
					{
						LocalContainerEntityManagerFactoryBean em
								= new LocalContainerEntityManagerFactoryBean();
						em.setDataSource(fadsSQLDataSource());
						em.setPackagesToScan(
								new String[] { "com.optum.fads.caseentrybatch.api.domain" });
						HibernateJpaVendorAdapter vendorAdapter
							= new HibernateJpaVendorAdapter();
						em.setJpaVendorAdapter(vendorAdapter);
					return em;
					}
	 
	 
	 @Bean(name = "txManagerSQL")
	 public PlatformTransactionManager txManagerSQL(@Qualifier("sqlEntityManagerFactory")EntityManagerFactory sqlEntityManagerFactory)
	 {
		 JpaTransactionManager txManager = new JpaTransactionManager();
	        txManager.setEntityManagerFactory(sqlEntityManagerFactory().getObject());
	        return txManager;
	 }
	 
	}
package com.optum.fads.caseentrybatch.api.config;

import org.hibernate.dialect.Dialect;
import org.springframework.context.annotation.Configuration;

@Configuration
public class SnowflakeDialect extends Dialect {

}package com.optum.fads.caseentrybatch.api.common;

/*
//***********************************************
//Copyright UNITEDHEALTH GROUP CORPORATION 2018.
//This software and documentation contain confidential and
//proprietary information owned by UnitedHealth Group Corporation.
//Unauthorized use and distribution are prohibited.
//***********************************************
*/

/**
* Constants used for Case Entry 
*/
public final class CaseEntryConstants {

 private CaseEntryConstants() {}
	
 public static final String INVESTIGATION_TYPE_PRELIMINARY = "PRI";
 public static final String INVESTIGATION_TYPE_FULLSCALE = "FSI";
 public static final String PROVIDER = "PV";
 public static final String NATIONAL_SETTLEMENT = "NS";
 public static final String MEMBER = "RP";
 public static final String PROVIDER_ROLE_ATTENDING = "AT";
 public static final String PROVIDER_ROLE_BILLING = "BP";
 public static final String PROVIDER_ROLE_REFERRING = "RF";
 public static final String PROVIDER_ROLE_TREATING = "RN";
 public static final String PROVIDER_ROLE_PRESCRIBING = "RX";
 public static final String BATCH_CASE = "Batch ";
 public static final String BATCH_IMPORTED = "I";
 public static final String BATCH_COMPLETED = "C";
 public static final String SUCCESS_MESSAGE = "Success";
 public static final String FAIL_MESSAGE = "Fail";
 public static final String ASSIGNMENT = "Assignment";
 public static final String PROCESSED = " Processed";

 public static final String AZURE_LOGIC_APP_URL = "EMAIL_LOGIC_APP_URL";
 public static final String SMTP_HOST_NAME = "EMAIL_SERVER_SMTP";
 public static final String CA_UNIVERSE_BATCH = "CA_UNIVERSE_BATCH_T";
 public static final String BATCH_SUCCESS_NOTIFICATION = "NBS";
 public static final String BATCH_ASSIGNMENT_NOTIFICATION	= "NBA";
 public static final String BATCH_FAIL_NOTIFICATION_USER	= "NBFU";
 public static final String BATCH_INVALID_NOTIFICATION_USER	= "NBIU";
 public static final String BATCH_FAIL_NOTIFICATION_ADMIN	= "NBFA";

 public static final String BATCH_ID_IN = "[BATCH ID]";
 public static final String ASSIGNED_TO = "[ASSIGNED TO]";
 public static final String CASE_ID = "[CASE ID]";
 public static final String TCNS = "[TCNS]";
 public static final String INVESTIGATION_TYPE = "[INVESTIGATION TYPE]";
 public static final String ASSIGNED_DATE = "[ASSIGNED DATE]";
 public static final String ERROR_LOG_INFO = "[error log info]";
 public static final String INVST_TYPE_CODE = "INVST_TYPE_CD";

 public static final int    ONE = 1;
 public static final int    ZERO = 0;
 public static final String BLANK_STR = " ";
 public static final String TEXT_SEPERATOR = ", ";
 public static final String EMPTY_STR = "";
 public static final String ONE_STR = "1";
 public static final String YES = "Y";
 public static final String NO = "N";
 public static final String DUPLICATE = "D";
 public static final long 	DATE_TIME_ZONE_ID =  700;
 public static final int 	ERROR_LOG_LENGTH =  8192;
 public static final String DATE_FORMAT_MMDDYYYY_D = "MM-dd-yyyy";
 public static final String CT_ADMIN_ID = "CT_ADMIN";
 public static final String SYSTEM_ADMIN_DIST_LIST = "SYS_ADMIN_DL";
}
/*
//***********************************************
// Copyright UNITEDHEALTH GROUP CORPORATION 2018.
// This software and documentation contain confidential and
// proprietary information owned by UnitedHealth Group Corporation.
// Unauthorized use and distribution are prohibited.
//***********************************************
*/

package com.optum.fads.caseentrybatch.api;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;


/**
 * Entry point to the cloud scaffolding boiler plate - Spring Boot
 * 
 * @author AUTHOR, AUTHOR_EMAIL
 * @version VERSION
 */
@SpringBootApplication
public class CaseEntryBatchApplication {
    /**
     * Main method for cloud scaffolding boiler plate. Sends metadata to discovery
     * service.
     */
    public static void main(String[] args) {
        SpringApplication.run(CaseEntryBatchApplication.class, args);
    }
}
server:
  port: 8080
  servlet:
    contextPath: /caseentrybatch
quickstart:
  generateOrderPeriod: 10s
  processOrderPeriod: 30s

spring: 
  application:
   name: caseentrybatch
  cloud:
    azure:
      keyvault:
        secrets:
          endpoint: https://kv-anly-pi-dev-cus-001.vault.azure.net
        credential:
          client-id: 
          client-secret: 
          tenant-id: 
  jpa:
    database-platform: com.optum.fads.caseentrybatch.api.config.SnowflakeDialect
    
  datasource:
     hikari:
      maximum-pool-size: ${MAXIMUM_DB_POOL_SIZE:50}
      minimum-idle: ${MIN_POOL_IDLE:1}
      connection-timeout: ${DB_CONNECTION_TIMEOUT:60000}
      idle-timeout: ${DB_POOL_IDLE_TIMEOUT:60000}
      leak-detection-threshold: ${LEAK_DETETCTION_THRESHOLD:0}
     sql:
       type: com.zaxxer.hikari.HikariDataSource
       jdbcUrl: jdbc:sqlserver://sql-pi-dev-cus-001.database.windows.net:1433;database=pi-dev-db;user=sqladmin
       userName: sql-admin-user
       password: sql-admin-password
       driverClassName: com.microsoft.sqlserver.jdbc.SQLServerDriver
       jpa:
           database-platform: org.hibernate.dialect.SQLServer2016Dialect
           database: SQL_SERVER 
           format-sql: true
           globally_quoted_identifiers: true
           show-sql: true
           hibernate:
              use-new-id-generator-mappings: true
              globally_quoted_identifiers: true
              hibernate.allow_update_outside_transaction: true
              naming:
                    implicit-strategy: org.hibernate.boot.model.naming.ImplicitNamingStrategyLegacyHbmImpl
                    physical-strategy: org.springframework.boot.orm.jpa.hibernate.SpringPhysicalNamingStrategy
     snfk:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: net.snowflake.client.jdbc.SnowflakeDriver
        jdbcUrl: jdbc:snowflake://ew98463.east-us-2.azure.snowflakecomputing.com:443/?TIMEZONE=UTC&CLIENT_RESULT_COLUMN_CASE_INSENSITIVE=true
        database: PI_DEMO_DB
        userName: pi-sf-usr-dev
        password: pi-sf-usr-dev-pw
        certKey: pi-sf-key-dev
        passphrase: pi-sf-key-dev-pw
        schema: FADS
        warehouse: SGS_PI_DEMO_XSMALL_WH
        role: 
        account: 
        jpa:
            database-platform: com.optum.fads.caseentrybatch.api.config.SnowflakeDialect
            database: default 
            format-sql: true
            globally_quoted_identifiers: true
            show-sql: true
            hibernate:
               use-new-id-generator-mappings: true
               globally_quoted_identifiers: true
               naming:
                     implicit-strategy: org.hibernate.boot.model.naming.ImplicitNamingStrategyLegacyHbmImpl
                     physical-strategy: org.springframework.boot.orm.jpa.hibernate.SpringPhysicalNamingStrategy
  quartz:
    properties:
      org:
        quartz:
          threadPool:
            class: org.quartz.simpl.SimpleThreadPool
            threadCount: 3      
management:
  endpoint:
    metrics.enabled: true
    prometheus.enabled: true
  endpoints.web.exposure.include:
    - health
    - info
    - prometheus
  prometheus.metrics.export.enabled: true
#  security:
#    oauth2:
#      resourceserver:
#        jwt:
#          jwk-set-uri: ${JWKS_URL}
#logging:
#  level:
#    org:
#      hibernate:
#        SQL: DEBUG
#        type: TRACE
db:
  snfk-login:
    useCert: ${USE_CERT:false}
	<?xml version="1.0" encoding="UTF-8"?>
<project
        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"
        xmlns="http://maven.apache.org/POM/4.0.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

    <modelVersion>4.0.0</modelVersion>

    <groupId>com.optum.fads</groupId>
    <artifactId>fads-case-entry-batch</artifactId>
    <version>1.0.0</version>
    <packaging>jar</packaging>
    
     <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
         <version>3.5.8</version>
        <relativePath/>
    </parent>

   <repositories>
        <repository>
             <id>central</id>
			<name>centraluhg.jfrog.io-releases</name>
			<url>https://centraluhg.jfrog.io/artifactory/com-optum-omms-maven-releases-vir</url>
        </repository>
        <repository>
            <id>snapshots</id>
            <name>snapshots-repo</name>
            <url>https://centraluhg.jfrog.io/artifactory/com-optum-omms-maven-snapshots</url>
        </repository>
    </repositories>

    <properties>
        <maven.test.skip>false</maven.test.skip>
        <skipTests>${maven.test.skip}</skipTests>
        <surefire.skip>${skipTests}</surefire.skip>
        <failsafe.skip>${skipTests}</failsafe.skip>
	    <log4j2.version>2.16.0</log4j2.version>
        <java.version>17</java.version>
        <spring.boot.version>3.5.8</spring.boot.version>
        <spring.cloud.version>2025.0.0</spring.cloud.version>
        <jasypt.version>3.0.5</jasypt.version>
        <jwt.version>4.4.0</jwt.version>
        <cloudsdk.version>4.2.0-RELEASE</cloudsdk.version>
        <modelmapper.version>3.2.2</modelmapper.version>
        <jacoco.version>0.8.12</jacoco.version>
        <springrunner.version>0.1.0</springrunner.version>
        <guava.version>32.1.2-jre</guava.version>
        <logback.encoder.version>7.4</logback.encoder.version>
        <lombok.version>1.18.28</lombok.version>
        <restassured.version>5.5.0</restassured.version>
        <snowflake-jdbc.version>3.23.1</snowflake-jdbc.version>
        <snakeyaml.version>2.0</snakeyaml.version>
	    <org.mapstruct.version>1.5.4.Final</org.mapstruct.version>
        <sonar.coverage.exclusions>
            **/com/optum/fads/caseentrybatch.api/**,
        </sonar.coverage.exclusions>
        <bcp.version>1.67</bcp.version>
        <netty.version>4.1.129.Final</netty.version>
    </properties>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>com.azure.spring</groupId>
                <artifactId>spring-cloud-azure-dependencies</artifactId>
                <version>6.1.0</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>

			<dependency>
				<groupId>org.apache.logging.log4j</groupId>
				<artifactId>log4j-bom</artifactId>
				<version>2.24.3</version>
				<scope>import</scope>
				<type>pom</type>
			</dependency>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-dependencies</artifactId>
                <version>${spring.boot.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>

            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring.cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
           
			
			<dependency>
			  <groupId>com.microsoft.azure</groupId>
			  <artifactId>msal4j</artifactId>
			  <version>1.17.2</version>
			</dependency>
			
			<dependency>
			  <groupId>io.netty</groupId>
			  <artifactId>netty-bom</artifactId>
			  <version>${netty.version}</version>
			  <type>pom</type>
			  <scope>import</scope>
			</dependency>

			<dependency>
				<groupId>ch.qos.logback</groupId>
				<artifactId>logback-core</artifactId>
				<version>1.5.25</version>
			</dependency>
			<dependency>
				<groupId>ch.qos.logback</groupId>
				<artifactId>logback-classic</artifactId>
				<version>1.5.25</version>
			</dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
      
        <dependency>
		  <groupId>io.netty</groupId>
		  <artifactId>netty-codec-http</artifactId>
		  <version>${netty.version}</version>
		</dependency>
		
		<dependency>
		  <groupId>io.netty</groupId>
		  <artifactId>netty-codec-http2</artifactId>
		  <version>${netty.version}</version>
		</dependency>
        <dependency>
            <groupId>com.azure.spring</groupId>
            <artifactId>spring-cloud-azure-starter-keyvault-secrets</artifactId>
        </dependency>
        <!-- Spring Boot Dependencies -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
        </dependency>
         <dependency>
		    <groupId>ch.qos.logback</groupId>
		    <artifactId>logback-classic</artifactId>
		</dependency>
		<dependency>
		    <groupId>ch.qos.logback</groupId>
		    <artifactId>logback-core</artifactId>
		</dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
		
		<!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-mail -->
		<dependency>
		    <groupId>org.springframework.boot</groupId>
		    <artifactId>spring-boot-starter-mail</artifactId>
		</dependency>
		
		<!-- https://mvnrepository.com/artifact/org.apache.commons/commons-email -->
		<dependency>
		    <groupId>org.apache.commons</groupId>
		    <artifactId>commons-email</artifactId>
		    <version>1.5</version>
		</dependency>
		
		<dependency>
			<groupId>org.apache.commons</groupId>
			<artifactId>commons-lang3</artifactId>
			 <version>3.18.0</version> 
		</dependency>

		<dependency>
			<groupId>org.hibernate.javax.persistence</groupId>
			<artifactId>hibernate-jpa-2.1-api</artifactId>
			<version>1.0.2.Final</version>
		</dependency>
		
		<!-- Micrometer Prometheus registry  -->
		<dependency>
		    <groupId>io.micrometer</groupId>
		    <artifactId>micrometer-registry-prometheus</artifactId>
		</dependency>

        <!-- Password Encryption -->
        <dependency>
            <groupId>com.github.ulisesbocchio</groupId>
            <artifactId>jasypt-spring-boot-starter</artifactId>
            <version>${jasypt.version}</version>
        </dependency>

        <!-- JWT -->
        <dependency>
            <groupId>com.auth0</groupId>
            <artifactId>java-jwt</artifactId>
            <version>${jwt.version}</version>
        </dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt</artifactId>
			<version>0.12.6</version>
		</dependency>
		
 		<dependency>
		    <groupId>org.apache.httpcomponents</groupId>
		    <artifactId>httpclient</artifactId>
		    <version>4.5.14</version>
		</dependency>

        <!-- Model Mapper -->
        <dependency>
            <groupId>org.modelmapper</groupId>
            <artifactId>modelmapper</artifactId>
            <version>${modelmapper.version}</version>
        </dependency>
        
        <!-- MapStruct -->

		<dependency>
			<groupId>org.mapstruct</groupId>
			<artifactId>mapstruct</artifactId>
			<version>${org.mapstruct.version}</version>
		</dependency>
		<dependency>
			<groupId>org.mapstruct</groupId>
			<artifactId>mapstruct-jdk8</artifactId>
			<version>${org.mapstruct.version}</version>
		</dependency>
		<dependency>
			<groupId>org.mapstruct</groupId>
			<artifactId>mapstruct-processor</artifactId>
			<version>${org.mapstruct.version}</version>
		</dependency>

        <!-- Jackson -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-annotations</artifactId>
	</dependency>

	<dependency>
	     <groupId>com.fasterxml.jackson.core</groupId>
	     <artifactId>jackson-databind</artifactId>
	</dependency>

        <!--Used in Getter/Setter Verifier @NonNull  -->
        <dependency>
            <groupId>com.google.guava</groupId>
            <artifactId>guava</artifactId>
            <version>${guava.version}</version>
        </dependency>

        

        <!-- Lombok -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <scope>provided</scope>
        </dependency>

        <!-- JSON logging-->
        <dependency>
            <groupId>net.logstash.logback</groupId>
            <artifactId>logstash-logback-encoder</artifactId>
            <version>${logback.encoder.version}</version>
            <scope>runtime</scope>
        </dependency>

        <dependency>
            <groupId>org.codehaus.janino</groupId>
            <artifactId>janino</artifactId>
            <scope>runtime</scope>
        </dependency>
        
		<!-- https://mvnrepository.com/artifact/org.codehaus.jettison/jettison -->
		<dependency>
		    <groupId>org.codehaus.jettison</groupId>
		    <artifactId>jettison</artifactId>
		    <version>1.5.4</version>
		</dependency>

        <!-- Testing -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <scope>test</scope>
        </dependency>
        
        <dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-quartz</artifactId>
		</dependency>

        <dependency>
            <groupId>org.mockito</groupId>
            <artifactId>mockito-core</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- Before After Spring Test Runner -->
        <dependency>
            <groupId>org.jacoco</groupId>
            <artifactId>jacoco-maven-plugin</artifactId>
            <version>${jacoco.version}</version>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>io.rest-assured</groupId>
            <artifactId>rest-assured</artifactId>
            <version>${restassured.version}</version>
            <scope>test</scope>
        </dependency>
        
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>
		
		<dependency>
            <groupId>org.springframework.data</groupId>
            <artifactId>spring-data-commons</artifactId>          
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-test</artifactId>
		</dependency>

        <!-- Quartz-Java dependency Remediation Upgrade  -->
        <dependency>
			<groupId>org.quartz-scheduler</groupId>
			<artifactId>quartz</artifactId>
		</dependency>
		
		<dependency>
		    <groupId>com.microsoft.sqlserver</groupId>
		    <artifactId>mssql-jdbc</artifactId>
		    <version>13.2.1.jre11</version>
		</dependency>

		
		<dependency>
            <groupId>org.hibernate</groupId>
            <artifactId>hibernate-core</artifactId>
            <version>6.2.3.Final</version>
        </dependency>
        
        <!-- Snowflake dependency -->
		<dependency>
            <groupId>net.snowflake</groupId>
            <artifactId>snowflake-jdbc</artifactId>
            <version>${snowflake-jdbc.version}</version>
        </dependency>
        <dependency>
			<groupId>org.bouncycastle</groupId>
			<artifactId>bcprov-ext-jdk15on</artifactId>
			<version>${bcp.version}</version>
		</dependency>
		<dependency>
			<groupId>org.bouncycastle</groupId>
			<artifactId>bcpkix-jdk15on</artifactId>
			<version>${bcp.version}</version>
		</dependency> 
		<dependency>
			<groupId>com.nimbusds</groupId>
			<artifactId>nimbus-jose-jwt</artifactId>
			<version>9.37.4</version>
		</dependency>

	</dependencies>

    <build>
        <finalName>${project.artifactId}</finalName>
        <pluginManagement>
            <plugins>
                <plugin>
                    <groupId>org.projectlombok</groupId>
                    <artifactId>lombok-maven-plugin</artifactId>
                    <version>${lombok.version}</version>
                    <dependencies>
                        <dependency>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>${lombok.version}</version>
                        </dependency>
                    </dependencies>
                </plugin>
            </plugins>
        </pluginManagement>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.13.0</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                    <annotationProcessorPaths>
						<path>
							<groupId>org.mapstruct</groupId>
							<artifactId>mapstruct-processor</artifactId>
							<version>${org.mapstruct.version}</version>
						</path>
						<path>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
							<version>${lombok.version}</version>
						</path>
					</annotationProcessorPaths>
                </configuration>
            </plugin>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-enforcer-plugin</artifactId>
                <version>3.0.0-M2</version>
                <executions>
                    <execution>
                        <id>enforce-maven</id>
                        <goals>
                            <goal>enforce</goal>
                        </goals>
                        <configuration>
                            <rules>
                                <requireMavenVersion>
                                    <version>3.3.9</version>
                                </requireMavenVersion>
                            </rules>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <version>${spring.boot.version}</version>
                <executions>
                    <execution>
                        <goals>
                            <goal>repackage</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>pl.project13.maven</groupId>
                <artifactId>git-commit-id-plugin</artifactId>
                <version>3.0.0</version>
                <configuration>
                    <generateGitPropertiesFile>true</generateGitPropertiesFile>
                </configuration>
                <executions>
                    <execution>
                        <goals>
                            <goal>revision</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
                <configuration>
                    <skip>${surefire.skip}</skip>
                </configuration>
            </plugin>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-failsafe-plugin</artifactId>
                <executions>
                    <execution>
                        <id>integration-test</id>
                        <goals>
                            <goal>integration-test</goal>
                        </goals>
                    </execution>
                    <execution>
                        <id>verify</id>
                        <goals>
                            <goal>verify</goal>
                        </goals>
                    </execution>
                </executions>
                <configuration>
                    <skip>${failsafe.skip}</skip>
                </configuration>
            </plugin>

            <plugin>
                <groupId>org.jacoco</groupId>
                <artifactId>jacoco-maven-plugin</artifactId>
                <version>${jacoco.version}</version>
            </plugin>

        </plugins>
    </build>
</project>


	

