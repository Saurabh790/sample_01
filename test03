package com.optum.fads.pgp.reportsection.api.service;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

import java.util.List;
import java.util.Optional;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UsernameNotFoundException;

import com.optum.fads.pgp.reportsection.api.domain.SeSurGrpModAccess;
import com.optum.fads.pgp.reportsection.api.domain.UiUserBase;
import com.optum.fads.pgp.reportsection.api.dto.AppUser;
import com.optum.fads.pgp.reportsection.api.repo.UserRepository;
import com.optum.fads.pgp.reportsection.api.service.impl.UserDetailsService;

@ExtendWith(MockitoExtension.class)
class UserDetailsServiceTest {

    @Mock
    private UserRepository userRepository;

    @InjectMocks
    private UserDetailsService service;

    @Test
    void loadUserByUsername_userNotFound_throws() {
        when(userRepository.findByUiEMailAddressOrUiUserId(eq("abc"), eq("abc")))
                .thenReturn(Optional.empty());

        assertThrows(UsernameNotFoundException.class, () -> service.loadUserByUsername("abc"));
    }

    @Test
    void loadUserByUsername_userFound_mapsRoleAndAccesses() {
        UiUserBase uiUserBase = mock(UiUserBase.class, RETURNS_DEEP_STUBS);

        // basic fields
        when(uiUserBase.getUiEMailAddress()).thenReturn("u@x.com");
        when(uiUserBase.getUiUserId()).thenReturn("user1");
        when(uiUserBase.getUiSystemId()).thenReturn("SYS-1");

        // deep stubs for role (group)
        when(uiUserBase.getSeUsrGrp().getSeSurGrp().getSurGrpId()).thenReturn(10);
        when(uiUserBase.getSeUsrGrp().getSeSurGrp().getSurGrpName()).thenReturn("Admin");

        // one module access
        SeSurGrpModAccess modAccess = mock(SeSurGrpModAccess.class, RETURNS_DEEP_STUBS);
        when(modAccess.getId().getSurModuleId()).thenReturn("REPORT_SECTION");
        when(modAccess.getSeSurModule().getSurModuleName()).thenReturn("Report Section");
        when(modAccess.getSeSurAccess().getSurAccessId()).thenReturn(2);

        when(uiUserBase.getSeUsrGrp().getSeSurGrp().getSeSurGrpModAccesses())
                .thenReturn(List.of(modAccess));

        when(userRepository.findByUiEMailAddressOrUiUserId(anyString(), anyString()))
                .thenReturn(Optional.of(uiUserBase));

        UserDetails out = service.loadUserByUsername("user1");

        assertNotNull(out);
        assertTrue(out instanceof AppUser);

        AppUser user = (AppUser) out;
        assertEquals("u@x.com", user.getUserEmail());
        assertEquals("user1", user.getUserId());
        assertEquals("SYS-1", user.getUserSystemId());

        assertNotNull(user.getRole());
        assertEquals("10", user.getRole().getId());
        assertEquals("Admin", user.getRole().getRoleName());

        assertNotNull(user.getRole().getAllowedAccesses());
        assertEquals(1, user.getRole().getAllowedAccesses().size());
        assertEquals("REPORT_SECTION", user.getRole().getAllowedAccesses().get(0).getModuleId());

        verify(userRepository).findByUiEMailAddressOrUiUserId(eq("user1"), eq("user1"));
    }
}
