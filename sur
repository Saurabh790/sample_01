/*
//***********************************************
// Copyright UNITEDHEALTH GROUP CORPORATION 2018.
// This software and documentation contain confidential and
// proprietary information owned by UnitedHealth Group Corporation.
// Unauthorized use and distribution are prohibited.
//***********************************************
*/

package com.optum.fads.pgp.jobs.api.controller;

import com.optum.fads.pgp.jobs.api.common.FadsConfigProperties;
import com.optum.fads.pgp.jobs.api.common.JobsConstants;
import com.optum.fads.pgp.jobs.api.common.ListTableParams;
import com.optum.fads.pgp.jobs.api.common.ListTableParamsReq;
import com.optum.fads.pgp.jobs.api.dto.FadsUser;
import com.optum.fads.pgp.jobs.api.dto.JobDTO;
import com.optum.fads.pgp.jobs.api.dto.PaginationResult;
import com.optum.fads.pgp.jobs.api.exception.JobsMonitorApiException;
import com.optum.fads.pgp.jobs.api.exception.Validate;
import com.optum.fads.pgp.jobs.api.service.IJobMonitorDataService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.SpringVersion;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.WebDataBinder;
import org.springframework.web.bind.annotation.*;

import java.io.StringReader;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

/**
 * Use this class to add the methods so that a single web service can be used to
 * get and update the FADS Jobs data
 * <p>
 * * @author Anil Wagh
 */

@RestController
public class JobMonitorController {

    private static final Logger logit = LoggerFactory
            .getLogger(JobMonitorController.class);
    private static final List<Integer> nonCancelledList = Arrays.asList(14, 15, 18, 20);
    @Autowired
    IJobMonitorDataService iJobMonitorDataService;

    final String[] DISALLOWED_FIELDS = new String[]{"listTableParams.selectedItemIds"};

    @InitBinder(value = "listTableParams")
    void initListTableParamsValidator(WebDataBinder binder) {
        binder.setDisallowedFields(DISALLOWED_FIELDS);
    }


    /**
     * this method will give the jobs records data by filter/sort criteria
     *
     * @param - ListTableParams (contains sort, filter conditions; page number, page size)
     */

    @GetMapping(value = {"/getjobs/"}, headers = "Accept=application/json")
    public ResponseEntity getJobsByParms(ListTableParamsReq listTableParamsReq,String searchInput) {
        PaginationResult paginationResult;
        try {
    		ListTableParams listTableParams=new ListTableParams();
    		listTableParams.setPageNumber(listTableParamsReq.getPageNumber());
    		listTableParams.setRecordsPerPage(listTableParamsReq.getRecordsPerPage());
    		listTableParams.setSearchBy(listTableParamsReq.getSearchBy());
    		listTableParams.setSearchInput(Collections.singletonList(searchInput));
    		listTableParams.setSelectedItemIds(listTableParamsReq.getSelectedItemIds());
    		listTableParams.setSortBy(listTableParamsReq.getSortBy());
    		listTableParams.setSortOrder(listTableParamsReq.getSortOrder());
            logit.info("version: " + SpringVersion.getVersion());
            paginationResult = iJobMonitorDataService.getJobsByListTableParms(listTableParams);
        } catch (JobsMonitorApiException ex) {
            logit.error(JobsConstants.JOB_DETAILS_NOT_FOUND, ex.getMessage());
            return ResponseEntity
                .status(HttpStatus.BAD_REQUEST)
                .body(JobsConstants.JOB_DETAILS_NOT_FOUND);
        }
        return ResponseEntity
                .status(HttpStatus.OK)
                .body(paginationResult);
    }

    /**
     * this method will get the job record corresponding to input Job ID
     *
     * @param - Job ID
     */

    @GetMapping(value = "/getjobdetails/{jobId}")
    public ResponseEntity getJobDetailsById(@PathVariable(name = "jobId") Integer jobMasterRecId) {
        JobDTO jobDTO = null;
        HttpStatus httpStatus = HttpStatus.OK;
        try {
            jobDTO = iJobMonitorDataService.getJobDetailsById(jobMasterRecId);
        } catch (JobsMonitorApiException ex) {
            logit.error(JobsConstants.JOB_DETAILS_NOT_FOUND, ex.getMessage());
            return ResponseEntity
                    .status(httpStatus)
                    .body(JobsConstants.JOB_DETAILS_NOT_FOUND);
        }

        return ResponseEntity
                .status(httpStatus)
                .body(jobDTO);
    }

    /**
     * this method will cancel job corresponding to input Job ID   (set its status to = 14)
     *
     * @param - Job ID
     */

    @PutMapping(value = "/canceljob/{jobId}")
    public ResponseEntity canceljobById(@PathVariable(name = "jobId") Integer jobId) {
        String retStatus;
        HttpStatus httpStatus = HttpStatus.OK;
        try {
            FadsUser user = (FadsUser) SecurityContextHolder.getContext().getAuthentication().getPrincipal();
            JobDTO jobDTO = iJobMonitorDataService.getJobDetailsById(jobId);
            if (null == jobDTO) {
                return ResponseEntity.
                        status(HttpStatus.BAD_REQUEST)
                        .body(JobsConstants.JOB_ID_DOES_NOT_EXIST);
            }
            boolean verifyStatus = nonCancelledList.stream().anyMatch((i) -> i == jobDTO.getStatus());
            if (verifyStatus) {
                logit.info("Job ID {} with status = {} is already complete, failed,  cancelled or scheduled for purge",
                        jobId, jobDTO.getStatus());
                return ResponseEntity.
                        status(HttpStatus.BAD_REQUEST)
                        .body(JobsConstants.CANCEL_JOB_INVALID_REQUEST);
            }
            jobDTO.setModifiedBy(user.getUserSystemId());
            retStatus = iJobMonitorDataService.cancelJob(jobDTO);

        } catch (JobsMonitorApiException ex) {
            logit.error(JobsConstants.CANCELLING_JOB_NOT_FOUND_MSG, ex.getMessage());
            return ResponseEntity.
                    status(HttpStatus.BAD_REQUEST)
                    .body(JobsConstants.CANCELLING_JOB_NOT_FOUND_MSG);
        }
        if (!retStatus.equals(JobsConstants.JOB_CANCELED)) {
            httpStatus = HttpStatus.BAD_REQUEST;
        }
        return ResponseEntity
                .status(httpStatus)
                .body(retStatus);
    }

    /**
     * this method will purge job corresponding to input Job ID   (set its status to = 15, purge flag = 1)
     *
     * @param - Transfer Object jobDTO
     */

    @DeleteMapping(value = "/purgejob/{jobId}")
    public ResponseEntity purgeJobsByJobId(@PathVariable(name = "jobId") Integer jobId) {
        logit.info("Started JobMonitorController : purgeJobsByJobId()");
        String retStatus;
        HttpStatus httpStatus = HttpStatus.OK;
        try {
            FadsUser user = (FadsUser) SecurityContextHolder.getContext().getAuthentication().getPrincipal();
            JobDTO jobDTO = iJobMonitorDataService.getJobDetailsById(jobId);
            int statusCd = jobDTO.getStatus();
            long caseCount = jobDTO.getCaseCount();
            Validate.assertTrue(caseCount > 0, JobsConstants.NON_ZERO_CASE_COUNT, HttpStatus.BAD_REQUEST);
            Validate.assertTrue((statusCd == 1 || statusCd == 15 || (statusCd >= 6 && statusCd <= 12)), JobsConstants.PURGE_JOB_INVALID_REQUEST, HttpStatus.BAD_REQUEST);
            retStatus = iJobMonitorDataService.purgeJob(jobDTO);
            logit.error("retstatus: {}", retStatus);
        } catch (JobsMonitorApiException ex) {
            logit.error(JobsConstants.EXCEPTION_MESSAGE, ex.getMessage());
            return ResponseEntity
                    .status(ex.getHttpStatus())
                    .body(ex.getErrorsInfo());
        }
        if (!retStatus.equals(JobsConstants.JOB_PURGED)) {
            httpStatus = HttpStatus.BAD_REQUEST;
        }
        logit.info("Completed JobMonitorController : purgeJobsByJobId()");
        return ResponseEntity
                .status(httpStatus)
                .body(retStatus);
    }

    /**
     * this method will check if the job scheduled and purge dates can be changed for input  for the input Job IDs and dates
     *
     * @param - Job ID
     */

    @GetMapping(value = "/changedates/{jobId}")
    public ResponseEntity changeDateById(@PathVariable(name = "jobId") Integer jobMasterRecId) {
        String retStatus;
        try {
            retStatus = iJobMonitorDataService.changeDatesById(jobMasterRecId);
        } catch (JobsMonitorApiException ex) {
            logit.error(JobsConstants.CHANGE_DATE_NOT_FOUND_MSG, ex.getMessage());
            return ResponseEntity.
                    status(HttpStatus.BAD_REQUEST)
                    .body(JobsConstants.CHANGE_DATE_NOT_FOUND_MSG);
        }
        return ResponseEntity
                .status(HttpStatus.OK)
                .body(retStatus);
    }

    /**
     * this method will change the job scheduled date corresponding to input Job ID and date
     *
     * @param - Transfer Object jobDTO
     */

    @PutMapping(value = "/changescheduledate")
    public ResponseEntity changeScheduleDateById(@RequestBody JobDTO jobDTO) {
        logit.info("Started JobMonitorController : changeScheduleDateById()");
        String retStatus;
        HttpStatus httpStatus = HttpStatus.OK;
        try {
            FadsUser user = (FadsUser) SecurityContextHolder.getContext().getAuthentication().getPrincipal();
            jobDTO.setModifiedBy(user.getUserSystemId());
            int jobStatus = jobDTO.getStatus();
            Validate.assertTrue((jobStatus != 1 && jobStatus != 3), JobsConstants.CHANGE_RUN_DATE_INVALID_REQUEST, HttpStatus.BAD_REQUEST);// Project Study Submitted or Waiting for stage 1 or 2 to begin
            retStatus = iJobMonitorDataService.changeScheduleDateById(jobDTO);
        } catch (JobsMonitorApiException ex) {
            logit.error(JobsConstants.EXCEPTION_MESSAGE, ex.getMessage());
            return ResponseEntity.
                    status(ex.getHttpStatus())
                    .body(ex.getErrorsInfo());
        }
        if (!retStatus.equals(JobsConstants.RUN_DATE_SAVED)) {
            httpStatus = HttpStatus.BAD_REQUEST;
        }
        logit.info("Completed JobMonitorController : changeScheduleDateById()");
        return ResponseEntity
                .status(httpStatus)
                .body(retStatus);
    }

    /**
     * this method will change the purge date corresponding to input Job ID and date
     *
     * @param - Transfer Object jobDTO
     */

    @PutMapping(value = "/changepurgedate")
    public ResponseEntity changePurgeDateById(@RequestBody JobDTO jobDTO) {
        logit.info("Started JobMonitorController : changePurgeDateById()");
        String retStatus;
        HttpStatus httpStatus = HttpStatus.OK;
        try {
            FadsUser user = (FadsUser) SecurityContextHolder.getContext().getAuthentication().getPrincipal();
            // jobDTO.setModifiedBy(user.getUsername());
            jobDTO.setUpdatedBySystemId(user.getUserSystemId());
            Validate.assertTrue(jobDTO.getStatus() != 20, JobsConstants.CHANGE_PURGE_DATE_INVALID_REQUEST, HttpStatus.BAD_REQUEST);
            retStatus = iJobMonitorDataService.changePurgeDateById(jobDTO);
        } catch (JobsMonitorApiException ex) {
            logit.error(JobsConstants.JOB_DETAILS_NOT_FOUND, ex.getMessage());
            return ResponseEntity.
                    status(HttpStatus.BAD_REQUEST)
                    .body(JobsConstants.CHANGE_PURGE_DATE_NOT_FOUND_MSG);
        }
        if (!retStatus.equals(JobsConstants.PURGE_DATE_SAVED)) {
            httpStatus = HttpStatus.BAD_REQUEST;
        }
        logit.info("Completed JobMonitorController : changePurgeDateById()");
        return ResponseEntity
                .status(httpStatus)
                .body(retStatus);
    }

    /**
     * this method will get the COGNOS report URL corresponding to option code 300 in FADS-_CONFIG_T
     *
     * @param - Job ID
     */

    @GetMapping(value = "/getreporturl/{optionCode}")
    public ResponseEntity getreportURL(@PathVariable(name = "optionCode") long optionCd) {
        String cognosReportURL;
        HttpStatus httpStatus = HttpStatus.OK;
        try {
            cognosReportURL = iJobMonitorDataService.getReportUrlByOptionCd(optionCd);
        } catch (JobsMonitorApiException ex) {
            logit.error(JobsConstants.REPORT_URL_NOT_FOUND_MSG, ex.getMessage());
            return ResponseEntity.
                    status(HttpStatus.BAD_REQUEST)
                    .body(JobsConstants.REPORT_URL_NOT_FOUND_MSG);
        }

        return ResponseEntity
                .status(httpStatus)
                .body(cognosReportURL);
    }

    /**
     * this method will give the jobs records data by filter/sort criteria
     *
     * @param - ListTableParams (contains sort, filter conditions; page number, page size)
     */

    @GetMapping(value = {"/getmyjobs/"}, headers = "Accept=application/json")
    public ResponseEntity getMyJobsByParms(ListTableParams listTableParams) {
        PaginationResult paginationResult;
        try {
            Authentication auth = SecurityContextHolder.getContext().getAuthentication();
            if (auth != null) {
                FadsUser user = (FadsUser) auth.getPrincipal();
                if (listTableParams.getSearchBy() == null) {
                    listTableParams.setSearchBy(new ArrayList<String>());
                    listTableParams.setSearchInput(new ArrayList<String>());
                }
                listTableParams.getSearchBy().add(JobsConstants.USER_SYSTEM_ID);
                listTableParams.getSearchInput().add(user.getUserSystemId());
            }
            paginationResult = iJobMonitorDataService.getJobsByListTableParms(listTableParams);
        } catch (JobsMonitorApiException ex) {
            logit.error(JobsConstants.MY_JOBS_NOT_FOUND_MSG, ex.getMessage());
            return ResponseEntity.
                    status(HttpStatus.BAD_REQUEST)
                    .body(JobsConstants.MY_JOBS_NOT_FOUND_MSG);
        }
        return ResponseEntity
                .status(HttpStatus.OK)
                .body(paginationResult);
    }

    /**
     * this method will give the case ids against job id
     *
     * @param - Job ID
     */
    @GetMapping(value = "/getCasesDetails/{jobId}")
    public ResponseEntity getCasesDetailsByJobId(@PathVariable(name = "jobId") Integer jobId) {
        List<String> casesDetailsByJobId;
        try {
            casesDetailsByJobId = iJobMonitorDataService.getCasesDetailsByJobId(jobId);
        } catch (JobsMonitorApiException ex) {
            logit.error(JobsConstants.CASES_DETAILS_NOT_FOUND_MSG, ex.getMessage());
            return ResponseEntity.
                    status(HttpStatus.BAD_REQUEST)
                    .body(JobsConstants.CASES_DETAILS_NOT_FOUND_MSG);
        }
        return ResponseEntity
                .status(HttpStatus.OK)
                .body(casesDetailsByJobId);
    }

    /**
     * This method retrieves FADS configuration details based on the provided list of option codes
     *
     * @param - optionCodes - A list of option codes for which the FADS configuration details are to be retrieved.
     */

     @GetMapping(value = "/getFadsConfigDetails")
     public ResponseEntity getFadsConfigDetails(@RequestParam(name = "optionCodes")  List<String> optionCodes) {
         List<Long> cd;
         List<FadsConfigProperties> fadsConfigData;
         HttpStatus httpStatus = HttpStatus.OK;
         try {
            cd = optionCodes.stream()
                    .map(Long::parseLong)
                    .collect(Collectors.toList());
             fadsConfigData = iJobMonitorDataService.getFadsConfigByIds(cd);
         } catch (JobsMonitorApiException ex) {
            logit.error(JobsConstants.FADS_CONFIG_DETAILS_NOT_FOUND_MSG, ex.getMessage());
             return ResponseEntity.
                     status(HttpStatus.BAD_REQUEST)
                     .body(JobsConstants.FADS_CONFIG_DETAILS_NOT_FOUND_MSG);
         } catch (NumberFormatException ex) {
            return ResponseEntity
                    .status(HttpStatus.BAD_REQUEST)
                    .body("Invalid option code format");
         }
 
         return ResponseEntity
                 .status(httpStatus)
                 .body(fadsConfigData);
     }

}
