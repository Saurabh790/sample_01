import org.springframework.batch.item.database.JdbcCursorItemReader;
import org.springframework.batch.item.database.builder.JdbcCursorItemReaderBuilder;
import org.springframework.jdbc.core.BeanPropertyRowMapper;
import org.springframework.jdbc.core.PreparedStatementSetter;
import org.springframework.batch.core.configuration.annotation.StepScope;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.sql.DataSource;
import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.SQLException;

@Configuration
public class InvoiceAggregationConfig {

  @Bean
  @StepScope
  public JdbcCursorItemReader<InvoiceSummary> invoiceSummaryReader(
      DataSource dataSource,
      @Value("#{jobParameters['runId']}") String runId,
      @Value("#{jobParameters['invoiceDate']}") String invoiceDateStr
  ) {

    final String runIdFinal = runId;
    final String invoiceDateFinal =
        (invoiceDateStr == null || invoiceDateStr.isBlank()) ? "2026-01-24" : invoiceDateStr;

    String sql =
        "SELECT run_id AS runId, customer_id AS customerId, invoice_date AS invoiceDate, " +
        "       ROUND(SUM(base_amount),2) AS totalGross, " +
        "       ROUND(SUM(discount),2) AS totalDiscount, " +
        "       ROUND(SUM(tax),2) AS totalTax, " +
        "       ROUND(SUM(commission),2) AS totalCommission, " +
        "       ROUND(SUM(net_amount),2) AS totalNet " +
        "FROM FINAL_TXN_LINE " +
        "WHERE run_id = ? AND invoice_date = ? " +
        "GROUP BY run_id, customer_id, invoice_date " +
        "ORDER BY customer_id";

    PreparedStatementSetter pss = new PreparedStatementSetter() {
      @Override
      public void setValues(PreparedStatement ps) throws SQLException {
        ps.setString(1, runIdFinal);
        ps.setDate(2, Date.valueOf(invoiceDateFinal));
      }
    };

    return new JdbcCursorItemReaderBuilder<InvoiceSummary>()
        .name("invoiceSummaryReader")
        .dataSource(dataSource)
        .sql(sql)
        .preparedStatementSetter(pss)
        .rowMapper(new BeanPropertyRowMapper<>(InvoiceSummary.class))
        .build();
  }
}
