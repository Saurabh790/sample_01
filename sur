package com.optum.fads.caseentrybatch.api.config;

import javax.sql.DataSource;

import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.boot.jdbc.DataSourceBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.jdbc.datasource.DriverManagerDataSource;
import org.springframework.orm.jpa.JpaTransactionManager;
import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.annotation.EnableTransactionManagement;

import com.azure.security.keyvault.secrets.SecretClient;

import jakarta.persistence.EntityManagerFactory;

/**
 * @author sbajaj8
 *
 */
@Configuration
@EnableAutoConfiguration(exclude={DataSourceAutoConfiguration.class})
@EnableTransactionManagement
@EnableJpaRepositories(entityManagerFactoryRef = "sqlEntityManagerFactory",
						transactionManagerRef = "txManagerSQL",
						basePackages = "com.optum.fads.caseentrybatch.api.repo" )
		public class ServiceConfigSQL 
		{
			@Value("${spring.datasource.sql.userName}")
			private String userName;

			@Value("${spring.datasource.sql.password}")
			private String password;

			@Value("${spring.datasource.sql.jdbcUrl}")
			private String url;

			@Value("${spring.datasource.sql.driverClassName}")
			private String driverClassName;

			private final SecretClient secretClient;

			public ServiceConfigSQL(SecretClient secretClient) {
				this.secretClient = secretClient;
			}

			@Primary
			@Bean(name = "fadsSQLDataSource")
			public DataSource fadsSQLDataSource() {
				String userNameValue = secretClient.getSecret(userName).getValue();
				String passwordValue = secretClient.getSecret(password).getValue();

				DriverManagerDataSource dataSource = new DriverManagerDataSource();
				dataSource.setDriverClassName(driverClassName);
				dataSource.setUsername(userNameValue);
				dataSource.setPassword(passwordValue);
				dataSource.setUrl(url);

				return dataSource;
			}
	
			@Bean(name = "sqlEntityManagerFactory")
				public LocalContainerEntityManagerFactoryBean sqlEntityManagerFactory()
					{
						LocalContainerEntityManagerFactoryBean em
								= new LocalContainerEntityManagerFactoryBean();
						em.setDataSource(fadsSQLDataSource());
						em.setPackagesToScan(
								new String[] { "com.optum.fads.caseentrybatch.api.domain" });
						HibernateJpaVendorAdapter vendorAdapter
							= new HibernateJpaVendorAdapter();
						em.setJpaVendorAdapter(vendorAdapter);
					return em;
					}
	 
	 
	 @Bean(name = "txManagerSQL")
	 public PlatformTransactionManager txManagerSQL(@Qualifier("sqlEntityManagerFactory")EntityManagerFactory sqlEntityManagerFactory)
	 {
		 JpaTransactionManager txManager = new JpaTransactionManager();
	        txManager.setEntityManagerFactory(sqlEntityManagerFactory().getObject());
	        return txManager;
	 }
	 
	}


	

