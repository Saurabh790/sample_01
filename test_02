package com.optum.fads.pgp.behavior.api.service.impl;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.when;

import java.util.ArrayList;
import java.util.Optional;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UsernameNotFoundException;

import com.optum.fads.pgp.behavior.api.domain.SeSurGrp;
import com.optum.fads.pgp.behavior.api.domain.SeUsrGrp;
import com.optum.fads.pgp.behavior.api.domain.UiUserBase;
import com.optum.fads.pgp.behavior.api.dto.AppUser;
import com.optum.fads.pgp.behavior.api.repo.UserRepository;

@ExtendWith(MockitoExtension.class)
class UserDetailsServiceTest {

    @Mock
    private UserRepository userRepository;

    @InjectMocks
    private UserDetailsService userDetailsService;

    @Test
    void loadUserByUsername_success() {
        // ---- Build UiUserBase tree ----
        UiUserBase uiUser = new UiUserBase();
        uiUser.setUiUserId("john123");
        uiUser.setUiSystemId("SYS001");
        uiUser.setUiEMailAddress("john@test.com");

        SeSurGrp group = new SeSurGrp();
        group.setSurGrpId(100);
        group.setSurGrpName("ADMIN");
        // IMPORTANT: empty access list so ModuleAccess.getByName(...) is never called
        group.setSeSurGrpModAccesses(new ArrayList<>());

        SeUsrGrp usrGrp = new SeUsrGrp();
        usrGrp.setSeSurGrp(group);

        uiUser.setSeUsrGrp(usrGrp);

        when(userRepository.findByUiEMailAddressOrUiUserId("john123", "john123"))
                .thenReturn(Optional.of(uiUser));

        // ---- Act ----
        UserDetails details = userDetailsService.loadUserByUsername("john123");

        // ---- Assert ----
        assertNotNull(details);
        assertTrue(details instanceof AppUser);

        AppUser appUser = (AppUser) details;
        assertEquals("john123", appUser.getUserId());
        assertEquals("john@test.com", appUser.getUserEmail());
        assertEquals("SYS001", appUser.getUserSystemId());

        assertNotNull(appUser.getRole());
        assertEquals("ADMIN", appUser.getRole().getRoleName());
        assertNotNull(appUser.getRole().getAllowedAccesses());
        // No accesses because we passed empty list
        assertTrue(appUser.getRole().getAllowedAccesses().isEmpty());
    }

    @Test
    void loadUserByUsername_notFound_throwsException() {
        when(userRepository.findByUiEMailAddressOrUiUserId("bad", "bad"))
                .thenReturn(Optional.empty());

        assertThrows(
                UsernameNotFoundException.class,
                () -> userDetailsService.loadUserByUsername("bad")
        );
    }
}
