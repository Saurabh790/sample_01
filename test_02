@Test
void addBehaviorPattern_success_noDr() {
    BehaviorPatternDTO dto = new BehaviorPatternDTO();
    dto.setBehaviorPatternName("BP1");
    dto.setThisBpRequiresDr(false);

    dto.setBaId("4");
    dto.setDataElementCode(123);
    dto.setDateElementCode(999);

    dto.setCreatedBySystemId("SYS1");
    dto.setModifiedBySystemId("SYS2");

    dto.setCreatedDate("12/11/2025 07:30:00 PM");
    dto.setModifiedDate("12/11/2025 07:30:00 PM");

    dto.setDataRules(new ArrayList<>());   // âœ… IMPORTANT (avoid NPE)

    when(behaviorPatternsRepository.getBehaviorPatternByName("bp1")).thenReturn(null);
    when(behaviorPatternErRepository.getExtractRuleById(-1)).thenReturn(new PrmErExtractRuleT());
    when(behaviorPatternsRepository.retrieveNextBpId()).thenReturn(100);
    when(behaviorPatternsRepository.saveAndFlush(any(PrmBpBehaviorPatsT.class)))
            .thenAnswer(inv -> inv.getArgument(0));

    BehaviorPatternDTO result = service.addBehaviorPattern(dto);

    assertNotNull(result);
    assertEquals(100, result.getBehaviorPatternId());
    assertEquals(-1, result.getErId());
}
@Test
void getBehaviorPatternById_success() {
    Integer bpId = 1;

    Object[] row = new Object[14];
    row[0] = -1;                 // erId
    row[1] = "1";                // baId
    row[2] = "BP_NAME";          // bp name
    row[3] = 100;                // dataElementCode
    row[4] = 999;                // dateElementCode
    row[5] = LocalDateTime.now();// createdDate
    row[6] = "John";             // created first
    row[7] = "Creator";          // created last
    row[8] = "SYS1";             // created system id
    row[9] = LocalDateTime.now();// modifiedDate
    row[10] = "Jane";            // modified first
    row[11] = "Updater";         // modified last
    row[12] = "SUMOF";           // sumOf
    row[13] = "DE_NAME";         // dataElementName

    when(behaviorPatternMasterRepository.retrieveBehaviorPatternById(bpId))
            .thenReturn(Collections.singletonList(row));

    // because row[0] = -1, service will call getSelectedDataRules(-1,true)
    when(behaviorPatternErDrRepository.retrieveErDrValues(-1))
            .thenReturn(Collections.emptyList());

    BehaviorPatternDTO dto = service.getBehaviorPatternById(bpId);

    assertNotNull(dto);
    assertEquals(1, dto.getBehaviorPatternId());
    assertEquals(-1, dto.getErId());
    assertEquals("BP_NAME", dto.getBehaviorPatternName());
    assertNotNull(dto.getDataRules());
}
