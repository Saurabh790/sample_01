package com.optum.fads.pgp.reportsection.api.service.impl;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.*;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.*;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.domain.Pageable;

import com.optum.fads.pgp.reportsection.api.common.ListTableParams;
import com.optum.fads.pgp.reportsection.api.common.constants.ReportSectionConstants;
import com.optum.fads.pgp.reportsection.api.domain.FadsConfigT;
import com.optum.fads.pgp.reportsection.api.domain.PrmRiRptItemT;
import com.optum.fads.pgp.reportsection.api.domain.UiUserBase;
import com.optum.fads.pgp.reportsection.api.dto.PaginationResultRI;
import com.optum.fads.pgp.reportsection.api.dto.ReportItemDTO;
import com.optum.fads.pgp.reportsection.api.exception.ReportSectionApiException;
import com.optum.fads.pgp.reportsection.api.mapper.ReportGroupDetailMapper;
import com.optum.fads.pgp.reportsection.api.repo.*;

@ExtendWith(MockitoExtension.class)
class ReportItemDataServiceTest {

    @Mock private ReportItemsRepository reportItemsRepository;
    @Mock private ReportItemFormulasRepository reportItemFormulasRepository;
    @Mock private ReportSectionItemsRepository reportSectionItemsRepository;
    @Mock private BehaviorPatternsRepository behaviorPatternsRepository;
    @Mock private BehaviorPatternErDrRepository behaviorPatternErDrRepository;
    @Mock private DataRulesRepository dataRulesRepository;
    @Mock private ReportSectionsRepository reportSectionsRepository;

    @Mock private FadsConfigRepository fadsConfigRepository;
    @Mock private ReportGroupDetailMapper reportGroupDetailMapper;

    private TestableReportItemDataService service;

    @BeforeEach
    void setup() {
        service = new TestableReportItemDataService(
                reportItemsRepository,
                reportItemFormulasRepository,
                reportSectionItemsRepository,
                behaviorPatternsRepository,
                behaviorPatternErDrRepository,
                dataRulesRepository,
                reportSectionsRepository
        );
        service.setFadsConfigRepository(fadsConfigRepository);
        service.setReportGroupDetailMapper(reportGroupDetailMapper);
    }

    // -------------------- getReportItemsList --------------------

    @Test
    void getReportItemsList_noSearch_selectedEmpty_usesGetReportItemsAndCount() {
        ListTableParams params = baseParams();
        params.setSearchBy(null);
        params.setSelectedItemIds(new ArrayList<>());

        PrmRiRptItemT ri = realRi(11, "RI-11");
        when(reportItemsRepository.getReportItems(any(Pageable.class))).thenReturn(List.of(ri));
        when(reportItemsRepository.count()).thenReturn(1L);

        PaginationResultRI out = service.getReportItemsList(params);

        assertEquals(1, out.getTotalRecordsCount());
        assertEquals(1, out.getReportItemsData().size());
        assertEquals(Integer.valueOf(11), out.getReportItemsData().get(0).getReportItemId());

        verify(reportItemsRepository).getReportItems(any(Pageable.class));
        verify(reportItemsRepository).count();
        verify(reportItemsRepository, never()).getAvailableReportItems(anyList(), any());
    }

    @Test
    void getReportItemsList_noSearch_selectedNotEmpty_usesAvailableAndCountBySize() {
        ListTableParams params = baseParams();
        params.setSearchBy(null);
        params.setSelectedItemIds(new ArrayList<>(List.of(1, 2)));

        PrmRiRptItemT ri = realRi(99, "RI-99");
        when(reportItemsRepository.getAvailableReportItems(eq(params.getSelectedItemIds()), any(Pageable.class)))
                .thenReturn(List.of(ri));
        when(reportItemsRepository.getAvailableReportItems(eq(params.getSelectedItemIds()), isNull()))
                .thenReturn(List.of(ri, realRi(100, "RI-100")));

        PaginationResultRI out = service.getReportItemsList(params);

        assertEquals(2, out.getTotalRecordsCount());
        assertEquals(1, out.getReportItemsData().size());

        verify(reportItemsRepository).getAvailableReportItems(eq(params.getSelectedItemIds()), any(Pageable.class));
        verify(reportItemsRepository).getAvailableReportItems(eq(params.getSelectedItemIds()), isNull());
        verify(reportItemsRepository, never()).count();
    }

    @Test
    void getReportItemsList_whenSearchByPresent_delegatesToSearchCriteriaMethod() {
        ListTableParams params = baseParams();
        params.setSearchBy(List.of(ReportSectionConstants.REPORT_ITEM_NAME));
        params.setSearchInput(List.of("abc"));
        params.setSelectedItemIds(new ArrayList<>());

        // make search path return empty and count 0
        when(reportItemsRepository.getReportItemsBySearchCrit(anyString(), anyString(), anyString(), any(Pageable.class)))
                .thenReturn(Collections.emptyList());
        when(reportItemsRepository.getReportItemsBySearchCrit(anyString(), anyString(), anyString(), isNull()))
                .thenReturn(Collections.emptyList());

        PaginationResultRI out = service.getReportItemsList(params);

        assertNotNull(out);
        assertEquals(0, out.getTotalRecordsCount());
        assertNotNull(out.getReportItemsData());
        assertTrue(out.getReportItemsData().isEmpty());
    }

    @Test
    void getReportItemsList_repositoryThrows_wrapsInReportSectionApiException() {
        ListTableParams params = baseParams();
        params.setSearchBy(null);
        params.setSelectedItemIds(new ArrayList<>());

        when(reportItemsRepository.getReportItems(any(Pageable.class))).thenThrow(new RuntimeException("db"));

        assertThrows(ReportSectionApiException.class, () -> service.getReportItemsList(params));
    }

    // -------------------- getReportItemsOnSearchCriteria branch routing --------------------

    @Test
    void getReportItemsOnSearchCriteria_selectedEmpty_noSpChar_callsGetReportItemsBySearchCrit() {
        ListTableParams params = baseParams();
        params.setSelectedItemIds(new ArrayList<>());
        params.setSearchBy(List.of(ReportSectionConstants.REPORT_ITEM_NAME));
        params.setSearchInput(List.of("abc"));

        PrmRiRptItemT ri = realRi(10, "abc");
        when(reportItemsRepository.getReportItemsBySearchCrit(anyString(), anyString(), anyString(), any(Pageable.class)))
                .thenReturn(List.of(ri));
        when(reportItemsRepository.getReportItemsBySearchCrit(anyString(), anyString(), anyString(), isNull()))
                .thenReturn(List.of(ri, realRi(11, "x")));

        PaginationResultRI out = service.getReportItemsOnSearchCriteria(params);

        assertEquals(2, out.getTotalRecordsCount());
        assertEquals(1, out.getReportItemsData().size());

        verify(reportItemsRepository).getReportItemsBySearchCrit(anyString(), anyString(), anyString(), any(Pageable.class));
        verify(reportItemsRepository).getReportItemsBySearchCrit(anyString(), anyString(), anyString(), isNull());
        verify(reportItemsRepository, never()).getReportItemsBySearchCritEsc(anyString(), anyString(), anyString(), any());
    }

    @Test
    void getReportItemsOnSearchCriteria_selectedEmpty_spChar_callsEscMethod() {
        ListTableParams params = baseParams();
        params.setSelectedItemIds(new ArrayList<>());
        params.setSearchBy(List.of(ReportSectionConstants.REPORT_ITEM_NAME));
        params.setSearchInput(List.of("a%"));

        PrmRiRptItemT ri = realRi(10, "a%");
        when(reportItemsRepository.getReportItemsBySearchCritEsc(anyString(), anyString(), anyString(), any(Pageable.class)))
                .thenReturn(List.of(ri));
        when(reportItemsRepository.getReportItemsBySearchCritEsc(anyString(), anyString(), anyString(), isNull()))
                .thenReturn(List.of(ri));

        PaginationResultRI out = service.getReportItemsOnSearchCriteria(params);

        assertEquals(1, out.getTotalRecordsCount());
        verify(reportItemsRepository).getReportItemsBySearchCritEsc(anyString(), anyString(), anyString(), any(Pageable.class));
    }

    @Test
    void getReportItemsOnSearchCriteria_selectedNotEmpty_noSpChar_callsGetAvailableBySearchCrit() {
        ListTableParams params = baseParams();
        params.setSelectedItemIds(new ArrayList<>(List.of(1, 2)));
        params.setSearchBy(List.of(ReportSectionConstants.REPORT_ITEM_NAME));
        params.setSearchInput(List.of("abc"));

        PrmRiRptItemT ri = realRi(10, "abc");
        when(reportItemsRepository.getAvailableReportItemsBySearchCrit(anyString(), anyString(), anyString(), anyList(), any(Pageable.class)))
                .thenReturn(List.of(ri));
        when(reportItemsRepository.getAvailableReportItemsBySearchCrit(anyString(), anyString(), anyString(), anyList(), isNull()))
                .thenReturn(List.of(ri, realRi(11, "x")));

        PaginationResultRI out = service.getReportItemsOnSearchCriteria(params);

        assertEquals(2, out.getTotalRecordsCount());
        verify(reportItemsRepository).getAvailableReportItemsBySearchCrit(anyString(), anyString(), anyString(), eq(params.getSelectedItemIds()), any(Pageable.class));
    }

    @Test
    void getReportItemsOnSearchCriteria_selectedNotEmpty_spChar_callsGetAvailableBySearchCritEsc() {
        ListTableParams params = baseParams();
        params.setSelectedItemIds(new ArrayList<>(List.of(1, 2)));
        params.setSearchBy(List.of(ReportSectionConstants.REPORT_ITEM_NAME));
        params.setSearchInput(List.of("a_"));

        PrmRiRptItemT ri = realRi(10, "a_");
        when(reportItemsRepository.getAvailableReportItemsBySearchCritEsc(anyString(), anyString(), anyString(), anyList(), any(Pageable.class)))
                .thenReturn(List.of(ri));
        when(reportItemsRepository.getAvailableReportItemsBySearchCritEsc(anyString(), anyString(), anyString(), anyList(), isNull()))
                .thenReturn(List.of(ri));

        PaginationResultRI out = service.getReportItemsOnSearchCriteria(params);

        assertEquals(1, out.getTotalRecordsCount());
        verify(reportItemsRepository).getAvailableReportItemsBySearchCritEsc(anyString(), anyString(), anyString(), eq(params.getSelectedItemIds()), any(Pageable.class));
    }

    @Test
    void getReportItemsOnSearchCriteria_myItemsIndex_selectedEmpty_routesToMyMethods() {
        ListTableParams params = baseParams();
        params.setSelectedItemIds(new ArrayList<>());
        params.setSearchBy(List.of(ReportSectionConstants.REPORT_ITEM_NAME, ReportSectionConstants.USER_SYSTEM_ID));
        params.setSearchInput(List.of("abc", "u1"));

        PrmRiRptItemT ri = realRi(10, "abc");

        when(reportItemsRepository.getMyReportItemsBySearchCrit(anyString(), anyString(), anyString(), anyString(), any(Pageable.class)))
                .thenReturn(List.of(ri));
        when(reportItemsRepository.getMyReportItemsBySearchCrit(anyString(), anyString(), anyString(), anyString(), isNull()))
                .thenReturn(List.of(ri, realRi(11, "x")));

        PaginationResultRI out = service.getReportItemsOnSearchCriteria(params);

        assertEquals(2, out.getTotalRecordsCount());
        verify(reportItemsRepository).getMyReportItemsBySearchCrit(anyString(), anyString(), anyString(), eq("u1"), any(Pageable.class));
    }

    @Test
    void getReportItemsOnSearchCriteria_whenNoRows_returnsEmptyAndCount0() {
        ListTableParams params = baseParams();
        params.setSelectedItemIds(new ArrayList<>());
        params.setSearchBy(List.of(ReportSectionConstants.REPORT_ITEM_NAME));
        params.setSearchInput(List.of("none"));

        when(reportItemsRepository.getReportItemsBySearchCrit(anyString(), anyString(), anyString(), any(Pageable.class)))
                .thenReturn(Collections.emptyList());
        when(reportItemsRepository.getReportItemsBySearchCrit(anyString(), anyString(), anyString(), isNull()))
                .thenReturn(Collections.emptyList());

        PaginationResultRI out = service.getReportItemsOnSearchCriteria(params);

        assertNotNull(out.getReportItemsData());
        assertTrue(out.getReportItemsData().isEmpty());
        assertEquals(0, out.getTotalRecordsCount());
    }

    // -------------------- protected method coverage via wrappers --------------------

    @Test
    void replReportItemName_noSpecialChars_wrapsWithPercent() {
        assertEquals("%abc%", service.callReplReportItemName("abc"));
    }

    @Test
    void replReportItemName_withPercent_escapesPercent() {
        String out = service.callReplReportItemName("a%");
        assertTrue(out.startsWith("%"));
        assertTrue(out.endsWith("%"));
        assertTrue(out.contains("\\%"));
    }

    @Test
    void replReportItemName_withUnderscore_escapesUnderscore() {
        String out = service.callReplReportItemName("a_");
        assertTrue(out.contains("\\_"));
    }

    @Test
    void getSearchCriteria_trimsMultipleSpaces_createdBy_modifiedBy() {
        ListTableParams params = baseParams();
        params.setSearchBy(List.of(ReportSectionConstants.CREATED_BY, ReportSectionConstants.MODIFIED_BY));
        params.setSearchInput(List.of("  john   doe  ", "  jane   doe  "));

        String[] crit = service.callGetSearchCriteria(params, -1);

        assertEquals("%john doe%", crit[1]);
        assertEquals("%jane doe%", crit[2]);
    }

    @Test
    void populateReportItemInd_mapsFields() {
        PrmRiRptItemT ri = realRi(44, "RI-44");
        ReportItemDTO dto = service.callPopulateReportItemInd(ri);

        assertEquals(Integer.valueOf(44), dto.getReportItemId());
        assertEquals("RI-44", dto.getReportItemName());
        assertEquals("A B", dto.getCreatedBy());
        assertEquals("C D", dto.getModifiedBy());
        assertEquals("U1", dto.getCreatedBySystemId());
        assertNotNull(dto.getCreatedDate());
        assertNotNull(dto.getModifiedDate());
    }

    // -------------------- getZoneId --------------------

    @Test
    void getZoneId_whenConfigPresent_returnsZoneFromConfig() {
        FadsConfigT cfg = new FadsConfigT();
        cfg.setOptionValue("Asia/Kolkata");

        when(fadsConfigRepository.findById(ReportSectionConstants.DATE_TIME_ZONE_ID))
                .thenReturn(Optional.of(cfg));

        ZoneId zid = service.getZoneId();
        assertEquals(ZoneId.of("Asia/Kolkata"), zid);
    }

    @Test
    void getZoneId_whenConfigMissing_returnsSystemDefault() {
        when(fadsConfigRepository.findById(ReportSectionConstants.DATE_TIME_ZONE_ID))
                .thenReturn(Optional.empty());

        ZoneId zid = service.getZoneId();
        assertEquals(ZoneId.systemDefault(), zid);
    }

    // -------------------- helpers --------------------

    private static ListTableParams baseParams() {
        ListTableParams p = new ListTableParams();
        p.setPageNumber(1);
        p.setRecordsPerPage(10);
        p.setSortBy(ReportSectionConstants.REPORT_ITEM_NAME);
        p.setSortOrder(1);
        return p;
    }

    /**
     * Build a REAL entity object instead of mocking it.
     * This avoids UnfinishedStubbingException and final/proxy issues.
     */
    private static PrmRiRptItemT realRi(int id, String name) {
        PrmRiRptItemT ri = new PrmRiRptItemT();
        ri.setRiId(id);
        ri.setReportItemName(name);
        ri.setRiCalcFmt("1");
        ri.setConstantNum(3);
        ri.setConstantDen(2);
        ri.setRiMinimumDenom(5);
        ri.setCreateDate(LocalDateTime.now());
        ri.setUpdateDate(LocalDateTime.now());

        UiUserBase cr = new UiUserBase();
        cr.setUiFirstName("A");
        cr.setUiLastName("B");
        cr.setUiSystemId("U1");

        UiUserBase upd = new UiUserBase();
        upd.setUiFirstName("C");
        upd.setUiLastName("D");
        upd.setUiSystemId("U2");

        ri.setUiUserBaseCr(cr);
        ri.setUiUserBaseUpd(upd);

        // important: avoid NPE in loops
        ri.setPrmBpRiFormulaTs(new ArrayList<>());

        return ri;
    }

    // subclass exposes protected methods safely + allows setting @Autowired fields
    static class TestableReportItemDataService extends ReportItemDataService {

        TestableReportItemDataService(ReportItemsRepository reportItemsRepository,
                                      ReportItemFormulasRepository reportItemFormulasRepository,
                                      ReportSectionItemsRepository reportSectionItemsRepository,
                                      BehaviorPatternsRepository behaviorPatternsRepository,
                                      BehaviorPatternErDrRepository behaviorPatternErDrRepository,
                                      DataRulesRepository dataRulesRepository,
                                      ReportSectionsRepository reportSectionsRepository) {
            super(reportItemsRepository,
                  reportItemFormulasRepository,
                  reportSectionItemsRepository,
                  behaviorPatternsRepository,
                  behaviorPatternErDrRepository,
                  dataRulesRepository,
                  reportSectionsRepository);
        }

        void setFadsConfigRepository(FadsConfigRepository repo) {
            setField("fadsConfigRepository", repo);
        }

        void setReportGroupDetailMapper(ReportGroupDetailMapper mapper) {
            setField("reportGroupDetailMapper", mapper);
        }

        String callReplReportItemName(String in) {
            return replReportItemName(in);
        }

        String[] callGetSearchCriteria(ListTableParams p, int idx) {
            return getSearchCriteria(p, idx);
        }

        ReportItemDTO callPopulateReportItemInd(PrmRiRptItemT ri) {
            return populateReportItemInd(ri);
        }

        private void setField(String name, Object val) {
            try {
                java.lang.reflect.Field f = ReportItemDataService.class.getDeclaredField(name);
                f.setAccessible(true);
                f.set(this, val);
            } catch (Exception e) {
                throw new RuntimeException(e);
            }
        }
    }
}
