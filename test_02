package com.optum.fads.userroles.api.controllers;

import java.security.SecureRandom;
import java.util.Collections;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.Optional;

import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

import com.optum.fads.userroles.api.common.constant.ApplicationConstants;
import com.optum.fads.userroles.api.dto.AllDropdownsResponse;
import com.optum.fads.userroles.api.dto.UserForAdmin;
import com.optum.fads.userroles.api.dto.UserListResponse;
import com.optum.fads.userroles.api.service.GroupDropdownService;
import com.optum.fads.userroles.api.service.IUserList;
import com.optum.fads.userroles.api.service.UserService;

@RestController
public class UserRolesController {

	private final IUserList userListService;
	private final UserService userService;
	private final GroupDropdownService groupDropdownService;
	private static final String DEFAULT_SORT_FIELD = "lastName";
//	private static final Map<String, String> FIELD_MAP;
	public UserRolesController(IUserList userListService, GroupDropdownService groupDropdownService,
			UserService userService) {
		this.userListService = userListService;
		this.userService = userService;
		this.groupDropdownService = groupDropdownService;
	}

//	static {
//		Map<String, String> m = new LinkedHashMap<>();
//		m.put("uiSystemId", "uiSystemId");
//		m.put("uiUserId", "uiUserId");
//		m.put("lastName", "uiLastName");
//		m.put("firstName", "uiFirstName");
//		m.put("title", "uiTitle");
//		m.put("email", "uiEMailAddress");
//		m.put("fadsGrpName", "seUsrGrp.fadsGrp.fadsGrpName");
//		m.put("surGrpName", "seUsrGrp.fadsSurGrp.surGrpName");
//		m.put("caseGrpName", "seUsrGrp.fadsCaseGrp.caseGrpName");
//		FIELD_MAP = Collections.unmodifiableMap(m);
//	}

	@GetMapping("/findAllByPageable")
	public UserListResponse getUsers(@RequestParam(defaultValue = "1") int pageNumber,
			@RequestParam(defaultValue = "10") int recordsPerPage,
			@RequestParam(defaultValue = DEFAULT_SORT_FIELD) String sortBy,
			@RequestParam(defaultValue = "1") int sortOrder, @RequestParam(required = false) String searchBy,
			@RequestParam(required = false) String searchInput) {

		String entitySortField = mapToEntityField(sortBy);

		Sort.Direction direction = (sortOrder == -1) ? Sort.Direction.DESC : Sort.Direction.ASC;
		Sort sort = Sort.by(direction, entitySortField);

		Pageable pageable = PageRequest.of(Math.max(pageNumber - 1, 0), recordsPerPage, sort);

		return userListService.getAllUsers(pageable, searchBy, searchInput);
	}

	@GetMapping("/dropdowns")
	public AllDropdownsResponse getAllDropdowns() {
		return groupDropdownService.getAllDropdowns();
	}

	@RequestMapping(method = RequestMethod.POST, value = "/saveUser", headers = "Accept=application/json")
	public @ResponseBody Map<String, String> createUser(@RequestBody UserForAdmin user) {
		Map<String, String> status = new HashMap<String, String>();
		SecureRandom rnd = new SecureRandom();

		String lastName = Optional.ofNullable(user.getLastName()).filter(v -> !v.isEmpty()).map(v -> v.substring(0, 1))
				.orElse("X");
		String firstName = Optional.ofNullable(user.getFirstName()).filter(v -> !v.isEmpty())
				.map(v -> v.substring(0, 1)).orElse("X");
		String systemId = lastName + firstName + rnd.nextInt(99_999_999);

		UserForAdmin userListItem = new UserForAdmin(systemId, user.getUserId(), user.getLastName(),
				user.getFirstName(), user.getTitle(), user.getEmail(), user.getFadsGroup(), user.getSurGroup(),
				user.getCaseGroup());

		try {
			userService.saveNewUser(userListItem);
			status.put(ApplicationConstants.STATUS, "SUCCESS");
		} catch (Exception e) {
			status.put(ApplicationConstants.STATUS, "FAILURE");
			status.put("message", e.getMessage());
		}

		return status;

	}

	@RequestMapping(method = RequestMethod.POST, value = "/updateUser", headers = "Accept=application/json")
	public @ResponseBody Map<String, String> updateUser(@RequestBody UserForAdmin user) {
		Map<String, String> status = new HashMap<String, String>();

		try {
			userService.updateUser(user);
			status.put(ApplicationConstants.STATUS, "SUCCESS");
		} catch (Exception e) {
			status.put(ApplicationConstants.STATUS, "FAILURE");
			status.put("message", e.getMessage());
		}

		return status;
	}

	private String mapToEntityField(String dtoField) {
		return switch (dtoField) {
		case "uiSystemId" -> "uiSystemId";
		case "uiUserId" -> "uiUserId";
		case "lastName" -> "uiLastName";
		case "firstName" -> "uiFirstName";
		case "title" -> "uiTitle";
		case "email" -> "uiEMailAddress";
		case "fadsGrpName" -> "seUsrGrp.fadsGrp.fadsGrpName";
		case "surGrpName" -> "seUsrGrp.fadsSurGrp.surGrpName";
		case "caseGrpName" -> "seUsrGrp.fadsCaseGrp.caseGrpName";
		default -> DEFAULT_SORT_FIELD.equals(dtoField) ? "uiLastName" : "uiLastName";
		};
	}
}



above is comntroller 
below is the service classpackage com.optum.fads.userroles.api.service.Impl;

import java.math.BigDecimal;
import java.util.List;
import java.util.Locale;
import java.util.Set;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

import com.optum.fads.userroles.api.domain.UiUserBase;
import com.optum.fads.userroles.api.dto.UserListItem;
import com.optum.fads.userroles.api.dto.UserListResponse;
import com.optum.fads.userroles.api.mapper.UserListItemMapper;
import com.optum.fads.userroles.api.repo.SeUsrGrpRepositoryD;
import com.optum.fads.userroles.api.repo.UiUserBaseRepository;
import com.optum.fads.userroles.api.service.IUserList;


@Service
public class UserListImpl implements IUserList {

	private static final Logger logger = LoggerFactory.getLogger(UserListImpl.class);
	private static final String FIELD_UI_SYSTEM_ID = "uiSystemId";
	private static final String FIELD_UI_USER_ID = "uiUserId";
	private static final String FIELD_LAST_NAME = "uiLastName";
	private static final String FIELD_FIRST_NAME = "uiFirstName";
	private static final String FIELD_TITLE = "uiTitle";
	private static final String FIELD_EMAIL = "uiEMailAddress";

	private static final String FIELD_FADS_NAME = "fadsGrpName";
	private static final String FIELD_SUR_NAME = "surGrpName";
	private static final String FIELD_CASE_NAME = "caseGrpName";

	private static final Set<BigDecimal> RESTRICTED_SET = Set.of(new BigDecimal("2"), new BigDecimal("3"));

	private final UiUserBaseRepository repository;
	private final SeUsrGrpRepositoryD SeUsrGrpRepositoryD;
	private final UserListItemMapper mapper;

	public UserListImpl(UiUserBaseRepository repository, SeUsrGrpRepositoryD SeUsrGrpRepositoryD,
			UserListItemMapper mapper) {
		this.repository = repository;
		this.SeUsrGrpRepositoryD = SeUsrGrpRepositoryD;
		this.mapper = mapper;
	}

	@Transactional(readOnly = true)
	@Override
	public UserListResponse getAllUsers(Pageable pageable, String searchBy, String searchInput) {
		Specification<UiUserBase> spec = gateByLoggedInUsersFadsGroup();

		if (StringUtils.hasText(searchBy) && StringUtils.hasText(searchInput)) {
			spec = spec.and(createSearchSpecification(searchBy, searchInput));
		}

		Page<UiUserBase> page = repository.findAll(spec, pageable);
		List<UserListItem> data = page.getContent().stream().map(mapper::toDto).toList();

		return new UserListResponse(data, page.getTotalElements());
	}

	private Specification<UiUserBase> gateByLoggedInUsersFadsGroup() {
		BigDecimal currentFadsId = resolveLoggedInFadsGrpId();

		if (currentFadsId == null || !RESTRICTED_SET.contains(currentFadsId)) {
			return Specification.where(null);
		}

		return (root, query, cb) -> {
			query.distinct(true);
			return root.get("seUsrGrp").get("fadsGrp").get("id").in(RESTRICTED_SET);
		};
	}

	private BigDecimal resolveLoggedInFadsGrpId() {
		Authentication auth = SecurityContextHolder.getContext().getAuthentication();
		if (auth == null || !StringUtils.hasText(auth.getName()))
			return null;
		logger.info("auth details "+auth);
		String uiSystemId = auth.getName(); 
		System.out.println ("auth details in sysout "+auth);
		return SeUsrGrpRepositoryD.findById(uiSystemId).map(s -> s.getFadsGrp() != null ? s.getFadsGrp().getId() : null)
				.orElse(null);
	}

	private Specification<UiUserBase> createSearchSpecification(String searchBy, String searchInput) {
		final String pattern = "%" + searchInput.toLowerCase(Locale.ROOT) + "%";

		return (root, query, cb) -> {
			query.distinct(true);

			return switch (searchBy) {
			case FIELD_UI_SYSTEM_ID, FIELD_UI_USER_ID, FIELD_LAST_NAME, FIELD_FIRST_NAME, FIELD_TITLE, FIELD_EMAIL ->
				cb.like(cb.lower(root.get(searchByToEntityColumn(searchBy))), pattern);

			case FIELD_FADS_NAME -> cb.like(cb.lower(root.get("seUsrGrp").get("fadsGrp").get("fadsGrpName")), pattern);

			case FIELD_SUR_NAME -> cb.like(cb.lower(root.get("seUsrGrp").get("fadsSurGrp").get("surGrpName")), pattern);

			case FIELD_CASE_NAME ->
				cb.like(cb.lower(root.get("seUsrGrp").get("fadsCaseGrp").get("caseGrpName")), pattern);

			default -> cb.like(cb.lower(root.get(FIELD_EMAIL)), pattern);
			};
		};
	}

	private String searchByToEntityColumn(String searchBy) {
		return switch (searchBy) {
		case FIELD_UI_SYSTEM_ID -> FIELD_UI_SYSTEM_ID;
		case FIELD_UI_USER_ID -> FIELD_UI_USER_ID;
		case FIELD_LAST_NAME -> FIELD_LAST_NAME;
		case FIELD_FIRST_NAME -> FIELD_FIRST_NAME;
		case FIELD_TITLE -> FIELD_TITLE;
		case FIELD_EMAIL -> FIELD_EMAIL;
		default -> FIELD_EMAIL;
		};
	}
}

now give me the corrected method test class 
