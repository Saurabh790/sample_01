// -------------------- createPageableReports branches --------------------

@Test
void createPageableReports_sortByModifiedDate_usesUpdateDateField() {
    ListTableParams p = baseParams();
    p.setSortBy(ReportSectionConstants.MODIFIED_DATE);
    p.setSortOrder(1); // ASC
    p.setPageNumber(1);
    p.setRecordsPerPage(5);

    Pageable pageable = service.callCreatePageable(p);

    assertEquals(0, pageable.getPageNumber());
    assertEquals(5, pageable.getPageSize());

    Sort.Order order = pageable.getSort().stream().findFirst().orElseThrow();
    assertEquals(ReportSectionConstants.UPDATE_DATE, order.getProperty());
    assertEquals(Sort.Direction.ASC, order.getDirection());
}

@Test
void createPageableReports_sortByCreatedBy_buildsTwoOrdersIgnoreCase() {
    ListTableParams p = baseParams();
    p.setSortBy(ReportSectionConstants.CREATED_BY);
    p.setSortOrder(-1); // DESC

    Pageable pageable = service.callCreatePageable(p);
    List<Sort.Order> orders = pageable.getSort().stream().toList();

    assertEquals(2, orders.size());
    assertEquals("uiUserBaseCr.uiFirstName", orders.get(0).getProperty());
    assertEquals("uiUserBaseCr.uiLastName", orders.get(1).getProperty());
    assertEquals(Sort.Direction.DESC, orders.get(0).getDirection());
    assertTrue(orders.get(0).isIgnoreCase());
    assertTrue(orders.get(1).isIgnoreCase());
}

@Test
void createPageableReports_sortByModifiedBy_buildsTwoOrdersIgnoreCase() {
    ListTableParams p = baseParams();
    p.setSortBy(ReportSectionConstants.MODIFIED_BY);
    p.setSortOrder(1); // ASC

    Pageable pageable = service.callCreatePageable(p);
    List<Sort.Order> orders = pageable.getSort().stream().toList();

    assertEquals(2, orders.size());
    assertEquals("uiUserBaseUpd.uiFirstName", orders.get(0).getProperty());
    assertEquals("uiUserBaseUpd.uiLastName", orders.get(1).getProperty());
    assertEquals(Sort.Direction.ASC, orders.get(0).getDirection());
    assertTrue(orders.get(0).isIgnoreCase());
    assertTrue(orders.get(1).isIgnoreCase());
}

// -------------------- getSearchCriteria branches --------------------

@Test
void getSearchCriteria_setsCreatedByAndModifiedBy_andTrimsExtraSpaces() {
    ListTableParams p = baseParams();
    p.setSearchBy(List.of(ReportSectionConstants.CREATED_BY, ReportSectionConstants.MODIFIED_BY));
    p.setSearchInput(List.of("  John   Smith  ", "  Mary   Jane  "));

    String[] out = service.callGetSearchCriteria(p, -1);

    assertEquals("%john smith%", out[1]);
    assertEquals("%mary jane%", out[2]);
}

@Test
void getSearchCriteria_detectsSpecialCharsInName_setsEscFlag() {
    ListTableParams p = baseParams();
    p.setSearchBy(List.of(ReportSectionConstants.REPORT_ITEM_NAME));
    p.setSearchInput(List.of("ab%cd"));

    String[] out = service.callGetSearchCriteria(p, -1);

    assertEquals(ReportSectionConstants.SEARCH_SP_CH_IN_NM_STR, out[3]);
    assertTrue(out[0].contains("\\%"));
}

@Test
void getSearchCriteria_setsUserSystemId_whenPresent() {
    ListTableParams p = baseParams();
    p.setSearchBy(List.of(ReportSectionConstants.USER_SYSTEM_ID));
    p.setSearchInput(List.of("ucr"));

    String[] out = service.callGetSearchCriteria(p, 0);

    assertEquals("ucr", out[4]);
}

// -------------------- getSelectedDataRules (covers populateDataRulesList + setCodeRangeValues) --------------------

@Test
void getSelectedDataRules_whenNoErDrRows_returnsEmptyList() {
    when(behaviorPatternErDrRepository.retrieveErDrValues(eq(123))).thenReturn(List.of());

    var out = service.getSelectedDataRules(123);

    assertNotNull(out);
    assertTrue(out.isEmpty());
    verify(dataRulesRepository, never()).getDataRulesByIds(anyList());
}

@Test
void getSelectedDataRules_whenRowsPresent_mapsCodeAndRangeValues() {
    // erdr rows -> dr ids
    var pk1 = mock(com.optum.fads.pgp.reportsection.api.domain.PrmErdrTPK.class);
    when(pk1.getDrId()).thenReturn(10);
    var erdr1 = mock(com.optum.fads.pgp.reportsection.api.domain.PrmErDrT.class);
    when(erdr1.getId()).thenReturn(pk1);

    var pk2 = mock(com.optum.fads.pgp.reportsection.api.domain.PrmErdrTPK.class);
    when(pk2.getDrId()).thenReturn(20);
    var erdr2 = mock(com.optum.fads.pgp.reportsection.api.domain.PrmErDrT.class);
    when(erdr2.getId()).thenReturn(pk2);

    when(behaviorPatternErDrRepository.retrieveErDrValues(eq(777))).thenReturn(List.of(erdr1, erdr2));

    // Build PrmDrDataRuleT mocks with nested structures used in populateDataRulesList
    var dr1 = mock(com.optum.fads.pgp.reportsection.api.domain.PrmDrDataRuleT.class);
    when(dr1.getDrId()).thenReturn(10);
    when(dr1.getDataRuleName()).thenReturn("DR-10");

    var mb = mock(com.optum.fads.pgp.reportsection.api.domain.PrmMbMasterT.class);
    when(mb.getMbCustDatadesc()).thenReturn("Element-Desc");
    when(mb.getMbCtecFid()).thenReturn(999);
    when(dr1.getPrmMbMasterT()).thenReturn(mb);

    var op = mock(com.optum.fads.pgp.reportsection.api.domain.PrmDrLuOperatorT.class);
    when(op.getOperatorDesc()).thenReturn("EQUALS");
    when(dr1.getPrmDrLuOperatorT()).thenReturn(op);

    var cr = mock(com.optum.fads.pgp.reportsection.api.domain.UiUserBase.class);
    when(cr.getUiFirstName()).thenReturn("C");
    when(cr.getUiLastName()).thenReturn("R");
    when(dr1.getUiUserBaseCr()).thenReturn(cr);

    var upd = mock(com.optum.fads.pgp.reportsection.api.domain.UiUserBase.class);
    when(upd.getUiFirstName()).thenReturn("U");
    when(upd.getUiLastName()).thenReturn("P");
    when(dr1.getUiUserBaseUpd()).thenReturn(upd);

    // code values (PrmDrSingleValuesTs)
    var singlePk = mock(com.optum.fads.pgp.reportsection.api.domain.PrmDrSingleValuesTPK.class);
    when(singlePk.getDrValue()).thenReturn("A");
    var single = mock(com.optum.fads.pgp.reportsection.api.domain.PrmDrSingleValuesT.class);
    when(single.getId()).thenReturn(singlePk);
    when(single.getDrLabel()).thenReturn("Alpha");
    when(dr1.getPrmDrSingleValuesTs()).thenReturn(List.of(single));

    // range values (PrmDrRangesTs)
    var range = mock(com.optum.fads.pgp.reportsection.api.domain.PrmDrRangesT.class);
    when(range.getDrRangeFrom()).thenReturn("1");
    when(range.getDrRangeTo()).thenReturn("10");
    when(dr1.getPrmDrRangesTs()).thenReturn(List.of(range));

    var dr2 = mock(com.optum.fads.pgp.reportsection.api.domain.PrmDrDataRuleT.class);
    when(dr2.getDrId()).thenReturn(20);
    when(dr2.getDataRuleName()).thenReturn("DR-20");
    when(dr2.getPrmMbMasterT()).thenReturn(mb);
    when(dr2.getPrmDrLuOperatorT()).thenReturn(op);
    when(dr2.getUiUserBaseCr()).thenReturn(cr);
    when(dr2.getUiUserBaseUpd()).thenReturn(upd);
    when(dr2.getPrmDrSingleValuesTs()).thenReturn(List.of());
    when(dr2.getPrmDrRangesTs()).thenReturn(List.of());

    when(dataRulesRepository.getDataRulesByIds(eq(List.of(10, 20)))).thenReturn(List.of(dr1, dr2));

    var out = service.getSelectedDataRules(777);

    assertEquals(2, out.size());
    assertEquals(Integer.valueOf(10), out.get(0).getDataRuleId());
    assertEquals("DR-10", out.get(0).getDataRuleName());

    // dr1 had both selectedValues and ranges => rangeValue should end up HAS_VALUE
    assertNotNull(out.get(0).getSelectedValues());
    assertEquals(1, out.get(0).getSelectedValues().size());
    assertEquals("Alpha", out.get(0).getSelectedValues().get(0).getValue());
    assertEquals("A", out.get(0).getSelectedValues().get(0).getCode());

    assertNotNull(out.get(0).getRangeValues());
    assertEquals(1, out.get(0).getRangeValues().size());
    assertEquals("1", out.get(0).getRangeValues().get(0).getFrom());
    assertEquals("10", out.get(0).getRangeValues().get(0).getTo());
}

// -------------------- getBehaviorPatterns --------------------

@Test
void getBehaviorPatterns_mapsProjectionAndCallsSelectedDataRules() {
    // report item formula -> bpId + type + operator
    var pk = new com.optum.fads.pgp.reportsection.api.domain.PrmBpRiFormulaTPK();
    pk.setBpId(500);
    pk.setRibpType(ReportSectionConstants.NUM_STR);

    var formula = new com.optum.fads.pgp.reportsection.api.domain.PrmBpRiFormulaT();
    formula.setId(pk);
    formula.setOperatorExp("+");

    PrmRiRptItemT ri = realRi(1, "RI-1");
    ri.setPrmBpRiFormulaTs(List.of(formula));

    // repository projection row (Object[])
    Object[] row = new Object[]{
            777,            // [0] erId
            "BA",           // [1] baId
            "BP-500",       // [2] name
            100,            // [3] dataElementCode
            null,           // [4] dateElementCode
            new java.util.Date(), // [5] createdDate
            "C",            // [6] createdFirst
            "R",            // [7] createdLast
            new java.util.Date(), // [8] modifiedDate
            "U",            // [9] modifiedFirst
            "P",            // [10] modifiedLast
            "SUMOF",        // [11]
            "DE-NAME"       // [12]
    };

    when(behaviorPatternsRepository.retrieveBehaviorPatternById(eq(500))).thenReturn(List.of(row));

    // Spy to avoid deep data rule mapping here (we already tested getSelectedDataRules separately)
    ReportItemDataService spy = spy(service);
    doReturn(List.of()).when(spy).getSelectedDataRules(eq(777));

    var out = spy.getBehaviorPatterns(ri);

    assertEquals(1, out.size());
    assertEquals(Integer.valueOf(500), out.get(0).getBehaviorPatternId());
    assertEquals(Integer.valueOf(777), out.get(0).getErId());
    assertEquals(ReportSectionConstants.NUM_STR, out.get(0).getType());
    assertEquals("+", out.get(0).getOperator());

    verify(behaviorPatternsRepository).retrieveBehaviorPatternById(500);
    verify(spy).getSelectedDataRules(777);
}

@Test
void getBehaviorPatterns_whenProjectionEmpty_throws() {
    var pk = new com.optum.fads.pgp.reportsection.api.domain.PrmBpRiFormulaTPK();
    pk.setBpId(501);
    pk.setRibpType(ReportSectionConstants.NUM_STR);
    var formula = new com.optum.fads.pgp.reportsection.api.domain.PrmBpRiFormulaT();
    formula.setId(pk);
    formula.setOperatorExp("+");

    PrmRiRptItemT ri = realRi(2, "RI-2");
    ri.setPrmBpRiFormulaTs(List.of(formula));

    when(behaviorPatternsRepository.retrieveBehaviorPatternById(eq(501))).thenReturn(List.of());

    assertThrows(ReportSectionApiException.class, () -> service.getBehaviorPatterns(ri));
}

// -------------------- getReportItemById --------------------

@Test
void getReportItemById_splitsNumAndDenBehaviorPatterns() {
    PrmRiRptItemT ri = realRi(88, "RI-88");
    when(reportItemsRepository.getReportItemById(eq(88))).thenReturn(ri);

    var bpNum = new com.optum.fads.pgp.reportsection.api.dto.BehaviorPatternDTO();
    bpNum.setType(ReportSectionConstants.NUM_STR);

    var bpDen = new com.optum.fads.pgp.reportsection.api.dto.BehaviorPatternDTO();
    bpDen.setType("DEN");

    ReportItemDataService spy = spy(service);
    doReturn(List.of(bpNum, bpDen)).when(spy).getBehaviorPatterns(eq(ri));

    var out = spy.getReportItemById(88);

    assertNotNull(out);
    assertEquals(Integer.valueOf(88), out.getReportItemId());
    assertEquals(1, out.getNumeratorBehaviorPatterns().size());
    assertEquals(1, out.getDenominatorBehaviorPatterns().size());
}

@Test
void getReportItemById_whenNullFromRepo_throwsNoData() {
    when(reportItemsRepository.getReportItemById(eq(999))).thenReturn(null);
    assertThrows(ReportSectionApiException.class, () -> service.getReportItemById(999));
}

// -------------------- getAvailableBehaviorPatterns (covers populatebehaviorPatternDTO) --------------------

@Test
void getAvailableBehaviorPatterns_whenReportItemMissing_throws() {
    when(reportItemsRepository.getReportItemById(eq(10))).thenReturn(null);
    assertThrows(ReportSectionApiException.class, () -> service.getAvailableBehaviorPatterns(10));
}

@Test
void getAvailableBehaviorPatterns_mapsDtos() {
    PrmRiRptItemT ri = realRi(10, "RI-10");
    when(reportItemsRepository.getReportItemById(eq(10))).thenReturn(ri);

    var bp = mock(com.optum.fads.pgp.reportsection.api.domain.PrmBpBehaviorPatsT.class);
    when(bp.getBpId()).thenReturn(700);
    when(bp.getBehaviorPatternName()).thenReturn("BP-700");
    when(bp.getBaId()).thenReturn("BA");

    var er = mock(com.optum.fads.pgp.reportsection.api.domain.PrmErExtractRuleT.class);
    when(er.getErId()).thenReturn(777);
    when(bp.getPrmErExtractRuleT()).thenReturn(er);

    var cr = mock(com.optum.fads.pgp.reportsection.api.domain.UiUserBase.class);
    when(cr.getUiUserId()).thenReturn("creator");
    when(bp.getUiUserBaseCr()).thenReturn(cr);

    var upd = mock(com.optum.fads.pgp.reportsection.api.domain.UiUserBase.class);
    when(upd.getUiUserId()).thenReturn("updater");
    when(bp.getUiUserBaseUpd()).thenReturn(upd);

    when(behaviorPatternsRepository.getAvailableBehaviorPatterns(eq(10))).thenReturn(List.of(bp));

    var out = service.getAvailableBehaviorPatterns(10);

    assertEquals(1, out.size());
    assertEquals(Integer.valueOf(700), out.get(0).getBehaviorPatternId());
    assertEquals(Integer.valueOf(777), out.get(0).getErId());
    assertEquals("BP-700", out.get(0).getBehaviorPatternName());
    assertEquals("BA", out.get(0).getBaId());
    assertEquals("creator", out.get(0).getCreatedBy());
    assertEquals("updater", out.get(0).getModifiedBy());
}

// -------------------- addReportItem (covers saveReportItemFormulas private) --------------------

@Test
void addReportItem_whenItemExists_returnsExistsMarkerAndIds() {
    PrmRiRptItemT existing = realRi(5, "EXISTS");

    when(reportItemsRepository.getReportItemByName(eq("abc"))).thenReturn(existing);

    var dto = new com.optum.fads.pgp.reportsection.api.dto.ReportItemDTO();
    dto.setReportItemName("ABC");
    dto.setCreatedBySystemId("UCR");
    dto.setModifiedBySystemId("UUPD");

    var out = service.addReportItem(dto);

    assertEquals(Integer.valueOf(5), out.getReportItemId());
    assertEquals(ReportSectionConstants.REPORT_ITEM_EXISTS, out.getReportItemName());
    assertEquals("UUPD", out.getModifiedBySystemId());
    assertEquals("UCR", out.getCreatedBySystemId());

    verify(reportItemsRepository, never()).saveAndFlush(any());
}

@Test
void addReportItem_whenNew_savesRiAndFormulas() {
    when(reportItemsRepository.getReportItemByName(eq("newri"))).thenReturn(null);
    when(reportItemsRepository.retrieveNextRiId()).thenReturn(101);
    when(reportItemsRepository.saveAndFlush(any())).thenAnswer(inv -> inv.getArgument(0));

    var dto = new com.optum.fads.pgp.reportsection.api.dto.ReportItemDTO();
    dto.setReportItemName("NewRI");
    dto.setCalcFMT(1);
    dto.setMinimumDenominator(5);
    dto.setDivideConstant(2);
    dto.setMultipleConstant(3);
    dto.setCreatedBySystemId("UCR");
    dto.setModifiedBySystemId("UUPD");
    dto.setCreatedDate("01/09/2026 05:30:00 PM");
    dto.setModifiedDate("01/09/2026 05:30:00 PM");

    // add one BP so saveReportItemFormulas executes
    var bp = new com.optum.fads.pgp.reportsection.api.dto.BehaviorPatternDTO();
    bp.setBehaviorPatternId(500);
    bp.setOperator("+");
    bp.setType(ReportSectionConstants.NUM_STR);
    dto.setNumeratorBehaviorPatterns(List.of(bp));
    dto.setDenominatorBehaviorPatterns(List.of());

    var out = service.addReportItem(dto);

    assertEquals(Integer.valueOf(101), out.getReportItemId());
    assertEquals("NewRI", out.getReportItemName());

    verify(reportItemsRepository).saveAndFlush(any(PrmRiRptItemT.class));
    verify(reportItemFormulasRepository).saveAll(argThat(list -> list.size() == 1));
    verify(reportItemFormulasRepository).flush();
}

// -------------------- updateReportItem (covers saveReportItemFormulas + delete formulas) --------------------

@Test
void updateReportItem_whenHasBehaviorPatterns_deletesOldAndSavesNew() {
    // mapper converts dto -> entity
    PrmRiRptItemT mapped = realRi(200, "RI-200");
    when(reportGroupDetailMapper.convertToPrmRiRptItemT(any())).thenReturn(mapped);

    // existing RI for createDate
    PrmRiRptItemT existing = realRi(200, "RI-200");
    existing.setCreateDate(LocalDateTime.now().minusDays(2));
    when(reportItemsRepository.getReportItemById(eq(200))).thenReturn(existing);

    when(reportItemsRepository.saveAndFlush(any())).thenAnswer(inv -> inv.getArgument(0));
    when(reportItemFormulasRepository.deleteReportItemFormulaByRiId(eq(200))).thenReturn(3);

    var dto = new com.optum.fads.pgp.reportsection.api.dto.ReportItemDTO();
    dto.setReportItemId(200);
    dto.setReportItemName("RI-200");
    dto.setModifiedDate("01/09/2026 05:30:00 PM");

    var bp = new com.optum.fads.pgp.reportsection.api.dto.BehaviorPatternDTO();
    bp.setBehaviorPatternId(501);
    bp.setOperator("+");
    bp.setType(ReportSectionConstants.NUM_STR);
    dto.setNumeratorBehaviorPatterns(List.of(bp));
    dto.setDenominatorBehaviorPatterns(List.of());

    String out = service.updateReportItem(200, dto);

    assertEquals(ReportSectionConstants.UPDATE_REPORT_ITEM_SUCCESS, out);
    verify(reportItemFormulasRepository).deleteReportItemFormulaByRiId(200);
    verify(reportItemFormulasRepository).saveAll(argThat(list -> list.size() == 1));
    verify(reportItemFormulasRepository).flush();
}

// -------------------- deleteReportItem branches --------------------

@Test
void deleteReportItem_whenMissing_returnsDoesNotExistMsg() {
    when(reportItemsRepository.getReportItemById(eq(1))).thenReturn(null);

    var out = service.deleteReportItem(1);

    assertEquals(1, out.size());
    assertEquals(ReportSectionConstants.REPORT_ITEM_DOES_NOT_EXIST, out.get(0));
}

@Test
void deleteReportItem_whenLinkedToSections_returnsSectionNamesAndDoesNotDelete() {
    when(reportItemsRepository.getReportItemById(eq(2))).thenReturn(realRi(2, "RI-2"));

    // rsri list (size > 1)
    var rsri1 = mock(com.optum.fads.pgp.reportsection.api.domain.PrmRsRiT.class);
    var pk1 = mock(com.optum.fads.pgp.reportsection.api.domain.PrmRsRiTPK.class);
    when(pk1.getRsId()).thenReturn(10);
    when(rsri1.getId()).thenReturn(pk1);

    var rsri2 = mock(com.optum.fads.pgp.reportsection.api.domain.PrmRsRiT.class);
    var pk2 = mock(com.optum.fads.pgp.reportsection.api.domain.PrmRsRiTPK.class);
    when(pk2.getRsId()).thenReturn(20);
    when(rsri2.getId()).thenReturn(pk2);

    when(reportSectionItemsRepository.getRsRisByRiId(eq(2))).thenReturn(List.of(rsri1, rsri2));

    var rsA = mock(com.optum.fads.pgp.reportsection.api.domain.PrmRsRptSecT.class);
    when(rsA.getReportSectionName()).thenReturn("RS-A");
    var rsB = mock(com.optum.fads.pgp.reportsection.api.domain.PrmRsRptSecT.class);
    when(rsB.getReportSectionName()).thenReturn("RS-B");

    when(reportSectionsRepository.getReportSectionByIds(eq(List.of(10, 20)))).thenReturn(List.of(rsA, rsB));

    var out = service.deleteReportItem(2);

    assertEquals(2, out.size());
    assertTrue(out.get(0).contains("RS-A") || out.get(1).contains("RS-A"));
    assertTrue(out.get(0).contains("RS-B") || out.get(1).contains("RS-B"));

    verify(reportItemFormulasRepository, never()).deleteReportItemFormulaByRiId(anyInt());
    verify(reportItemsRepository, never()).deleteReportItem(anyInt());
}

@Test
void deleteReportItem_whenNotLinked_deletesFormulasThenDeletesItem_successMsg() {
    when(reportItemsRepository.getReportItemById(eq(3))).thenReturn(realRi(3, "RI-3"));
    when(reportSectionItemsRepository.getRsRisByRiId(eq(3))).thenReturn(List.of());

    when(reportItemFormulasRepository.deleteReportItemFormulaByRiId(eq(3))).thenReturn(2);
    when(reportItemsRepository.deleteReportItem(eq(3))).thenReturn(1);

    var out = service.deleteReportItem(3);

    assertEquals(1, out.size());
    assertEquals(ReportSectionConstants.DELETE_REPORT_ITEM_SUCCESS, out.get(0));
}


import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

import java.time.LocalDateTime;
import java.util.List;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.extension.ExtendWith;

import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
