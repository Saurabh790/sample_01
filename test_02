@Test
void getBehaviorPatternsOnSearchCriteria_myItems_noSpecialChars() {
    ListTableParams p = new ListTableParams();
    p.setPageNumber(1);
    p.setRecordsPerPage(10);
    p.setSortBy(BehaviorPatternConstants.BEHAVIOR_PATTERN_ID);
    p.setSortOrder(0);
    p.setSelectedItemIds(new ArrayList<>());

    p.setSearchBy(Arrays.asList(
            BehaviorPatternConstants.BEHAVIOR_PATTERN_NAME,
            BehaviorPatternConstants.CREATED_BY,
            BehaviorPatternConstants.MODIFIED_BY,
            BehaviorPatternConstants.USER_SYSTEM_ID
    ));
    p.setSearchInput(Arrays.asList(
            "bpname",
            " john   doe ",
            " jane   doe ",
            "SYS1"
    ));

    PrmBpBehaviorPatsT entity = new PrmBpBehaviorPatsT();
    entity.setBpId(1);
    PrmErExtractRuleT er = new PrmErExtractRuleT(); er.setErId(-1);
    entity.setPrmErExtractRuleT(er);
    PrmMbMasterT mb = new PrmMbMasterT(); mb.setMbCtecFid(11); mb.setMbCustDatadesc("DE");
    entity.setPrmMbMasterT(mb);
    UiUserBase cr = new UiUserBase(); cr.setUiFirstName("A"); cr.setUiLastName("B"); cr.setUiSystemId("SYSCR");
    UiUserBase upd = new UiUserBase(); upd.setUiFirstName("C"); upd.setUiLastName("D"); upd.setUiSystemId("SYSUPD");
    entity.setUiUserBaseCr(cr);
    entity.setUiUserBaseUpd(upd);
    entity.setCreateDate(LocalDateTime.now());
    entity.setUpdateDate(LocalDateTime.now());
    entity.setBehaviorPatternName("bpname");
    entity.setBaId("1");

    when(behaviorPatternsRepository.getMyBehaviorPatternsBySearchCrit(
            anyString(), anyString(), anyString(), anyString(), any(Pageable.class)
    )).thenReturn(Collections.singletonList(entity));

    when(behaviorPatternsRepository.getMyBehaviorPatternsBySearchCrit(
            anyString(), anyString(), anyString(), anyString(), isNull()
    )).thenReturn(Collections.singletonList(entity));

    PaginationResult r = service.getBehaviorPatternsOnSearchCriteria(p);

    assertEquals(1, r.getTotalRecordsCount());
    assertEquals(1, r.getBehaviorPatternsData().size());
    verify(behaviorPatternsRepository).getMyBehaviorPatternsBySearchCrit(
            anyString(), anyString(), anyString(), anyString(), any(Pageable.class)
    );
}


@Test
void getBehaviorPatternsOnSearchCriteria_selectedItems_specialChars_escBranch() {
    ListTableParams p = new ListTableParams();
    p.setPageNumber(1);
    p.setRecordsPerPage(10);
    p.setSortBy(BehaviorPatternConstants.BEHAVIOR_PATTERN_ID);
    p.setSortOrder(0);
    p.setSelectedItemIds(Arrays.asList(1,2,3));

    p.setSearchBy(Collections.singletonList(BehaviorPatternConstants.BEHAVIOR_PATTERN_NAME));
    p.setSearchInput(Collections.singletonList("ab%cd")); // triggers ESC path

    PrmBpBehaviorPatsT entity = new PrmBpBehaviorPatsT();
    entity.setBpId(1);
    PrmErExtractRuleT er = new PrmErExtractRuleT(); er.setErId(-1);
    entity.setPrmErExtractRuleT(er);
    PrmMbMasterT mb = new PrmMbMasterT(); mb.setMbCtecFid(11); mb.setMbCustDatadesc("DE");
    entity.setPrmMbMasterT(mb);
    UiUserBase cr = new UiUserBase(); cr.setUiFirstName("A"); cr.setUiLastName("B"); cr.setUiSystemId("SYSCR");
    UiUserBase upd = new UiUserBase(); upd.setUiFirstName("C"); upd.setUiLastName("D"); upd.setUiSystemId("SYSUPD");
    entity.setUiUserBaseCr(cr);
    entity.setUiUserBaseUpd(upd);
    entity.setCreateDate(LocalDateTime.now());
    entity.setUpdateDate(LocalDateTime.now());
    entity.setBehaviorPatternName("ab%cd");
    entity.setBaId("1");

    when(behaviorPatternsRepository.getAvailableBehaviorPatternsBySearchCritEsc(
            anyString(), anyString(), anyString(), anyList(), any(Pageable.class)
    )).thenReturn(Collections.singletonList(entity));

    when(behaviorPatternsRepository.getAvailableBehaviorPatternsBySearchCritEsc(
            anyString(), anyString(), anyString(), anyList(), isNull()
    )).thenReturn(Collections.singletonList(entity));

    PaginationResult r = service.getBehaviorPatternsOnSearchCriteria(p);

    assertEquals(1, r.getTotalRecordsCount());
    verify(behaviorPatternsRepository).getAvailableBehaviorPatternsBySearchCritEsc(
            anyString(), anyString(), anyString(), anyList(), any(Pageable.class)
    );
}
