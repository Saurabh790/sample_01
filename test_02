@Test
void testSaveNewUser_success() {
    // Arrange
    UserForAdmin inputUser = new UserForAdmin();
    inputUser.setSystemId("JD12345678");
    inputUser.setUserId("john.doe@example.com");
    inputUser.setFirstName("John");
    inputUser.setLastName("Doe");
    inputUser.setTitle("Developer");
    inputUser.setEmail("john.doe@example.com");
    inputUser.setFadsGroup(1);
    inputUser.setSurGroup(2);
    inputUser.setCaseGroup(3);

    UiUserBase entityToSave = new UiUserBase();
    entityToSave.setUiSystemId("JD12345678");
    entityToSave.setUiUserId("john.doe@example.com");

    UiUserBase savedEntity = new UiUserBase();
    savedEntity.setUiSystemId("JD12345678");
    savedEntity.setUiUserId("john.doe@example.com");

    // Mock group entities that will be loaded inside the service
    SeFadsGrp fadsGrp = new SeFadsGrp();
    fadsGrp.setId(java.math.BigDecimal.valueOf(1));

    SeSurGrp surGrp = new SeSurGrp();
    surGrp.setId(java.math.BigDecimal.valueOf(2));

    SeCaseGrp caseGrp = new SeCaseGrp();
    caseGrp.setId(java.math.BigDecimal.valueOf(3));

    // Mock repository calls
    when(repo.existsByUiUserId("john.doe@example.com")).thenReturn(false);
    when(seUsrGrpRepository.existsByUiSystemId("JD12345678")).thenReturn(false);
    when(mapper.toEntity(inputUser)).thenReturn(entityToSave);
    when(repo.save(entityToSave)).thenReturn(savedEntity);

    // These are called from saveNewUser() to resolve the group objects
    when(seFadsGrpRepository.findById(java.math.BigDecimal.valueOf(1)))
            .thenReturn(java.util.Optional.of(fadsGrp));
    when(seSurGrpRepository.findById(java.math.BigDecimal.valueOf(2)))
            .thenReturn(java.util.Optional.of(surGrp));
    when(seCaseGrpRepository.findById(java.math.BigDecimal.valueOf(3)))
            .thenReturn(java.util.Optional.of(caseGrp));

    // Let save(...) return whatever was passed in so we can inspect it
    when(seUsrGrpRepository.save(any(SeUsrGrp.class)))
            .thenAnswer(invocation -> invocation.getArgument(0));

    // Act
    assertDoesNotThrow(() -> userService.saveNewUser(inputUser));

    // Assert basic interactions
    verify(repo, times(1)).existsByUiUserId("john.doe@example.com");
    verify(seUsrGrpRepository, times(1)).existsByUiSystemId("JD12345678");
    verify(mapper, times(1)).toEntity(inputUser);
    verify(repo, times(1)).save(entityToSave);
    verify(repo, times(1)).flush();

    // Capture the SeUsrGrp that was persisted
    ArgumentCaptor<SeUsrGrp> seUserGroupCaptor = ArgumentCaptor.forClass(SeUsrGrp.class);
    verify(seUsrGrpRepository, times(1)).save(seUserGroupCaptor.capture());

    SeUsrGrp capturedSeUserGroup = seUserGroupCaptor.getValue();

    // Types now match exactly: UiUserBase, SeFadsGrp, SeSurGrp, SeCaseGrp
    assertEquals(savedEntity, capturedSeUserGroup.getUiUserBase());
    assertSame(fadsGrp, capturedSeUserGroup.getFadsGrp());
    assertSame(surGrp, capturedSeUserGroup.getFadsSurGrp());
    assertSame(caseGrp, capturedSeUserGroup.getFadsCaseGrp());
}
