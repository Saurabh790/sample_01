package com.optum.fads.caseentrybatch.poc.batch;

import java.util.List;
import java.util.stream.Collectors;

import javax.sql.DataSource;

import org.springframework.batch.item.ItemWriter;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

@Component
public class TxnStatusUpdateWriter implements ItemWriter<ProcessedTxn> {

  private final JdbcTemplate jdbc;

  public TxnStatusUpdateWriter(DataSource dataSource) {
    this.jdbc = new JdbcTemplate(dataSource);
  }

  @Override
  public void write(List<? extends ProcessedTxn> items) {
    List<ProcessedTxn> good = items.stream()
        .filter(i -> i.getKind() == ProcessedTxn.Kind.GOOD)
        .collect(Collectors.toList());

    for (ProcessedTxn p : good) {
      jdbc.update("UPDATE TXN_SOURCE SET status='D', run_id=? WHERE txn_id=?",
          p.getRunId(), p.getTxnId());
    }

    List<ProcessedTxn> err = items.stream()
        .filter(i -> i.getKind() == ProcessedTxn.Kind.ERROR)
        .collect(Collectors.toList());

    for (ProcessedTxn p : err) {
      jdbc.update("UPDATE TXN_SOURCE SET status='E', run_id=? WHERE txn_id=?",
          p.getRunId(), p.getTxnId());
    }
  }
}


package com.optum.fads.caseentrybatch.poc.batch;

import javax.sql.DataSource;

import org.springframework.batch.item.database.BeanPropertyItemSqlParameterSourceProvider;
import org.springframework.batch.item.database.JdbcBatchItemWriter;
import org.springframework.batch.item.database.builder.JdbcBatchItemWriterBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class InvoiceAggregationWriterConfig {

  @Bean
  public JdbcBatchItemWriter<InvoiceSummary> invoiceFinalWriter(DataSource dataSource) {
    return new JdbcBatchItemWriterBuilder<InvoiceSummary>()
        .dataSource(dataSource)
        .sql(
            "INSERT INTO INVOICE_FINAL(run_id, customer_id, invoice_date, total_gross, total_discount, total_tax, total_commission, total_net, created_at) " +
            "VALUES (:runId, :customerId, :invoiceDate, :totalGross, :totalDiscount, :totalTax, :totalCommission, :totalNet, CURRENT_TIMESTAMP)"
        )
        .itemSqlParameterSourceProvider(new BeanPropertyItemSqlParameterSourceProvider<>())
        .build();
  }
}


<dependencies>
  <dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-batch</artifactId>
  </dependency>

  <dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-jdbc</artifactId>
  </dependency>

  <dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>runtime</scope>
  </dependency>

  <dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <scope>test</scope>
  </dependency>

  <dependency>
    <groupId>org.springframework.batch</groupId>
    <artifactId>spring-batch-test</artifactId>
    <scope>test</scope>
  </dependency>
</dependencies>

