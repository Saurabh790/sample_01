server:
  port: 8080

management:
  endpoint:
    gateway:
      access: read-only   # or: unrestricted
  endpoints:
    web:
      exposure:
        include: health,info,gateway
        exclude: caches, scheduledtasks, mappings, beans, heapdump, env, metrics, threaddump, loggers, configprops, conditions
  health:
    circuitbreakers:
      enabled: true
    ratelimiters:
      enabled: true

logging:
  level:
    org.springframework: INFO
    org.springframework.web.HttpLogging: INFO
    org.springframework.security: INFO
    org.springframework.security.oauth2: INFO
    org.springframework.cloud.gateway: DEBUG

spring:
  application:
    name: fads-api-gateway
  autoconfigure:
    exclude:
      - org.springframework.boot.actuate.autoconfigure.security.reactive.ReactiveManagementWebSecurityAutoConfiguration
      - org.springframework.boot.autoconfigure.security.reactive.ReactiveSecurityAutoConfiguration
      - org.springframework.boot.autoconfigure.security.oauth2.client.reactive.ReactiveOAuth2ClientAutoConfiguration
      - org.springframework.boot.autoconfigure.security.oauth2.resource.reactive.ReactiveOAuth2ResourceServerAutoConfiguration

  cloud:
    gateway:
      server:
        webflux:
          x-forwarded:
            enabled: true
          default-filters:
            - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
          routes:
            - id: authorization
              uri: https://as-pi-dev-authorization.azurewebsites.net
              predicates:
                - Path=/api/v1.0/authorization/**
              filters:
                - RewritePath=/api/v1.0/authorization/(?<segment>/?.*), /authorization/${segment}

            - id: datarules
              uri: https://as-pi-dev-datarules.azurewebsites.net
              predicates:
                - Path=/api/v1.0/datarules/**
              filters:
                - RewritePath=/api/v1.0/datarules/(?<segment>/?.*), /datarules/${segment}

            - id: behavior
              uri: https://as-pi-dev-behavior.azurewebsites.net
              predicates:
                - Path=/api/v1.0/behavior/**
              filters:
                - RewritePath=/api/v1.0/behavior/(?<segment>/?.*), /behavior/${segment}

            - id: reportgroup
              uri: https://as-pi-dev-reportgroup.azurewebsites.net
              predicates:
                - Path=/api/v1.0/reportgroup/**
              filters:
                - RewritePath=/api/v1.0/reportgroup/(?<segment>/?.*), /reportgroup/${segment}

            - id: study
              uri: https://as-pi-dev-study.azurewebsites.net
              predicates:
                - Path=/api/v1.0/study/**
              filters:
                - RewritePath=/api/v1.0/study/(?<segment>/?.*), /study/${segment}

            - id: jobmonitor
              uri: https://as-pi-dev-jobmonitor.azurewebsites.net
              predicates:
                - Path=/api/v1.0/jobmonitor/**
              filters:
                - RewritePath=/api/v1.0/jobmonitor/(?<segment>/?.*), /jobmonitor/${segment}

            - id: peergroup
              uri: https://as-pi-dev-peergroup.azurewebsites.net
              predicates:
                - Path=/api/v1.0/peergroup/**
              filters:
                - RewritePath=/api/v1.0/peergroup/(?<segment>/?.*), /peergroup/${segment}

            - id: casetracking
              uri: https://as-pi-dev-casetracking.azurewebsites.net
              predicates:
                - Path=/api/v1.0/casetracking/**
              filters:
                - RewritePath=/api/v1.0/casetracking/(?<segment>/?.*), /casetracking/${segment}

            - id: caseentry
              uri: https://as-pi-dev-caseentry.azurewebsites.net
              predicates:
                - Path=/api/v1.0/caseentry/**
              filters:
                - RewritePath=/api/v1.0/caseentry/(?<segment>/?.*), /caseentry/${segment}

            - id: caseClaimCorrections
              uri: https://as-pi-dev-casecorrection.azurewebsites.net
              predicates:
                - Path=/api/v1.0/case-claim-corrections/**
              filters:
                - RewritePath=/api/v1.0/case-claim-corrections/(?<segment>/?.*), /case-claim-corrections/${segment}

            - id: userroles
              uri: https://as-pi-dev-userroles.azurewebsites.net
              predicates:
                - Path=/api/v1.0/userroles/**
              filters:
                - RewritePath=/api/v1.0/userroles/(?<segment>/?.*), /userroles/${segment}

          globalcors:
            add-to-simple-url-handler-mapping: true
            cors-configurations:
              "[/**]":
                allowedOrigins: "*"
                allowedMethods: "*"
                allowedHeaders: "*"

resilience4j.circuitbreaker:
  instances:
    gatewayCircuitBreaker:
      registerHealthIndicator: true
      slidingWindowType: COUNT_BASED
      slidingWindowSize: 5
      minimumNumberOfCalls: 5
      permittedNumberOfCallsInHalfOpenState: 3
      waitDurationInOpenState: 30s
      failureRateThreshold: 50
      eventConsumerBufferSize: 5
      automaticTransitionFromOpenToHalfOpenEnabled: true

resilience4j.timelimiter:
  instances:
    gatewayCircuitBreaker:
      timeoutDuration: 30s
      cancelRunningFuture: true
