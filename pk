package com.optum.fads.casereminders.api.repo;

import static org.junit.jupiter.api.Assertions.*;

import java.time.LocalDateTime;
import java.util.List;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.test.context.TestPropertySource;

import com.optum.fads.casereminders.api.domain.CaEmailsT;
import com.optum.fads.casereminders.api.domain.CaEmailsTPK;

/**
 * Repository test for CaEmailsRepository.
 *
 * Uses H2 in MSSQLServer compatibility mode so GETDATE() works.
 */
@DataJpaTest
@TestPropertySource(properties = {
        // H2 in SQL Server mode so GETDATE() is supported
        "spring.datasource.url=jdbc:h2:mem:testdb;MODE=MSSQLServer;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE",
        "spring.datasource.driverClassName=org.h2.Driver",
        "spring.datasource.username=sa",
        "spring.datasource.password=",

        // Let Hibernate create tables from entities
        "spring.jpa.hibernate.ddl-auto=create-drop",
        "spring.jpa.show-sql=false"
})
class CaEmailsRepositoryTest {

    @Autowired
    private CaEmailsRepository repository;

    @Test
    void findTodaysReminders_returnsOnlyDueUnsentMatchingType() {
        // GIVEN
        saveEmail(1, 1, "REM", LocalDateTime.now().minusHours(1), "N"); // should match
        saveEmail(1, 2, "REM", LocalDateTime.now().plusDays(1), "N");   // future -> not match
        saveEmail(1, 3, "REM", LocalDateTime.now().minusHours(1), "Y"); // sent -> not match
        saveEmail(1, 4, "OTHER", LocalDateTime.now().minusHours(1), "N"); // type diff -> not match

        // WHEN
        List<CaEmailsT> results = repository.findTodaysReminders("REM");

        // THEN
        assertEquals(1, results.size());
        assertNotNull(results.get(0).getId());
        assertEquals(1, results.get(0).getId().getCaseId());
        assertEquals(1, results.get(0).getId().getSeqNum());
    }

    @Test
    void getNextSequenceId_returnsMaxPlusOne_forCaseId() {
        // GIVEN caseId=99 has seq 1 and 2
        saveEmail(99, 1, "REM", LocalDateTime.now().minusHours(1), "N");
        saveEmail(99, 2, "REM", LocalDateTime.now().minusHours(1), "N");

        // WHEN
        Integer next = repository.getNextSequenceId(99);

        // THEN
        // query is: Max(SEQ_NUM+1) => max seq 2 => returns 3
        assertEquals(3, next);
    }

    @Test
    void getNextSequenceId_whenNoRows_returnsNull() {
        Integer next = repository.getNextSequenceId(55555);
        assertNull(next);
    }

    // -------------------------
    // helper
    // -------------------------

    private CaEmailsT saveEmail(int caseId, int seqNum, String emailType, LocalDateTime remDt, String sentFlag) {
        CaEmailsTPK pk = new CaEmailsTPK();
        pk.setCaseId(caseId);
        pk.setSeqNum(seqNum);

        CaEmailsT entity = new CaEmailsT();
        entity.setId(pk);

        entity.setEmailType(emailType);
        entity.setSentFlag(sentFlag);

        // remDt type depends on your entity field type
        // If your CaEmailsT.remDt is LocalDateTime, this is perfect.
        // If it's java.util.Date or java.sql.Timestamp, convert here.
        entity.setRemDt(remDt);

        // optional fields (if required by DB constraints, set them)
        entity.setToEmail("to@test.com");
        entity.setSubjEmail("subject");
        entity.setRemComment("text");

        return repository.save(entity);
    }
}
