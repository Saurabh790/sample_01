@Test
void addBehaviorPattern_success_noDr() {
    BehaviorPatternDTO dto = new BehaviorPatternDTO();
    dto.setBehaviorPatternName("BP1");
    dto.setThisBpRequiresDr(false);

    dto.setBaId("1");
    dto.setDataElementCode(123);
    dto.setDateElementCode(999);

    dto.setCreatedBySystemId("SYS1");
    dto.setModifiedBySystemId("SYS2");

    dto.setCreatedDate("12/11/2025 07:30:00 PM");
    dto.setModifiedDate("12/11/2025 07:30:00 PM");

    when(behaviorPatternsRepository.getBehaviorPatternByName("bp1")).thenReturn(null);
    when(behaviorPatternErRepository.getExtractRuleById(-1)).thenReturn(new PrmErExtractRuleT());

    when(behaviorPatternsRepository.retrieveNextBpId()).thenReturn(100);

    // saveAndFlush called
    when(behaviorPatternsRepository.saveAndFlush(any(PrmBpBehaviorPatsT.class)))
            .thenAnswer(inv -> inv.getArgument(0));

    BehaviorPatternDTO result = service.addBehaviorPattern(dto);

    assertNotNull(result);
    assertEquals(100, result.getBehaviorPatternId());
    assertEquals(-1, result.getErId());
}
B) updateBehaviorPattern_success (avoid implementRequiresDr work)
Make erId = -1 and thisBpRequiresDr=false so implementRequiresDr does nothing.

java
Copy code
@Test
void updateBehaviorPattern_success_noDr_noDeletes() {
    BehaviorPatternDTO dto = new BehaviorPatternDTO();
    dto.setBehaviorPatternId(1);
    dto.setBehaviorPatternName("Updated BP");
    dto.setThisBpRequiresDr(false);

    dto.setBaId("1");
    dto.setDataElementCode(123);
    dto.setDateElementCode(0);

    dto.setModifiedDate("12/11/2025 07:30:00 PM");

    // mapper output used by service
    PrmBpBehaviorPatsT mapped = new PrmBpBehaviorPatsT();
    mapped.setBpId(1);
    mapped.setPrmErExtractRuleT(new PrmErExtractRuleT()); // safe
    mapped.setUiUserBaseCr(new UiUserBase());
    mapped.setUiUserBaseUpd(new UiUserBase());
    mapped.setPrmMbMasterT(new PrmMbMasterT());

    when(behaviorPatternDetailMapper.convertToPrmBpBehaviorPatsT(dto)).thenReturn(mapped);

    // used for createDate
    PrmBpBehaviorPatsT existing = new PrmBpBehaviorPatsT();
    existing.setCreateDate(LocalDateTime.now());
    when(behaviorPatternsRepository.getBehaviorPatternById(1)).thenReturn(existing);

    when(behaviorPatternsRepository.save(any(PrmBpBehaviorPatsT.class)))
            .thenAnswer(inv -> inv.getArgument(0));

    String msg = service.updateBehaviorPattern(-1, dto);
    assertEquals(BehaviorPatternConstants.UPDATE_SUCCESS_MESSAGE, msg);
}
C) updateBehaviorPattern_notFound (2 options)
✅ Option 1 (recommended): after you add the null-check in service
java
Copy code
@Test
void updateBehaviorPattern_notFound_throwsApiException() {
    BehaviorPatternDTO dto = new BehaviorPatternDTO();
    dto.setBehaviorPatternId(1);
    dto.setBehaviorPatternName("BP");
    dto.setModifiedDate("12/11/2025 07:30:00 PM");

    when(behaviorPatternDetailMapper.convertToPrmBpBehaviorPatsT(dto))
            .thenReturn(new PrmBpBehaviorPatsT());

    when(behaviorPatternsRepository.getBehaviorPatternById(1)).thenReturn(null);

    assertThrows(BehaviorPatternApiException.class,
            () -> service.updateBehaviorPattern(-1, dto));
}
Option 2 (if you don’t change service): expect NPE
java
Copy code
assertThrows(NullPointerException.class, () -> service.updateBehaviorPattern(-1, dto));
D) deleteBehaviorPattern_success (no constraint path, no ER deletes)
java
Copy code
@Test
void deleteBehaviorPattern_success() {
    PrmBpBehaviorPatsT bp = new PrmBpBehaviorPatsT();
    PrmErExtractRuleT er = new PrmErExtractRuleT();
    er.setErId(-1); // prevents ER delete calls
    bp.setPrmErExtractRuleT(er);

    when(behaviorPatternsRepository.getBehaviorPatternById(1)).thenReturn(bp);
    when(behaviorPatternMasterRepository.retrieveBpRiFormulas(1)).thenReturn(Collections.emptyList());

    when(behaviorPatternsRepository.deleteBehaviorPattern(1)).thenReturn(1);

    List<String> msgs = service.deleteBehaviorPattern(1);
    assertTrue(msgs.contains(BehaviorPatternConstants.DELETE_SUCCESS_MESSAGE));
}
E) deleteBehaviorPattern_notFound (no exception!)
java
Copy code
@Test
void deleteBehaviorPattern_notFound_returnsDoesNotExistMessage() {
    when(behaviorPatternsRepository.getBehaviorPatternById(1)).thenReturn(null);

    List<String> msgs = service.deleteBehaviorPattern(1);

    assertNotNull(msgs);
    assertTrue(msgs.contains(BehaviorPatternConstants.BEHAVIOR_PATTERN_DOES_NOT_EXIST));
}
