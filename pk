package com.optum.fads.caseentrybatch.poc.batch;

import java.util.HashMap;
import java.util.Map;

import javax.sql.DataSource;

import org.springframework.batch.core.configuration.annotation.StepScope;
import org.springframework.batch.item.database.JdbcPagingItemReader;
import org.springframework.batch.item.database.Order;
import org.springframework.batch.item.database.support.H2PagingQueryProvider;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.jdbc.core.BeanPropertyRowMapper;

@Configuration
public class TxnSourceReaderConfig {

  @Bean
  @StepScope
  public JdbcPagingItemReader<TxnSourceRow> txnSourceReader(
      DataSource dataSource,
      @Value("#{jobParameters['invoiceDate']}") String invoiceDateStr
  ) {
    if (invoiceDateStr == null || invoiceDateStr.isBlank()) {
      invoiceDateStr = "2026-01-24";
    }

    Map<String, Object> params = new HashMap<>();
    params.put("invoiceDate", java.sql.Date.valueOf(invoiceDateStr));

    H2PagingQueryProvider queryProvider = new H2PagingQueryProvider();
    queryProvider.setSelectClause(
        "SELECT s.txn_id AS txnId, s.customer_id AS customerId, s.product_id AS productId, " +
        "       s.txn_amount AS txnAmount, s.invoice_date AS invoiceDate, " +
        "       c.discount_rate AS discountRate, p.tax_rate AS taxRate"
    );
    queryProvider.setFromClause(
        "FROM TXN_SOURCE s " +
        "LEFT JOIN CUSTOMER c ON c.customer_id = s.customer_id " +
        "LEFT JOIN PRODUCT  p ON p.product_id  = s.product_id"
    );
    queryProvider.setWhereClause("WHERE s.invoice_date = :invoiceDate AND s.status = 'N'");
    queryProvider.setSortKeys(Map.of("s.txn_id", Order.ASCENDING));

    JdbcPagingItemReader<TxnSourceRow> reader = new JdbcPagingItemReader<>();
    reader.setDataSource(dataSource);
    reader.setQueryProvider(queryProvider);
    reader.setParameterValues(params);
    reader.setPageSize(10);
    reader.setRowMapper(new BeanPropertyRowMapper<>(TxnSourceRow.class));
    return reader;
  }
}
