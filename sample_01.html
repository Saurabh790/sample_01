package com.optum.fads.pgp.jobs.api.service.util;


import com.optum.fads.pgp.jobs.api.common.JobsConstants;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class ServiceUtil {
    private static final Logger logit = LoggerFactory
            .getLogger(ServiceUtil.class);

    public static String replStudyName(String searchInput) {
        StringBuilder strbldr = new StringBuilder();
        String studyNameVal;
        String replacedInput = "";
        // the space is an encoded string %20
        if (StringUtils.containsAny(searchInput, JobsConstants.SPACE_ENCODED_STR)) {
            searchInput = searchInput.replaceAll(JobsConstants.SPACE_ENCODED_STR, JobsConstants.BLANK_STR);
        }
        if (StringUtils.containsAny(searchInput, JobsConstants.PLUS_REPL_STR)) {
            searchInput = searchInput.replaceAll(JobsConstants.PLUS_REPL_STR, JobsConstants.PLUS_STR);
        }
        if (StringUtils.containsAny(searchInput, JobsConstants.COMMA_REPL_STR)) {
            searchInput = searchInput.replaceAll(JobsConstants.COMMA_REPL_STR, JobsConstants.COMMA_STR);
        }
        if (StringUtils.containsAny(searchInput, JobsConstants.PERCENT_CHAR)
                || StringUtils.containsAny(searchInput, JobsConstants.UNDERSCORE_CHAR)) {
            if (StringUtils.containsAny(searchInput, JobsConstants.PERCENT_CHAR)) {
                replacedInput = searchInput.replaceAll("\\%", "\\\\%");
            } else if (StringUtils.containsAny(searchInput, JobsConstants.UNDERSCORE_CHAR)) {
                replacedInput = searchInput.replaceAll("\\_", "\\\\_");
            } else {
                replacedInput = searchInput;
            }
            strbldr.append(JobsConstants.PERCENT_STR);
            strbldr.append(replacedInput);
            strbldr.append(JobsConstants.PERCENT_STR);
            studyNameVal = strbldr.toString();
        } else {
            studyNameVal = JobsConstants.PERCENT_STR + searchInput + JobsConstants.PERCENT_STR;
        }
        return studyNameVal;
    }

    public static String createCaseId(String caPrmNodeCd, String caScndNodeCd, Integer caSequenceId, Integer caYearId) {
        StringBuffer ikey = new StringBuffer();
        ikey.append(caPrmNodeCd);
        ikey.append("-");
        //if secondaryNode is not null, then we need to append
        if(null != caScndNodeCd && caScndNodeCd.length()>0){
            ikey.append(caScndNodeCd);
            ikey.append("-");
        }
        ikey.append(caYearId);
        ikey.append("-");
        ikey.append(getFormattedSequenceId(caSequenceId));
        return ikey.toString();
    }

    private static String getFormattedSequenceId(long number) {
        String formatNumber = "" + number;
        try {
            String format = String.format("%%0%dd", 5);
            formatNumber = String.format(format, number);
        } catch (Exception e) {
            logit.error("Error at JobMonitorUtil.getFormattedSequenceId():", e);
        }
        return formatNumber;
    }
}
