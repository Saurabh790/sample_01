package com.optum.fads.userroles.api.controllers;

import java.security.SecureRandom;
import java.util.Collections;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.Optional;

import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

import com.optum.fads.userroles.api.common.constant.ApplicationConstants;
import com.optum.fads.userroles.api.dto.AllDropdownsResponse;
import com.optum.fads.userroles.api.dto.UserForAdmin;
import com.optum.fads.userroles.api.dto.UserListResponse;
import com.optum.fads.userroles.api.service.GroupDropdownService;
import com.optum.fads.userroles.api.service.IUserList;
import com.optum.fads.userroles.api.service.UserService;

@RestController
public class UserRolesController {

	private final IUserList userListService;
	private final UserService userService;
	private final GroupDropdownService groupDropdownService;
	private static final String DEFAULT_SORT_FIELD = "lastName";
//	private static final Map<String, String> FIELD_MAP;
	public UserRolesController(IUserList userListService, GroupDropdownService groupDropdownService,
			UserService userService) {
		this.userListService = userListService;
		this.userService = userService;
		this.groupDropdownService = groupDropdownService;
	}

//	static {
//		Map<String, String> m = new LinkedHashMap<>();
//		m.put("uiSystemId", "uiSystemId");
//		m.put("uiUserId", "uiUserId");
//		m.put("lastName", "uiLastName");
//		m.put("firstName", "uiFirstName");
//		m.put("title", "uiTitle");
//		m.put("email", "uiEMailAddress");
//		m.put("fadsGrpName", "seUsrGrp.fadsGrp.fadsGrpName");
//		m.put("surGrpName", "seUsrGrp.fadsSurGrp.surGrpName");
//		m.put("caseGrpName", "seUsrGrp.fadsCaseGrp.caseGrpName");
//		FIELD_MAP = Collections.unmodifiableMap(m);
//	}

	@GetMapping("/findAllByPageable")
	public UserListResponse getUsers(@RequestParam(defaultValue = "1") int pageNumber,
			@RequestParam(defaultValue = "10") int recordsPerPage,
			@RequestParam(defaultValue = DEFAULT_SORT_FIELD) String sortBy,
			@RequestParam(defaultValue = "1") int sortOrder, @RequestParam(required = false) String searchBy,
			@RequestParam(required = false) String searchInput) {

		String entitySortField = mapToEntityField(sortBy);

		Sort.Direction direction = (sortOrder == -1) ? Sort.Direction.DESC : Sort.Direction.ASC;
		Sort sort = Sort.by(direction, entitySortField);

		Pageable pageable = PageRequest.of(Math.max(pageNumber - 1, 0), recordsPerPage, sort);

		return userListService.getAllUsers(pageable, searchBy, searchInput);
	}

	@GetMapping("/dropdowns")
	public AllDropdownsResponse getAllDropdowns() {
		return groupDropdownService.getAllDropdowns();
	}

	@RequestMapping(method = RequestMethod.POST, value = "/saveUser", headers = "Accept=application/json")
	public @ResponseBody Map<String, String> createUser(@RequestBody UserForAdmin user) {
		Map<String, String> status = new HashMap<String, String>();
		SecureRandom rnd = new SecureRandom();

		String lastName = Optional.ofNullable(user.getLastName()).filter(v -> !v.isEmpty()).map(v -> v.substring(0, 1))
				.orElse("X");
		String firstName = Optional.ofNullable(user.getFirstName()).filter(v -> !v.isEmpty())
				.map(v -> v.substring(0, 1)).orElse("X");
		String systemId = lastName + firstName + rnd.nextInt(99_999_999);

		UserForAdmin userListItem = new UserForAdmin(systemId, user.getUserId(), user.getLastName(),
				user.getFirstName(), user.getTitle(), user.getEmail(), user.getFadsGroup(), user.getSurGroup(),
				user.getCaseGroup());

		try {
			userService.saveNewUser(userListItem);
			status.put(ApplicationConstants.STATUS, "SUCCESS");
		} catch (Exception e) {
			status.put(ApplicationConstants.STATUS, "FAILURE");
			status.put("message", e.getMessage());
		}

		return status;

	}

	@RequestMapping(method = RequestMethod.POST, value = "/updateUser", headers = "Accept=application/json")
	public @ResponseBody Map<String, String> updateUser(@RequestBody UserForAdmin user) {
		Map<String, String> status = new HashMap<String, String>();

		try {
			userService.updateUser(user);
			status.put(ApplicationConstants.STATUS, "SUCCESS");
		} catch (Exception e) {
			status.put(ApplicationConstants.STATUS, "FAILURE");
			status.put("message", e.getMessage());
		}

		return status;
	}

	private String mapToEntityField(String dtoField) {
		return switch (dtoField) {
		case "uiSystemId" -> "uiSystemId";
		case "uiUserId" -> "uiUserId";
		case "lastName" -> "uiLastName";
		case "firstName" -> "uiFirstName";
		case "title" -> "uiTitle";
		case "email" -> "uiEMailAddress";
		case "fadsGrpName" -> "seUsrGrp.fadsGrp.fadsGrpName";
		case "surGrpName" -> "seUsrGrp.fadsSurGrp.surGrpName";
		case "caseGrpName" -> "seUsrGrp.fadsCaseGrp.caseGrpName";
		default -> DEFAULT_SORT_FIELD.equals(dtoField) ? "uiLastName" : "uiLastName";
		};
	}
}
