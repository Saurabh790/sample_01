package com.optum.fads.caseentrybatch.poc.batch;

import org.springframework.batch.core.configuration.annotation.StepScope;
import org.springframework.batch.item.database.JdbcBatchItemWriter;
import org.springframework.batch.item.database.JdbcCursorItemReader;
import org.springframework.batch.item.database.builder.JdbcBatchItemWriterBuilder;
import org.springframework.batch.item.database.builder.JdbcCursorItemReaderBuilder;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.jdbc.core.BeanPropertyRowMapper;

import javax.sql.DataSource;

@Configuration
public class InvoiceAggregationConfig {

  @Bean
  @StepScope
  public JdbcCursorItemReader<InvoiceSummary> invoiceSummaryReader(
      DataSource dataSource,
      @Value("#{jobParameters['runId']}") String runId,
      @Value("#{jobParameters['invoiceDate']}") String invoiceDateStr
  ) {

    final String invoiceDateFinal =
        (invoiceDateStr == null || invoiceDateStr.isBlank()) ? "2026-01-24" : invoiceDateStr;

    String sql =
        "SELECT run_id AS runId, customer_id AS customerId, invoice_date AS invoiceDate, " +
        "       ROUND(SUM(base_amount),2) AS totalGross, " +
        "       ROUND(SUM(discount),2) AS totalDiscount, " +
        "       ROUND(SUM(tax),2) AS totalTax, " +
        "       ROUND(SUM(commission),2) AS totalCommission, " +
        "       ROUND(SUM(net_amount),2) AS totalNet " +
        "FROM FINAL_TXN_LINE " +
        "WHERE run_id = ? AND invoice_date = ? " +
        "GROUP BY run_id, customer_id, invoice_date " +
        "ORDER BY customer_id";

    return new JdbcCursorItemReaderBuilder<InvoiceSummary>()
        .name("invoiceSummaryReader")
        .dataSource(dataSource)
        .sql(sql)
        .preparedStatementSetter(ps -> {
          ps.setString(1, runId);
          ps.setDate(2, java.sql.Date.valueOf(invoiceDateFinal)); // ✅ uses final variable
        })
        .rowMapper(new BeanPropertyRowMapper<>(InvoiceSummary.class))
        .build();
  }

  @Bean
  public JdbcBatchItemWriter<InvoiceSummary> invoiceWriter(DataSource dataSource) {
    return new JdbcBatchItemWriterBuilder<InvoiceSummary>()
        .dataSource(dataSource)
        .sql("INSERT INTO INVOICE_FINAL(run_id, customer_id, invoice_date, total_gross, total_discount, total_tax, total_commission, total_net, created_at) " +
             "VALUES (?,?,?,?,?,?,?,?, CURRENT_TIMESTAMP)")
        .itemPreparedStatementSetter((ps, i) -> {
          ps.setString(1, i.runId);
          ps.setString(2, i.customerId);
          ps.setDate(3, java.sql.Date.valueOf(i.invoiceDate)); // LocalDate -> java.sql.Date ✅
          ps.setBigDecimal(4, i.totalGross);
          ps.setBigDecimal(5, i.totalDiscount);
          ps.setBigDecimal(6, i.totalTax);
          ps.setBigDecimal(7, i.totalCommission);
          ps.setBigDecimal(8, i.totalNet);
        })
        .build();
  }
}
