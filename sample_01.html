@RestController
public class UserRolesHistoryController {

    private static final String DEFAULT_SORT_FIELD = "changeDt";
    private static final int DEFAULT_PAGE_NUMBER = 1;
    private static final int DEFAULT_PAGE_SIZE = 10;
    private static final int MAX_PAGE_SIZE = 100;      // choose a limit that makes sense for you
    private static final int MAX_PAGE_NUMBER = 10_000; // optional safety cap

    private final IUserHistory userHistoryService;

    public UserRolesHistoryController(IUserHistory userHistoryService) {
        this.userHistoryService = userHistoryService;
    }

    @GetMapping("/api/getUserHistory")
    public UserHistoryResponse getAllUserHistory(
            @RequestParam(defaultValue = "1") int pageNumber,
            @RequestParam(defaultValue = "10") int recordsPerPage,
            @RequestParam(defaultValue = DEFAULT_SORT_FIELD) String sortBy,
            @RequestParam(defaultValue = "-1") int sortOrder,
            @RequestParam(required = false) String searchBy,
            @RequestParam(required = false) String searchInput) {

        // 1) Normalize and validate pageNumber and recordsPerPage
        int safePageNumber = pageNumber;
        if (safePageNumber < 1) {
            safePageNumber = DEFAULT_PAGE_NUMBER;
        } else if (safePageNumber > MAX_PAGE_NUMBER) {
            safePageNumber = MAX_PAGE_NUMBER;
        }

        int safePageSize = recordsPerPage;
        if (safePageSize < 1) {
            safePageSize = DEFAULT_PAGE_SIZE;
        } else if (safePageSize > MAX_PAGE_SIZE) {
            safePageSize = MAX_PAGE_SIZE;
        }

        int zeroBasedPageIndex = safePageNumber - 1;  // arithmetic now on validated value

        // 2) Map DTO field names to entity field names
        String entitySortField = mapToEntityField(sortBy);

        // 3) Create Sort object
        Sort.Direction direction = sortOrder == -1 ? Sort.Direction.DESC : Sort.Direction.ASC;
        Sort sort = Sort.by(direction, entitySortField);

        // 4) Use validated page + size
        Pageable pageable = PageRequest.of(zeroBasedPageIndex, safePageSize, sort);

        // 5) Call service
        return userHistoryService.getAllUserHistory(pageable, searchBy, searchInput);
    }

    private String mapToEntityField(String dtoField) {
        return switch (dtoField) {
            case "histSeqNum" -> "id.histSeqNum";
            case "changeUsr" -> "changeUsr.uiSystemId";
            case "uiSystemId" -> "uiSystem.uiSystemId";
            case "fadsGrpName" -> "fadsGrp.fadsGrpName";
            case "fadsSurGrpName" -> "fadsSurGrp.surGrpName";
            case "fadsCaseGrpName" -> "fadsCaseGrp.caseGrpName";
            case "uiUserId" -> "uiUserId";
            case "uiLastName" -> "uiLastName";
            case "uiFirstName" -> "uiFirstName";
            case "uiEmailAddress" -> "uiEMailAddress";
            case DEFAULT_SORT_FIELD -> DEFAULT_SORT_FIELD;
            default -> DEFAULT_SORT_FIELD;
        };
    }
}
