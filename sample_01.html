package com.optum.fads.userroles.api.config.dao.impl;

import java.util.ArrayList;
import java.util.List;

import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import jakarta.persistence.TypedQuery;
import jakarta.persistence.criteria.CriteriaBuilder;
import jakarta.persistence.criteria.CriteriaQuery;
import jakarta.persistence.criteria.Predicate;
import jakarta.persistence.criteria.Root;

import org.hibernate.LockOptions;
import org.hibernate.Session;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.context.ApplicationContext;
import org.springframework.stereotype.Repository;

import com.optum.fads.userroles.api.config.dao.LuValuesDAO;
import com.optum.fads.userroles.api.config.domain.LuValues;
import com.optum.fads.userroles.api.config.domain.LuValuesId;

@Repository
public class LuValuesDAOImpl implements LuValuesDAO {

    private static final Logger log = LoggerFactory.getLogger(LuValuesDAOImpl.class);

    @PersistenceContext
    private EntityManager em;

    private Session session() {
        return em.unwrap(Session.class);
    }

    @Override
    public void save(LuValues transientInstance) {
        log.debug("saving LuValues instance");
        em.persist(transientInstance);
    }

    @Override
    public void delete(LuValues persistentInstance) {
        log.debug("deleting LuValues instance");
        em.remove(em.contains(persistentInstance) ? persistentInstance : em.merge(persistentInstance));
    }

    @Override
    public LuValues findById(LuValuesId id) { // FIXED package/type
        log.debug("getting LuValues instance with id: {}", id);
        return em.find(LuValues.class, id); // FIX: use entity class, not string FQN
    }

    @Override
    public List<LuValues> findByExample(LuValues probe) {
        // REPLACEMENT for removed org.hibernate.criterion.Example
        // Build a dynamic Criteria query using non-null fields from the probe.
        log.debug("finding LuValues by example (dynamic criteria)");
        CriteriaBuilder cb = em.getCriteriaBuilder();
        CriteriaQuery<LuValues> cq = cb.createQuery(LuValues.class);
        Root<LuValues> root = cq.from(LuValues.class);

        List<Predicate> ps = new ArrayList<>();
        if (probe.getId() != null) {
            if (probe.getId().getFieldId() != null) {
                ps.add(cb.equal(root.get("id").get("fieldId"), probe.getId().getFieldId()));
            }
            if (probe.getId().getLuId() != null) {
                ps.add(cb.equal(root.get("id").get("luId"), probe.getId().getLuId()));
            }
        }
        if (probe.getLuCode() != null)   ps.add(cb.equal(root.get("luCode"), probe.getLuCode()));
        if (probe.getLuLabel() != null)  ps.add(cb.equal(root.get("luLabel"), probe.getLuLabel()));
        if (probe.getLuView() != null)   ps.add(cb.equal(root.get("luView"), probe.getLuView()));
        if (probe.getObjId() != null)    ps.add(cb.equal(root.get("objId"), probe.getObjId()));
        if (probe.getLuSeq() != null)    ps.add(cb.equal(root.get("luSeq"), probe.getLuSeq()));
        if (probe.getLuParent() != null) ps.add(cb.equal(root.get("luParent"), probe.getLuParent()));

        cq.select(root).where(ps.toArray(Predicate[]::new));
        return em.createQuery(cq).getResultList();
    }

    @SuppressWarnings("unchecked")
    @Override
    public List<LuValues> findByProperty(String propertyName, Object value) {
        log.debug("finding LuValues with property: {}, value: {}", propertyName, value);
        // Use named parameter (Hibernate 6 disallows bare '?')
        String ql = "select l from LuValues l where l." + propertyName + " = :val";
        TypedQuery<LuValues> q = em.createQuery(ql, LuValues.class);
        q.setParameter("val", value);
        return q.getResultList();
    }

    @Override public List<LuValues> findByLuCode(Object v)   { return findByProperty("luCode", v); }
    @Override public List<LuValues> findByLuLabel(Object v)  { return findByProperty("luLabel", v); }
    @Override public List<LuValues> findByLuView(Object v)   { return findByProperty("luView", v); }
    @Override public List<LuValues> findByObjId(Object v)    { return findByProperty("objId", v); }
    @Override public List<LuValues> findByLuSeq(Object v)    { return findByProperty("luSeq", v); }
    @Override public List<LuValues> findByLuParent(Object v) { return findByProperty("luParent", v); }

    @Override
    public List<LuValues> findAll() {
        log.debug("finding all LuValues");
        return em.createQuery("select l from LuValues l", LuValues.class).getResultList();
    }

    @Override
    public LuValues merge(LuValues detached) {
        log.debug("merging LuValues");
        return em.merge(detached);
    }

    @Override
    public void attachDirty(LuValues instance) {
        log.debug("attachDirty -> saveOrUpdate");
        em.merge(instance);
    }

    @Override
    public void attachClean(LuValues instance) {
        log.debug("attachClean (no-op for JPA). Using Hibernate lock NONE for parity.");
        session().buildLockRequest(LockOptions.NONE).lock(instance);
    }

    @Override
    public List<LuValues> findByFieldIdAndOrderBySeq(String fieldId) {
        log.debug("findByFieldIdAndOrderBySeq {}", fieldId);
        String ql = """
            select l from LuValues l
            where l.id.fieldId = :fieldId
              and l.luView = '1'
            order by l.luSeq asc
            """;
        return em.createQuery(ql, LuValues.class)
                 .setParameter("fieldId", fieldId)
                 .getResultList();
    }

    public static LuValuesDAO getFromApplicationContext(ApplicationContext ctx) {
        return ctx.getBean(LuValuesDAOImpl.class);
    }
}
