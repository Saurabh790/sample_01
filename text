package com.optum.fads.authorization.api.service.impl;

import java.util.*;
import java.util.stream.Collectors;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.optum.fads.authorization.api.dto.*;
import com.optum.fads.authorization.api.entity.*;
import com.optum.fads.authorization.api.mapper.UserDetailMapper;
import com.optum.fads.authorization.api.repo.UserRepository;
import com.optum.fads.authorization.api.service.IUserDetailsService;

@Service
public class UserDetailsService implements IUserDetailsService {

    private static final Logger log = LoggerFactory.getLogger(UserDetailsService.class);

    @Autowired private UserRepository userRepository;
    @Autowired private UserDetailMapper userDetailMapper;

    @Override
    @Transactional(readOnly = true)
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        log.info("Attempting to load user by username: {}", username);

        UiUserBase uiUserBase = userRepository.findByUiEMailAddress(username)
                .orElseThrow(() -> new UsernameNotFoundException("Not found: " + username));

        FADSUser user = userDetailMapper.toAppUser(uiUserBase);

        // --------- PGP / SUR ROLE ----------
        SeSurGrp surGrp = uiUserBase.getSeUsrGrp() != null ? uiUserBase.getSeUsrGrp().getSeSurGrp() : null;
        if (surGrp != null && surGrp.getSeSurGrpModAccesses() != null) {
            List<SurAccessLevel> accesses = surGrp.getSeSurGrpModAccesses().stream()
                    .map(sma -> new SurAccessLevel(
                            sma.getId().getSurModuleId(),
                            ModuleAccess.getByName(sma.getId().getSurModuleId()).toString(),
                            safe(() -> sma.getSeSurModule().getSurModuleName()),
                            safe(() -> sma.getSeSurAccess().getSurAccessId())
                    ))
                    .collect(Collectors.toList());

            user.getRole().setPgpRole(PgpRole.builder()
                    .groupId(surGrp.getSurGrpId())
                    .roleName(surGrp.getSurGrpName())
                    .pgpAccesses(accesses)
                    .build());
        }

        // --------- CASE ROLE ----------
        SeCaseGrp caseGrp = uiUserBase.getSeUsrGrp() != null ? uiUserBase.getSeUsrGrp().getSeCaseGrp() : null;
        if (caseGrp != null) {
            CaseRole caseRole = new CaseRole();
            caseRole.setGroupId(caseGrp.getCaseGrpId());
            caseRole.setRoleName(caseGrp.getCaseGrpName());

            // Modules by case type
            Map<String, List<CaseModule>> byType = new LinkedHashMap<>();
            Map<String, String> typeNames = new LinkedHashMap<>();

            Set<SeCaseGrpModAccess> modAccesses = nz(caseGrp.getSeCaseGrpModAccesses());
            for (SeCaseGrpModAccess ma : modAccesses) {
                CaseModule m = new CaseModule();
                m.setModuleId(safe(() -> ma.getSeCaseModule().getCaseModuleId()));
                m.setModuleCd(safe(() -> ma.getSeCaseModule().getCaseModuleCd()));
                m.setModuleName(safe(() -> ma.getSeCaseModule().getCaseModuleName()));
                m.setModuleAccess(safe(() -> ma.getSeCaseAccess().getAccessId()));

                String typeCd = safe(() -> ma.getCaLuCaseTypeT().getTypeCd());
                String typeDesc = safe(() -> ma.getCaLuCaseTypeT().getTypeDesc());
                if (typeCd == null) continue;

                byType.computeIfAbsent(typeCd, k -> new ArrayList<>()).add(m);
                typeNames.put(typeCd, typeDesc);
            }

            List<CaseTypeModule> caseTypeModules = new ArrayList<>();
            typeNames.forEach((typeCd, typeName) -> {
                CaseTypeModule ctm = new CaseTypeModule();
                ctm.setCaseTypeId(typeCd);
                ctm.setCaseTypeName(typeName);
                ctm.setModulePermissions(byType.getOrDefault(typeCd, List.of()));
                caseTypeModules.add(ctm);
            });
            caseRole.setCaseTypeModules(caseTypeModules);

            // Node permissions
            Set<SeCaseGrpNodeAccess> nodeAccesses = nz(caseGrp.getSeCaseGrpNodeAccesses());
            Collection<CaseNode> nodePermissions = new ArrayList<>();
            for (SeCaseGrpNodeAccess na : nodeAccesses) {
                CaseNode node = new CaseNode();
                node.setNodeId(safe(() -> na.getId().getCaseNodeId()));
                node.setNodeAccess(safe(() -> na.getSeCaseAccess().getAccessId()));
                node.setRestrictAccess(na.getAnyRestrictApply());
                node.setDeleteAccess(na.getCanDeleteCases());
                nodePermissions.add(node);
            }
            caseRole.setNodePermissions(new HashSet<>(nodePermissions));

            user.getRole().setCaseRole(caseRole);
        }

        // --------- FADS ROLE ----------
        SeFadsGrp fadsGrp = uiUserBase.getSeUsrGrp() != null ? uiUserBase.getSeUsrGrp().getSeFadsGrp() : null;
        if (fadsGrp != null) {
            FadsRole fadsRole = new FadsRole();
            fadsRole.setGroupId(fadsGrp.getFadsGrpId());
            fadsRole.setGroupName(fadsGrp.getFadsGrpName());

            // Component permissions (skip access = "H")
            Set<SeFadsGrpCompAccess> compAccesses = nz(fadsGrp.getSeFadsGrpCompAccesses());
            // Pre-index module accesses per component to avoid scanning each time
            Map<String, List<SeFadsGrpModAccess>> modByComp =
                    nz(fadsGrp.getSeFadsGrpModAccesses()).stream()
                            .collect(Collectors.groupingBy(a -> safe(() -> a.getSeFadsComponent().getComponentId()),
                                    LinkedHashMap::new, Collectors.toList()));

            List<FadsComponent> components = new ArrayList<>();
            for (SeFadsGrpCompAccess ca : compAccesses) {
                String compAccess = safe(() -> ca.getSeFadsAccess().getFadsAccessId());
                if ("H".equalsIgnoreCase(compAccess)) {
                    continue; // hidden/no access
                }

                FadsComponent comp = new FadsComponent();
                String compId = safe(() -> ca.getId().getFadsCompId());
                comp.setComponentId(compId);
                comp.setComponentCd(safe(() -> ca.getSeFadsComponent().getComponentCd()));
                comp.setComponentName(safe(() -> ca.getSeFadsComponent().getComponentName()));
                comp.setComponentSeq(nvlInt(safe(() -> ca.getSeFadsComponent().getComponentSeq()), 0));
                comp.setComponentAccess(compAccess);

                // Modules for this component (skip access = "H")
                List<SeFadsGrpModAccess> mods = modByComp.getOrDefault(compId, List.of());
                List<FadsModule> fadsModules = new ArrayList<>();
                for (SeFadsGrpModAccess ma : mods) {
                    String moduleAccess = safe(() -> ma.getSeFadsAccess().getFadsAccessId());
                    if ("H".equalsIgnoreCase(moduleAccess)) continue;

                    FadsModule fm = new FadsModule();
                    fm.setModuleId(safe(() -> ma.getId().getFadsModuleId()));
                    fm.setModuleCd(safe(() -> ma.getSeFadsModule().getFadsModuleCd()));
                    fm.setModuleName(safe(() -> ma.getSeFadsModule().getFadsModuleName()));
                    fm.setModuleSeq(nvlInt(safe(() -> ma.getSeFadsModule().getModuleSeq()), 0));
                    fm.setModuleAccess(moduleAccess);

                    // Elements: include those NOT listed in "no-access" for this group
                    List<FadsModuleElement> elements = new ArrayList<>();
                    List<FadsModElemConfig> elemConfigs =
                            nz(safe(() -> ma.getSeFadsModule().getFadsModElemConfigs()));
                    for (FadsModElemConfig cfg : elemConfigs) {
                        boolean blocked = nz(cfg.getSeFadsGrpElemNoAccesses()).stream()
                                .anyMatch(na -> safe(() -> na.getSeFadsGrp().getFadsGrpId())
                                        .equals(fadsGrp.getFadsGrpId()));
                        if (blocked) continue;

                        FadsModuleElement el = new FadsModuleElement();
                        el.setElementId(cfg.getElementId());
                        el.setElementCd(cfg.getElementCd());
                        el.setElementName(cfg.getElementName());
                        el.setElementSeq(nvlInt(cfg.getElementSeq(), 0));
                        elements.add(el);
                    }
                    // sort elements by elementSeq
                    elements.sort(Comparator.comparingInt(FadsModuleElement::getElementSeq));
                    fm.setElements(elements);

                    fadsModules.add(fm);
                }

                // sort modules by moduleSeq
                fadsModules.sort(Comparator.comparingInt(FadsModule::getModuleSeq));
                comp.setModules(fadsModules);

                components.add(comp);
            }

            // sort components by componentSeq
            components.sort(Comparator.comparingInt(FadsComponent::getComponentSeq));
            fadsRole.setComponentPermissions(components);

            user.getRole().setFadsRole(fadsRole);
        }

        return user;
    }

    // --------- small helpers ---------
    private static <T> T safe(SupplierX<T> s) {
        try { return s.get(); } catch (Exception e) { return null; }
    }
    private static <T> Set<T> nz(Set<T> s) { return s != null ? s : Collections.emptySet(); }
    private static int nvlInt(Integer v, int d) { return v != null ? v : d; }

    @FunctionalInterface
    private interface SupplierX<T> { T get() throws Exception; }
}
