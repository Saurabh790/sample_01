
package com.optum.fads.userroles.api.service.Impl;

import com.optum.fads.userroles.api.domain.SeUsrGrp;
import com.optum.fads.userroles.api.domain.UiUserBase;
import com.optum.fads.userroles.api.dto.UserForAdmin;
import com.optum.fads.userroles.api.dto.UserListItem;
import com.optum.fads.userroles.api.dto.UserListItemHistoryRequest;
import com.optum.fads.userroles.api.mapper.UserListItemMapper;
import com.optum.fads.userroles.api.repo.SeCaseGrpRepository;
import com.optum.fads.userroles.api.repo.SeFadsGrpRepository;
import com.optum.fads.userroles.api.repo.SeSurGrpRepository;
import com.optum.fads.userroles.api.repo.SeUsrGrpRepository;
import com.optum.fads.userroles.api.repo.UiUserBaseRepository;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.*;
import org.springframework.data.domain.*;
import org.springframework.data.jpa.domain.Specification;

import java.math.BigDecimal;
import java.util.List;
import java.util.Map;
import java.util.NoSuchElementException;
import java.util.Optional;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

class UserServiceImplTest {

	@Mock
	private UiUserBaseRepository repo;

	@Mock
	private UserListItemMapper mapper;

	@Mock
	private SeUsrGrpRepository seUsrGrpRepository;

	@Mock
	private SeFadsGrpRepository seFadsGrpRepository;

	@Mock
	private SeSurGrpRepository seSurGrpRepository;

	@Mock
	private SeCaseGrpRepository seCaseGrpRepository;

	@Mock
	private UserHistoryImpl userHistory;

	@InjectMocks
	private UserServiceImpl userService;

	@BeforeEach
	void setUp() {
		MockitoAnnotations.openMocks(this);
	}

	@Test
	void testGetUsersList_withFilters() {
		// Arrange
		Map<String, String> filters = Map.of("lastName", "Doe");
		Map<String, String> fieldMap = Map.of("lastName", "uiLastName");
		Pageable pageable = PageRequest.of(0, 10);

		UiUserBase entity = new UiUserBase();
		entity.setUiSystemId("sys123");
		entity.setUiUserId("user123");
		entity.setUiLastName("Doe");

		UserListItem dto = new UserListItem("sys123", "user123", "Doe", "John", "Engineer", "john.doe@example.com",
				"FADS Group", "SUR Group", "CASE Group");

		Page<UiUserBase> entityPage = new PageImpl<>(List.of(entity));
		when(repo.findAll(any(Specification.class), eq(pageable))).thenReturn(entityPage);

		when(mapper.toDto(entity)).thenReturn(dto);

		// Act
		Page<UserListItem> result = userService.getUsersList(filters, pageable, fieldMap);

		// Assert
		assertNotNull(result);
		assertEquals(1, result.getContent().size());
		assertEquals("Doe", result.getContent().get(0).getLastName());
		verify(repo, times(1)).findAll(any(Specification.class), eq(pageable));
		verify(mapper, times(1)).toDto(entity);
	}

	@Test
	void testGetUsersList_withoutFilters() {
		// Arrange
		Map<String, String> filters = Map.of(); // empty
		Map<String, String> fieldMap = Map.of("lastName", "uiLastName");
		Pageable pageable = PageRequest.of(0, 10);

		UiUserBase entity = new UiUserBase();
		entity.setUiSystemId("sys123");
		entity.setUiUserId("user123");

		UserListItem dto = new UserListItem("sys123", "user123", "Doe", "John", "Engineer", "john.doe@example.com",
				"FADS Group", "SUR Group", "CASE Group");

		Page<UiUserBase> entityPage = new PageImpl<>(List.of(entity));
		when(repo.findAll(pageable)).thenReturn(entityPage);
		when(mapper.toDto(entity)).thenReturn(dto);

		// Act
		Page<UserListItem> result = userService.getUsersList(filters, pageable, fieldMap);

		// Assert
		assertNotNull(result);
		assertEquals(1, result.getContent().size());
		verify(repo, times(1)).findAll(pageable);
		verify(mapper, times(1)).toDto(entity);
	}

	@Test
	void testSaveNewUser_success() {
		// Arrange
		UserForAdmin inputUser = new UserForAdmin();
		inputUser.setSystemId("JD12345678");
		inputUser.setUserId("john.doe@example.com");
		inputUser.setFirstName("John");
		inputUser.setLastName("Doe");
		inputUser.setTitle("Developer");
		inputUser.setEmail("john.doe@example.com");
		inputUser.setFadsGroup(1);
		inputUser.setSurGroup(2);
		inputUser.setCaseGroup(3);

		UiUserBase entityToSave = new UiUserBase();
		entityToSave.setUiSystemId("JD12345678");
		entityToSave.setUiUserId("john.doe@example.com");

		UiUserBase savedEntity = new UiUserBase();
		savedEntity.setUiSystemId("JD12345678");
		savedEntity.setUiUserId("john.doe@example.com");

		// Mock repository calls
		when(repo.existsByUiUserId("john.doe@example.com")).thenReturn(false);
		when(seUsrGrpRepository.existsByUiSystemId("JD12345678")).thenReturn(false);
		when(mapper.toEntity(inputUser)).thenReturn(entityToSave);
		when(repo.save(entityToSave)).thenReturn(savedEntity);
		when(seUsrGrpRepository.save(any(SeUsrGrp.class))).thenReturn(new SeUsrGrp());

		// Act
		assertDoesNotThrow(() -> userService.saveNewUser(inputUser));

		// Assert
		verify(repo, times(1)).existsByUiUserId("john.doe@example.com");
		verify(seUsrGrpRepository, times(1)).existsByUiSystemId("JD12345678");
		verify(mapper, times(1)).toEntity(inputUser);
		verify(repo, times(1)).save(entityToSave);
		verify(repo, times(1)).flush();
		
		// Verify SeUserGroup creation and save
		ArgumentCaptor<SeUsrGrp> seUserGroupCaptor = ArgumentCaptor.forClass(SeUsrGrp.class);
		verify(seUsrGrpRepository, times(1)).save(seUserGroupCaptor.capture());

		SeUsrGrp capturedSeUserGroup = seUserGroupCaptor.getValue();
		assertEquals(savedEntity, capturedSeUserGroup.getUiUserBase());
		assertEquals(Integer.valueOf(1), capturedSeUserGroup.getFadsGrp());
		assertEquals(Integer.valueOf(2), capturedSeUserGroup.getFadsSurGrp());
		assertEquals(Integer.valueOf(3), capturedSeUserGroup.getFadsCaseGrp());
	}

	@Test
	void testSaveNewUser_userAlreadyExists() {
		// Arrange
		UserForAdmin inputUser = new UserForAdmin();
		inputUser.setSystemId("JD12345678");
		inputUser.setUserId("existing.user@example.com");
		inputUser.setFirstName("John");
		inputUser.setLastName("Doe");

		when(repo.existsByUiUserId("existing.user@example.com")).thenReturn(true);

		// Act & Assert
		IllegalArgumentException exception = assertThrows(IllegalArgumentException.class, 
			() -> userService.saveNewUser(inputUser));
		
		assertEquals("User with uiUserId existing.user@example.com already exists.", exception.getMessage());
		
		// Verify that we stop after checking user existence
		verify(repo, times(1)).existsByUiUserId("existing.user@example.com");
		verify(seUsrGrpRepository, never()).existsByUiSystemId(anyString());
		verify(mapper, never()).toEntity(any());
		verify(repo, never()).save(any());
		verify(seUsrGrpRepository, never()).save(any());
	}

	@Test
	void testSaveNewUser_userGroupAlreadyExists() {
		// Arrange
		UserForAdmin inputUser = new UserForAdmin();
		inputUser.setSystemId("JD12345678");
		inputUser.setUserId("new.user@example.com");
		inputUser.setFirstName("John");
		inputUser.setLastName("Doe");

		when(repo.existsByUiUserId("new.user@example.com")).thenReturn(false);
		when(seUsrGrpRepository.existsByUiSystemId("JD12345678")).thenReturn(true);

		// Act & Assert
		IllegalArgumentException exception = assertThrows(IllegalArgumentException.class, 
			() -> userService.saveNewUser(inputUser));
		
		assertEquals("User group with uiSystemId JD12345678 already exists.", exception.getMessage());
		
		// Verify the flow stops after checking group existence
		verify(repo, times(1)).existsByUiUserId("new.user@example.com");
		verify(seUsrGrpRepository, times(1)).existsByUiSystemId("JD12345678");
		verify(mapper, never()).toEntity(any());
		verify(repo, never()).save(any());
		verify(seUsrGrpRepository, never()).save(any());
	}

	@Test
	void testSaveNewUser_repositoryException() {
		// Arrange
		UserForAdmin inputUser = new UserForAdmin();
		inputUser.setSystemId("JD12345678");
		inputUser.setUserId("error.user@example.com");
		inputUser.setFirstName("John");
		inputUser.setLastName("Doe");

		UiUserBase entityToSave = new UiUserBase();

		when(repo.existsByUiUserId("error.user@example.com")).thenReturn(false);
		when(seUsrGrpRepository.existsByUiSystemId("JD12345678")).thenReturn(false);
		when(mapper.toEntity(inputUser)).thenReturn(entityToSave);
		when(repo.save(entityToSave)).thenThrow(new RuntimeException("Database error"));

		// Act & Assert
		RuntimeException exception = assertThrows(RuntimeException.class, 
			() -> userService.saveNewUser(inputUser));
		
		assertEquals("Database error", exception.getMessage());
		
		// Verify that save was attempted
		verify(repo, times(1)).save(entityToSave);
		verify(seUsrGrpRepository, never()).save(any()); // Should not reach this point
	}

	@Test
	void testUpdateUser_success() {
		// Arrange
		UserForAdmin inputUser = new UserForAdmin();
		inputUser.setSystemId("JD12345678");
		inputUser.setUserId("john.doe@example.com");
		inputUser.setFirstName("John");
		inputUser.setLastName("Doe");
		inputUser.setTitle("Senior Developer");
		inputUser.setEmail("john.doe@example.com");
		inputUser.setFadsGroup(1);
		inputUser.setSurGroup(2);
		inputUser.setCaseGroup(3);

		UiUserBase entityFromMapper = new UiUserBase();
		entityFromMapper.setUiSystemId("JD12345678");
		entityFromMapper.setUiUserId("john.doe@example.com");
		entityFromMapper.setUiLastName("Doe");
		entityFromMapper.setUiFirstName("John");
		entityFromMapper.setUiTitle("Senior Developer");

		UiUserBase savedUser = new UiUserBase();
		savedUser.setUiSystemId("JD12345678");
		savedUser.setUiUserId("john.doe@example.com");
		savedUser.setUiLastName("Doe");
		savedUser.setUiFirstName("John");
		savedUser.setUiTitle("Senior Developer");

		SeUsrGrp existingUserGroup = new SeUsrGrp();
		existingUserGroup.setUiUserBase(savedUser);

		when(repo.existsById("JD12345678")).thenReturn(true);
		when(mapper.toEntity(inputUser)).thenReturn(entityFromMapper);
		when(repo.save(entityFromMapper)).thenReturn(savedUser);
		when(seUsrGrpRepository.findById("JD12345678")).thenReturn(Optional.of(existingUserGroup));
		when(seUsrGrpRepository.save(any(SeUsrGrp.class))).thenReturn(existingUserGroup);

		// Act
		assertDoesNotThrow(() -> userService.updateUser(inputUser));

		// Assert
		verify(repo, times(1)).existsById("JD12345678");
		verify(mapper, times(1)).toEntity(inputUser);
		verify(repo, times(1)).save(entityFromMapper);
		verify(repo, times(1)).flush();
		verify(seUsrGrpRepository, times(1)).findById("JD12345678");
		verify(seUsrGrpRepository, times(1)).save(existingUserGroup);
		verify(userHistory, times(1)).createHistory(any(UserListItemHistoryRequest.class));
	}

	@Test
	void testUpdateUser_userNotFound() {
		// Arrange
		UserForAdmin inputUser = new UserForAdmin();
		inputUser.setSystemId("NOTFOUND123");
		inputUser.setUserId("notfound@example.com");

		when(repo.existsById("NOTFOUND123")).thenReturn(false);

		// Act & Assert
		IllegalArgumentException exception = assertThrows(IllegalArgumentException.class, 
			() -> userService.updateUser(inputUser));

		assertEquals("User not found with systemId: NOTFOUND123", exception.getMessage());
		verify(repo, times(1)).existsById("NOTFOUND123");
		verify(mapper, never()).toEntity(any());
		verify(repo, never()).save(any());
		verify(userHistory, never()).createHistory(any());
	}

	@Test
	void testUpdateUser_withGroupAssignments() {
		// Arrange
		UserForAdmin inputUser = new UserForAdmin();
		inputUser.setSystemId("JD12345678");
		inputUser.setUserId("john.doe@example.com");
		inputUser.setFadsGroup(5);
		inputUser.setSurGroup(10);
		inputUser.setCaseGroup(15);

		UiUserBase entityFromMapper = new UiUserBase();
		entityFromMapper.setUiSystemId("JD12345678");

		UiUserBase savedUser = new UiUserBase();
		savedUser.setUiSystemId("JD12345678");

		SeUsrGrp existingUserGroup = new SeUsrGrp();
		existingUserGroup.setUiUserBase(savedUser);

		when(repo.existsById("JD12345678")).thenReturn(true);
		when(mapper.toEntity(inputUser)).thenReturn(entityFromMapper);
		when(repo.save(entityFromMapper)).thenReturn(savedUser);
		when(seUsrGrpRepository.findById("JD12345678")).thenReturn(Optional.of(existingUserGroup));
		when(seUsrGrpRepository.save(any(SeUsrGrp.class))).thenReturn(existingUserGroup);

		// Act
		assertDoesNotThrow(() -> userService.updateUser(inputUser));

		// Assert
		verify(repo, times(1)).existsById("JD12345678");
		verify(mapper, times(1)).toEntity(inputUser);
		verify(repo, times(1)).save(entityFromMapper);
		verify(repo, times(1)).flush();
		verify(seUsrGrpRepository, times(1)).findById("JD12345678");
		
		// Verify SeUserGroup group assignments
		ArgumentCaptor<SeUsrGrp> seUserGroupCaptor = ArgumentCaptor.forClass(SeUsrGrp.class);
		verify(seUsrGrpRepository, times(1)).save(seUserGroupCaptor.capture());

		SeUsrGrp capturedSeUserGroup = seUserGroupCaptor.getValue();
		assertEquals(Integer.valueOf(5), capturedSeUserGroup.getFadsGrp());
		assertEquals(Integer.valueOf(10), capturedSeUserGroup.getFadsSurGrp());
		assertEquals(Integer.valueOf(15), capturedSeUserGroup.getFadsCaseGrp());
		
		// Verify history record creation
		ArgumentCaptor<UserListItemHistoryRequest> historyCaptor = ArgumentCaptor.forClass(UserListItemHistoryRequest.class);
		verify(userHistory, times(1)).createHistory(historyCaptor.capture());
		
		UserListItemHistoryRequest historyRequest = historyCaptor.getValue();
		assertEquals("john.doe@example.com", historyRequest.getUiUserId());
		assertEquals("JD12345678", historyRequest.getUiSystemId());
		assertEquals(Integer.valueOf(5), historyRequest.getFadsGrpId());
		assertEquals(Integer.valueOf(10), historyRequest.getFadsSurGrpId());
		assertEquals(Integer.valueOf(15), historyRequest.getFadsCaseGrpId());
	}

}
